<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Absensi SMP Purnawarman</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .scale-90 {
            transform: scale(0.9);
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .setup-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .step-number {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-gradient-to-br from-blue-50 to-indigo-100">
  <div id="app" class="h-full"><!-- Setup Google Sheets Screen -->
   <div id="setupScreen" class="min-h-full flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl w-full space-y-8">
     <div class="text-center">
      <div class="mx-auto h-16 w-16 bg-blue-600 rounded-full flex items-center justify-center mb-4">
       <svg class="h-8 w-8 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
       </svg>
      </div>
      <h2 id="appTitle" class="text-3xl font-bold text-gray-900">Setup Google Sheets</h2>
      <p id="schoolName" class="mt-2 text-xl text-gray-600">Konfigurasi Koneksi Data</p>
     </div><!-- Setup Instructions -->
     <div class="setup-card rounded-lg p-8 mb-8">
      <h3 class="text-2xl font-bold mb-6">üìã Panduan Setup Google Apps Script</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6"><!-- Step 1 -->
       <div class="bg-white bg-opacity-10 rounded-lg p-6">
        <div class="flex items-center mb-4">
         <div class="step-number w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold mr-3">
          1
         </div>
         <h4 class="text-lg font-semibold">Buat Google Spreadsheet</h4>
        </div>
        <ul class="text-sm space-y-2 opacity-90">
         <li>‚Ä¢ Buka Google Sheets (sheets.google.com)</li>
         <li>‚Ä¢ Buat spreadsheet baru: "Sistem Absensi SMP"</li>
         <li>‚Ä¢ Buat 5 sheet: Users, Siswa, Guru, Jadwal, Absensi</li>
         <li>‚Ä¢ Salin ID dari URL spreadsheet</li>
        </ul>
       </div><!-- Step 2 -->
       <div class="bg-white bg-opacity-10 rounded-lg p-6">
        <div class="flex items-center mb-4">
         <div class="step-number w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold mr-3">
          2
         </div>
         <h4 class="text-lg font-semibold">Buat Apps Script</h4>
        </div>
        <ul class="text-sm space-y-2 opacity-90">
         <li>‚Ä¢ Di spreadsheet, klik Extensions &gt; Apps Script</li>
         <li>‚Ä¢ Hapus kode default, paste kode yang disediakan</li>
         <li>‚Ä¢ Simpan project dengan nama "AbsensiAPI"</li>
         <li>‚Ä¢ Deploy sebagai Web App</li>
        </ul>
       </div><!-- Step 3 -->
       <div class="bg-white bg-opacity-10 rounded-lg p-6">
        <div class="flex items-center mb-4">
         <div class="step-number w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold mr-3">
          3
         </div>
         <h4 class="text-lg font-semibold">Deploy Web App</h4>
        </div>
        <ul class="text-sm space-y-2 opacity-90">
         <li>‚Ä¢ Klik Deploy &gt; New deployment</li>
         <li>‚Ä¢ Type: Web app</li>
         <li>‚Ä¢ Execute as: Me</li>
         <li>‚Ä¢ Who has access: Anyone</li>
         <li>‚Ä¢ Salin Web App URL</li>
        </ul>
       </div><!-- Step 4 -->
       <div class="bg-white bg-opacity-10 rounded-lg p-6">
        <div class="flex items-center mb-4">
         <div class="step-number w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold mr-3">
          4
         </div>
         <h4 class="text-lg font-semibold">Kode Apps Script</h4>
        </div>
        <ul class="text-sm space-y-2 opacity-90">
         <li>‚Ä¢ Copy kode dari panduan lengkap</li>
         <li>‚Ä¢ Paste ke Apps Script editor</li>
         <li>‚Ä¢ Authorize permissions saat diminta</li>
         <li>‚Ä¢ Test dengan URL deployment</li>
        </ul>
       </div>
      </div>
     </div><!-- Apps Script Code -->
     <div class="bg-gray-800 text-green-400 rounded-lg p-6 mb-6">
      <div class="flex justify-between items-center mb-4">
       <h4 class="text-lg font-semibold text-white">üìù Kode Google Apps Script</h4><button id="copyCodeBtn" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700"> Copy Code </button>
      </div>
      <pre id="appsScriptCode" class="text-xs overflow-x-auto whitespace-pre-wrap">function doGet(e) {
  return handleRequest(e);
}

function doPost(e) {
  return handleRequest(e);
}

function handleRequest(e) {
  const action = e.parameter.action;
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  
  try {
    switch(action) {
      case 'test':
        return createResponse({success: true, message: 'Connection successful'});
        
      case 'initialize':
        return initializeData(spreadsheet);
        
      case 'getData':
        return getData(spreadsheet, e.parameter.sheet);
        
      case 'saveAbsensi':
        return saveAbsensi(spreadsheet, JSON.parse(e.parameter.data));
        
      case 'saveData':
        return saveData(spreadsheet, e.parameter.sheet, JSON.parse(e.parameter.data));
        
      case 'updateData':
        return updateData(spreadsheet, e.parameter.sheet, JSON.parse(e.parameter.data), e.parameter.rowIndex);
        
      case 'deleteData':
        return deleteData(spreadsheet, e.parameter.sheet, e.parameter.rowIndex);
        
      default:
        return createResponse({success: false, error: 'Invalid action'});
    }
  } catch (error) {
    return createResponse({success: false, error: error.toString()});
  }
}

function createResponse(data) {
  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

function initializeData(spreadsheet) {
  // Initialize Users sheet
  const usersSheet = getOrCreateSheet(spreadsheet, 'Users');
  const usersData = [
    ['Username', 'Password', 'Nama', 'Role', 'Hari Piket'],
    ['admin', 'admin123', 'Administrator', 'Admin', ''],
    ['kepsek', 'kepsek123', 'Kepala Sekolah', 'Kepala Sekolah', ''],
    ['piket1', 'piket123', 'Guru Piket Senin', 'Guru Piket', 'Senin'],
    ['piket2', 'piket123', 'Guru Piket Selasa', 'Guru Piket', 'Selasa']
  ];
  usersSheet.clear();
  usersSheet.getRange(1, 1, usersData.length, usersData[0].length).setValues(usersData);

  // Initialize Siswa sheet
  const siswaSheet = getOrCreateSheet(spreadsheet, 'Siswa');
  const siswaData = [
    ['NIS', 'Nama', 'Kelas', 'JK', 'Alamat'],
    ['2024001', 'Ahmad Fauzi', '71', 'L', 'Jl. Merdeka No. 1'],
    ['2024002', 'Siti Nurhaliza', '71', 'P', 'Jl. Sudirman No. 2'],
    ['2024003', 'Budi Santoso', '72', 'L', 'Jl. Thamrin No. 3'],
    ['2024004', 'Dewi Sartika', '81', 'P', 'Jl. Diponegoro No. 4'],
    ['2024005', 'Rudi Hartono', '81', 'L', 'Jl. Gatot Subroto No. 5']
  ];
  siswaSheet.clear();
  siswaSheet.getRange(1, 1, siswaData.length, siswaData[0].length).setValues(siswaData);

  // Initialize Guru sheet
  const guruSheet = getOrCreateSheet(spreadsheet, 'Guru');
  const guruData = [
    ['NUPTK', 'Nama', 'Mapel', 'JK', 'Alamat'],
    ['196501011990032001', 'Dra. Siti Aminah', 'Matematika', 'P', 'Jl. Guru No. 1'],
    ['197203151998021001', 'Ahmad Wijaya, S.Pd', 'Bahasa Indonesia', 'L', 'Jl. Guru No. 2'],
    ['196803121995121001', 'Dr. Budi Setiawan', 'IPA', 'L', 'Jl. Guru No. 3'],
    ['197505201998032002', 'Sari Indah, S.Pd', 'IPS', 'P', 'Jl. Guru No. 4']
  ];
  guruSheet.clear();
  guruSheet.getRange(1, 1, guruData.length, guruData[0].length).setValues(guruData);

  // Initialize Jadwal sheet
  const jadwalSheet = getOrCreateSheet(spreadsheet, 'Jadwal');
  const jadwalData = [
    ['Hari', 'Jam Mulai', 'Jam Selesai', 'Kelas', 'NUPTK', 'Nama Guru', 'Mapel'],
    ['Senin', '07:00', '08:30', '71', '196501011990032001', 'Dra. Siti Aminah', 'Matematika'],
    ['Senin', '08:30', '10:00', '71', '197203151998021001', 'Ahmad Wijaya, S.Pd', 'Bahasa Indonesia'],
    ['Selasa', '07:00', '08:30', '81', '196803121995121001', 'Dr. Budi Setiawan', 'IPA'],
    ['Rabu', '09:00', '10:30', '72', '197505201998032002', 'Sari Indah, S.Pd', 'IPS']
  ];
  jadwalSheet.clear();
  jadwalSheet.getRange(1, 1, jadwalData.length, jadwalData[0].length).setValues(jadwalData);

  // Initialize Absensi sheet
  const absensiSheet = getOrCreateSheet(spreadsheet, 'Absensi');
  const absensiData = [
    ['Tanggal', 'Jenis', 'Kelas', 'NIS/NUPTK', 'Nama', 'Status', 'Keterangan', 'Timestamp']
  ];
  absensiSheet.clear();
  absensiSheet.getRange(1, 1, absensiData.length, absensiData[0].length).setValues(absensiData);

  return createResponse({success: true, message: 'Data initialized successfully'});
}

function getData(spreadsheet, sheetName) {
  const sheet = spreadsheet.getSheetByName(sheetName);
  if (!sheet) {
    return createResponse({success: false, error: 'Sheet not found: ' + sheetName});
  }
  
  const data = sheet.getDataRange().getValues();
  return createResponse({success: true, data: data});
}

function saveData(spreadsheet, sheetName, rowData) {
  const sheet = getOrCreateSheet(spreadsheet, sheetName);
  
  // Add new row to the end
  sheet.appendRow(rowData);
  
  return createResponse({success: true, message: 'Data saved successfully'});
}

function updateData(spreadsheet, sheetName, rowData, rowIndex) {
  const sheet = spreadsheet.getSheetByName(sheetName);
  if (!sheet) {
    return createResponse({success: false, error: 'Sheet not found: ' + sheetName});
  }
  
  const row = parseInt(rowIndex) + 1; // Convert to 1-based index
  const range = sheet.getRange(row, 1, 1, rowData.length);
  range.setValues([rowData]);
  
  return createResponse({success: true, message: 'Data updated successfully'});
}

function deleteData(spreadsheet, sheetName, rowIndex) {
  const sheet = spreadsheet.getSheetByName(sheetName);
  if (!sheet) {
    return createResponse({success: false, error: 'Sheet not found: ' + sheetName});
  }
  
  const row = parseInt(rowIndex) + 1; // Convert to 1-based index
  sheet.deleteRow(row);
  
  return createResponse({success: true, message: 'Data deleted successfully'});
}

function saveAbsensi(spreadsheet, absensiData) {
  const sheet = getOrCreateSheet(spreadsheet, 'Absensi');
  
  // Get existing data
  const existingData = sheet.getDataRange().getValues();
  const headers = existingData[0];
  const filteredData = [headers];
  
  // Create a map of existing records by primary key (tanggal + nis/nuptk)
  const existingRecordsMap = new Map();
  for (let i = 1; i &lt; existingData.length; i++) {
    const row = existingData[i];
    const primaryKey = `${row[0]}_${row[3]}`; // tanggal + nis/nuptk
    existingRecordsMap.set(primaryKey, i);
  }
  
  // Process new data - update existing or add new based on primary key
  const updatedRows = new Set();
  
  absensiData.forEach(newRow =&gt; {
    const primaryKey = `${newRow[0]}_${newRow[3]}`; // tanggal + nis/nuptk
    
    if (existingRecordsMap.has(primaryKey)) {
      // Update existing record
      const existingRowIndex = existingRecordsMap.get(primaryKey);
      existingData[existingRowIndex] = newRow;
      updatedRows.add(existingRowIndex);
    } else {
      // Add new record
      existingData.push(newRow);
    }
  });
  
  // Rebuild filtered data with updates
  for (let i = 1; i &lt; existingData.length; i++) {
    filteredData.push(existingData[i]);
  }
  
  // Update sheet
  sheet.clear();
  if (filteredData.length &gt; 0) {
    sheet.getRange(1, 1, filteredData.length, filteredData[0].length).setValues(filteredData);
  }
  
  return createResponse({success: true, message: 'Absensi saved successfully'});
}

function getOrCreateSheet(spreadsheet, sheetName) {
  let sheet = spreadsheet.getSheetByName(sheetName);
  if (!sheet) {
    sheet = spreadsheet.insertSheet(sheetName);
  }
  return sheet;
}</pre>
     </div><!-- Configuration Form -->
     <div class="bg-white shadow rounded-lg p-6">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Konfigurasi Apps Script</h3>
      <form id="setupForm" class="space-y-4">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Web App URL</label> <input type="url" id="webAppUrl" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec" required>
        <p class="text-xs text-gray-500 mt-1">URL dari deployment Google Apps Script</p>
       </div>
       <div class="flex space-x-4"><button type="submit" id="testConnectionBtn" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50"> <span id="testConnectionText">Test Koneksi</span> <span id="testConnectionLoader" class="loading ml-2 hidden"></span> </button> <button type="button" id="initializeDataBtn" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 disabled:opacity-50 hidden"> <span id="initializeDataText">Inisialisasi Data Sample</span> <span id="initializeDataLoader" class="loading ml-2 hidden"></span> </button> <button type="button" id="copyCodeBtn2" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500"> Copy Code </button>
       </div>
      </form><!-- Connection Status -->
      <div id="connectionStatus" class="mt-4 hidden">
       <div class="bg-green-50 border-l-4 border-green-400 p-4">
        <div class="flex">
         <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-green-400" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
          </svg>
         </div>
         <div class="ml-3">
          <h3 class="text-sm font-medium text-green-800">Koneksi Berhasil!</h3>
          <div class="mt-2 text-sm text-green-700">
           <p>Google Sheets berhasil terhubung. Anda dapat melanjutkan ke aplikasi.</p>
          </div>
          <div class="mt-4"><button id="proceedToAppBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 text-sm"> Lanjut ke Aplikasi </button>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Login Screen -->
   <div id="loginScreen" class="hidden min-h-full flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8 scale-90">
     <div class="text-center">
      <div class="mx-auto h-16 w-16 bg-blue-600 rounded-full flex items-center justify-center mb-4">
       <svg class="h-8 w-8 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
       </svg>
      </div>
      <h2 class="text-3xl font-bold text-gray-900">Absensi Online</h2>
      <p class="mt-2 text-xl text-gray-600">SMP Purnawarman</p>
     </div>
     <form id="loginForm" class="mt-8 space-y-6">
      <div class="space-y-4">
       <div><label for="username" class="block text-sm font-medium text-gray-700">Username</label> <input id="username" name="username" type="text" required class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Masukkan username">
       </div>
       <div class="relative"><label for="password" class="block text-sm font-medium text-gray-700">Password</label> <input id="password" name="password" type="password" required class="mt-1 appearance-none relative block w-full px-3 py-2 pr-10 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Masukkan password"> <button type="button" id="togglePassword" class="absolute inset-y-0 right-0 top-6 pr-3 flex items-center">
         <svg id="eyeIcon" class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
         </svg></button>
       </div>
      </div>
      <div><button type="submit" id="loginBtn" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50"> <span id="loginBtnText">Masuk</span> <span id="loginLoader" class="loading ml-2 hidden"></span> </button>
      </div>
     </form>
    </div>
   </div><!-- Dashboard Admin -->
   <div id="adminDashboard" class="hidden min-h-full bg-gray-50">
    <nav class="bg-white shadow-sm border-b">
     <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
       <div class="flex items-center">
        <h1 class="text-xl font-semibold text-gray-900">Dashboard Admin</h1>
       </div>
       <div class="flex items-center space-x-4"><span id="userInfo" class="text-sm text-gray-600"></span> <button id="logoutBtn" class="text-sm text-red-600 hover:text-red-800">Keluar</button>
       </div>
      </div>
     </div>
    </nav>
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8"><!-- Tab Navigation -->
     <div class="mb-6">
      <nav class="flex space-x-8"><button id="tabAbsensi" class="tab-btn active py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">Absensi</button> <button id="tabDataMaster" class="tab-btn py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Data Master</button> <button id="tabJadwal" class="tab-btn py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Jadwal</button> <button id="tabSetup" class="tab-btn py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Setup</button>
      </nav>
     </div><!-- Real-time Clock -->
     <div class="mb-6 scale-90 origin-top">
      <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg p-4 shadow-lg">
       <div class="flex items-center justify-between">
        <div>
         <h2 class="text-xl font-bold mb-1">üïê Waktu Sekarang</h2>
         <div id="currentDateTime" class="text-2xl font-mono font-bold">
          Loading...
         </div>
        </div>
        <div class="text-right">
         <div class="text-sm opacity-90">
          Sistem Absensi
         </div>
         <div class="text-lg font-semibold">
          SMP Purnawarman
         </div>
        </div>
       </div>
      </div>
     </div><!-- Info Cards -->
     <div class="mb-6"><!-- Date Selector for Statistics (Hidden) -->
      <div class="mb-6 bg-white rounded-lg shadow p-4">
       <div class="flex items-center justify-between">
        <h3 class="text-lg font-medium text-gray-900">üìä Statistik Absensi</h3>
        <div class="flex items-center space-x-4" style="display: none;"><label class="text-sm font-medium text-gray-700">Pilih Tanggal:</label> <input type="date" id="statistikTanggal" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"> <button id="refreshStatistikBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50"> <span id="refreshStatistikText">Refresh</span> <span id="refreshStatistikLoader" class="loading ml-2 hidden"></span> </button>
        </div>
       </div>
      </div><!-- Statistik Siswa -->
      <div class="mb-6">
       <h3 class="text-lg font-medium text-gray-900 mb-3">üìö Statistik Siswa - <span id="statistikSiswaDate">Loading...</span></h3>
       <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
        <div class="bg-white overflow-hidden shadow rounded-lg">
         <div class="p-4">
          <div class="flex items-center">
           <div class="flex-shrink-0">
            <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
            </svg>
           </div>
           <div class="ml-3 w-0 flex-1">
            <dl>
             <dt class="text-xs font-medium text-gray-500 truncate">
              Total Siswa
             </dt>
             <dd id="totalSiswa" class="text-lg font-medium text-gray-900">
              0
             </dd>
            </dl>
           </div>
          </div>
         </div>
        </div>
        <div class="bg-white overflow-hidden shadow rounded-lg">
         <div class="p-4">
          <div class="flex items-center">
           <div class="flex-shrink-0">
            <svg class="h-6 w-6 text-green-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
           </div>
           <div class="ml-3 w-0 flex-1">
            <dl>
             <dt class="text-xs font-medium text-gray-500 truncate">
              Hadir
             </dt>
             <dd id="siswaHadir" class="text-lg font-medium text-green-600">
              0
             </dd>
            </dl>
           </div>
          </div>
         </div>
        </div>
        <div class="bg-white overflow-hidden shadow rounded-lg">
         <div class="p-4">
          <div class="flex items-center">
           <div class="flex-shrink-0">
            <svg class="h-6 w-6 text-orange-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
           </div>
           <div class="ml-3 w-0 flex-1">
            <dl>
             <dt class="text-xs font-medium text-gray-500 truncate">
              Tidak Hadir
             </dt>
             <dd id="siswaTidakHadir" class="text-lg font-medium text-orange-600">
              0
             </dd>
            </dl>
           </div>
          </div>
         </div>
        </div>
        <div class="bg-white overflow-hidden shadow rounded-lg">
         <div class="p-4">
          <div class="flex items-center">
           <div class="flex-shrink-0">
            <svg class="h-6 w-6 text-yellow-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
           </div>
           <div class="ml-3 w-0 flex-1">
            <dl>
             <dt class="text-xs font-medium text-gray-500 truncate">
              Izin
             </dt>
             <dd id="siswaIzin" class="text-lg font-medium text-yellow-600">
              0
             </dd>
            </dl>
           </div>
          </div>
         </div>
        </div>
        <div class="bg-white overflow-hidden shadow rounded-lg">
         <div class="p-4">
          <div class="flex items-center">
           <div class="flex-shrink-0">
            <svg class="h-6 w-6 text-blue-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
            </svg>
           </div>
           <div class="ml-3 w-0 flex-1">
            <dl>
             <dt class="text-xs font-medium text-gray-500 truncate">
              Sakit
             </dt>
             <dd id="siswaSakit" class="text-lg font-medium text-blue-600">
              0
             </dd>
            </dl>
           </div>
          </div>
         </div>
        </div>
        <div class="bg-white overflow-hidden shadow rounded-lg">
         <div class="p-4">
          <div class="flex items-center">
           <div class="flex-shrink-0">
            <svg class="h-6 w-6 text-red-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
           </div>
           <div class="ml-3 w-0 flex-1">
            <dl>
             <dt class="text-xs font-medium text-gray-500 truncate">
              Alpha
             </dt>
             <dd id="siswaAlpha" class="text-lg font-medium text-red-600">
              0
             </dd>
            </dl>
           </div>
          </div>
         </div>
        </div>
       </div>
      </div><!-- Statistik Guru -->
      <div class="mb-4">
       <h3 class="text-lg font-medium text-gray-900 mb-3">üë®‚Äçüè´ Statistik Guru - <span id="statistikGuruDate">Loading...</span></h3>
       <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
        <div class="bg-white overflow-hidden shadow rounded-lg">
         <div class="p-4">
          <div class="flex items-center">
           <div class="flex-shrink-0">
            <svg class="h-6 w-6 text-purple-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
            </svg>
           </div>
           <div class="ml-3 w-0 flex-1">
            <dl>
             <dt class="text-xs font-medium text-gray-500 truncate">
              Total Guru
             </dt>
             <dd id="totalGuru" class="text-lg font-medium text-gray-900">
              0
             </dd>
            </dl>
           </div>
          </div>
         </div>
        </div>
        <div class="bg-white overflow-hidden shadow rounded-lg">
         <div class="p-4">
          <div class="flex items-center">
           <div class="flex-shrink-0">
            <svg class="h-6 w-6 text-green-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
           </div>
           <div class="ml-3 w-0 flex-1">
            <dl>
             <dt class="text-xs font-medium text-gray-500 truncate">
              Hadir
             </dt>
             <dd id="guruHadir" class="text-lg font-medium text-green-600">
              0
             </dd>
            </dl>
           </div>
          </div>
         </div>
        </div>
        <div class="bg-white overflow-hidden shadow rounded-lg">
         <div class="p-4">
          <div class="flex items-center">
           <div class="flex-shrink-0">
            <svg class="h-6 w-6 text-orange-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
           </div>
           <div class="ml-3 w-0 flex-1">
            <dl>
             <dt class="text-xs font-medium text-gray-500 truncate">
              Tidak Hadir
             </dt>
             <dd id="guruTidakHadir" class="text-lg font-medium text-orange-600">
              0
             </dd>
            </dl>
           </div>
          </div>
         </div>
        </div>
        <div class="bg-white overflow-hidden shadow rounded-lg">
         <div class="p-4">
          <div class="flex items-center">
           <div class="flex-shrink-0">
            <svg class="h-6 w-6 text-yellow-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
           </div>
           <div class="ml-3 w-0 flex-1">
            <dl>
             <dt class="text-xs font-medium text-gray-500 truncate">
              Izin
             </dt>
             <dd id="guruIzin" class="text-lg font-medium text-yellow-600">
              0
             </dd>
            </dl>
           </div>
          </div>
         </div>
        </div>
        <div class="bg-white overflow-hidden shadow rounded-lg">
         <div class="p-4">
          <div class="flex items-center">
           <div class="flex-shrink-0">
            <svg class="h-6 w-6 text-blue-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
            </svg>
           </div>
           <div class="ml-3 w-0 flex-1">
            <dl>
             <dt class="text-xs font-medium text-gray-500 truncate">
              Sakit
             </dt>
             <dd id="guruSakit" class="text-lg font-medium text-blue-600">
              0
             </dd>
            </dl>
           </div>
          </div>
         </div>
        </div>
        <div class="bg-white overflow-hidden shadow rounded-lg">
         <div class="p-4">
          <div class="flex items-center">
           <div class="flex-shrink-0">
            <svg class="h-6 w-6 text-red-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
           </div>
           <div class="ml-3 w-0 flex-1">
            <dl>
             <dt class="text-xs font-medium text-gray-500 truncate">
              Alpha
             </dt>
             <dd id="guruAlpha" class="text-lg font-medium text-red-600">
              0
             </dd>
            </dl>
           </div>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div><!-- Tab Content -->
     <div class="bg-white shadow rounded-lg"><!-- Absensi Tab -->
      <div id="absensiContent" class="tab-content p-6"><!-- Sub Tab Navigation for Absensi -->
       <div class="mb-6">
        <nav class="flex space-x-8"><button id="tabInputAbsensi" class="absensi-tab-btn active py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">Input Absensi</button> <button id="tabLaporanAbsensi" class="absensi-tab-btn py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Laporan Absensi</button>
        </nav>
       </div><!-- Input Absensi Content -->
       <div id="inputAbsensiContent" class="absensi-tab-content">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Input Absensi</h3><!-- Attendance Status Indicator -->
        <div id="attendanceStatusIndicator" class="mb-6 hidden">
         <div class="bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 rounded-lg p-4">
          <div class="flex items-center">
           <div class="flex-shrink-0">
            <svg class="h-6 w-6 text-green-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
           </div>
           <div class="ml-3 flex-1">
            <h4 class="text-sm font-medium text-green-800">‚úÖ Status Absensi Hari Ini</h4>
            <div id="attendanceStatusContent" class="mt-1 text-sm text-green-700"><!-- Dynamic content will be inserted here -->
            </div>
           </div>
           <div class="ml-4"><button id="viewTodayAttendanceBtn" class="inline-flex items-center px-3 py-1 border border-transparent text-xs leading-4 font-medium rounded-md text-green-700 bg-green-100 hover:bg-green-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200"> üìä Lihat Detail </button>
           </div>
          </div>
         </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label> <input type="date" id="tanggalAbsensi" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Jenis Absensi</label> <select id="jenisAbsensi" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"> <option value="">Pilih Jenis</option> <option value="siswa">Siswa</option> <option value="guru">Guru</option> </select>
         </div>
         <div id="kelasContainer" class="hidden"><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label> <select id="kelasAbsensi" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"> <option value="">Pilih Kelas</option> </select>
         </div>
         <div class="flex items-end"><button id="muatDataBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50"> <span id="muatDataText">Tarik Data</span> <span id="muatDataLoader" class="loading ml-2 hidden"></span> </button>
         </div>
        </div>
        <div id="absensiList" class="hidden">
         <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
           <thead class="bg-gray-50">
            <tr>
             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIS/NUPTK</th>
             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
             <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
            </tr>
           </thead>
           <tbody id="absensiTableBody" class="bg-white divide-y divide-gray-200">
           </tbody>
          </table>
         </div>
         <div class="mt-6 flex justify-end"><button id="simpanAbsensiBtn" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 disabled:opacity-50"> <span id="simpanAbsensiText">Simpan Absensi</span> <span id="simpanAbsensiLoader" class="loading ml-2 hidden"></span> </button>
         </div>
        </div>
       </div><!-- Laporan Absensi Content -->
       <div id="laporanAbsensiContent" class="absensi-tab-content hidden">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Laporan Absensi</h3><!-- Tipe Laporan Radio Buttons -->
        <div class="mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg border border-blue-200"><label class="block text-sm font-medium text-gray-700 mb-4">üìä Pilih Tipe Laporan</label>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><label class="flex items-start p-4 border-2 border-gray-200 rounded-lg hover:border-blue-300 cursor-pointer transition-colors duration-200"> <input type="radio" name="tipeLaporan" value="detail" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 mt-1" checked>
           <div class="ml-3"><span class="text-sm font-medium text-gray-900">üìã Detail Absensi</span>
            <p class="text-xs text-gray-600 mt-1">Menampilkan data absensi harian secara detail per individu dengan tanggal, status, dan keterangan lengkap</p>
           </div></label> <label class="flex items-start p-4 border-2 border-gray-200 rounded-lg hover:border-blue-300 cursor-pointer transition-colors duration-200"> <input type="radio" name="tipeLaporan" value="rekap" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 mt-1">
           <div class="ml-3"><span class="text-sm font-medium text-gray-900">üìà Rekapitulasi Kehadiran</span>
            <p class="text-xs text-gray-600 mt-1">Menampilkan ringkasan kehadiran per individu dengan total hadir, izin, sakit, alpha, dan persentase kehadiran</p>
           </div></label>
         </div><!-- Info Box -->
         <div class="mt-4 p-3 bg-blue-100 border border-blue-300 rounded-md">
          <div class="flex items-start">
           <svg class="w-5 h-5 text-blue-500 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
           </svg>
           <div>
            <h4 class="text-sm font-medium text-blue-800">üí° Tips Penggunaan</h4>
            <p class="text-xs text-blue-700 mt-1">‚Ä¢ <strong>Detail Absensi:</strong> Cocok untuk melihat kehadiran harian dan mencari data spesifik<br>
              ‚Ä¢ <strong>Rekapitulasi:</strong> Cocok untuk evaluasi kehadiran, laporan bulanan, dan analisis performa</p>
           </div>
          </div>
         </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Jenis Laporan</label> <select id="jenisLaporan" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"> <option value="">Pilih Jenis</option> <option value="siswa">Siswa</option> <option value="guru">Guru</option> </select>
         </div>
         <div id="kelasLaporanContainer" class="hidden"><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label> <select id="kelasLaporan" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"> <option value="">Semua Kelas</option> </select>
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Dari Tanggal</label> <input type="date" id="dariTanggal" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
         </div>
         <div><label class="block text-sm font-medium text-gray-700 mb-2">Sampai Tanggal</label> <input type="date" id="sampaiTanggal" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
         </div>
         <div class="flex items-end"><button id="tarikDataBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50"> <span id="tarikDataText">Tarik Data</span> <span id="tarikDataLoader" class="loading ml-2 hidden"></span> </button>
         </div>
        </div>
        <div id="laporanResult" class="hidden">
         <div class="mb-4 flex space-x-2"><button id="cetakPDFBtn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">Cetak PDF</button> <button id="cetakExcelBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">Export Excel</button>
         </div>
         <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
           <thead class="bg-gray-50">
            <tr id="laporanTableHeader">
            </tr>
           </thead>
           <tbody id="laporanTableBody" class="bg-white divide-y divide-gray-200">
           </tbody>
          </table>
         </div>
        </div>
       </div>
      </div><!-- Data Master Tab -->
      <div id="dataMasterContent" class="tab-content p-6 hidden"><!-- Sub Tab Navigation -->
       <div class="mb-6">
        <nav class="flex space-x-8"><button id="tabUsers" class="data-tab-btn active py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">Users</button> <button id="tabSiswaData" class="data-tab-btn py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Siswa</button> <button id="tabGuruData" class="data-tab-btn py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Guru</button> <button id="tabJadwalData" class="data-tab-btn py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Jadwal</button>
        </nav>
       </div><!-- Users Content -->
       <div id="usersContent" class="data-tab-content">
        <div class="flex justify-between items-center mb-4">
         <h3 class="text-lg font-medium text-gray-900">Data Users</h3>
         <div class="flex space-x-2"><button id="addUserBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
           <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
           </svg> Tambah User </button> <button id="refreshUsersBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
           <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
           </svg> Refresh </button>
         </div>
        </div>
        <div class="overflow-x-auto">
         <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
           <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hari Piket</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
           </tr>
          </thead>
          <tbody id="usersTableBody" class="bg-white divide-y divide-gray-200">
          </tbody>
         </table>
        </div>
       </div><!-- Siswa Data Content -->
       <div id="siswaDataContent" class="data-tab-content hidden">
        <div class="flex justify-between items-center mb-4">
         <h3 class="text-lg font-medium text-gray-900">Data Siswa</h3>
         <div class="flex space-x-2"><button id="addSiswaBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
           <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
           </svg> Tambah Siswa </button> <button id="refreshSiswaDataBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
           <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
           </svg> Refresh </button>
         </div>
        </div>
        <div class="overflow-x-auto">
         <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
           <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIS</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">JK</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alamat</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
           </tr>
          </thead>
          <tbody id="siswaDataTableBody" class="bg-white divide-y divide-gray-200">
          </tbody>
         </table>
        </div>
       </div><!-- Guru Data Content -->
       <div id="guruDataContent" class="data-tab-content hidden">
        <div class="flex justify-between items-center mb-4">
         <h3 class="text-lg font-medium text-gray-900">Data Guru</h3>
         <div class="flex space-x-2"><button id="addGuruBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
           <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
           </svg> Tambah Guru </button> <button id="refreshGuruDataBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
           <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
           </svg> Refresh </button>
         </div>
        </div>
        <div class="overflow-x-auto">
         <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
           <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NUPTK</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">JK</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alamat</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
           </tr>
          </thead>
          <tbody id="guruDataTableBody" class="bg-white divide-y divide-gray-200">
          </tbody>
         </table>
        </div>
       </div><!-- Jadwal Data Content -->
       <div id="jadwalDataContent" class="data-tab-content hidden">
        <div class="flex justify-between items-center mb-4">
         <h3 class="text-lg font-medium text-gray-900">Data Jadwal</h3>
         <div class="flex space-x-2"><button id="addJadwalBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
           <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
           </svg> Tambah Jadwal </button> <button id="refreshJadwalDataBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
           <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
           </svg> Refresh </button>
         </div>
        </div>
        <div class="overflow-x-auto">
         <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
           <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hari</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NUPTK</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Guru</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mapel</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
           </tr>
          </thead>
          <tbody id="jadwalDataTableBody" class="bg-white divide-y divide-gray-200">
          </tbody>
         </table>
        </div>
       </div>
      </div><!-- Jadwal Tab -->
      <div id="jadwalContent" class="tab-content p-6 hidden">
       <div class="flex justify-between items-center mb-6">
        <h3 class="text-lg font-medium text-gray-900">Jadwal Mengajar Guru</h3><button id="refreshJadwalBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
         <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
         </svg> Refresh Jadwal </button>
       </div>
       <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
         <thead class="bg-gray-50">
          <tr>
           <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hari</th>
           <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam</th>
           <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
           <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
           <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Guru</th>
          </tr>
         </thead>
         <tbody id="jadwalTableBody" class="bg-white divide-y divide-gray-200">
         </tbody>
        </table>
       </div>
      </div><!-- Setup Tab -->
      <div id="setupContent" class="tab-content p-6 hidden">
       <h3 class="text-lg font-medium text-gray-900 mb-4">Status Koneksi Google Sheets</h3><!-- Connection Status -->
       <div class="bg-green-50 border-l-4 border-green-400 p-6 mb-6">
        <div class="flex">
         <div class="flex-shrink-0">
          <svg class="h-6 w-6 text-green-400" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
          </svg>
         </div>
         <div class="ml-3">
          <h3 class="text-lg font-medium text-green-800">‚úÖ Google Sheets Terhubung</h3>
          <div class="mt-2 text-sm text-green-700">
           <p class="mb-2">Sistem absensi sudah terhubung dengan Google Sheets dan siap digunakan.</p>
           <p class="text-xs text-green-600">URL: https://script.google.com/macros/s/AKfycbyXvanZbuN56w9EQC7wBLb2-n3PCHEv6GSVBLXSuNwdf6MOv3DNpzOUgZdmLRUOaeXj/exec</p>
          </div>
         </div>
        </div>
       </div><!-- Action Buttons -->
       <div class="bg-white shadow rounded-lg p-6">
        <h4 class="text-md font-medium text-gray-900 mb-4">Aksi Sistem</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><button id="testConnectionBtnAdmin" class="bg-blue-600 text-white px-4 py-3 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50"> <span id="testConnectionTextAdmin">üîÑ Test Koneksi</span> <span id="testConnectionLoaderAdmin" class="loading ml-2 hidden"></span> </button> <button id="initializeDataBtnAdmin" class="bg-green-600 text-white px-4 py-3 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 disabled:opacity-50"> <span id="initializeDataTextAdmin">üìä Inisialisasi Data Sample</span> <span id="initializeDataLoaderAdmin" class="loading ml-2 hidden"></span> </button>
        </div>
        <div class="mt-4 text-sm text-gray-600">
         <p><strong>Test Koneksi:</strong> Memverifikasi koneksi ke Google Sheets</p>
         <p><strong>Inisialisasi Data:</strong> Membuat data sample untuk testing sistem</p>
        </div>
       </div><!-- System Information -->
       <div class="bg-blue-50 border-l-4 border-blue-400 p-6 mt-6">
        <div class="flex">
         <div class="flex-shrink-0">
          <svg class="h-6 w-6 text-blue-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
         </div>
         <div class="ml-3">
          <h4 class="text-md font-medium text-blue-800">‚ÑπÔ∏è Informasi Sistem</h4>
          <div class="mt-2 text-sm text-blue-700">
           <ul class="list-disc list-inside space-y-1">
            <li>Sistem menggunakan Google Sheets sebagai database</li>
            <li>Data tersimpan secara real-time di cloud</li>
            <li>Akses data dapat dilakukan dari mana saja</li>
            <li>Backup otomatis oleh Google Drive</li>
           </ul>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div><!-- Modal for Add/Edit Data -->
  <div id="dataModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
   <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
    <div class="mt-3">
     <div class="flex justify-between items-center mb-4">
      <h3 id="modalTitle" class="text-lg font-medium text-gray-900">Tambah Data</h3><button id="closeModalBtn" class="text-gray-400 hover:text-gray-600">
       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
       </svg></button>
     </div>
     <form id="dataForm" class="space-y-4">
      <div id="formFields"></div>
      <div class="flex justify-end space-x-3 pt-4"><button type="button" id="cancelBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400"> Batal </button> <button type="submit" id="saveBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50"> <span id="saveBtnText">Simpan</span> <span id="saveBtnLoader" class="loading ml-2 hidden"></span> </button>
      </div>
     </form>
    </div>
   </div>
  </div><!-- Confirmation Modal -->
  <div id="confirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
   <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
    <div class="mt-3 text-center">
     <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
      <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16c-.77.833.192 2.5 1.732 2.5z"></path>
      </svg>
     </div>
     <h3 class="text-lg font-medium text-gray-900 mb-2">Konfirmasi Hapus</h3>
     <p id="confirmMessage" class="text-sm text-gray-500 mb-4">Apakah Anda yakin ingin menghapus data ini?</p>
     <div class="flex justify-center space-x-3"><button id="confirmCancelBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400"> Batal </button> <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 disabled:opacity-50"> <span id="deleteBtnText">Hapus</span> <span id="deleteBtnLoader" class="loading ml-2 hidden"></span> </button>
     </div>
    </div>
   </div>
  </div>
  <script>
        // Global variables
        let currentUser = null;
        let appsScriptConfig = {
            webAppUrl: 'https://script.google.com/macros/s/AKfycbyXvanZbuN56w9EQC7wBLb2-n3PCHEv6GSVBLXSuNwdf6MOv3DNpzOUgZdmLRUOaeXj/exec'
        };
        let allData = {
            users: [],
            siswa: [],
            guru: [],
            jadwal: [],
            absensi: []
        };
        let currentAbsensiData = [];

        // Date conversion functions for Indonesian format (DD/MM/YYYY)
        function convertToIndonesianDateFormat(dateStr) {
            // Convert YYYY-MM-DD to DD/MM/YYYY (Indonesian format)
            if (dateStr && dateStr.includes('-')) {
                const parts = dateStr.split('-');
                if (parts.length === 3) {
                    return `${parts[2].padStart(2, '0')}/${parts[1].padStart(2, '0')}/${parts[0]}`;
                }
            }
            return dateStr;
        }

        function convertFromIndonesianDateFormat(dateStr) {
            // Convert DD/MM/YYYY to YYYY-MM-DD for internal processing
            if (dateStr && dateStr.includes('/')) {
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    // Check if it's DD/MM/YYYY format (Indonesian format)
                    if (parts[0].length <= 2 && parts[1].length <= 2 && parts[2].length === 4) {
                        return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                    }
                }
            }
            return dateStr;
        }

        // üöÄ FIXED DATE CONVERSION SYSTEM - Prioritas format Indonesia DD/MM/YYYY
        function convertFromGoogleSheetsDateFormat(dateStr) {
            if (!dateStr) return dateStr;
            
            console.log('üîç FIXED Converting date from Google Sheets:', dateStr);
            
            // PATTERN 1: Standard DD/MM/YYYY format (PRIORITAS UTAMA - Format Indonesia)
            if (dateStr.includes('/') && !dateStr.includes('T')) {
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    // SELALU anggap DD/MM/YYYY (format Indonesia)
                    if (parts[0].length <= 2 && parts[1].length <= 2 && parts[2].length === 4) {
                        const day = parts[0].padStart(2, '0');
                        const month = parts[1].padStart(2, '0');
                        const year = parts[2];
                        
                        // Validasi range tanggal dan bulan
                        const dayNum = parseInt(day);
                        const monthNum = parseInt(month);
                        
                        if (dayNum >= 1 && dayNum <= 31 && monthNum >= 1 && monthNum <= 12) {
                            const converted = `${year}-${month}-${day}`;
                            console.log('‚úÖ PATTERN 1 - DD/MM/YYYY (Indonesia):', dateStr, '‚Üí', converted);
                            return converted;
                        }
                    }
                }
            }
            
            // PATTERN 2: Malformed ISO with slash (29T17:00:00.000Z/10/2025)
            if (dateStr.includes('T') && dateStr.includes('Z') && dateStr.includes('/')) {
                const match = dateStr.match(/(\d{1,2})T.*?\/(\d{1,2})\/(\d{4})/);
                if (match) {
                    const day = match[1].padStart(2, '0');
                    const month = match[2].padStart(2, '0');
                    const year = match[3];
                    const converted = `${year}-${month}-${day}`;
                    console.log('‚úÖ PATTERN 2 - Malformed ISO:', dateStr, '‚Üí', converted);
                    return converted;
                }
            }
            
            // PATTERN 3: T format with slash (29T.../10/2025)
            if (dateStr.includes('T') && dateStr.includes('/')) {
                const match = dateStr.match(/(\d{1,2})T[^\/]*\/(\d{1,2})\/(\d{4})/);
                if (match) {
                    const day = match[1].padStart(2, '0');
                    const month = match[2].padStart(2, '0');
                    const year = match[3];
                    const converted = `${year}-${month}-${day}`;
                    console.log('‚úÖ PATTERN 3 - T format:', dateStr, '‚Üí', converted);
                    return converted;
                }
            }
            
            // PATTERN 4: Google Sheets serial numbers
            if (!dateStr.includes('-') && !dateStr.includes('/') && !dateStr.includes('T')) {
                const dateNum = parseFloat(dateStr);
                if (!isNaN(dateNum) && dateNum > 40000 && dateNum < 100000) {
                    // Excel/Google Sheets epoch starts at 1900-01-01, but with 1900 leap year bug
                    const excelEpoch = new Date(1899, 11, 30); // December 30, 1899
                    const resultDate = new Date(excelEpoch.getTime() + (dateNum * 24 * 60 * 60 * 1000));
                    const converted = resultDate.toLocaleDateString('en-CA', { timeZone: 'Asia/Jakarta' });
                    console.log('‚úÖ PATTERN 4 - Serial number:', dateStr, '‚Üí', converted);
                    return converted;
                }
            }
            
            // PATTERN 5: Standard ISO with time (2025-10-29T17:00:00.000Z)
            if (dateStr.includes('T') && !dateStr.includes('/')) {
                const converted = dateStr.split('T')[0];
                console.log('‚úÖ PATTERN 5 - ISO with time:', dateStr, '‚Üí', converted);
                return converted;
            }
            
            // PATTERN 6: YYYY-MM-DD format (sudah benar)
            if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                console.log('‚úÖ PATTERN 6 - Already YYYY-MM-DD:', dateStr);
                return dateStr;
            }
            
            // PATTERN 7: BRUTE FORCE - Extract numbers dengan prioritas DD/MM/YYYY
            if (dateStr.match(/\d/)) {
                const numbers = dateStr.match(/\d+/g);
                if (numbers && numbers.length >= 3) {
                    // Find year (4 digits, 2020-2030 range)
                    const year = numbers.find(n => n.length === 4 && parseInt(n) >= 2020 && parseInt(n) <= 2030);
                    if (year) {
                        const otherNumbers = numbers.filter(n => n !== year);
                        if (otherNumbers.length >= 2) {
                            // PRIORITAS: Anggap format DD/MM (Indonesia)
                            const day = otherNumbers[0].padStart(2, '0');
                            const month = otherNumbers[1].padStart(2, '0');
                            
                            // Validate day and month ranges
                            const dayNum = parseInt(day);
                            const monthNum = parseInt(month);
                            
                            if (dayNum >= 1 && dayNum <= 31 && monthNum >= 1 && monthNum <= 12) {
                                const converted = `${year}-${month}-${day}`;
                                console.log('‚úÖ PATTERN 7 - Brute force DD/MM:', dateStr, '‚Üí', converted);
                                return converted;
                            }
                        }
                    }
                }
            }
            
            console.log('‚ö†Ô∏è ALL PATTERNS FAILED - Date format not recognized:', dateStr);
            
            // Show toast notification for problematic dates
            if (typeof showToast === 'function') {
                showToast(`‚ö†Ô∏è Format tanggal bermasalah: ${dateStr}`, 'error');
            }
            
            return dateStr;
        }

        // Format date for display in Indonesian format
        function formatDateForDisplay(dateStr) {
            if (!dateStr) return '-';
            
            // If it's YYYY-MM-DD format, convert to DD/MM/YYYY
            if (dateStr.includes('-')) {
                return convertToIndonesianDateFormat(dateStr);
            }
            
            // If it's already DD/MM/YYYY, return as is
            return dateStr;
        }

        // Get today's date in Indonesian format (DD/MM/YYYY)
        function getTodayIndonesianFormat() {
            const today = new Date();
            const day = today.getDate().toString().padStart(2, '0');
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const year = today.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Session management functions
        function saveUserSession(user) {
            sessionStorage.setItem('currentUser', JSON.stringify(user));
            sessionStorage.setItem('loginTime', new Date().getTime().toString());
        }

        function loadUserSession() {
            const userStr = sessionStorage.getItem('currentUser');
            const loginTime = sessionStorage.getItem('loginTime');
            
            if (userStr && loginTime) {
                // Check if session is still valid (24 hours)
                const now = new Date().getTime();
                const sessionAge = now - parseInt(loginTime);
                const maxAge = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
                
                if (sessionAge < maxAge) {
                    return JSON.parse(userStr);
                } else {
                    // Session expired, clear it
                    clearUserSession();
                }
            }
            return null;
        }

        function clearUserSession() {
            sessionStorage.removeItem('currentUser');
            sessionStorage.removeItem('loginTime');
        }

        // Default configuration
        const defaultConfig = {
            school_name: "SMP Purnawarman",
            app_title: "Absensi Online",
            web_app_url: "https://script.google.com/macros/s/AKfycbyXvanZbuN56w9EQC7wBLb2-n3PCHEv6GSVBLXSuNwdf6MOv3DNpzOUgZdmLRUOaeXj/exec"
        };

        // Initialize app
        async function initializeApp() {
            console.log('Starting app initialization...');
            
            setupEventListeners();
            setTodayDate();
            
            // Check for existing session
            const savedUser = loadUserSession();
            if (savedUser) {
                console.log('Found existing session for user:', savedUser.nama);
                currentUser = savedUser;
                showDashboard();
                showToast(`Selamat datang kembali, ${savedUser.nama}!`, 'success');
            } else {
                // Show login screen if no valid session
                showLoginScreen();
            }
            
            // Initialize ElementSdk
            if (window.elementSdk) {
                try {
                    await window.elementSdk.init({
                        defaultConfig,
                        onConfigChange: async (config) => {
                            const schoolNameEl = document.getElementById('schoolName');
                            const appTitleEl = document.getElementById('appTitle');
                            if (schoolNameEl) schoolNameEl.textContent = config.school_name || defaultConfig.school_name;
                            if (appTitleEl) appTitleEl.textContent = config.app_title || defaultConfig.app_title;
                            
                            // Update apps script config if provided
                            if (config.web_app_url) {
                                appsScriptConfig.webAppUrl = config.web_app_url;
                                // Update both setup forms
                                const webAppUrlEl = document.getElementById('webAppUrl');
                                const webAppUrlAdminEl = document.getElementById('webAppUrlAdmin');
                                if (webAppUrlEl) webAppUrlEl.value = config.web_app_url;
                                if (webAppUrlAdminEl) webAppUrlAdminEl.value = config.web_app_url;
                            }
                        },
                        mapToCapabilities: (config) => ({
                            recolorables: [],
                            borderables: [],
                            fontEditable: undefined,
                            fontSizeable: undefined
                        }),
                        mapToEditPanelValues: (config) => new Map([
                            ["school_name", config.school_name || defaultConfig.school_name],
                            ["app_title", config.app_title || defaultConfig.app_title],
                            ["web_app_url", config.web_app_url || defaultConfig.web_app_url]
                        ])
                    });
                } catch (error) {
                    console.log('ElementSdk not available');
                }
            }
            
            console.log('App initialization completed');
        }

        // Show login screen
        function showLoginScreen() {
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
        }

        // Google Apps Script API functions
        class AppsScriptAPI {
            constructor(webAppUrl) {
                this.webAppUrl = webAppUrl;
            }

            async testConnection() {
                try {
                    const response = await fetch(`${this.webAppUrl}?action=test`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    return data;
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }

            async getData(sheetName) {
                try {
                    const response = await fetch(`${this.webAppUrl}?action=getData&sheet=${sheetName}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    return result;
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }

            async initializeData() {
                try {
                    const response = await fetch(`${this.webAppUrl}?action=initialize`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    return result;
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }

            async saveData(sheetName, rowData) {
                try {
                    const formData = new FormData();
                    formData.append('action', 'saveData');
                    formData.append('sheet', sheetName);
                    formData.append('data', JSON.stringify(rowData));

                    const response = await fetch(this.webAppUrl, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    return result;
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }

            async updateData(sheetName, rowData, rowIndex) {
                try {
                    const formData = new FormData();
                    formData.append('action', 'updateData');
                    formData.append('sheet', sheetName);
                    formData.append('data', JSON.stringify(rowData));
                    formData.append('rowIndex', rowIndex.toString());

                    console.log('Sending update request:', {
                        action: 'updateData',
                        sheet: sheetName,
                        data: rowData,
                        rowIndex: rowIndex,
                        url: this.webAppUrl
                    });

                    const response = await fetch(this.webAppUrl, {
                        method: 'POST',
                        body: formData
                    });
                    
                    console.log('Response status:', response.status);
                    console.log('Response headers:', response.headers);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Response error text:', errorText);
                        throw new Error(`HTTP error! status: ${response.status}, text: ${errorText}`);
                    }
                    
                    const responseText = await response.text();
                    console.log('Raw response text:', responseText);
                    
                    const result = JSON.parse(responseText);
                    console.log('Update response:', result);
                    return result;
                } catch (error) {
                    console.error('Update error:', error);
                    return { success: false, error: error.message };
                }
            }

            async deleteData(sheetName, rowIndex) {
                try {
                    const formData = new FormData();
                    formData.append('action', 'deleteData');
                    formData.append('sheet', sheetName);
                    formData.append('rowIndex', rowIndex);

                    const response = await fetch(this.webAppUrl, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    return result;
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }

            async saveAbsensi(absensiData) {
                try {
                    const formData = new FormData();
                    formData.append('action', 'saveAbsensi');
                    formData.append('data', JSON.stringify(absensiData));

                    const response = await fetch(this.webAppUrl, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    return result;
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Setup form
            document.getElementById('setupForm').addEventListener('submit', testConnection);
            document.getElementById('initializeDataBtn').addEventListener('click', initializeSampleData);
            document.getElementById('proceedToAppBtn').addEventListener('click', proceedToApp);
            document.getElementById('copyCodeBtn').addEventListener('click', copyAppsScriptCode);
            document.getElementById('copyCodeBtn2').addEventListener('click', copyAppsScriptCode);

            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('togglePassword').addEventListener('click', togglePasswordVisibility);

            // Tab navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => switchTab(e.target.id));
            });

            // Data Master tab navigation
            document.querySelectorAll('.data-tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => switchDataTab(e.target.id));
            });

            // Absensi sub-tab navigation
            document.querySelectorAll('.absensi-tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => switchAbsensiTab(e.target.id));
            });

            // Modal event listeners
            document.getElementById('closeModalBtn').addEventListener('click', closeModal);
            document.getElementById('cancelBtn').addEventListener('click', closeModal);
            document.getElementById('dataForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('confirmCancelBtn').addEventListener('click', closeConfirmModal);
            document.getElementById('confirmDeleteBtn').addEventListener('click', handleConfirmDelete);

            // Add buttons
            document.getElementById('addUserBtn').addEventListener('click', () => openAddModal('Users'));
            document.getElementById('addSiswaBtn').addEventListener('click', () => openAddModal('Siswa'));
            document.getElementById('addGuruBtn').addEventListener('click', () => openAddModal('Guru'));
            document.getElementById('addJadwalBtn').addEventListener('click', () => openAddModal('Jadwal'));

            // Refresh buttons for data master
            document.getElementById('refreshUsersBtn').addEventListener('click', loadUsersData);
            document.getElementById('refreshSiswaDataBtn').addEventListener('click', loadSiswaDataTable);
            document.getElementById('refreshGuruDataBtn').addEventListener('click', loadGuruDataTable);
            document.getElementById('refreshJadwalDataBtn').addEventListener('click', loadJadwalDataTable);

            // Absensi form
            document.getElementById('jenisAbsensi').addEventListener('change', handleJenisAbsensiChange);
            document.getElementById('muatDataBtn').addEventListener('click', loadAbsensiData);
            document.getElementById('simpanAbsensiBtn').addEventListener('click', saveAbsensi);
            document.getElementById('viewTodayAttendanceBtn').addEventListener('click', viewTodayAttendance);

            // Laporan form
            document.getElementById('jenisLaporan').addEventListener('change', handleJenisLaporanChange);
            document.getElementById('tarikDataBtn').addEventListener('click', loadLaporanData);
            document.getElementById('cetakPDFBtn').addEventListener('click', cetakPDF);
            document.getElementById('cetakExcelBtn').addEventListener('click', cetakExcel);


            

            
            // Report type radio buttons
            document.querySelectorAll('input[name="tipeLaporan"]').forEach(radio => {
                radio.addEventListener('change', handleTipeLaporanChange);
            });

            // Refresh buttons
            document.getElementById('refreshJadwalBtn').addEventListener('click', loadJadwalData);
            document.getElementById('refreshStatistikBtn').addEventListener('click', refreshStatistikManual);

            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Setup admin form
            document.getElementById('testConnectionBtnAdmin').addEventListener('click', testConnectionAdmin);
            document.getElementById('initializeDataBtnAdmin').addEventListener('click', initializeSampleDataAdmin);
        }

        // Get today's date in Indonesia timezone (YYYY-MM-DD format)
        function getTodayDate() {
            return new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Jakarta' });
        }

        // Get yesterday's date in Indonesia timezone (YYYY-MM-DD format)
        function getYesterdayDate() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            return yesterday.toLocaleDateString('en-CA', { timeZone: 'Asia/Jakarta' });
        }

        // Get display date for statistics (yesterday's date)
        function getStatisticsDisplayDate() {
            return getYesterdayDate();
        }

        // Set today's date and start real-time clock
        function setTodayDate() {
            // Get today's date for absensi input (current date)
            const today = getTodayDate();
            // Get yesterday's date for statistics (previous day)
            const yesterday = getYesterdayDate();
            
            console.log('Setting today date to:', today);
            console.log('Setting statistics date to:', yesterday);
            
            // Absensi input uses today's date
            document.getElementById('tanggalAbsensi').value = today;
            
            // Reports use today's date by default
            document.getElementById('dariTanggal').value = today;
            document.getElementById('sampaiTanggal').value = today;
            
            // Statistics use yesterday's date by default
            document.getElementById('statistikTanggal').value = yesterday;
            
            // Start real-time clock
            updateDateTime();
            setInterval(updateDateTime, 1000); // Update every second
        }

        // Update real-time date and time display
        function updateDateTime() {
            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'Asia/Jakarta'
            };
            
            const dateTimeString = now.toLocaleDateString('id-ID', options);
            const dateTimeElement = document.getElementById('currentDateTime');
            if (dateTimeElement) {
                dateTimeElement.textContent = dateTimeString;
            }
        }

        // Optimized function to load only master data (siswa, guru, users, jadwal)
        async function loadMasterDataOnly() {
            try {
                const appsScript = new AppsScriptAPI(appsScriptConfig.webAppUrl);
                
                console.log('Loading master data only...');
                
                // Load Users
                const usersResult = await appsScript.getData('Users');
                if (usersResult.success && usersResult.data && usersResult.data.length > 1) {
                    const headers = usersResult.data[0];
                    allData.users = usersResult.data.slice(1).filter(row => row.some(cell => cell && cell.toString().trim())).map(row => {
                        const user = {};
                        headers.forEach((header, index) => {
                            user[header.toLowerCase().replace(' ', '_')] = row[index] || '';
                        });
                        return user;
                    });
                }

                // Load Siswa
                const siswaResult = await appsScript.getData('Siswa');
                if (siswaResult.success && siswaResult.data && siswaResult.data.length > 1) {
                    const headers = siswaResult.data[0];
                    allData.siswa = siswaResult.data.slice(1).filter(row => row.some(cell => cell && cell.toString().trim())).map(row => {
                        const siswa = {};
                        headers.forEach((header, index) => {
                            const key = header.toLowerCase() === 'nis' ? 'nis' : 
                                       header.toLowerCase() === 'nama' ? 'nama' :
                                       header.toLowerCase() === 'kelas' ? 'kelas' :
                                       header.toLowerCase() === 'jk' ? 'jenis_kelamin' :
                                       header.toLowerCase() === 'alamat' ? 'alamat' : header.toLowerCase();
                            siswa[key] = row[index] || '';
                        });
                        return siswa;
                    });
                }

                // Load Guru
                const guruResult = await appsScript.getData('Guru');
                if (guruResult.success && guruResult.data && guruResult.data.length > 1) {
                    const headers = guruResult.data[0];
                    allData.guru = guruResult.data.slice(1).filter(row => row.some(cell => cell && cell.toString().trim())).map(row => {
                        const guru = {};
                        headers.forEach((header, index) => {
                            const key = header.toLowerCase() === 'nuptk' ? 'nip' : 
                                       header.toLowerCase() === 'nama' ? 'nama' :
                                       header.toLowerCase() === 'mapel' ? 'mata_pelajaran' :
                                       header.toLowerCase() === 'jk' ? 'jenis_kelamin' :
                                       header.toLowerCase() === 'alamat' ? 'alamat' : header.toLowerCase();
                            guru[key] = row[index] || '';
                        });
                        return guru;
                    });
                }

                // Load Jadwal
                const jadwalResult = await appsScript.getData('Jadwal');
                if (jadwalResult.success && jadwalResult.data && jadwalResult.data.length > 1) {
                    const headers = jadwalResult.data[0];
                    allData.jadwal = jadwalResult.data.slice(1).filter(row => row.some(cell => cell && cell.toString().trim())).map(row => {
                        const jadwal = {};
                        headers.forEach((header, index) => {
                            const key = header.toLowerCase().replace(' ', '_');
                            jadwal[key] = row[index] || '';
                        });
                        return jadwal;
                    });
                }

                console.log('Master data loaded - Siswa:', allData.siswa.length, 'Guru:', allData.guru.length);
                populateKelasOptions();
                
            } catch (error) {
                console.error('Error loading master data:', error);
                throw error;
            }
        }

        // Optimized function to load only today's absensi data
        async function loadTodayAbsensiData() {
            try {
                const appsScript = new AppsScriptAPI(appsScriptConfig.webAppUrl);
                const today = getTodayDate();
                
                console.log('Loading today absensi data for:', today);
                
                // Load Absensi
                const absensiResult = await appsScript.getData('Absensi');
                if (absensiResult.success && absensiResult.data && absensiResult.data.length > 1) {
                    const headers = absensiResult.data[0];
                    const allAbsensi = absensiResult.data.slice(1).filter(row => row.some(cell => cell && cell.toString().trim())).map(row => {
                        const absensi = {};
                        headers.forEach((header, index) => {
                            const key = header.toLowerCase().replace('/', '_').replace(' ', '_');
                            absensi[key] = row[index] || '';
                        });
                        return absensi;
                    });
                    
                    // Filter only today's data with comprehensive date matching
                    allData.absensi = allAbsensi.filter(a => {
                        let absensiDateStr = a.tanggal;
                        
                        // Handle DD/MM/YYYY format from Google Sheets (our standard format)
                        if (absensiDateStr && absensiDateStr.includes('/')) {
                            absensiDateStr = convertFromGoogleSheetsDateFormat(absensiDateStr);
                        }
                        
                        // Handle Google Sheets date serial numbers
                        if (absensiDateStr && !absensiDateStr.includes('-') && !absensiDateStr.includes('/')) {
                            const dateNum = parseFloat(absensiDateStr);
                            if (!isNaN(dateNum) && dateNum > 40000) {
                                const excelDate = new Date((dateNum - 25569) * 86400 * 1000);
                                absensiDateStr = excelDate.toLocaleDateString('en-CA', { timeZone: 'Asia/Jakarta' });
                            }
                        }
                        
                        // Handle ISO date strings that might have time component
                        if (absensiDateStr && absensiDateStr.includes('T')) {
                            absensiDateStr = absensiDateStr.split('T')[0];
                        }
                        
                        return absensiDateStr === yesterday;
                    });
                    
                    console.log('Today absensi records loaded:', allData.absensi.length);
                } else {
                    allData.absensi = [];
                }
                
            } catch (error) {
                console.error('Error loading today absensi data:', error);
                throw error;
            }
        }

        // Show admin confirmation dialog (inline, not browser dialog)
        function showAdminConfirmation(title, message) {
            return new Promise((resolve) => {
                // Create modal overlay
                const overlay = document.createElement('div');
                overlay.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
                
                // Create modal content
                overlay.innerHTML = `
                    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                        <div class="mt-3">
                            <div class="flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mx-auto mb-4">
                                <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 text-center mb-2">${title}</h3>
                            <p class="text-sm text-gray-500 text-center mb-4">${message}</p>
                            <div class="flex justify-center space-x-3">
                                <button id="adminConfirmCancel" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors">
                                    Batal
                                </button>
                                <button id="adminConfirmOk" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                                    Ya, Lanjutkan
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add to body
                document.body.appendChild(overlay);
                
                // Add event listeners
                document.getElementById('adminConfirmCancel').addEventListener('click', () => {
                    document.body.removeChild(overlay);
                    resolve(false);
                });
                
                document.getElementById('adminConfirmOk').addEventListener('click', () => {
                    document.body.removeChild(overlay);
                    resolve(true);
                });
                
                // Close on overlay click
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        document.body.removeChild(overlay);
                        resolve(false);
                    }
                });
            });
        }

        // Show absensi edit confirmation dialog (inline, not browser dialog)
        function showAbsensiEditConfirmation(title, message, details) {
            return new Promise((resolve) => {
                // Create modal overlay
                const overlay = document.createElement('div');
                overlay.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
                
                // Create modal content
                overlay.innerHTML = `
                    <div class="relative top-20 mx-auto p-6 border w-[480px] shadow-lg rounded-md bg-white">
                        <div class="mt-3">
                            <div class="flex items-center justify-center h-12 w-12 rounded-full bg-orange-100 mx-auto mb-4">
                                <svg class="h-6 w-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 text-center mb-3">${title}</h3>
                            <p class="text-sm text-gray-600 text-center mb-3">${message}</p>
                            <div class="bg-yellow-50 border border-yellow-200 rounded-md p-3 mb-4">
                                <div class="flex items-start">
                                    <svg class="w-5 h-5 text-yellow-400 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                    <p class="text-xs text-yellow-800">${details}</p>
                                </div>
                            </div>
                            <div class="flex justify-center space-x-3">
                                <button id="absensiEditCancel" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors">
                                    ‚ùå Batal
                                </button>
                                <button id="absensiEditConfirm" class="px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700 transition-colors">
                                    ‚úèÔ∏è Ya, Ubah Absensi
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add to body
                document.body.appendChild(overlay);
                
                // Add event listeners
                document.getElementById('absensiEditCancel').addEventListener('click', () => {
                    document.body.removeChild(overlay);
                    resolve(false);
                });
                
                document.getElementById('absensiEditConfirm').addEventListener('click', () => {
                    document.body.removeChild(overlay);
                    resolve(true);
                });
                
                // Close on overlay click
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        document.body.removeChild(overlay);
                        resolve(false);
                    }
                });
            });
        }

        // Show absensi blocked dialog (one-time daily limit enforcement)
        function showAbsensiBlockedDialog(title, message, details) {
            return new Promise((resolve) => {
                // Create modal overlay
                const overlay = document.createElement('div');
                overlay.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
                
                // Create modal content
                overlay.innerHTML = `
                    <div class="relative top-20 mx-auto p-6 border w-[520px] shadow-lg rounded-md bg-white">
                        <div class="mt-3">
                            <div class="flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mx-auto mb-4">
                                <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L18.364 5.636M5.636 18.364l12.728-12.728"></path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 text-center mb-3">${title}</h3>
                            <p class="text-sm text-gray-600 text-center mb-3">${message}</p>
                            <div class="bg-red-50 border border-red-200 rounded-md p-4 mb-4">
                                <div class="flex items-start">
                                    <svg class="w-5 h-5 text-red-400 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                    </svg>
                                    <div>
                                        <h4 class="text-sm font-medium text-red-800 mb-1">üö´ KEBIJAKAN SATU KALI ABSENSI</h4>
                                        <p class="text-xs text-red-700">${details}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-blue-50 border border-blue-200 rounded-md p-3 mb-4">
                                <div class="flex items-start">
                                    <svg class="w-5 h-5 text-blue-400 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                    </svg>
                                    <div>
                                        <h4 class="text-sm font-medium text-blue-800 mb-1">üìä Alternatif Aksi</h4>
                                        <p class="text-xs text-blue-700">‚Ä¢ Gunakan menu "Laporan" untuk melihat data absensi hari ini<br>‚Ä¢ Gunakan menu "Rekap Kehadiran" untuk analisis kehadiran<br>‚Ä¢ Hubungi admin jika ada kesalahan data yang perlu diperbaiki</p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-center space-x-3">
                                <button id="absensiBlockedOk" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                                    ‚úÖ Mengerti
                                </button>
                                <button id="absensiBlockedViewReport" class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
                                    üìä Lihat Laporan
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add to body
                document.body.appendChild(overlay);
                
                // Add event listeners
                document.getElementById('absensiBlockedOk').addEventListener('click', () => {
                    document.body.removeChild(overlay);
                    resolve('ok');
                });
                
                document.getElementById('absensiBlockedViewReport').addEventListener('click', () => {
                    document.body.removeChild(overlay);
                    // Switch to absensi tab and then to laporan sub-tab
                    switchTab('tabAbsensi');
                    switchAbsensiTab('tabLaporanAbsensi');
                    resolve('report');
                });
                
                // Close on overlay click
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        document.body.removeChild(overlay);
                        resolve('ok');
                    }
                });
            });
        }

        // Show absensi update confirmation dialog for existing data (DEPRECATED - no longer used due to one-time limit)
        function showAbsensiUpdateConfirmation(title, message, details) {
            return new Promise((resolve) => {
                // Create modal overlay
                const overlay = document.createElement('div');
                overlay.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
                
                // Create modal content
                overlay.innerHTML = `
                    <div class="relative top-20 mx-auto p-6 border w-[520px] shadow-lg rounded-md bg-white">
                        <div class="mt-3">
                            <div class="flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mx-auto mb-4">
                                <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 text-center mb-3">${title}</h3>
                            <p class="text-sm text-gray-600 text-center mb-3">${message}</p>
                            <div class="bg-red-50 border border-red-200 rounded-md p-4 mb-4">
                                <div class="flex items-start">
                                    <svg class="w-5 h-5 text-red-400 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                    </svg>
                                    <div>
                                        <h4 class="text-sm font-medium text-red-800 mb-1">‚ö†Ô∏è PERINGATAN: Data Akan Ditimpa</h4>
                                        <p class="text-xs text-red-700">${details}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-blue-50 border border-blue-200 rounded-md p-3 mb-4">
                                <div class="flex items-start">
                                    <svg class="w-5 h-5 text-blue-400 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                    </svg>
                                    <div>
                                        <h4 class="text-sm font-medium text-blue-800 mb-1">üí° Alternatif</h4>
                                        <p class="text-xs text-blue-700">Jika Anda hanya ingin melihat data yang sudah ada, gunakan menu "Laporan" untuk melihat data absensi tanpa mengubahnya.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-center space-x-3">
                                <button id="absensiUpdateCancel" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors">
                                    ‚ùå Batal
                                </button>
                                <button id="absensiUpdateConfirm" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors">
                                    üîÑ Ya, Perbarui Data
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add to body
                document.body.appendChild(overlay);
                
                // Add event listeners
                document.getElementById('absensiUpdateCancel').addEventListener('click', () => {
                    document.body.removeChild(overlay);
                    resolve(false);
                });
                
                document.getElementById('absensiUpdateConfirm').addEventListener('click', () => {
                    document.body.removeChild(overlay);
                    resolve(true);
                });
                
                // Close on overlay click
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        document.body.removeChild(overlay);
                        resolve(false);
                    }
                });
            });
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast fade-in px-4 py-2 rounded-md text-white ${
                type === 'error' ? 'bg-red-500' : 
                type === 'success' ? 'bg-green-500' : 
                'bg-blue-500'
            }`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Test Apps Script connection
        async function testConnection(e) {
            e.preventDefault();
            
            const webAppUrl = document.getElementById('webAppUrl').value;
            
            if (!webAppUrl) {
                showToast('Harap isi Web App URL', 'error');
                return;
            }

            const testBtn = document.getElementById('testConnectionBtn');
            const testText = document.getElementById('testConnectionText');
            const testLoader = document.getElementById('testConnectionLoader');

            // Show loading
            testBtn.disabled = true;
            testText.textContent = 'Testing...';
            testLoader.classList.remove('hidden');

            try {
                const appsScript = new AppsScriptAPI(webAppUrl);
                const result = await appsScript.testConnection();
                
                if (result.success) {
                    appsScriptConfig.webAppUrl = webAppUrl;
                    
                    // Update config via ElementSdk
                    if (window.elementSdk) {
                        await window.elementSdk.setConfig({
                            web_app_url: webAppUrl
                        });
                    }
                    
                    document.getElementById('connectionStatus').classList.remove('hidden');
                    document.getElementById('initializeDataBtn').classList.remove('hidden');
                    showToast('Koneksi berhasil!', 'success');
                    
                    // Load existing data
                    await loadAllData();
                } else {
                    showToast(`Koneksi gagal: ${result.error}`, 'error');
                }
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                // Hide loading
                testBtn.disabled = false;
                testText.textContent = 'Test Koneksi';
                testLoader.classList.add('hidden');
            }
        }

        // Copy Apps Script code to clipboard
        function copyAppsScriptCode() {
            const codeElement = document.getElementById('appsScriptCode');
            const code = codeElement.textContent;
            
            navigator.clipboard.writeText(code).then(() => {
                showToast('Kode berhasil disalin!', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = code;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('Kode berhasil disalin!', 'success');
            });
        }

        // Initialize sample data via Apps Script
        async function initializeSampleData() {
            const initBtn = document.getElementById('initializeDataBtn');
            const initText = document.getElementById('initializeDataText');
            const initLoader = document.getElementById('initializeDataLoader');

            // Show loading
            initBtn.disabled = true;
            initText.textContent = 'Menginisialisasi...';
            initLoader.classList.remove('hidden');

            try {
                const appsScript = new AppsScriptAPI(appsScriptConfig.webAppUrl);
                const result = await appsScript.initializeData();
                
                if (result.success) {
                    showToast('Data sample berhasil diinisialisasi!', 'success');
                    
                    // Load the initialized data
                    await loadAllData();
                } else {
                    showToast(`Error inisialisasi: ${result.error}`, 'error');
                }
                
            } catch (error) {
                showToast(`Error inisialisasi: ${error.message}`, 'error');
            } finally {
                // Hide loading
                initBtn.disabled = false;
                initText.textContent = 'Inisialisasi Data Sample';
                initLoader.classList.add('hidden');
            }
        }

        // Load all data from Apps Script
        async function loadAllData() {
            try {
                const appsScript = new AppsScriptAPI(appsScriptConfig.webAppUrl);
                
                console.log('Loading all data from Apps Script...');
                
                // Load Users
                const usersResult = await appsScript.getData('Users');
                console.log('Users result:', usersResult);
                if (usersResult.success && usersResult.data && usersResult.data.length > 1) {
                    const headers = usersResult.data[0];
                    allData.users = usersResult.data.slice(1).filter(row => row.some(cell => cell && cell.toString().trim())).map(row => {
                        const user = {};
                        headers.forEach((header, index) => {
                            user[header.toLowerCase().replace(' ', '_')] = row[index] || '';
                        });
                        return user;
                    });
                } else {
                    allData.users = [];
                }

                // Load Siswa
                const siswaResult = await appsScript.getData('Siswa');
                console.log('Siswa result:', siswaResult);
                if (siswaResult.success && siswaResult.data && siswaResult.data.length > 1) {
                    const headers = siswaResult.data[0];
                    allData.siswa = siswaResult.data.slice(1).filter(row => row.some(cell => cell && cell.toString().trim())).map(row => {
                        const siswa = {};
                        headers.forEach((header, index) => {
                            const key = header.toLowerCase() === 'nis' ? 'nis' : 
                                       header.toLowerCase() === 'nama' ? 'nama' :
                                       header.toLowerCase() === 'kelas' ? 'kelas' :
                                       header.toLowerCase() === 'jk' ? 'jenis_kelamin' :
                                       header.toLowerCase() === 'alamat' ? 'alamat' : header.toLowerCase();
                            siswa[key] = row[index] || '';
                        });
                        return siswa;
                    });
                } else {
                    allData.siswa = [];
                }

                // Load Guru
                const guruResult = await appsScript.getData('Guru');
                console.log('Guru result:', guruResult);
                if (guruResult.success && guruResult.data && guruResult.data.length > 1) {
                    const headers = guruResult.data[0];
                    allData.guru = guruResult.data.slice(1).filter(row => row.some(cell => cell && cell.toString().trim())).map(row => {
                        const guru = {};
                        headers.forEach((header, index) => {
                            const key = header.toLowerCase() === 'nuptk' ? 'nip' : 
                                       header.toLowerCase() === 'nama' ? 'nama' :
                                       header.toLowerCase() === 'mapel' ? 'mata_pelajaran' :
                                       header.toLowerCase() === 'jk' ? 'jenis_kelamin' :
                                       header.toLowerCase() === 'alamat' ? 'alamat' : header.toLowerCase();
                            guru[key] = row[index] || '';
                        });
                        return guru;
                    });
                } else {
                    allData.guru = [];
                }

                // Load Jadwal
                const jadwalResult = await appsScript.getData('Jadwal');
                console.log('Jadwal result:', jadwalResult);
                if (jadwalResult.success && jadwalResult.data && jadwalResult.data.length > 1) {
                    const headers = jadwalResult.data[0];
                    allData.jadwal = jadwalResult.data.slice(1).filter(row => row.some(cell => cell && cell.toString().trim())).map(row => {
                        const jadwal = {};
                        headers.forEach((header, index) => {
                            const key = header.toLowerCase().replace(' ', '_');
                            jadwal[key] = row[index] || '';
                        });
                        return jadwal;
                    });
                } else {
                    allData.jadwal = [];
                }

                // Load Absensi
                const absensiResult = await appsScript.getData('Absensi');
                console.log('Absensi result:', absensiResult);
                if (absensiResult.success && absensiResult.data && absensiResult.data.length > 1) {
                    const headers = absensiResult.data[0];
                    allData.absensi = absensiResult.data.slice(1).filter(row => row.some(cell => cell && cell.toString().trim())).map(row => {
                        const absensi = {};
                        headers.forEach((header, index) => {
                            const key = header.toLowerCase().replace('/', '_').replace(' ', '_');
                            absensi[key] = row[index] || '';
                        });
                        return absensi;
                    });
                } else {
                    allData.absensi = [];
                }

                console.log('Final loaded data:', allData);
                console.log('Siswa count:', allData.siswa.length);
                console.log('Guru count:', allData.guru.length);
                console.log('Jadwal count:', allData.jadwal.length);

                // Update UI
                updateInfoCards();
                populateKelasOptions();

                console.log('All data loaded successfully');
                
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Error memuat data dari Apps Script: ' + error.message, 'error');
            }
        }

        // Proceed to app
        function proceedToApp() {
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        // Toggle password visibility
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password');
            const eyeIcon = document.getElementById('eyeIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
                `;
            } else {
                passwordInput.type = 'password';
                eyeIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                `;
            }
        }

        // Handle login
        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const loginBtnText = document.getElementById('loginBtnText');
            const loginLoader = document.getElementById('loginLoader');

            // Show loading
            loginBtn.disabled = true;
            loginBtnText.textContent = 'Memproses...';
            loginLoader.classList.remove('hidden');

            try {
                // Default users for login (when Google Sheets not configured yet)
                const defaultUsers = [
                    { username: 'admin', password: 'admin123', nama: 'Administrator', role: 'Admin', hari_piket: '' },
                    { username: 'kepsek', password: 'kepsek123', nama: 'Kepala Sekolah', role: 'Kepala Sekolah', hari_piket: '' },
                    { username: 'piket1', password: 'piket123', nama: 'Guru Piket Senin', role: 'Guru Piket', hari_piket: 'Senin' },
                    { username: 'piket2', password: 'piket123', nama: 'Guru Piket Selasa', role: 'Guru Piket', hari_piket: 'Selasa' }
                ];

                // Try to find user in loaded data first, fallback to default users
                let user = null;
                if (allData.users && allData.users.length > 0) {
                    user = allData.users.find(u => u.username === username && u.password === password);
                }
                
                // If not found in loaded data, check default users
                if (!user) {
                    user = defaultUsers.find(u => u.username === username && u.password === password);
                }
                
                if (!user) {
                    showToast('Username atau password salah!', 'error');
                    return;
                }

                currentUser = user;
                saveUserSession(user); // Save session
                showDashboard();
                showToast('Login berhasil!', 'success');

            } catch (error) {
                console.error('Login error:', error);
                showToast('Terjadi kesalahan saat login', 'error');
            } finally {
                // Hide loading
                loginBtn.disabled = false;
                loginBtnText.textContent = 'Masuk';
                loginLoader.classList.add('hidden');
            }
        }

        // Show dashboard
        async function showDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
            document.getElementById('userInfo').textContent = `${currentUser.nama} (${currentUser.role})`;
            
            // Initialize report type radio buttons after dashboard is shown
            setTimeout(() => {
                const radioButtons = document.querySelectorAll('input[name="tipeLaporan"]');
                console.log('üîß Found radio buttons:', radioButtons.length);
                if (radioButtons.length > 0) {
                    radioButtons.forEach(radio => {
                        radio.addEventListener('change', handleTipeLaporanChange);
                    });
                    console.log('‚úÖ Radio button event listeners attached successfully');
                } else {
                    console.log('‚ö†Ô∏è No radio buttons found, will retry...');
                    // Retry after laporan tab is accessed
                }
            }, 500);
            
            // Apps Script URL is now permanently configured
            
            // Initialize with default data if Google Sheets not configured
            if (!appsScriptConfig.webAppUrl) {
                initializeDefaultData();
                showToast('‚ö†Ô∏è Google Sheets belum dikonfigurasi. Menggunakan data default. Silakan setup di tab Setup.', 'info');
            }
            
            // Load initial data for dashboard
            try {
                if (appsScriptConfig.webAppUrl) {
                    // Auto refresh: Load ALL data from Google Sheets when login successful
                    showToast('üîÑ Memuat semua data dari Google Sheets...', 'info');
                    await loadAllData(); // Load complete fresh data from Google Sheets
                    await updateInfoCards(); // Update statistics with fresh data
                    showToast('‚úÖ Semua data berhasil dimuat!', 'success');
                } else {
                    // Use default data and update UI
                    await updateInfoCards();
                }
                
                // Auto refresh data master tables after login
                console.log('Auto refreshing data master tables...');
                renderUsersDataTable();
                renderSiswaDataTable();
                renderGuruDataTable();
                renderJadwalDataTable();
                
                // Check and display today's attendance status
                await checkTodayAttendanceStatus();
                
                // Start real-time statistics updates and enhanced auto-sync
                startRealtimeStatistics();
                startEnhancedAutoSync();
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showToast('‚ùå Gagal memuat data dashboard', 'error');
            }
        }

        // Initialize default data when Google Sheets not configured
        function initializeDefaultData() {
            // Default users
            allData.users = [
                { username: 'admin', password: 'admin123', nama: 'Administrator', role: 'Admin', hari_piket: '' },
                { username: 'kepsek', password: 'kepsek123', nama: 'Kepala Sekolah', role: 'Kepala Sekolah', hari_piket: '' },
                { username: 'piket1', password: 'piket123', nama: 'Guru Piket Senin', role: 'Guru Piket', hari_piket: 'Senin' },
                { username: 'piket2', password: 'piket123', nama: 'Guru Piket Selasa', role: 'Guru Piket', hari_piket: 'Selasa' }
            ];

            // Default siswa
            allData.siswa = [
                { nis: '2024001', nama: 'Ahmad Fauzi', kelas: '71', jenis_kelamin: 'L', alamat: 'Jl. Merdeka No. 1' },
                { nis: '2024002', nama: 'Siti Nurhaliza', kelas: '71', jenis_kelamin: 'P', alamat: 'Jl. Sudirman No. 2' },
                { nis: '2024003', nama: 'Budi Santoso', kelas: '72', jenis_kelamin: 'L', alamat: 'Jl. Thamrin No. 3' },
                { nis: '2024004', nama: 'Dewi Sartika', kelas: '81', jenis_kelamin: 'P', alamat: 'Jl. Diponegoro No. 4' },
                { nis: '2024005', nama: 'Rudi Hartono', kelas: '81', jenis_kelamin: 'L', alamat: 'Jl. Gatot Subroto No. 5' }
            ];

            // Default guru
            allData.guru = [
                { nip: '196501011990032001', nama: 'Dra. Siti Aminah', mata_pelajaran: 'Matematika', jenis_kelamin: 'P', alamat: 'Jl. Guru No. 1' },
                { nip: '197203151998021001', nama: 'Ahmad Wijaya, S.Pd', mata_pelajaran: 'Bahasa Indonesia', jenis_kelamin: 'L', alamat: 'Jl. Guru No. 2' },
                { nip: '196803121995121001', nama: 'Dr. Budi Setiawan', mata_pelajaran: 'IPA', jenis_kelamin: 'L', alamat: 'Jl. Guru No. 3' },
                { nip: '197505201998032002', nama: 'Sari Indah, S.Pd', mata_pelajaran: 'IPS', jenis_kelamin: 'P', alamat: 'Jl. Guru No. 4' }
            ];

            // Default jadwal
            allData.jadwal = [
                { hari: 'Senin', jam_mulai: '07:00', jam_selesai: '08:30', kelas: '71', nuptk: '196501011990032001', nama_guru: 'Dra. Siti Aminah', mapel: 'Matematika' },
                { hari: 'Senin', jam_mulai: '08:30', jam_selesai: '10:00', kelas: '71', nuptk: '197203151998021001', nama_guru: 'Ahmad Wijaya, S.Pd', mapel: 'Bahasa Indonesia' },
                { hari: 'Selasa', jam_mulai: '07:00', jam_selesai: '08:30', kelas: '81', nuptk: '196803121995121001', nama_guru: 'Dr. Budi Setiawan', mapel: 'IPA' },
                { hari: 'Rabu', jam_mulai: '09:00', jam_selesai: '10:30', kelas: '72', nuptk: '197505201998032002', nama_guru: 'Sari Indah, S.Pd', mapel: 'IPS' }
            ];

            // Default absensi (empty)
            allData.absensi = [];

            // Update kelas options
            populateKelasOptions();
        }

        // Switch tab
        function switchTab(tabId) {
            // Remove active class from all tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });

            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Show selected tab
            const selectedTab = document.getElementById(tabId);
            selectedTab.classList.add('active', 'border-blue-500', 'text-blue-600');
            selectedTab.classList.remove('border-transparent', 'text-gray-500');

            // Show corresponding content
            if (tabId === 'tabAbsensi') {
                document.getElementById('absensiContent').classList.remove('hidden');
            } else if (tabId === 'tabDataMaster') {
                document.getElementById('dataMasterContent').classList.remove('hidden');
            } else if (tabId === 'tabJadwal') {
                document.getElementById('jadwalContent').classList.remove('hidden');
            } else if (tabId === 'tabSetup') {
                document.getElementById('setupContent').classList.remove('hidden');
            }
        }

        // Switch absensi sub-tab
        function switchAbsensiTab(tabId) {
            // Remove active class from all absensi tabs
            document.querySelectorAll('.absensi-tab-btn').forEach(btn => {
                btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });

            // Hide all absensi tab contents
            document.querySelectorAll('.absensi-tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Show selected tab
            const selectedTab = document.getElementById(tabId);
            selectedTab.classList.add('active', 'border-blue-500', 'text-blue-600');
            selectedTab.classList.remove('border-transparent', 'text-gray-500');

            // Show corresponding content
            if (tabId === 'tabInputAbsensi') {
                document.getElementById('inputAbsensiContent').classList.remove('hidden');
            } else if (tabId === 'tabLaporanAbsensi') {
                document.getElementById('laporanAbsensiContent').classList.remove('hidden');
                
                // Initialize radio button event listeners when laporan tab is shown
                setTimeout(() => {
                    const radioButtons = document.querySelectorAll('input[name="tipeLaporan"]');
                    console.log('üîß Initializing radio buttons on laporan tab:', radioButtons.length);
                    radioButtons.forEach(radio => {
                        // Remove existing listeners to avoid duplicates
                        radio.removeEventListener('change', handleTipeLaporanChange);
                        // Add new listener
                        radio.addEventListener('change', handleTipeLaporanChange);
                    });
                    console.log('‚úÖ Radio button event listeners initialized for laporan tab');
                }, 100);
            }
        }

        // Handle jenis absensi change
        function handleJenisAbsensiChange() {
            const jenis = document.getElementById('jenisAbsensi').value;
            const kelasContainer = document.getElementById('kelasContainer');
            
            // Ensure date is always today for real-time attendance
            const today = getTodayDate();
            document.getElementById('tanggalAbsensi').value = today;
            
            if (jenis === 'siswa') {
                kelasContainer.classList.remove('hidden');
                populateKelasOptions(); // Populate kelas options when siswa is selected
            } else {
                kelasContainer.classList.add('hidden');
            }
        }

        // Handle jenis laporan change
        function handleJenisLaporanChange() {
            const jenis = document.getElementById('jenisLaporan').value;
            const kelasContainer = document.getElementById('kelasLaporanContainer');
            
            if (jenis === 'siswa') {
                kelasContainer.classList.remove('hidden');
            } else {
                kelasContainer.classList.add('hidden');
            }
        }

        // Handle tipe laporan change
        function handleTipeLaporanChange() {
            const tipeLaporan = document.querySelector('input[name="tipeLaporan"]:checked').value;
            console.log('Report type changed to:', tipeLaporan);
            
            // Clear previous results when switching report types
            document.getElementById('laporanResult').classList.add('hidden');
        }

        // Load absensi data with enhanced filtering and display (combined from laporan functionality)
        async function loadAbsensiData() {
            const tanggal = document.getElementById('tanggalAbsensi').value;
            const jenis = document.getElementById('jenisAbsensi').value;
            const kelas = document.getElementById('kelasAbsensi').value;

            console.log('Loading absensi data with params:', { tanggal, jenis, kelas });

            // FIXED: Store selected values to preserve them during refresh
            const selectedTanggal = tanggal;
            const selectedJenis = jenis;
            const selectedKelas = kelas;
            
            // Store kelas selection to preserve it throughout the process
            window.currentSelectedKelas = selectedKelas;

            // Validasi input
            if (!tanggal || !jenis) {
                showToast('‚ùå Pilih tanggal dan jenis absensi', 'error');
                return;
            }

            if (jenis === 'siswa' && !kelas) {
                showToast('‚ùå Pilih kelas untuk absensi siswa', 'error');
                return;
            }

            const muatDataBtn = document.getElementById('muatDataBtn');
            const muatDataText = document.getElementById('muatDataText');
            const muatDataLoader = document.getElementById('muatDataLoader');

            // Show loading
            muatDataBtn.disabled = true;
            muatDataText.textContent = 'üîÑ Menarik Data...';
            muatDataLoader.classList.remove('hidden');

            try {
                // ENHANCED: Force complete refresh of absensi data for maximum accuracy (copied from loadLaporanData)
                console.log('üîÑ Force refreshing ALL absensi data for maximum report accuracy...');
                console.log('üìä Filter parameters:', { jenis, kelas, tanggal });
                
                showToast('üîÑ Memuat data terbaru dari Google Sheets...', 'info');
                
                const appsScript = new AppsScriptAPI(appsScriptConfig.webAppUrl);
                const absensiResult = await appsScript.getData('Absensi');
                
                if (absensiResult.success && absensiResult.data && absensiResult.data.length > 1) {
                    const headers = absensiResult.data[0];
                    allData.absensi = absensiResult.data.slice(1).filter(row => row.some(cell => cell && cell.toString().trim())).map(row => {
                        const absensi = {};
                        headers.forEach((header, index) => {
                            const key = header.toLowerCase().replace('/', '_').replace(' ', '_');
                            absensi[key] = row[index] || '';
                        });
                        return absensi;
                    });
                }

                console.log('‚úÖ Total absensi records loaded:', allData.absensi.length);
                console.log('üìã Sample absensi records:', allData.absensi.slice(0, 3));

                // Enhanced filtering with comprehensive date handling and class filtering (copied from loadLaporanData)
                let filteredAbsensi = allData.absensi.filter(a => {
                    // Normalize tanggal format - ensure it's YYYY-MM-DD
                    let absensiDateStr = a.tanggal;
                    
                    // Use enhanced Google Sheets date conversion
                    absensiDateStr = convertFromGoogleSheetsDateFormat(absensiDateStr);
                    
                    // Enhanced date filtering
                    const isDateMatch = absensiDateStr === selectedTanggal;
                    
                    // FIXED: Proper jenis filtering - ensure exact match
                    const isJenisMatch = a.jenis && a.jenis.toLowerCase() === selectedJenis.toLowerCase();
                    
                    // Enhanced class filtering logic for siswa
                    let isKelasMatch = true;
                    if (selectedJenis === 'siswa') {
                        // For siswa: if kelas is selected (not empty), filter by that class
                        if (selectedKelas && selectedKelas.trim() !== '') {
                            isKelasMatch = a.kelas && a.kelas.toString().trim() === selectedKelas.toString().trim();
                        }
                    }
                    // For guru: no class filtering needed
                    
                    const matchResult = isJenisMatch && isDateMatch && isKelasMatch;
                    
                    // Debug logging for troubleshooting
                    if (selectedJenis === 'siswa' && isDateMatch) {
                        console.log('üîç Filtering siswa record:', {
                            nama: a.nama,
                            jenis: a.jenis,
                            kelas: a.kelas,
                            tanggal: absensiDateStr,
                            isJenisMatch,
                            isDateMatch,
                            isKelasMatch,
                            matchResult,
                            filterKelas: selectedKelas
                        });
                    }
                    
                    return matchResult;
                });

                console.log('üìä Filtered absensi records:', filteredAbsensi.length);

                // Get master data list for comparison
                let masterDataList = [];
                if (selectedJenis === 'siswa') {
                    masterDataList = allData.siswa.filter(s => 
                        s.kelas && s.kelas.toString().trim() === selectedKelas.toString().trim()
                    );
                    
                    if (masterDataList.length === 0) {
                        console.log('‚ùå No siswa found for kelas:', selectedKelas);
                        console.log('üìã Available siswa classes:', [...new Set(allData.siswa.map(s => s.kelas))]);
                        showToast(`‚ùå Tidak ada siswa untuk kelas ${selectedKelas}. Periksa data siswa di menu Data Master.`, 'error');
                        return;
                    }
                } else {
                    masterDataList = allData.guru;
                    
                    if (masterDataList.length === 0) {
                        showToast('‚ùå Tidak ada data guru. Periksa data guru di menu Data Master.', 'error');
                        return;
                    }
                }

                // Create absensi data by combining master data with existing attendance
                currentAbsensiData = masterDataList.map(item => {
                    const idField = selectedJenis === 'siswa' ? 'nis' : 'nip';
                    const existingRecord = filteredAbsensi.find(a => 
                        a.nis_nuptk === item[idField]
                    );
                    
                    return {
                        ...item,
                        status: existingRecord ? existingRecord.status : 'Hadir',
                        keterangan: existingRecord ? existingRecord.keterangan : '',
                        hasExistingData: !!existingRecord
                    };
                });

                console.log('‚úÖ Final current absensi data prepared:', currentAbsensiData.length, 'records');
                
                renderAbsensiTable();
                document.getElementById('absensiList').classList.remove('hidden');
                
                // Show comprehensive success message
                const kelasInfo = selectedJenis === 'siswa' ? ` kelas ${selectedKelas}` : '';
                const dateFormatted = new Date(selectedTanggal + 'T00:00:00').toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                const existingCount = currentAbsensiData.filter(item => item.hasExistingData).length;
                const newCount = currentAbsensiData.length - existingCount;
                
                if (existingCount > 0) {
                    showToast(`‚úÖ Data berhasil dimuat! ${existingCount} sudah ada absensi, ${newCount} belum ada untuk ${dateFormatted}`, 'success');
                } else {
                    showToast(`‚úÖ Data berhasil dimuat! ${currentAbsensiData.length} data ${selectedJenis}${kelasInfo} untuk ${dateFormatted}`, 'success');
                }
                
                // FIXED: Preserve kelas selection after data loading
                if (selectedJenis === 'siswa' && selectedKelas) {
                    document.getElementById('kelasAbsensi').value = selectedKelas;
                    console.log('üìö Kelas selection preserved after tarik data:', selectedKelas);
                }

            } catch (error) {
                console.error('‚ùå Error loading absensi data:', error);
                showToast('‚ùå Gagal memuat data: ' + error.message, 'error');
            } finally {
                // Hide loading
                muatDataBtn.disabled = false;
                muatDataText.textContent = 'Tarik Data';
                muatDataLoader.classList.add('hidden');
            }
        }

        // Render absensi table with data overwrite capability (newest data always wins)
        function renderAbsensiTable() {
            const tbody = document.getElementById('absensiTableBody');
            tbody.innerHTML = '';

            // Check if attendance already exists for today (for display information only)
            const today = getTodayDate();
            const existingTodayAbsensi = allData.absensi.filter(a => {
                let absensiDateStr = a.tanggal;
                
                if (absensiDateStr && absensiDateStr.includes('/')) {
                    const parts = absensiDateStr.split('/');
                    if (parts.length === 3) {
                        if (parts[0].length <= 2 && parts[1].length <= 2 && parts[2].length === 4) {
                            absensiDateStr = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                        } else if (parts[1].length <= 2 && parts[0].length <= 2 && parts[2].length === 4) {
                            absensiDateStr = `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
                        }
                    }
                }
                
                if (absensiDateStr && !absensiDateStr.includes('-') && !absensiDateStr.includes('/')) {
                    const dateNum = parseFloat(absensiDateStr);
                    if (!isNaN(dateNum) && dateNum > 40000) {
                        const excelDate = new Date((dateNum - 25569) * 86400 * 1000);
                        absensiDateStr = excelDate.toLocaleDateString('en-CA', { timeZone: 'Asia/Jakarta' });
                    }
                }
                
                if (absensiDateStr && absensiDateStr.includes('T')) {
                    absensiDateStr = absensiDateStr.split('T')[0];
                }
                
                return absensiDateStr === today;
            });

            // UPDATED: Always allow editing - newest data will overwrite existing data
            const isReadOnly = false; // Always editable
            const disabledClass = 'cursor-pointer';
            const disabledAttr = '';

            currentAbsensiData.forEach((item, index) => {
                // Check if this person already has attendance record today
                const jenis = document.getElementById('jenisAbsensi').value;
                const idField = jenis === 'siswa' ? 'nis' : 'nip';
                const personId = item[idField];
                
                const existingRecord = existingTodayAbsensi.find(a => a.nis_nuptk === personId);
                const hasExistingRecord = !!existingRecord;
                
                // Remove attendance status indicator - no longer showing existing attendance info

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <div class="font-medium">${item.nama}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${item.nis || item.nip}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex flex-wrap gap-2">
                            <label class="flex items-center ${disabledClass}">
                                <input type="radio" name="status_${index}" value="Hadir" class="status-radio hidden" data-index="${index}" ${item.status === 'Hadir' ? 'checked' : ''} ${disabledAttr}>
                                <div class="status-icon w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all ${item.status === 'Hadir' ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 hover:border-green-400'}">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <span class="ml-1 text-xs text-green-600">Hadir</span>
                            </label>
                            <label class="flex items-center ${disabledClass}">
                                <input type="radio" name="status_${index}" value="Izin" class="status-radio hidden" data-index="${index}" ${item.status === 'Izin' ? 'checked' : ''} ${disabledAttr}>
                                <div class="status-icon w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all ${item.status === 'Izin' ? 'bg-yellow-500 border-yellow-500 text-white' : 'border-gray-300 hover:border-yellow-400'}">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <span class="ml-1 text-xs text-yellow-600">Izin</span>
                            </label>
                            <label class="flex items-center ${disabledClass}">
                                <input type="radio" name="status_${index}" value="Sakit" class="status-radio hidden" data-index="${index}" ${item.status === 'Sakit' ? 'checked' : ''} ${disabledAttr}>
                                <div class="status-icon w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all ${item.status === 'Sakit' ? 'bg-blue-500 border-blue-500 text-white' : 'border-gray-300 hover:border-blue-400'}">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h4a1 1 0 010 2H6.414l2.293 2.293a1 1 0 01-1.414 1.414L5 6.414V8a1 1 0 01-2 0V4zm9 1a1 1 0 010-2h4a1 1 0 011 1v4a1 1 0 01-2 0V6.414l-2.293 2.293a1 1 0 11-1.414-1.414L13.586 5H12zm-9 7a1 1 0 012 0v1.586l2.293-2.293a1 1 0 111.414 1.414L6.414 15H8a1 1 0 010 2H4a1 1 0 01-1-1v-4zm13-1a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 010-2h1.586l-2.293-2.293a1 1 0 111.414-1.414L15.586 13H14a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <span class="ml-1 text-xs text-blue-600">Sakit</span>
                            </label>
                            <label class="flex items-center ${disabledClass}">
                                <input type="radio" name="status_${index}" value="Alpha" class="status-radio hidden" data-index="${index}" ${item.status === 'Alpha' ? 'checked' : ''} ${disabledAttr}>
                                <div class="status-icon w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all ${item.status === 'Alpha' ? 'bg-red-500 border-red-500 text-white' : 'border-gray-300 hover:border-red-400'}">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <span class="ml-1 text-xs text-red-600">Alpha</span>
                            </label>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="text" class="keterangan-input px-2 py-1 border border-gray-300 rounded text-sm w-full ${isReadOnly ? 'bg-gray-100' : ''}" 
                               data-index="${index}" value="${item.keterangan}" placeholder="Keterangan tambahan" ${disabledAttr}>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Remove informational message - no longer showing attendance status info

            // Add event listeners for status and keterangan changes (always enabled)
            document.querySelectorAll('.status-radio').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    currentAbsensiData[index].status = e.target.value;
                    
                    // Update visual state of all radio buttons for this row
                    const allRadios = document.querySelectorAll(`input[name="status_${index}"]`);
                    allRadios.forEach(r => {
                        const icon = r.nextElementSibling;
                        
                        if (r.checked) {
                            // Set active state
                            if (r.value === 'Hadir') {
                                icon.className = 'status-icon w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all bg-green-500 border-green-500 text-white';
                            } else if (r.value === 'Izin') {
                                icon.className = 'status-icon w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all bg-yellow-500 border-yellow-500 text-white';
                            } else if (r.value === 'Sakit') {
                                icon.className = 'status-icon w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all bg-blue-500 border-blue-500 text-white';
                            } else if (r.value === 'Alpha') {
                                icon.className = 'status-icon w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all bg-red-500 border-red-500 text-white';
                            }
                        } else {
                            // Set inactive state
                            icon.className = 'status-icon w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all border-gray-300 hover:border-gray-400';
                        }
                    });
                });
            });

            document.querySelectorAll('.keterangan-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    currentAbsensiData[index].keterangan = e.target.value;
                });
            });

            // Always show save button (data overwrite is allowed)
            const saveButton = document.getElementById('simpanAbsensiBtn');
            if (saveButton) {
                saveButton.style.display = 'inline-flex';
            }
        }

        // Save absensi (with strict one-time daily limit enforcement)
        async function saveAbsensi() {
            const tanggal = document.getElementById('tanggalAbsensi').value;
            const jenis = document.getElementById('jenisAbsensi').value;
            const kelas = document.getElementById('kelasAbsensi').value;

            // Validasi input
            if (!tanggal || !jenis) {
                showToast('‚ùå Pilih tanggal dan jenis absensi', 'error');
                return;
            }

            // Enhanced validation: Check if data has been loaded first
            if (!currentAbsensiData || currentAbsensiData.length === 0) {
                showToast('‚ùå Belum ada data absensi yang dimuat. Silakan klik "Tarik Data" terlebih dahulu.', 'error');
                return;
            }

            // For siswa, validate kelas selection only if no data is loaded
            if (jenis === 'siswa' && (!kelas || kelas.trim() === '')) {
                showToast('‚ùå Pilih kelas untuk absensi siswa', 'error');
                return;
            }

            // Validasi tanggal harus hari ini
            const today = getTodayDate();
            if (tanggal !== today) {
                showToast('Absensi hanya dapat disimpan untuk hari ini!', 'error');
                return;
            }

            // CRITICAL: Double-check if attendance already exists before saving (STRICT ONE-TIME DAILY LIMIT)
            const existingTodayAbsensi = allData.absensi.filter(a => {
                let absensiDateStr = a.tanggal;
                
                // Use enhanced Google Sheets date conversion
                absensiDateStr = convertFromGoogleSheetsDateFormat(absensiDateStr);
                
                return absensiDateStr === today && 
                       a.jenis === jenis &&
                       (jenis === 'guru' || a.kelas === kelas);
            });

            // STRICT ENFORCEMENT: Block save if attendance already exists (ONE-TIME DAILY LIMIT)
            if (existingTodayAbsensi.length > 0) {
                const kelasInfo = jenis === 'siswa' ? ` kelas ${kelas}` : '';
                const dateFormatted = new Date(today + 'T00:00:00').toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                console.log('üö´ SAVE BLOCKED: Attendance already exists for today:', existingTodayAbsensi.length, 'records');
                
                // Show blocking message
                const blockTitle = 'üö´ Tidak Dapat Menyimpan - Absensi Sudah Ada';
                const blockMessage = `Absensi ${jenis}${kelasInfo} untuk ${dateFormatted} sudah pernah disimpan sebelumnya.`;
                const blockDetails = `Sistem menerapkan kebijakan SATU KALI ABSENSI per hari untuk menjaga integritas data. Ditemukan ${existingTodayAbsensi.length} record absensi yang sudah tersimpan di Google Sheets. Data tidak dapat ditimpa atau diubah.`;
                
                await showAbsensiBlockedDialog(blockTitle, blockMessage, blockDetails);
                
                console.log('üö´ Save operation blocked due to one-time daily limit');
                showToast('üö´ Absensi sudah tersimpan hari ini. Tidak dapat menyimpan ulang.', 'error');
                
                // Reset form after blocking
                resetAbsensiForm();
                return;
            }

            const simpanBtn = document.getElementById('simpanAbsensiBtn');
            const simpanText = document.getElementById('simpanAbsensiText');
            const simpanLoader = document.getElementById('simpanAbsensiLoader');

            // Show loading
            simpanBtn.disabled = true;
            simpanText.textContent = 'üíæ Menyimpan...';
            simpanLoader.classList.remove('hidden');

            try {
                const appsScript = new AppsScriptAPI(appsScriptConfig.webAppUrl);
                
                // Enhanced: Use consistent date format (DD/MM/YYYY) and local timestamp
                const currentTime = new Date();
                const timestamp = currentTime.toLocaleString('id-ID', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    timeZone: 'Asia/Jakarta'
                });
                
                // CRITICAL: Ensure consistent DD/MM/YYYY format for Google Sheets
                const formattedDate = convertToIndonesianDateFormat(tanggal);
                console.log('üìÖ Date formatting for Google Sheets:', {
                    original: tanggal,
                    formatted: formattedDate,
                    format: 'DD/MM/YYYY'
                });
                
                // CRITICAL FIX: Ensure kelas is ALWAYS properly included for siswa records
                const absensiData = currentAbsensiData.map(item => {
                    const kelasValue = jenis === 'siswa' ? (kelas || '') : '';
                    
                    console.log('üìù Processing record:', {
                        nama: item.nama,
                        jenis: jenis,
                        kelas: kelasValue,
                        originalKelas: kelas,
                        itemKelas: item.kelas,
                        tanggal: formattedDate
                    });
                    
                    return [
                        formattedDate, // CONSISTENT: Always use DD/MM/YYYY format for Google Sheets
                        jenis,
                        kelasValue, // CRITICAL: Use kelasValue which is guaranteed to have kelas for siswa
                        item.nis || item.nip,
                        item.nama,
                        item.status,
                        item.keterangan || '',
                        timestamp
                    ];
                });

                console.log('üíæ DETAILED Saving absensi data:', {
                    tanggal,
                    jenis,
                    selectedKelas: kelas,
                    recordCount: absensiData.length,
                    sampleRecord: absensiData[0],
                    allRecords: absensiData.slice(0, 3) // Show first 3 records for debugging
                });
                
                // Validate that siswa records have kelas
                if (jenis === 'siswa') {
                    const recordsWithoutKelas = absensiData.filter(record => !record[2] || record[2].trim() === '');
                    if (recordsWithoutKelas.length > 0) {
                        console.error('‚ùå Found siswa records without kelas:', recordsWithoutKelas);
                        showToast('‚ùå Error: Ada data siswa tanpa kelas. Silakan pilih kelas terlebih dahulu.', 'error');
                        return;
                    }
                    console.log('‚úÖ All siswa records have kelas:', kelas);
                }
                
                showToast('üíæ Mengirim data ke Google Sheets...', 'info');
                const result = await appsScript.saveAbsensi(absensiData);
                
                if (result.success) {
                    showToast(`‚úÖ Absensi ${jenis} berhasil disimpan! (${absensiData.length} data)`, 'success');
                    
                    // Log successful save with kelas info
                    console.log('‚úÖ Successfully saved absensi with kelas:', {
                        jenis,
                        kelas: jenis === 'siswa' ? kelas : 'N/A',
                        recordCount: absensiData.length
                    });
                    
                    // ENHANCED: Force complete refresh of all absensi data for accurate statistics
                    console.log('üîÑ Force refreshing ALL absensi data for accurate statistics...');
                    showToast('üîÑ Memperbarui statistik...', 'info');
                    
                    // Update statistics for H-1 (yesterday) - statistics always show previous day
                    const yesterday = getYesterdayDate();
                    await updateInfoCards(yesterday);
                    console.log('üìä Statistics updated immediately after save for H-1 date:', yesterday);
                    
                    // Auto refresh statistics after save
                    console.log('üìä Auto refreshing H-1 statistics after absensi save...');
                    await refreshStatistikManual();
                    
                    // FIXED: Preserve form state for siswa - keep kelas selected
                    if (jenis === 'siswa') {
                        preserveAbsensiFormStateAfterSave(jenis, kelas);
                        // Ensure kelas remains selected after save
                        document.getElementById('kelasAbsensi').value = kelas;
                        console.log('üìö Kelas selection preserved after save:', kelas);
                    } else {
                        resetAbsensiForm();
                    }
                    
                    // Update timestamp display
                    showToast(`üíæ Tersimpan pada: ${timestamp}`, 'success');
                    showToast(`üìä Statistik H-1 telah diperbarui!`, 'info');
                } else {
                    showToast(`‚ùå Gagal menyimpan: ${result.error}`, 'error');
                    // Don't reset form on error - preserve user's work
                }
                
            } catch (error) {
                console.error('‚ùå Save absensi error:', error);
                showToast(`‚ùå Gagal menyimpan: ${error.message}`, 'error');
                // Don't reset form on error - preserve user's work
            } finally {
                // Hide loading
                simpanBtn.disabled = false;
                simpanText.textContent = 'Simpan Absensi';
                simpanLoader.classList.add('hidden');
            }
        }

        // Load siswa data
        async function loadSiswaData() {
            await loadAllData();
            loadSiswaTable();
        }

        // Load guru data
        async function loadGuruData() {
            await loadAllData();
            loadGuruTable();
        }

        // Load jadwal data
        async function loadJadwalData() {
            console.log('Loading jadwal data...');
            await loadAllData();
            loadJadwalTable();
        }

        // Load siswa table
        function loadSiswaTable() {
            const tbody = document.getElementById('siswaTableBody');
            tbody.innerHTML = '';

            allData.siswa.forEach(siswa => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-3 py-2 text-sm text-gray-900">${siswa.nis}</td>
                    <td class="px-3 py-2 text-sm text-gray-900">${siswa.nama}</td>
                    <td class="px-3 py-2 text-sm text-gray-900">${siswa.kelas}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load guru table
        function loadGuruTable() {
            const tbody = document.getElementById('guruTableBody');
            tbody.innerHTML = '';

            allData.guru.forEach(guru => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-3 py-2 text-sm text-gray-900">${guru.nip}</td>
                    <td class="px-3 py-2 text-sm text-gray-900">${guru.nama}</td>
                    <td class="px-3 py-2 text-sm text-gray-900">${guru.mata_pelajaran}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load jadwal table
        function loadJadwalTable() {
            const tbody = document.getElementById('jadwalTableBody');
            tbody.innerHTML = '';

            console.log('Loading jadwal table with data:', allData.jadwal);

            if (allData.jadwal.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">
                        Tidak ada data jadwal
                    </td>
                `;
                tbody.appendChild(row);
                return;
            }

            allData.jadwal.forEach(jadwal => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${jadwal.hari || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${jadwal.jam_mulai || '-'} - ${jadwal.jam_selesai || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${jadwal.kelas || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${jadwal.mapel || jadwal.mata_pelajaran || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${jadwal.nama_guru || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Populate kelas options
        function populateKelasOptions() {
            const kelasSelect = document.getElementById('kelasAbsensi');
            const kelasLaporanSelect = document.getElementById('kelasLaporan');
            const kelasRekapAbsensiSelect = document.getElementById('kelasRekapAbsensi');
            
            // Get unique classes from siswa data
            const uniqueKelas = [...new Set(allData.siswa.map(s => s.kelas))].sort();
            
            // Clear existing options
            kelasSelect.innerHTML = '<option value="">Pilih Kelas</option>';
            kelasLaporanSelect.innerHTML = '<option value="">Semua Kelas</option>';
            if (kelasRekapAbsensiSelect) {
                kelasRekapAbsensiSelect.innerHTML = '<option value="">Semua Kelas</option>';
            }
            
            uniqueKelas.forEach(kelas => {
                kelasSelect.innerHTML += `<option value="${kelas}">${kelas}</option>`;
                kelasLaporanSelect.innerHTML += `<option value="${kelas}">${kelas}</option>`;
                if (kelasRekapAbsensiSelect) {
                    kelasRekapAbsensiSelect.innerHTML += `<option value="${kelas}">${kelas}</option>`;
                }
            });
        }

        // Initialize rekap absensi form - FIXED: Use actual dates without H-1 logic
        function initializeRekapAbsensiForm() {
            const today = getTodayDate();
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const oneWeekAgoStr = oneWeekAgo.toLocaleDateString('en-CA', { timeZone: 'Asia/Jakarta' });
            
            // Set default date range - use actual selected dates
            document.getElementById('dariTanggalRekapAbsensi').value = oneWeekAgoStr;
            document.getElementById('sampaiTanggalRekapAbsensi').value = today;
            
            // Populate kelas options for rekap absensi
            populateKelasOptionsRekapAbsensi();
            
            console.log('üìÖ Rekap form initialized with date range:', { from: oneWeekAgoStr, to: today });
        }

        // Handle jenis rekap absensi change
        function handleJenisRekapAbsensiChange() {
            const jenis = document.getElementById('jenisRekapAbsensi').value;
            const kelasContainer = document.getElementById('kelasRekapAbsensiContainer');
            
            if (jenis === 'siswa') {
                kelasContainer.classList.remove('hidden');
            } else {
                kelasContainer.classList.add('hidden');
            }
        }

        // Populate kelas options for rekap absensi
        function populateKelasOptionsRekapAbsensi() {
            const kelasRekapAbsensiSelect = document.getElementById('kelasRekapAbsensi');
            
            // Get unique classes from siswa data
            const uniqueKelas = [...new Set(allData.siswa.map(s => s.kelas))].sort();
            
            // Clear existing options
            kelasRekapAbsensiSelect.innerHTML = '<option value="">Semua Kelas</option>';
            
            uniqueKelas.forEach(kelas => {
                kelasRekapAbsensiSelect.innerHTML += `<option value="${kelas}">${kelas}</option>`;
            });
        }

        // Generate rekap kehadiran absensi - FIXED: Use actual selected dates from Google Sheets
        async function generateRekapKehadiranAbsensi() {
            const jenis = document.getElementById('jenisRekapAbsensi').value;
            const kelas = document.getElementById('kelasRekapAbsensi').value;
            const dariTanggal = document.getElementById('dariTanggalRekapAbsensi').value;
            const sampaiTanggal = document.getElementById('sampaiTanggalRekapAbsensi').value;

            console.log('üìä REKAP: Generate rekap kehadiran with exact params:', { dariTanggal, sampaiTanggal, jenis, kelas });

            if (!jenis || !dariTanggal || !sampaiTanggal) {
                showToast('‚ùå Lengkapi semua field rekap kehadiran', 'error');
                return;
            }

            const generateBtn = document.getElementById('generateRekapAbsensiBtn');
            const generateText = document.getElementById('generateRekapAbsensiText');
            const generateLoader = document.getElementById('generateRekapAbsensiLoader');

            // Show loading
            generateBtn.disabled = true;
            generateText.textContent = 'üîÑ Generating...';
            generateLoader.classList.remove('hidden');

            try {
                // Force refresh absensi data
                showToast('üîÑ Memuat data terbaru dari Google Sheets...', 'info');
                
                const appsScript = new AppsScriptAPI(appsScriptConfig.webAppUrl);
                const absensiResult = await appsScript.getData('Absensi');
                
                if (absensiResult.success && absensiResult.data && absensiResult.data.length > 1) {
                    const headers = absensiResult.data[0];
                    allData.absensi = absensiResult.data.slice(1).filter(row => row.some(cell => cell && cell.toString().trim())).map(row => {
                        const absensi = {};
                        headers.forEach((header, index) => {
                            const key = header.toLowerCase().replace('/', '_').replace(' ', '_');
                            absensi[key] = row[index] || '';
                        });
                        return absensi;
                    });
                }

                // FIXED: Filter absensi data by date range and type - Use exact date matching
                const filteredAbsensi = allData.absensi.filter(a => {
                    // CRITICAL FIX: Normalize date format from Google Sheets
                    let absensiDateStr = a.tanggal;
                    let originalDateStr = absensiDateStr; // Keep original for debugging
                    
                    // Use enhanced Google Sheets date conversion
                    absensiDateStr = convertFromGoogleSheetsDateFormat(absensiDateStr);
                    
                    // CRITICAL FIX: Use EXACT date range filtering based on user selection
                    const isDateInRange = absensiDateStr >= dariTanggal && absensiDateStr <= sampaiTanggal;
                    
                    // Debug logging for date conversion issues
                    if (originalDateStr !== absensiDateStr) {
                        console.log('üìÖ REKAP Date conversion:', {
                            original: originalDateStr,
                            converted: absensiDateStr,
                            filterRange: `${dariTanggal} to ${sampaiTanggal}`,
                            inRange: isDateInRange,
                            nama: a.nama
                        });
                    }
                    
                    // ENHANCED DEBUG: Log all date comparisons for troubleshooting
                    if (a.nama && a.nama.includes('Ahmad')) { // Sample debug for first record
                        console.log('üîç REKAP Date debug sample:', {
                            nama: a.nama,
                            originalDate: originalDateStr,
                            convertedDate: absensiDateStr,
                            filterFrom: dariTanggal,
                            filterTo: sampaiTanggal,
                            isInRange: isDateInRange,
                            comparison: `${absensiDateStr} >= ${dariTanggal} && ${absensiDateStr} <= ${sampaiTanggal}`
                        });
                    }
                    const isJenisMatch = a.jenis && a.jenis.toLowerCase() === jenis.toLowerCase();
                    
                    // Enhanced class filtering for siswa
                    let isKelasMatch = true;
                    if (jenis === 'siswa') {
                        if (kelas && kelas.trim() !== '') {
                            isKelasMatch = a.kelas && a.kelas.toString().trim() === kelas.toString().trim();
                        }
                        // If no kelas selected (empty), show all siswa records
                    }
                    // For guru: no class filtering needed
                    
                    const matchResult = isJenisMatch && isDateInRange && isKelasMatch;
                    
                    // Debug logging for troubleshooting
                    if (isDateInRange && isJenisMatch) {
                        console.log('üîç Matching record for rekap kehadiran:', {
                            nama: a.nama,
                            jenis: a.jenis,
                            kelas: a.kelas,
                            tanggal: absensiDateStr,
                            status: a.status,
                            nis_nuptk: a.nis_nuptk,
                            matchResult
                        });
                    }
                    
                    return matchResult;
                });

                console.log('üìä REKAP: Filtered absensi records for rekap kehadiran:', filteredAbsensi.length);
                console.log('üìã REKAP: Sample filtered records:', filteredAbsensi.slice(0, 3));
                
                // CRITICAL DEBUG: Show all dates in the dataset for comparison
                const allDatesInData = [...new Set(allData.absensi.map(a => a.tanggal))].sort();
                console.log('üìÖ REKAP: All dates in dataset:', allDatesInData);
                console.log('üìÖ REKAP: Filter range:', `${dariTanggal} to ${sampaiTanggal}`);
                
                // ENHANCED DEBUG: Show normalized dates for comparison
                const normalizedDates = [...new Set(allData.absensi.map(a => {
                    let dateStr = a.tanggal;
                    if (dateStr && dateStr.includes('/')) {
                        const parts = dateStr.split('/');
                        if (parts.length === 3 && parts[0].length <= 2 && parts[1].length <= 2 && parts[2].length === 4) {
                            dateStr = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                        }
                    }
                    return dateStr;
                }))].sort();
                console.log('üìÖ REKAP: Normalized dates in dataset:', normalizedDates);

                // Generate rekap data using the same function as laporan rekap
                const rekapData = generateRekapData(filteredAbsensi, jenis, kelas);
                console.log('üìä Generated rekap kehadiran data:', rekapData.length, 'records');
                console.log('üìã Sample rekap kehadiran data:', rekapData.slice(0, 3));
                
                // Store for export
                window.currentRekapAbsensiData = {
                    data: rekapData,
                    jenis: jenis,
                    kelas: kelas,
                    dariTanggal: dariTanggal,
                    sampaiTanggal: sampaiTanggal,
                    filteredAbsensi: filteredAbsensi
                };

                // Render results
                renderRekapKehadiranAbsensiTable(rekapData, jenis);
                updateRekapAbsensiSummary(rekapData);
                
                document.getElementById('rekapAbsensiResult').classList.remove('hidden');
                showToast(`‚úÖ Rekap kehadiran berhasil dibuat! (${rekapData.length} record)`, 'success');

                // FIXED: Keep selected dates - no automatic reset
                console.log('‚úÖ REKAP: Rekap kehadiran generated successfully with exact selected dates:', { dariTanggal, sampaiTanggal });

            } catch (error) {
                console.error('‚ùå Error generating rekap:', error);
                showToast('‚ùå Gagal membuat rekap: ' + error.message, 'error');
            } finally {
                // Hide loading
                generateBtn.disabled = false;
                generateText.textContent = 'Generate Rekap';
                generateLoader.classList.add('hidden');
            }
        }



        // Render rekap kehadiran table
        function renderRekapKehadiranTable(rekapData, jenis) {
            const thead = document.getElementById('rekapTableHeader');
            const tbody = document.getElementById('rekapTableBody');
            
            // Clear existing content
            thead.innerHTML = '';
            tbody.innerHTML = '';
            
            // Create headers
            let headers = ['No', 'Nama', jenis === 'siswa' ? 'NIS' : 'NUPTK'];
            if (jenis === 'siswa') {
                headers.push('Kelas');
            } else {
                headers.push('Mata Pelajaran');
            }
            headers.push('Hadir', 'Izin', 'Sakit', 'Alpha', 'Total', 'Persentase', 'Status');
            
            headers.forEach(header => {
                const th = document.createElement('th');
                th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                th.textContent = header;
                thead.appendChild(th);
            });
            
            // Create rows
            rekapData.forEach((item, index) => {
                const persentase = parseFloat(item.persentaseHadir);
                let statusClass, statusText;
                
                if (persentase >= 90) {
                    statusClass = 'bg-green-100 text-green-800';
                    statusText = 'Sangat Baik';
                } else if (persentase >= 75) {
                    statusClass = 'bg-blue-100 text-blue-800';
                    statusText = 'Baik';
                } else if (persentase >= 60) {
                    statusClass = 'bg-yellow-100 text-yellow-800';
                    statusText = 'Cukup';
                } else {
                    statusClass = 'bg-red-100 text-red-800';
                    statusText = 'Perlu Perhatian';
                }
                
                const row = document.createElement('tr');
                let rowHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.nama}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.id}</td>
                `;
                
                if (jenis === 'siswa') {
                    rowHTML += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.kelas}</td>`;
                } else {
                    rowHTML += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.mata_pelajaran}</td>`;
                }
                
                rowHTML += `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-semibold">${item.hadir}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-yellow-600 font-semibold">${item.izin}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 font-semibold">${item.sakit}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-semibold">${item.alpha}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-bold">${item.total}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${item.persentaseHadir}%</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                `;
                
                row.innerHTML = rowHTML;
                tbody.appendChild(row);
            });
        }

        // Update rekap summary
        function updateRekapSummary(rekapData) {
            const total = rekapData.length;
            const totalHadir = rekapData.reduce((sum, item) => sum + item.hadir, 0);
            const totalKeseluruhan = rekapData.reduce((sum, item) => sum + item.total, 0);
            const rataRataHadir = totalKeseluruhan > 0 ? ((totalHadir / totalKeseluruhan) * 100).toFixed(1) : 0;
            
            const kehadiranRendah = rekapData.filter(item => parseFloat(item.persentaseHadir) < 75).length;
            const perluPerhatian = rekapData.filter(item => parseFloat(item.persentaseHadir) < 60).length;
            
            document.getElementById('rekapTotal').textContent = total;
            document.getElementById('rekapRataHadir').textContent = rataRataHadir + '%';
            document.getElementById('rekapRendah').textContent = kehadiranRendah;
            document.getElementById('rekapPerhatian').textContent = perluPerhatian;
        }

        // Render rekap kehadiran absensi table
        function renderRekapKehadiranAbsensiTable(rekapData, jenis) {
            const thead = document.getElementById('rekapAbsensiTableHeader');
            const tbody = document.getElementById('rekapAbsensiTableBody');
            
            // Clear existing content
            thead.innerHTML = '';
            tbody.innerHTML = '';
            
            // Create headers
            let headers = ['No', 'Nama', jenis === 'siswa' ? 'NIS' : 'NUPTK'];
            if (jenis === 'siswa') {
                headers.push('Kelas');
            } else {
                headers.push('Mata Pelajaran');
            }
            headers.push('Hadir', 'Izin', 'Sakit', 'Alpha', 'Total', 'Persentase', 'Status');
            
            headers.forEach(header => {
                const th = document.createElement('th');
                th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                th.textContent = header;
                thead.appendChild(th);
            });
            
            // Create rows
            rekapData.forEach((item, index) => {
                const persentase = parseFloat(item.persentaseHadir);
                let statusClass, statusText;
                
                if (persentase >= 90) {
                    statusClass = 'bg-green-100 text-green-800';
                    statusText = 'Sangat Baik';
                } else if (persentase >= 75) {
                    statusClass = 'bg-blue-100 text-blue-800';
                    statusText = 'Baik';
                } else if (persentase >= 60) {
                    statusClass = 'bg-yellow-100 text-yellow-800';
                    statusText = 'Cukup';
                } else {
                    statusClass = 'bg-red-100 text-red-800';
                    statusText = 'Perlu Perhatian';
                }
                
                const row = document.createElement('tr');
                let rowHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.nama}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.id}</td>
                `;
                
                if (jenis === 'siswa') {
                    rowHTML += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.kelas}</td>`;
                } else {
                    rowHTML += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.mata_pelajaran}</td>`;
                }
                
                rowHTML += `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-semibold">${item.hadir}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-yellow-600 font-semibold">${item.izin}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 font-semibold">${item.sakit}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-semibold">${item.alpha}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-bold">${item.total}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${item.persentaseHadir}%</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                `;
                
                row.innerHTML = rowHTML;
                tbody.appendChild(row);
            });
        }

        // Update rekap absensi summary
        function updateRekapAbsensiSummary(rekapData) {
            const total = rekapData.length;
            const totalHadir = rekapData.reduce((sum, item) => sum + item.hadir, 0);
            const totalKeseluruhan = rekapData.reduce((sum, item) => sum + item.total, 0);
            const rataRataHadir = totalKeseluruhan > 0 ? ((totalHadir / totalKeseluruhan) * 100).toFixed(1) : 0;
            
            const kehadiranRendah = rekapData.filter(item => parseFloat(item.persentaseHadir) < 75).length;
            const perluPerhatian = rekapData.filter(item => parseFloat(item.persentaseHadir) < 60).length;
            
            document.getElementById('rekapAbsensiTotal').textContent = total;
            document.getElementById('rekapAbsensiRataHadir').textContent = rataRataHadir + '%';
            document.getElementById('rekapAbsensiRendah').textContent = kehadiranRendah;
            document.getElementById('rekapAbsensiPerhatian').textContent = perluPerhatian;
        }

        // Export rekap absensi to PDF
        function exportRekapAbsensiPDF() {
            if (!window.currentRekapAbsensiData || !window.currentRekapAbsensiData.data.length) {
                showToast('Tidak ada data rekap untuk diexport. Silakan generate rekap terlebih dahulu.', 'error');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Header
                doc.setFontSize(16);
                doc.text('Rekap Kehadiran SMP Purnawarman', 20, 20);
                
                doc.setFontSize(12);
                doc.text(`Jenis: ${window.currentRekapAbsensiData.jenis}`, 20, 35);
                if (window.currentRekapAbsensiData.kelas) {
                    doc.text(`Kelas: ${window.currentRekapAbsensiData.kelas}`, 20, 45);
                }
                doc.text(`Periode: ${window.currentRekapAbsensiData.dariTanggal} s/d ${window.currentRekapAbsensiData.sampaiTanggal}`, 20, 55);
                doc.text(`Total: ${window.currentRekapAbsensiData.data.length}`, 20, 65);
                
                let yPos = 85;
                
                // Table headers
                const headers = ['No', 'Nama', 'ID', 'H', 'I', 'S', 'A', 'Total', '%', 'Status'];
                
                doc.setFontSize(10);
                headers.forEach((header, index) => {
                    doc.text(header, 20 + (index * 18), yPos);
                });
                
                yPos += 10;
                
                // Table data
                window.currentRekapAbsensiData.data.forEach((item, index) => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    const persentase = parseFloat(item.persentaseHadir);
                    const status = persentase >= 90 ? 'SB' : persentase >= 75 ? 'B' : persentase >= 60 ? 'C' : 'PP';
                    
                    const row = [
                        (index + 1).toString(),
                        item.nama.substring(0, 12),
                        item.id.substring(0, 10),
                        item.hadir.toString(),
                        item.izin.toString(),
                        item.sakit.toString(),
                        item.alpha.toString(),
                        item.total.toString(),
                        item.persentaseHadir + '%',
                        status
                    ];
                    
                    row.forEach((cell, cellIndex) => {
                        doc.text(cell, 20 + (cellIndex * 18), yPos);
                    });
                    
                    yPos += 8;
                });
                
                // Save PDF
                const fileName = `Rekap_Kehadiran_${window.currentRekapAbsensiData.jenis}_${window.currentRekapAbsensiData.dariTanggal}_${window.currentRekapAbsensiData.sampaiTanggal}.pdf`;
                doc.save(fileName);
                
                showToast('‚úÖ PDF rekap berhasil diunduh!', 'success');
                
            } catch (error) {
                console.error('Error exporting rekap PDF:', error);
                showToast('‚ùå Gagal export PDF: ' + error.message, 'error');
            }
        }

        // Export rekap absensi to Excel
        function exportRekapAbsensiExcel() {
            if (!window.currentRekapAbsensiData || !window.currentRekapAbsensiData.data.length) {
                showToast('Tidak ada data rekap untuk diexport. Silakan generate rekap terlebih dahulu.', 'error');
                return;
            }

            try {
                const rekapData = window.currentRekapAbsensiData.data;
                
                // Prepare headers
                let headers = ['No', 'Nama', window.currentRekapAbsensiData.jenis === 'siswa' ? 'NIS' : 'NUPTK'];
                if (window.currentRekapAbsensiData.jenis === 'siswa') {
                    headers.push('Kelas');
                } else {
                    headers.push('Mata Pelajaran');
                }
                headers.push('Hadir', 'Izin', 'Sakit', 'Alpha', 'Total', 'Persentase Hadir', 'Status Kehadiran');
                
                // Create worksheet data
                const wsData = [headers];
                
                rekapData.forEach((item, index) => {
                    const persentase = parseFloat(item.persentaseHadir);
                    const status = persentase >= 90 ? 'Sangat Baik' : 
                                  persentase >= 75 ? 'Baik' : 
                                  persentase >= 60 ? 'Cukup' : 'Perlu Perhatian';
                    
                    let row = [
                        index + 1,
                        item.nama,
                        item.id
                    ];
                    
                    if (window.currentRekapAbsensiData.jenis === 'siswa') {
                        row.push(item.kelas);
                    } else {
                        row.push(item.mata_pelajaran);
                    }
                    
                    row.push(
                        item.hadir,
                        item.izin,
                        item.sakit,
                        item.alpha,
                        item.total,
                        item.persentaseHadir + '%',
                        status
                    );
                    
                    wsData.push(row);
                });
                
                // Add summary info at the top
                const summaryData = [
                    ['REKAP KEHADIRAN SMP PURNAWARMAN'],
                    [''],
                    [`Jenis: ${window.currentRekapAbsensiData.jenis}`],
                    [`Kelas: ${window.currentRekapAbsensiData.kelas || 'Semua Kelas'}`],
                    [`Periode: ${window.currentRekapAbsensiData.dariTanggal} s/d ${window.currentRekapAbsensiData.sampaiTanggal}`],
                    [`Total: ${rekapData.length}`],
                    [`Tanggal Export: ${new Date().toLocaleDateString('id-ID')}`],
                    [''],
                    ...wsData
                ];
                
                // Create workbook and worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(summaryData);
                
                // Set column widths
                const colWidths = [
                    { wch: 5 },  // No
                    { wch: 25 }, // Nama
                    { wch: 15 }, // ID
                    { wch: 12 }, // Kelas/Mapel
                    { wch: 8 },  // Hadir
                    { wch: 8 },  // Izin
                    { wch: 8 },  // Sakit
                    { wch: 8 },  // Alpha
                    { wch: 8 },  // Total
                    { wch: 15 }, // Persentase
                    { wch: 15 }  // Status
                ];
                
                ws['!cols'] = colWidths;
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Rekap Kehadiran');
                
                // Generate filename
                const fileName = `Rekap_Kehadiran_${window.currentRekapAbsensiData.jenis}_${window.currentRekapAbsensiData.dariTanggal}_${window.currentRekapAbsensiData.sampaiTanggal}.xlsx`;
                
                // Save file
                XLSX.writeFile(wb, fileName);
                
                showToast(`‚úÖ Excel rekap berhasil diexport! (${rekapData.length} record)`, 'success');
                
            } catch (error) {
                console.error('Error exporting rekap Excel:', error);
                showToast('‚ùå Gagal export Excel: ' + error.message, 'error');
            }
        }

        // Export rekap to PDF
        function exportRekapPDF() {
            if (!window.currentRekapData || !window.currentRekapData.data.length) {
                showToast('Tidak ada data rekap untuk diexport. Silakan generate rekap terlebih dahulu.', 'error');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Header
                doc.setFontSize(16);
                doc.text('Rekap Kehadiran SMP Purnawarman', 20, 20);
                
                doc.setFontSize(12);
                doc.text(`Jenis: ${window.currentRekapData.jenis}`, 20, 35);
                if (window.currentRekapData.kelas) {
                    doc.text(`Kelas: ${window.currentRekapData.kelas}`, 20, 45);
                }
                doc.text(`Periode: ${window.currentRekapData.dariTanggal} s/d ${window.currentRekapData.sampaiTanggal}`, 20, 55);
                doc.text(`Total: ${window.currentRekapData.data.length}`, 20, 65);
                
                let yPos = 85;
                
                // Table headers
                const headers = ['No', 'Nama', 'ID', 'H', 'I', 'S', 'A', 'Total', '%', 'Status'];
                
                doc.setFontSize(10);
                headers.forEach((header, index) => {
                    doc.text(header, 20 + (index * 18), yPos);
                });
                
                yPos += 10;
                
                // Table data
                window.currentRekapData.data.forEach((item, index) => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    const persentase = parseFloat(item.persentaseHadir);
                    const status = persentase >= 90 ? 'SB' : persentase >= 75 ? 'B' : persentase >= 60 ? 'C' : 'PP';
                    
                    const row = [
                        (index + 1).toString(),
                        item.nama.substring(0, 12),
                        item.id.substring(0, 10),
                        item.hadir.toString(),
                        item.izin.toString(),
                        item.sakit.toString(),
                        item.alpha.toString(),
                        item.total.toString(),
                        item.persentaseHadir + '%',
                        status
                    ];
                    
                    row.forEach((cell, cellIndex) => {
                        doc.text(cell, 20 + (cellIndex * 18), yPos);
                    });
                    
                    yPos += 8;
                });
                
                // Save PDF
                const fileName = `Rekap_Kehadiran_${window.currentRekapData.jenis}_${window.currentRekapData.dariTanggal}_${window.currentRekapData.sampaiTanggal}.pdf`;
                doc.save(fileName);
                
                showToast('‚úÖ PDF rekap berhasil diunduh!', 'success');
                
            } catch (error) {
                console.error('Error exporting rekap PDF:', error);
                showToast('‚ùå Gagal export PDF: ' + error.message, 'error');
            }
        }

        // Export rekap to Excel
        function exportRekapExcel() {
            if (!window.currentRekapData || !window.currentRekapData.data.length) {
                showToast('Tidak ada data rekap untuk diexport. Silakan generate rekap terlebih dahulu.', 'error');
                return;
            }

            try {
                const rekapData = window.currentRekapData.data;
                
                // Prepare headers
                let headers = ['No', 'Nama', window.currentRekapData.jenis === 'siswa' ? 'NIS' : 'NUPTK'];
                if (window.currentRekapData.jenis === 'siswa') {
                    headers.push('Kelas');
                } else {
                    headers.push('Mata Pelajaran');
                }
                headers.push('Hadir', 'Izin', 'Sakit', 'Alpha', 'Total', 'Persentase Hadir', 'Status Kehadiran');
                
                // Create worksheet data
                const wsData = [headers];
                
                rekapData.forEach((item, index) => {
                    const persentase = parseFloat(item.persentaseHadir);
                    const status = persentase >= 90 ? 'Sangat Baik' : 
                                  persentase >= 75 ? 'Baik' : 
                                  persentase >= 60 ? 'Cukup' : 'Perlu Perhatian';
                    
                    let row = [
                        index + 1,
                        item.nama,
                        item.id
                    ];
                    
                    if (window.currentRekapData.jenis === 'siswa') {
                        row.push(item.kelas);
                    } else {
                        row.push(item.mata_pelajaran);
                    }
                    
                    row.push(
                        item.hadir,
                        item.izin,
                        item.sakit,
                        item.alpha,
                        item.total,
                        item.persentaseHadir + '%',
                        status
                    );
                    
                    wsData.push(row);
                });
                
                // Add summary info at the top
                const summaryData = [
                    ['REKAP KEHADIRAN SMP PURNAWARMAN'],
                    [''],
                    [`Jenis: ${window.currentRekapData.jenis}`],
                    [`Kelas: ${window.currentRekapData.kelas || 'Semua Kelas'}`],
                    [`Periode: ${window.currentRekapData.dariTanggal} s/d ${window.currentRekapData.sampaiTanggal}`],
                    [`Total: ${rekapData.length}`],
                    [`Tanggal Export: ${new Date().toLocaleDateString('id-ID')}`],
                    [''],
                    ...wsData
                ];
                
                // Create workbook and worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(summaryData);
                
                // Set column widths
                const colWidths = [
                    { wch: 5 },  // No
                    { wch: 25 }, // Nama
                    { wch: 15 }, // ID
                    { wch: 12 }, // Kelas/Mapel
                    { wch: 8 },  // Hadir
                    { wch: 8 },  // Izin
                    { wch: 8 },  // Sakit
                    { wch: 8 },  // Alpha
                    { wch: 8 },  // Total
                    { wch: 15 }, // Persentase
                    { wch: 15 }  // Status
                ];
                
                ws['!cols'] = colWidths;
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Rekap Kehadiran');
                
                // Generate filename
                const fileName = `Rekap_Kehadiran_${window.currentRekapData.jenis}_${window.currentRekapData.dariTanggal}_${window.currentRekapData.sampaiTanggal}.xlsx`;
                
                // Save file
                XLSX.writeFile(wb, fileName);
                
                showToast(`‚úÖ Excel rekap berhasil diexport! (${rekapData.length} record)`, 'success');
                
            } catch (error) {
                console.error('Error exporting rekap Excel:', error);
                showToast('‚ùå Gagal export Excel: ' + error.message, 'error');
            }
        }

        // Update info cards with statistics for selected date
        async function updateInfoCards(selectedDate = null) {
            // FIXED: Always use H-1 (yesterday) for statistics data but show today's date in title
            const yesterday = getYesterdayDate();
            const today = getTodayDate();
            const targetDate = yesterday; // Always use yesterday for statistics data
            console.log('Updating statistics for H-1 date:', targetDate);
            
            // Update date display - show today's date in title but use yesterday's data
            const todayFormatted = new Date(today + 'T00:00:00').toLocaleDateString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('statistikSiswaDate').textContent = todayFormatted;
            document.getElementById('statistikGuruDate').textContent = todayFormatted;
            
            // Refresh absensi data from Google Sheets for real-time accuracy
            try {
                const appsScript = new AppsScriptAPI(appsScriptConfig.webAppUrl);
                const absensiResult = await appsScript.getData('Absensi');
                
                if (absensiResult.success && absensiResult.data && absensiResult.data.length > 1) {
                    const headers = absensiResult.data[0];
                    allData.absensi = absensiResult.data.slice(1).filter(row => row.some(cell => cell && cell.toString().trim())).map(row => {
                        const absensi = {};
                        headers.forEach((header, index) => {
                            const key = header.toLowerCase().replace('/', '_').replace(' ', '_');
                            absensi[key] = row[index] || '';
                        });
                        return absensi;
                    });
                }
            } catch (error) {
                console.error('Error refreshing absensi data for statistics:', error);
            }
            
            // Filter absensi for selected date with comprehensive date matching
            const selectedDateAbsensi = allData.absensi.filter(a => {
                let absensiDateStr = a.tanggal;
                
                // Use enhanced Google Sheets date conversion
                absensiDateStr = convertFromGoogleSheetsDateFormat(absensiDateStr);
                
                return absensiDateStr === targetDate;
            });
            
            console.log('Selected date absensi records found:', selectedDateAbsensi.length);
            console.log('Sample selected date records:', selectedDateAbsensi.slice(0, 3));
            
            // Siswa stats
            const totalSiswa = allData.siswa.length;
            const siswaAbsensiSelected = selectedDateAbsensi.filter(a => a.jenis === 'siswa');
            const siswaHadir = siswaAbsensiSelected.filter(a => a.status === 'Hadir').length;
            const siswaIzin = siswaAbsensiSelected.filter(a => a.status === 'Izin').length;
            const siswaSakit = siswaAbsensiSelected.filter(a => a.status === 'Sakit').length;
            const siswaAlpha = siswaAbsensiSelected.filter(a => a.status === 'Alpha').length;
            
            // Calculate siswa tidak hadir (Izin + Sakit + Alpha)
            const siswaTidakHadir = siswaIzin + siswaSakit + siswaAlpha;
            
            console.log('Siswa stats for', targetDate, ':', { totalSiswa, siswaHadir, siswaTidakHadir, siswaIzin, siswaSakit, siswaAlpha });
            
            // Update with animation
            animateCounterUpdate('totalSiswa', totalSiswa);
            animateCounterUpdate('siswaHadir', siswaHadir);
            animateCounterUpdate('siswaTidakHadir', siswaTidakHadir);
            animateCounterUpdate('siswaIzin', siswaIzin);
            animateCounterUpdate('siswaSakit', siswaSakit);
            animateCounterUpdate('siswaAlpha', siswaAlpha);

            // Guru stats
            const totalGuru = allData.guru.length;
            const guruAbsensiSelected = selectedDateAbsensi.filter(a => a.jenis === 'guru');
            const guruHadir = guruAbsensiSelected.filter(a => a.status === 'Hadir').length;
            const guruIzin = guruAbsensiSelected.filter(a => a.status === 'Izin').length;
            const guruSakit = guruAbsensiSelected.filter(a => a.status === 'Sakit').length;
            const guruAlpha = guruAbsensiSelected.filter(a => a.status === 'Alpha').length;
            
            // Calculate guru tidak hadir (Izin + Sakit + Alpha)
            const guruTidakHadir = guruIzin + guruSakit + guruAlpha;
            
            console.log('Guru stats for', targetDate, ':', { totalGuru, guruHadir, guruTidakHadir, guruIzin, guruSakit, guruAlpha });
            
            // Update with animation
            animateCounterUpdate('totalGuru', totalGuru);
            animateCounterUpdate('guruHadir', guruHadir);
            animateCounterUpdate('guruTidakHadir', guruTidakHadir);
            animateCounterUpdate('guruIzin', guruIzin);
            animateCounterUpdate('guruSakit', guruSakit);
            animateCounterUpdate('guruAlpha', guruAlpha);
        }

        // Animate counter updates for real-time feel
        function animateCounterUpdate(elementId, newValue) {
            const element = document.getElementById(elementId);
            const currentValue = parseInt(element.textContent) || 0;
            
            if (currentValue !== newValue) {
                element.style.transform = 'scale(1.1)';
                element.style.transition = 'transform 0.2s ease';
                
                setTimeout(() => {
                    element.textContent = newValue;
                    element.style.transform = 'scale(1)';
                }, 100);
            }
        }

        // Enhanced manual refresh statistics function with maximum data refresh
        async function refreshStatistikManual() {
            const refreshBtn = document.getElementById('refreshStatistikBtn');
            const refreshText = document.getElementById('refreshStatistikText');
            const refreshLoader = document.getElementById('refreshStatistikLoader');
            
            // Show loading
            refreshBtn.disabled = true;
            refreshText.textContent = 'üîÑ Refreshing...';
            refreshLoader.classList.remove('hidden');
            
            try {
                // ENHANCED: Force complete refresh of ALL data from Google Sheets for maximum accuracy
                console.log('üîÑ Force refreshing ALL data from Google Sheets for maximum statistics accuracy...');
                showToast('üîÑ Memuat data terbaru dari Google Sheets...', 'info');
                
                // Complete refresh of all data
                await loadAllData();
                
                // FIXED: Always use H-1 (yesterday) for statistics refresh
                const yesterday = getYesterdayDate();
                await updateInfoCards(yesterday);
                
                showToast('‚úÖ Statistik H-1 berhasil diperbarui dengan data terbaru!', 'success');
                console.log('üìä Statistics refreshed with latest data for H-1 date:', yesterday);
                
            } catch (error) {
                console.error('‚ùå Error refreshing statistics:', error);
                showToast('‚ùå Gagal memperbarui statistik', 'error');
            } finally {
                // Hide loading
                refreshBtn.disabled = false;
                refreshText.textContent = 'Refresh';
                refreshLoader.classList.add('hidden');
            }
        }

        // Update info cards with enhanced animation
        function updateInfoCardsWithAnimation() {
            // FIXED: Always use H-1 (yesterday) for statistics data
            const yesterday = getYesterdayDate();
            console.log('Updating statistics with animation for H-1 date:', yesterday);
            
            // Filter yesterday's absensi with comprehensive date matching
            const yesterdayAbsensi = allData.absensi.filter(a => {
                let absensiDateStr = a.tanggal;
                
                // Handle DD/MM/YYYY format from Google Sheets (our standard format)
                if (absensiDateStr && absensiDateStr.includes('/')) {
                    absensiDateStr = convertFromGoogleSheetsDateFormat(absensiDateStr);
                }
                
                // Handle Google Sheets date serial numbers
                if (absensiDateStr && !absensiDateStr.includes('-') && !absensiDateStr.includes('/')) {
                    const dateNum = parseFloat(absensiDateStr);
                    if (!isNaN(dateNum) && dateNum > 40000) {
                        const excelDate = new Date((dateNum - 25569) * 86400 * 1000);
                        absensiDateStr = excelDate.toLocaleDateString('en-CA', { timeZone: 'Asia/Jakarta' });
                    }
                }
                
                // Handle ISO date strings that might have time component
                if (absensiDateStr && absensiDateStr.includes('T')) {
                    absensiDateStr = absensiDateStr.split('T')[0];
                }
                
                return absensiDateStr === yesterday;
            });
            
            console.log('Yesterday absensi records found for animation:', yesterdayAbsensi.length);
            console.log('Sample yesterday records for animation:', yesterdayAbsensi.slice(0, 3));
            
            // Siswa stats
            const totalSiswa = allData.siswa.length;
            const siswaAbsensiYesterday = yesterdayAbsensi.filter(a => a.jenis === 'siswa');
            const siswaHadir = siswaAbsensiYesterday.filter(a => a.status === 'Hadir').length;
            const siswaIzin = siswaAbsensiYesterday.filter(a => a.status === 'Izin').length;
            const siswaSakit = siswaAbsensiYesterday.filter(a => a.status === 'Sakit').length;
            const siswaAlpha = siswaAbsensiYesterday.filter(a => a.status === 'Alpha').length;
            
            // Calculate siswa tidak hadir (Izin + Sakit + Alpha)
            const siswaTidakHadir = siswaIzin + siswaSakit + siswaAlpha;
            
            console.log('Siswa stats with animation:', { totalSiswa, siswaHadir, siswaTidakHadir, siswaIzin, siswaSakit, siswaAlpha });
            
            // Update with enhanced animation
            animateCounterUpdateEnhanced('totalSiswa', totalSiswa);
            animateCounterUpdateEnhanced('siswaHadir', siswaHadir);
            animateCounterUpdateEnhanced('siswaTidakHadir', siswaTidakHadir);
            animateCounterUpdateEnhanced('siswaIzin', siswaIzin);
            animateCounterUpdateEnhanced('siswaSakit', siswaSakit);
            animateCounterUpdateEnhanced('siswaAlpha', siswaAlpha);

            // Guru stats
            const totalGuru = allData.guru.length;
            const guruAbsensiYesterday = yesterdayAbsensi.filter(a => a.jenis === 'guru');
            const guruHadir = guruAbsensiYesterday.filter(a => a.status === 'Hadir').length;
            const guruIzin = guruAbsensiYesterday.filter(a => a.status === 'Izin').length;
            const guruSakit = guruAbsensiYesterday.filter(a => a.status === 'Sakit').length;
            const guruAlpha = guruAbsensiYesterday.filter(a => a.status === 'Alpha').length;
            
            // Calculate guru tidak hadir (Izin + Sakit + Alpha)
            const guruTidakHadir = guruIzin + guruSakit + guruAlpha;
            
            console.log('Guru stats with animation:', { totalGuru, guruHadir, guruTidakHadir, guruIzin, guruSakit, guruAlpha });
            
            // Update with enhanced animation
            animateCounterUpdateEnhanced('totalGuru', totalGuru);
            animateCounterUpdateEnhanced('guruHadir', guruHadir);
            animateCounterUpdateEnhanced('guruTidakHadir', guruTidakHadir);
            animateCounterUpdateEnhanced('guruIzin', guruIzin);
            animateCounterUpdateEnhanced('guruSakit', guruSakit);
            animateCounterUpdateEnhanced('guruAlpha', guruAlpha);
        }

        // Enhanced animation for counter updates
        function animateCounterUpdateEnhanced(elementId, newValue) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const currentValue = parseInt(element.textContent) || 0;
            
            if (currentValue !== newValue) {
                // Add pulsing animation
                element.style.transform = 'scale(1.2)';
                element.style.transition = 'all 0.3s ease';
                element.style.backgroundColor = '#10B981'; // Green highlight
                element.style.color = 'white';
                element.style.borderRadius = '4px';
                element.style.padding = '2px 4px';
                
                setTimeout(() => {
                    element.textContent = newValue;
                    element.style.transform = 'scale(1)';
                    element.style.backgroundColor = 'transparent';
                    element.style.color = '';
                    element.style.padding = '';
                }, 200);
                
                // Remove border radius after animation
                setTimeout(() => {
                    element.style.borderRadius = '';
                }, 500);
            }
        }

        // Reset absensi form to default state (only after successful save)
        function resetAbsensiForm() {
            // Reset form fields to default
            document.getElementById('jenisAbsensi').value = '';
            document.getElementById('kelasAbsensi').value = '';
            
            // Hide kelas container
            document.getElementById('kelasContainer').classList.add('hidden');
            
            // Hide absensi list
            document.getElementById('absensiList').classList.add('hidden');
            
            // Clear current absensi data
            currentAbsensiData = [];
            
            // Reset date to today
            const today = getTodayDate();
            document.getElementById('tanggalAbsensi').value = today;
            
            console.log('Absensi form reset to default state');
        }

        // Preserve form state (keep jenis and kelas selected)
        function preserveAbsensiFormState() {
            // Don't reset form - keep current selections
            // Only hide the absensi list to allow new data loading
            document.getElementById('absensiList').classList.add('hidden');
            
            // Clear current absensi data for fresh loading
            currentAbsensiData = [];
            
            console.log('Absensi form state preserved');
        }

        // Preserve form state after successful save (for siswa - keep kelas selected)
        function preserveAbsensiFormStateAfterSave(jenis, kelas) {
            // Keep form fields as they are - don't reset
            // Only hide the absensi list to show save was successful
            document.getElementById('absensiList').classList.add('hidden');
            
            // Clear current absensi data
            currentAbsensiData = [];
            
            // Keep the form ready for next absensi input with same kelas
            console.log(`Absensi form state preserved after save - ${jenis} kelas ${kelas} tetap terpilih`);
            
            // Show helpful message
            showToast(`‚úÖ Form siap untuk absensi ${jenis} kelas ${kelas} berikutnya`, 'info');
        }

        // Start real-time statistics updates and auto-refresh
        function startRealtimeStatistics() {
            // Update statistics every 30 seconds for H-1 (yesterday)
            setInterval(async () => {
                try {
                    // FIXED: Always use H-1 (yesterday) for real-time statistics
                    const yesterday = getYesterdayDate();
                    await updateInfoCards(yesterday);
                } catch (error) {
                    console.error('Error updating real-time statistics:', error);
                }
            }, 30000); // 30 seconds
            
            // ENHANCED: Auto-refresh data master every 2 minutes for data consistency
            setInterval(async () => {
                try {
                    console.log('üîÑ Auto-refreshing data master for consistency...');
                    
                    // Determine which data master tab is currently active
                    const activeTab = document.querySelector('.data-tab-btn.active');
                    if (activeTab) {
                        const tabId = activeTab.id;
                        
                        // Only refresh if user is on data master tab
                        const dataMasterContent = document.getElementById('dataMasterContent');
                        if (dataMasterContent && !dataMasterContent.classList.contains('hidden')) {
                            
                            if (tabId === 'tabUsers') {
                                await fastRefreshSingleSheet('Users');
                                renderUsersDataTable();
                                console.log('üîÑ Auto-refreshed Users data');
                            } else if (tabId === 'tabSiswaData') {
                                await fastRefreshSingleSheet('Siswa');
                                renderSiswaDataTable();
                                populateKelasOptions(); // Update kelas options
                                console.log('üîÑ Auto-refreshed Siswa data');
                            } else if (tabId === 'tabGuruData') {
                                await fastRefreshSingleSheet('Guru');
                                renderGuruDataTable();
                                console.log('üîÑ Auto-refreshed Guru data');
                            } else if (tabId === 'tabJadwalData') {
                                await fastRefreshSingleSheet('Jadwal');
                                renderJadwalDataTable();
                                console.log('üîÑ Auto-refreshed Jadwal data');
                            }
                            
                            // Show subtle notification
                            showToast('üîÑ Data master diperbarui otomatis', 'info');
                        }
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error in auto-refresh data master:', error);
                }
            }, 120000); // 2 minutes
        }

        // Enhanced auto-sync for critical data changes
        function startEnhancedAutoSync() {
            // Monitor for critical data changes and auto-sync
            const originalPush = Array.prototype.push;
            const originalSplice = Array.prototype.splice;
            
            // Override push method for auto-sync detection
            ['users', 'siswa', 'guru', 'jadwal'].forEach(dataType => {
                if (allData[dataType]) {
                    // Monitor additions
                    const originalPush = allData[dataType].push;
                    allData[dataType].push = function(...items) {
                        const result = originalPush.apply(this, items);
                        console.log(`üìä Detected ${dataType} addition, scheduling background sync...`);
                        scheduleBackgroundSync(dataType);
                        return result;
                    };
                    
                    // Monitor deletions
                    const originalSplice = allData[dataType].splice;
                    allData[dataType].splice = function(...args) {
                        const result = originalSplice.apply(this, args);
                        console.log(`üìä Detected ${dataType} deletion, scheduling background sync...`);
                        scheduleBackgroundSync(dataType);
                        return result;
                    };
                }
            });
        }

        // Schedule background sync for data consistency
        function scheduleBackgroundSync(dataType) {
            // Debounce multiple rapid changes
            if (window.syncTimeouts && window.syncTimeouts[dataType]) {
                clearTimeout(window.syncTimeouts[dataType]);
            }
            
            if (!window.syncTimeouts) window.syncTimeouts = {};
            
            window.syncTimeouts[dataType] = setTimeout(async () => {
                try {
                    console.log(`üîÑ Background sync for ${dataType}...`);
                    await fastRefreshSingleSheet(dataType.charAt(0).toUpperCase() + dataType.slice(1));
                    console.log(`‚úÖ Background sync completed for ${dataType}`);
                } catch (error) {
                    console.error(`‚ùå Background sync failed for ${dataType}:`, error);
                }
            }, 5000); // 5 second delay to batch multiple changes
        }

        // Load laporan data with enhanced real-time updates and maximum refresh
        async function loadLaporanData() {
			// Tampilkan loading dan nonaktifkan tombol
			const tarikBtn = document.getElementById('tarikDataBtn');
			const tarikText = document.getElementById('tarikDataText');
			const tarikLoader = document.getElementById('tarikDataLoader');
			tarikBtn.disabled = true;
			tarikText.textContent = 'Memuat...';
			tarikLoader.classList.remove('hidden');

			try {
				// Ambil nilai filter
				const dariTanggalElement = document.getElementById('dariTanggal');
				const sampaiTanggalElement = document.getElementById('sampaiTanggal');
				const jenis = document.getElementById('jenisLaporan').value;
				const selectedKelas = document.getElementById('kelasLaporan').value;
				const tipeLaporan = document.querySelector('input[name="tipeLaporan"]:checked').value;

				const dariTanggal = dariTanggalElement.value; // Format: YYYY-MM-DD
				const sampaiTanggal = sampaiTanggalElement.value; // Format: YYYY-MM-DD

				// Hapus laporan sebelumnya
				document.getElementById('laporanDetailContainer').innerHTML = '';
				document.getElementById('laporanRekapContainer').innerHTML = '';
				document.getElementById('exportButtonsContainer').classList.add('hidden');

				if (!allData || !allData.absensi) {
					await fetchDataFromGoogleSheets();
				}

				if (!allData || !allData.absensi || allData.absensi.length === 0) {
					showToast('‚ö†Ô∏è Data Absensi Kosong. Tidak ada yang bisa ditarik.', 'warning');
					return;
				}

				console.log('üìã Sample absensi records:', allData.absensi.slice(0, 3));
				
				// ULTIMATE FIX: Enhanced filtering dengan perbandingan string tanggal YYYY-MM-DD
				let filteredAbsensi = allData.absensi.filter(a => {
					// Pastikan Anda sudah memiliki fungsi convertFromGoogleSheetsDateFormat()
					// (Fungsi ini harus ada di kode Anda, seperti yang terlihat di bagian lain)
					let absensiDateStr = convertFromGoogleSheetsDateFormat(a.tanggal);
					
					// Perbandingan String YYYY-MM-DD: Ini adalah FIX untuk masalah zona waktu
					// Memastikan data yang difilter HARI INI sesuai dengan tanggal input HARI INI.
					const isDateInRange = absensiDateStr >= dariTanggal && absensiDateStr <= sampaiTanggal;

					// Filter berdasarkan Jenis (Siswa/Guru)
					const isCorrectType = a.jenis.toLowerCase() === jenis.toLowerCase();

					// Filter berdasarkan Kelas (Hanya untuk Jenis: Siswa dan jika kelas dipilih)
					const isCorrectKelas = (jenis.toLowerCase() === 'siswa' && selectedKelas) 
										 ? (a.kelas.toLowerCase() === selectedKelas.toLowerCase()) 
										 : true;
					
					// Kembalikan hanya data yang sesuai dengan filter
					return isDateInRange && isCorrectType && isCorrectKelas;
				});

				console.log(`‚úÖ Total records filtered: ${filteredAbsensi.length}`);
				
				// Tampilkan tombol ekspor
				document.getElementById('exportButtonsContainer').classList.remove('hidden');

				// Simpan data laporan saat ini ke window object untuk fungsi export (PDF/Excel)
				window.currentReportData = {
					data: filteredAbsensi,
					tipeLaporan,
					jenis,
					kelas: selectedKelas,
					dariTanggal,
					sampaiTanggal
				};

				// Lanjutkan ke logika display/rekap
				if (tipeLaporan === 'detail') {
					displayDetailLaporan(filteredAbsensi, jenis, selectedKelas);
				} else if (tipeLaporan === 'rekap') {
					const rekapData = processRekap(filteredAbsensi, jenis, selectedKelas);
					displayRekapLaporan(rekapData, jenis, selectedKelas);
				}

			} catch (error) {
				console.error('‚ùå Error loading laporan data:', error);
				showToast('‚ùå Gagal memuat data laporan: ' + error.message, 'error');
			} finally {
				// Sembunyikan loading
				const tarikBtn = document.getElementById('tarikDataBtn');
				const tarikText = document.getElementById('tarikDataText');
				const tarikLoader = document.getElementById('tarikDataLoader');
				tarikBtn.disabled = false;
				tarikText.textContent = 'Tarik Data';
				tarikLoader.classList.add('hidden');
			}
		}

        // Generate recap data
        function generateRekapData(absensiData, jenis, kelas) {
            console.log('üìä Generating rekap data for:', { jenis, kelas, recordCount: absensiData.length });
            
            if (jenis === 'siswa') {
                // For siswa: generate per-individual summary (not per-class)
                const rekapMap = new Map();
                
                // Get siswa data for the selected class or all classes
                let targetSiswa = allData.siswa;
                if (kelas && kelas.trim() !== '') {
                    targetSiswa = allData.siswa.filter(s => s.kelas === kelas);
                    console.log('üìö Filtering siswa for kelas:', kelas, 'found:', targetSiswa.length);
                }
                
                // Initialize recap data for each siswa
                targetSiswa.forEach(siswa => {
                    rekapMap.set(siswa.nis, {
                        nama: siswa.nama,
                        id: siswa.nis,
                        kelas: siswa.kelas,
                        hadir: 0,
                        izin: 0,
                        sakit: 0,
                        alpha: 0,
                        total: 0,
                        persentaseHadir: 0
                    });
                });
                
                console.log('üë®‚Äçüéì Initialized siswa rekap map with', rekapMap.size, 'students');
                
                // Count attendance for each siswa
                absensiData.forEach(record => {
                    const key = record.nis_nuptk;
                    if (rekapMap.has(key)) {
                        const recap = rekapMap.get(key);
                        recap.total++;
                        
                        switch (record.status) {
                            case 'Hadir':
                                recap.hadir++;
                                break;
                            case 'Izin':
                                recap.izin++;
                                break;
                            case 'Sakit':
                                recap.sakit++;
                                break;
                            case 'Alpha':
                                recap.alpha++;
                                break;
                        }
                        
                        // Calculate percentage
                        recap.persentaseHadir = recap.total > 0 ? 
                            ((recap.hadir / recap.total) * 100).toFixed(1) : '0.0';
                    }
                });
                
                // Return only students with attendance records, sorted by percentage
                const result = Array.from(rekapMap.values())
                    .filter(item => item.total > 0)
                    .sort((a, b) => parseFloat(b.persentaseHadir) - parseFloat(a.persentaseHadir));
                
                console.log('üìä Generated siswa rekap result:', result.length, 'records with attendance');
                return result;
                
            } else {
                // For guru: generate per-individual summary
                const rekapMap = new Map();
                
                // Initialize recap data for all guru
                allData.guru.forEach(guru => {
                    rekapMap.set(guru.nip, {
                        nama: guru.nama,
                        id: guru.nip,
                        mata_pelajaran: guru.mata_pelajaran,
                        hadir: 0,
                        izin: 0,
                        sakit: 0,
                        alpha: 0,
                        total: 0,
                        persentaseHadir: 0
                    });
                });
                
                console.log('üë®‚Äçüè´ Initialized guru rekap map with', rekapMap.size, 'teachers');
                
                // Count attendance for each guru
                absensiData.forEach(record => {
                    const key = record.nis_nuptk;
                    if (rekapMap.has(key)) {
                        const recap = rekapMap.get(key);
                        recap.total++;
                        
                        switch (record.status) {
                            case 'Hadir':
                                recap.hadir++;
                                break;
                            case 'Izin':
                                recap.izin++;
                                break;
                            case 'Sakit':
                                recap.sakit++;
                                break;
                            case 'Alpha':
                                recap.alpha++;
                                break;
                        }
                        
                        // Calculate percentage
                        recap.persentaseHadir = recap.total > 0 ? 
                            ((recap.hadir / recap.total) * 100).toFixed(1) : '0.0';
                    }
                });
                
                // Return only teachers with attendance records, sorted by percentage
                const result = Array.from(rekapMap.values())
                    .filter(item => item.total > 0)
                    .sort((a, b) => parseFloat(b.persentaseHadir) - parseFloat(a.persentaseHadir));
                
                console.log('üìä Generated guru rekap result:', result.length, 'records with attendance');
                return result;
            }
        }

        // Render recap table with enhanced UI and better data presentation
        function renderRekapTable(rekapData, jenis) {
            const thead = document.getElementById('laporanTableHeader');
            const tbody = document.getElementById('laporanTableBody');
            
            // Clear existing content
            thead.innerHTML = '';
            tbody.innerHTML = '';
            
            // Create headers for recap based on jenis
            let headers = [];
            if (jenis === 'siswa') {
                headers = ['No', 'Nama Siswa', 'NIS', 'Kelas', 'Hadir', 'Izin', 'Sakit', 'Alpha', 'Total Hari', 'Persentase Kehadiran', 'Status'];
            } else {
                headers = ['No', 'Nama Guru', 'NUPTK', 'Mata Pelajaran', 'Hadir', 'Izin', 'Sakit', 'Alpha', 'Total Hari', 'Persentase Kehadiran', 'Status'];
            }
            
            headers.forEach(header => {
                const th = document.createElement('th');
                th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                th.textContent = header;
                thead.appendChild(th);
            });
            
            // Create rows for recap
            rekapData.forEach((item, index) => {
                const persentaseKehadiran = parseFloat(item.persentaseHadir);
                
                // Determine status and color based on attendance percentage
                let statusClass, statusText;
                if (persentaseKehadiran >= 95) {
                    statusClass = 'bg-green-100 text-green-800';
                    statusText = 'Sangat Baik';
                } else if (persentaseKehadiran >= 85) {
                    statusClass = 'bg-blue-100 text-blue-800';
                    statusText = 'Baik';
                } else if (persentaseKehadiran >= 75) {
                    statusClass = 'bg-yellow-100 text-yellow-800';
                    statusText = 'Cukup';
                } else if (persentaseKehadiran >= 60) {
                    statusClass = 'bg-orange-100 text-orange-800';
                    statusText = 'Kurang';
                } else {
                    statusClass = 'bg-red-100 text-red-800';
                    statusText = 'Perlu Perhatian';
                }
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors duration-200';
                
                let rowHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>`;
                
                if (jenis === 'siswa') {
                    rowHTML += `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${item.nama}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">${item.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                Kelas ${item.kelas}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-semibold">${item.hadir}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-yellow-600 font-semibold">${item.izin}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 font-semibold">${item.sakit}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-semibold">${item.alpha}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-bold">${item.total}</td>
                    `;
                } else {
                    rowHTML += `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${item.nama}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">${item.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">
                                ${item.mata_pelajaran}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-semibold">${item.hadir}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-yellow-600 font-semibold">${item.izin}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 font-semibold">${item.sakit}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-semibold">${item.alpha}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-bold">${item.total}</td>
                    `;
                }
                
                rowHTML += `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                                <div class="h-2 rounded-full ${
                                    persentaseKehadiran >= 90 ? 'bg-green-500' :
                                    persentaseKehadiran >= 75 ? 'bg-yellow-500' :
                                    'bg-red-500'
                                }" style="width: ${persentaseKehadiran}%"></div>
                            </div>
                            <span class="text-sm font-semibold text-gray-900">${item.persentaseHadir}%</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                `;
                
                row.innerHTML = rowHTML;
                tbody.appendChild(row);
            });
            
            // Add summary row at the bottom
            if (rekapData.length > 0) {
                const totalHadir = rekapData.reduce((sum, item) => sum + item.hadir, 0);
                const totalIzin = rekapData.reduce((sum, item) => sum + item.izin, 0);
                const totalSakit = rekapData.reduce((sum, item) => sum + item.sakit, 0);
                const totalAlpha = rekapData.reduce((sum, item) => sum + item.alpha, 0);
                const totalKeseluruhan = rekapData.reduce((sum, item) => sum + item.total, 0);
                const rataRataKehadiran = totalKeseluruhan > 0 ? ((totalHadir / totalKeseluruhan) * 100).toFixed(1) : '0.0';
                
                const summaryRow = document.createElement('tr');
                summaryRow.className = 'bg-gray-100 font-semibold border-t-2 border-gray-300';
                
                let summaryHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-bold">TOTAL</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-bold">${rekapData.length} ${jenis}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">-</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">-</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-bold">${totalHadir}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-yellow-600 font-bold">${totalIzin}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 font-bold">${totalSakit}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-bold">${totalAlpha}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-bold">${totalKeseluruhan}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                                <div class="h-2 rounded-full ${
                                    parseFloat(rataRataKehadiran) >= 90 ? 'bg-green-500' :
                                    parseFloat(rataRataKehadiran) >= 75 ? 'bg-yellow-500' :
                                    'bg-red-500'
                                }" style="width: ${rataRataKehadiran}%"></div>
                            </div>
                            <span class="text-sm font-bold text-gray-900">${rataRataKehadiran}%</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            parseFloat(rataRataKehadiran) >= 90 ? 'bg-green-100 text-green-800' :
                            parseFloat(rataRataKehadiran) >= 75 ? 'bg-yellow-100 text-yellow-800' :
                            'bg-red-100 text-red-800'
                        }">
                            Rata-rata
                        </span>
                    </td>
                `;
                
                summaryRow.innerHTML = summaryHTML;
                tbody.appendChild(summaryRow);
            }
        }

        // Render laporan table
        function renderLaporanTable(data, jenis) {
            const thead = document.getElementById('laporanTableHeader');
            const tbody = document.getElementById('laporanTableBody');
            
            // Clear existing content
            thead.innerHTML = '';
            tbody.innerHTML = '';
            
            // Create headers
            const headers = ['No', 'Tanggal', 'Nama', jenis === 'siswa' ? 'NIS' : 'NUPTK', 'Kelas', 'Status', 'Keterangan'];
            headers.forEach(header => {
                const th = document.createElement('th');
                th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                th.textContent = header;
                thead.appendChild(th);
            });
            
            // Create rows
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors duration-200';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">
                        <span class="px-2 py-1 bg-gray-100 rounded text-xs">
                            ${formatDateForDisplay(item.tanggal)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${item.nama}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">${item.nis_nuptk}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${item.kelas ? `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Kelas ${item.kelas}</span>` : '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            item.status === 'Hadir' ? 'bg-green-100 text-green-800' :
                            item.status === 'Izin' ? 'bg-yellow-100 text-yellow-800' :
                            item.status === 'Sakit' ? 'bg-blue-100 text-blue-800' :
                            'bg-red-100 text-red-800'
                        }">
                            ${item.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate" title="${item.keterangan || ''}">${item.keterangan || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Cetak PDF
        function cetakPDF() {
            if (!window.currentReportData || !window.currentReportData.data.length) {
                showToast('Tidak ada data laporan untuk dicetak. Silakan tarik data terlebih dahulu.', 'error');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Header
                doc.setFontSize(16);
                const reportTitle = window.currentReportData.tipeLaporan === 'rekap' ? 
                    'Rekapitulasi Absensi SMP Purnawarman' : 
                    'Laporan Absensi SMP Purnawarman';
                doc.text(reportTitle, 20, 20);
                
                doc.setFontSize(12);
                doc.text(`Jenis: ${window.currentReportData.jenis}`, 20, 35);
                if (window.currentReportData.kelas) {
                    doc.text(`Kelas: ${window.currentReportData.kelas}`, 20, 45);
                }
                doc.text(`Periode: ${window.currentReportData.dariTanggal} s/d ${window.currentReportData.sampaiTanggal}`, 20, 55);
                
                let yPos = 75;
                
                if (window.currentReportData.tipeLaporan === 'rekap') {
                    // Generate recap data for PDF
                    const rekapData = generateRekapData(window.currentReportData.data, window.currentReportData.jenis, window.currentReportData.kelas);
                    doc.text(`Total ${window.currentReportData.jenis}: ${rekapData.length}`, 20, 65);
                    
                    // Recap table headers
                    const headers = ['No', 'Nama', window.currentReportData.jenis === 'siswa' ? 'NIS' : 'NUPTK'];
                    if (window.currentReportData.jenis === 'siswa') headers.push('Kelas');
                    headers.push('H', 'I', 'S', 'A', 'Total', '%');
                    
                    doc.setFontSize(10);
                    headers.forEach((header, index) => {
                        doc.text(header, 20 + (index * 20), yPos);
                    });
                    
                    yPos += 10;
                    
                    // Recap table data
                    rekapData.forEach((item, index) => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }
                        
                        const persentase = item.total > 0 ? ((item.hadir / item.total) * 100).toFixed(1) : '0.0';
                        const row = [
                            (index + 1).toString(),
                            item.nama.substring(0, 12),
                            item.id.substring(0, 10)
                        ];
                        
                        if (window.currentReportData.jenis === 'siswa') {
                            row.push(item.kelas);
                        }
                        
                        row.push(
                            item.hadir.toString(),
                            item.izin.toString(),
                            item.sakit.toString(),
                            item.alpha.toString(),
                            item.total.toString(),
                            persentase + '%'
                        );
                        
                        row.forEach((cell, cellIndex) => {
                            doc.text(cell, 20 + (cellIndex * 20), yPos);
                        });
                        
                        yPos += 8;
                    });
                } else {
                    // Detail report
                    doc.text(`Total Record: ${window.currentReportData.data.length}`, 20, 65);
                    
                    // Table headers
                    const headers = ['No', 'Tanggal', 'Nama', window.currentReportData.jenis === 'siswa' ? 'NIS' : 'NUPTK', 'Kelas', 'Status', 'Keterangan'];
                    
                    doc.setFontSize(10);
                    headers.forEach((header, index) => {
                        doc.text(header, 20 + (index * 25), yPos);
                    });
                    
                    yPos += 10;
                    
                    // Table data
                    window.currentReportData.data.forEach((item, index) => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }
                        
                        const row = [
                            (index + 1).toString(),
                            formatDateForDisplay(item.tanggal) || '-',
                            item.nama || '-',
                            item.nis_nuptk || '-',
                            item.kelas || '-',
                            item.status || '-',
                            item.keterangan || '-'
                        ];
                        
                        row.forEach((cell, cellIndex) => {
                            doc.text(cell.substring(0, 15), 20 + (cellIndex * 25), yPos);
                        });
                        
                        yPos += 8;
                    });
                }
                
                // Save PDF
                const reportType = window.currentReportData.tipeLaporan === 'rekap' ? 'Rekap' : 'Detail';
                const fileName = `${reportType}_Absensi_${window.currentReportData.jenis}_${window.currentReportData.dariTanggal}_${window.currentReportData.sampaiTanggal}.pdf`;
                doc.save(fileName);
                
                showToast('‚úÖ PDF berhasil diunduh!', 'success');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showToast('‚ùå Gagal membuat PDF: ' + error.message, 'error');
            }
        }



        // Export Excel dengan rentang tanggal
        function cetakExcel() {
            if (!window.currentReportData || !window.currentReportData.data.length) {
                showToast('Tidak ada data laporan untuk diexport. Silakan tarik data terlebih dahulu.', 'error');
                return;
            }

            try {
                let wsData, headers, summaryData, colWidths;
                
                if (window.currentReportData.tipeLaporan === 'rekap') {
                    // Generate recap data for Excel
                    const rekapData = generateRekapData(window.currentReportData.data, window.currentReportData.jenis, window.currentReportData.kelas);
                    
                    // Prepare recap headers based on jenis
                    if (window.currentReportData.jenis === 'siswa') {
                        headers = ['No', 'Kelas', 'Total Siswa', 'Hadir', 'Izin', 'Sakit', 'Alpha', 'Total Absensi', 'Persentase Kehadiran'];
                    } else {
                        headers = ['No', 'Nama', 'NUPTK', 'Hadir', 'Izin', 'Sakit', 'Alpha', 'Total', 'Persentase Kehadiran'];
                    }
                    
                    // Create worksheet data for recap
                    wsData = [headers];
                    
                    rekapData.forEach((item, index) => {
                        let row = [];
                        
                        if (window.currentReportData.jenis === 'siswa') {
                            // For siswa (per-class summary)
                            const persentase = item.totalAbsensi > 0 ? ((item.hadir / item.totalAbsensi) * 100).toFixed(1) + '%' : '0.0%';
                            row = [
                                index + 1,
                                item.kelas,
                                item.totalSiswa,
                                item.hadir,
                                item.izin,
                                item.sakit,
                                item.alpha,
                                item.totalAbsensi,
                                persentase
                            ];
                        } else {
                            // For guru (per-individual summary)
                            const persentase = item.total > 0 ? ((item.hadir / item.total) * 100).toFixed(1) + '%' : '0.0%';
                            row = [
                                index + 1,
                                item.nama,
                                item.id,
                                item.hadir,
                                item.izin,
                                item.sakit,
                                item.alpha,
                                item.total,
                                persentase
                            ];
                        }
                        
                        wsData.push(row);
                    });
                    
                    // Summary for recap
                    summaryData = [
                        ['REKAPITULASI ABSENSI SMP PURNAWARMAN'],
                        [''],
                        [`Jenis: ${window.currentReportData.jenis}`],
                        [`Kelas: ${window.currentReportData.kelas || 'Semua Kelas'}`],
                        [`Periode: ${window.currentReportData.dariTanggal} s/d ${window.currentReportData.sampaiTanggal}`],
                        [`Total ${window.currentReportData.jenis === 'siswa' ? 'Kelas' : 'Guru'}: ${rekapData.length}`],
                        [`Tanggal Export: ${new Date().toLocaleDateString('id-ID')}`],
                        [''],
                        ...wsData
                    ];
                    
                    // Column widths for recap
                    if (window.currentReportData.jenis === 'siswa') {
                        colWidths = [
                            { wch: 5 },  // No
                            { wch: 8 },  // Kelas
                            { wch: 12 }, // Total Siswa
                            { wch: 8 },  // Hadir
                            { wch: 8 },  // Izin
                            { wch: 8 },  // Sakit
                            { wch: 8 },  // Alpha
                            { wch: 15 }, // Total Absensi
                            { wch: 18 }  // Persentase
                        ];
                    } else {
                        colWidths = [
                            { wch: 5 },  // No
                            { wch: 25 }, // Nama
                            { wch: 15 }, // NUPTK
                            { wch: 8 },  // Hadir
                            { wch: 8 },  // Izin
                            { wch: 8 },  // Sakit
                            { wch: 8 },  // Alpha
                            { wch: 8 },  // Total
                            { wch: 18 }  // Persentase
                        ];
                    }
                    
                } else {
                    // Detail report
                    const reportData = window.currentReportData.data;
                    headers = ['No', 'Tanggal', 'Nama', window.currentReportData.jenis === 'siswa' ? 'NIS' : 'NUPTK', 'Kelas', 'Status', 'Keterangan'];
                    
                    // Create worksheet data
                    wsData = [headers];
                    
                    reportData.forEach((item, index) => {
                        wsData.push([
                            index + 1,
                            formatDateForDisplay(item.tanggal) || '-',
                            item.nama || '-',
                            item.nis_nuptk || '-',
                            item.kelas || '-',
                            item.status || '-',
                            item.keterangan || '-'
                        ]);
                    });
                    
                    // Add summary info at the top
                    summaryData = [
                        ['LAPORAN ABSENSI SMP PURNAWARMAN'],
                        [''],
                        [`Jenis: ${window.currentReportData.jenis}`],
                        [`Kelas: ${window.currentReportData.kelas || 'Semua Kelas'}`],
                        [`Periode: ${window.currentReportData.dariTanggal} s/d ${window.currentReportData.sampaiTanggal}`],
                        [`Total Record: ${reportData.length}`],
                        [`Tanggal Export: ${new Date().toLocaleDateString('id-ID')}`],
                        [''],
                        ...wsData
                    ];
                    
                    // Set column widths
                    colWidths = [
                        { wch: 5 },  // No
                        { wch: 12 }, // Tanggal
                        { wch: 25 }, // Nama
                        { wch: 15 }, // NIS/NUPTK
                        { wch: 8 },  // Kelas
                        { wch: 10 }, // Status
                        { wch: 30 }  // Keterangan
                    ];
                }
                
                // Create workbook and worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(summaryData);
                
                ws['!cols'] = colWidths;
                
                // Style the header row
                const headerRowIndex = 8; // Row where actual data headers start (0-indexed)
                for (let col = 0; col < headers.length; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: headerRowIndex, c: col });
                    if (!ws[cellAddress]) ws[cellAddress] = {};
                    ws[cellAddress].s = {
                        font: { bold: true },
                        fill: { fgColor: { rgb: "CCCCCC" } },
                        alignment: { horizontal: "center" }
                    };
                }
                
                // Add worksheet to workbook
                const sheetName = window.currentReportData.tipeLaporan === 'rekap' ? 'Rekapitulasi Absensi' : 'Laporan Absensi';
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
                
                // Generate filename
                const reportType = window.currentReportData.tipeLaporan === 'rekap' ? 'Rekap' : 'Laporan';
                const fileName = `${reportType}_Absensi_${window.currentReportData.jenis}_${window.currentReportData.dariTanggal}_${window.currentReportData.sampaiTanggal}.xlsx`;
                
                // Save file
                XLSX.writeFile(wb, fileName);
                
                const recordCount = window.currentReportData.tipeLaporan === 'rekap' ? 
                    generateRekapData(window.currentReportData.data, window.currentReportData.jenis, window.currentReportData.kelas).length :
                    window.currentReportData.data.length;
                    
                showToast(`‚úÖ Excel berhasil diexport! (${recordCount} record)`, 'success');
                
            } catch (error) {
                console.error('Error exporting Excel:', error);
                showToast('‚ùå Gagal export Excel: ' + error.message, 'error');
            }
        }

        // Logout
        function logout() {
            currentUser = null;
            clearUserSession(); // Clear session storage
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            // Clear form
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            showToast('Anda telah logout', 'info');
        }

        // Modal and form handling variables
        let currentEditMode = 'add'; // 'add' or 'edit'
        let currentSheetName = '';
        let currentRowIndex = -1;
        let currentDeleteCallback = null;

        // Data Master tab switching
        function switchDataTab(tabId) {
            // Remove active class from all data tabs
            document.querySelectorAll('.data-tab-btn').forEach(btn => {
                btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });

            // Hide all data tab contents
            document.querySelectorAll('.data-tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Show selected tab
            const selectedTab = document.getElementById(tabId);
            selectedTab.classList.add('active', 'border-blue-500', 'text-blue-600');
            selectedTab.classList.remove('border-transparent', 'text-gray-500');

            // Show corresponding content and render existing data first
            if (tabId === 'tabUsers') {
                document.getElementById('usersContent').classList.remove('hidden');
                renderUsersDataTable(); // Render existing data first
            } else if (tabId === 'tabSiswaData') {
                document.getElementById('siswaDataContent').classList.remove('hidden');
                renderSiswaDataTable(); // Render existing data first
            } else if (tabId === 'tabGuruData') {
                document.getElementById('guruDataContent').classList.remove('hidden');
                renderGuruDataTable(); // Render existing data first
            } else if (tabId === 'tabJadwalData') {
                document.getElementById('jadwalDataContent').classList.remove('hidden');
                renderJadwalDataTable(); // Render existing data first
            }
        }

        // Fast refresh functions for data master
        async function fastRefreshSingleSheet(sheetName) {
            try {
                const appsScript = new AppsScriptAPI(appsScriptConfig.webAppUrl);
                const result = await appsScript.getData(sheetName);
                
                if (result.success && result.data && result.data.length > 1) {
                    const headers = result.data[0];
                    const processedData = result.data.slice(1).filter(row => row.some(cell => cell && cell.toString().trim())).map(row => {
                        const item = {};
                        headers.forEach((header, index) => {
                            let key = header.toLowerCase().replace(' ', '_');
                            if (sheetName === 'Siswa') {
                                key = header.toLowerCase() === 'nis' ? 'nis' : 
                                     header.toLowerCase() === 'nama' ? 'nama' :
                                     header.toLowerCase() === 'kelas' ? 'kelas' :
                                     header.toLowerCase() === 'jk' ? 'jenis_kelamin' :
                                     header.toLowerCase() === 'alamat' ? 'alamat' : header.toLowerCase();
                            } else if (sheetName === 'Guru') {
                                key = header.toLowerCase() === 'nuptk' ? 'nip' : 
                                     header.toLowerCase() === 'nama' ? 'nama' :
                                     header.toLowerCase() === 'mapel' ? 'mata_pelajaran' :
                                     header.toLowerCase() === 'jk' ? 'jenis_kelamin' :
                                     header.toLowerCase() === 'alamat' ? 'alamat' : header.toLowerCase();
                            }
                            item[key] = row[index] || '';
                        });
                        return item;
                    });
                    
                    // Update specific data array
                    if (sheetName === 'Users') allData.users = processedData;
                    else if (sheetName === 'Siswa') allData.siswa = processedData;
                    else if (sheetName === 'Guru') allData.guru = processedData;
                    else if (sheetName === 'Jadwal') allData.jadwal = processedData;
                    
                    return true;
                }
                return false;
            } catch (error) {
                console.error(`Error refreshing ${sheetName}:`, error);
                return false;
            }
        }

        // Load siswa data table (optimized)
        async function loadSiswaDataTable() {
            const refreshBtn = document.getElementById('refreshSiswaDataBtn');
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<span class="loading inline-block mr-1"></span>Refreshing...';
            }
            
            try {
                // Fast refresh only siswa data
                await fastRefreshSingleSheet('Siswa');
                renderSiswaDataTable();
                showToast('‚úÖ Data siswa berhasil diperbarui!', 'success');
            } catch (error) {
                showToast('‚ùå Gagal memperbarui data siswa', 'error');
            } finally {
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>Refresh';
                }
            }
        }

        // Render siswa data table with enhanced UI
        function renderSiswaDataTable() {
            const tbody = document.getElementById('siswaDataTableBody');
            tbody.innerHTML = '';

            allData.siswa.forEach((siswa, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors duration-200';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">${siswa.nis}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${siswa.nama}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                            Kelas ${siswa.kelas}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            siswa.jenis_kelamin === 'L' ? 'bg-blue-100 text-blue-800' : 'bg-pink-100 text-pink-800'
                        }">
                            ${siswa.jenis_kelamin === 'L' ? 'Laki-laki' : 'Perempuan'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate" title="${siswa.alamat}">${siswa.alamat}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="openEditModal('Siswa', ${index})" class="inline-flex items-center px-3 py-1 border border-transparent text-xs leading-4 font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 mr-2 transition-colors duration-200">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                            Edit
                        </button>
                        <button onclick="openDeleteConfirm('Siswa', ${index}, '${siswa.nama}')" class="inline-flex items-center px-3 py-1 border border-transparent text-xs leading-4 font-medium rounded-md text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            Hapus
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load guru data table (optimized)
        async function loadGuruDataTable() {
            const refreshBtn = document.getElementById('refreshGuruDataBtn');
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<span class="loading inline-block mr-1"></span>Refreshing...';
            }
            
            try {
                // Fast refresh only guru data
                await fastRefreshSingleSheet('Guru');
                renderGuruDataTable();
                showToast('‚úÖ Data guru berhasil diperbarui!', 'success');
            } catch (error) {
                showToast('‚ùå Gagal memperbarui data guru', 'error');
            } finally {
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>Refresh';
                }
            }
        }

        // Render guru data table with enhanced UI
        function renderGuruDataTable() {
            const tbody = document.getElementById('guruDataTableBody');
            tbody.innerHTML = '';

            allData.guru.forEach((guru, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors duration-200';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">${guru.nip}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${guru.nama}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                            ${guru.mata_pelajaran}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            guru.jenis_kelamin === 'L' ? 'bg-blue-100 text-blue-800' : 'bg-pink-100 text-pink-800'
                        }">
                            ${guru.jenis_kelamin === 'L' ? 'Laki-laki' : 'Perempuan'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate" title="${guru.alamat}">${guru.alamat}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="openEditModal('Guru', ${index})" class="inline-flex items-center px-3 py-1 border border-transparent text-xs leading-4 font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 mr-2 transition-colors duration-200">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                            Edit
                        </button>
                        <button onclick="openDeleteConfirm('Guru', ${index}, '${guru.nama}')" class="inline-flex items-center px-3 py-1 border border-transparent text-xs leading-4 font-medium rounded-md text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            Hapus
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load users data (optimized)
        async function loadUsersData() {
            const refreshBtn = document.getElementById('refreshUsersBtn');
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<span class="loading inline-block mr-1"></span>Refreshing...';
            }
            
            try {
                // Fast refresh only users data
                await fastRefreshSingleSheet('Users');
                renderUsersDataTable();
                showToast('‚úÖ Data users berhasil diperbarui!', 'success');
            } catch (error) {
                showToast('‚ùå Gagal memperbarui data users', 'error');
            } finally {
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>Refresh';
                }
            }
        }

        // Render users data table with enhanced UI
        function renderUsersDataTable() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            allData.users.forEach((user, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors duration-200';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.username}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${user.nama}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            user.role === 'Admin' ? 'bg-purple-100 text-purple-800' :
                            user.role === 'Kepala Sekolah' ? 'bg-blue-100 text-blue-800' :
                            'bg-green-100 text-green-800'
                        }">
                            ${user.role}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.hari_piket || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="openEditModal('Users', ${index})" class="inline-flex items-center px-3 py-1 border border-transparent text-xs leading-4 font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 mr-2 transition-colors duration-200">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                            Edit
                        </button>
                        <button onclick="openDeleteConfirm('Users', ${index}, '${user.nama}')" class="inline-flex items-center px-3 py-1 border border-transparent text-xs leading-4 font-medium rounded-md text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            Hapus
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load jadwal data table (optimized)
        async function loadJadwalDataTable() {
            const refreshBtn = document.getElementById('refreshJadwalDataBtn');
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<span class="loading inline-block mr-1"></span>Refreshing...';
            }
            
            try {
                // Fast refresh only jadwal data
                await fastRefreshSingleSheet('Jadwal');
                renderJadwalDataTable();
                showToast('‚úÖ Data jadwal berhasil diperbarui!', 'success');
            } catch (error) {
                showToast('‚ùå Gagal memperbarui data jadwal', 'error');
            } finally {
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>Refresh';
                }
            }
        }

        // Render jadwal data table with enhanced UI
        function renderJadwalDataTable() {
            const tbody = document.getElementById('jadwalDataTableBody');
            tbody.innerHTML = '';

            allData.jadwal.forEach((jadwal, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors duration-200';
                
                // Color coding for days
                const dayColors = {
                    'Senin': 'bg-red-100 text-red-800',
                    'Selasa': 'bg-orange-100 text-orange-800',
                    'Rabu': 'bg-yellow-100 text-yellow-800',
                    'Kamis': 'bg-green-100 text-green-800',
                    'Jumat': 'bg-blue-100 text-blue-800'
                };
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${dayColors[jadwal.hari] || 'bg-gray-100 text-gray-800'}">
                            ${jadwal.hari}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">
                        <span class="px-2 py-1 bg-gray-100 rounded text-xs">
                            ${jadwal.jam_mulai} - ${jadwal.jam_selesai}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                            Kelas ${jadwal.kelas}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">${jadwal.nuptk}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${jadwal.nama_guru}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">
                            ${jadwal.mapel}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="openEditModal('Jadwal', ${index})" class="inline-flex items-center px-3 py-1 border border-transparent text-xs leading-4 font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 mr-2 transition-colors duration-200">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                            Edit
                        </button>
                        <button onclick="openDeleteConfirm('Jadwal', ${index}, '${jadwal.nama_guru} - ${jadwal.mapel}')" class="inline-flex items-center px-3 py-1 border border-transparent text-xs leading-4 font-medium rounded-md text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            Hapus
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Open add modal
        function openAddModal(sheetName) {
            currentEditMode = 'add';
            currentSheetName = sheetName;
            currentRowIndex = -1;
            
            document.getElementById('modalTitle').textContent = `Tambah ${sheetName}`;
            generateFormFields(sheetName);
            document.getElementById('dataModal').classList.remove('hidden');
        }

        // Open edit modal
        function openEditModal(sheetName, rowIndex) {
            currentEditMode = 'edit';
            currentSheetName = sheetName;
            currentRowIndex = rowIndex;
            
            document.getElementById('modalTitle').textContent = `Edit ${sheetName}`;
            generateFormFields(sheetName, rowIndex);
            document.getElementById('dataModal').classList.remove('hidden');
        }

        // Generate form fields based on sheet type
        function generateFormFields(sheetName, rowIndex = -1) {
            const formFields = document.getElementById('formFields');
            formFields.innerHTML = '';
            
            let fields = [];
            let data = null;
            
            if (rowIndex >= 0) {
                if (sheetName === 'Users') data = allData.users[rowIndex];
                else if (sheetName === 'Siswa') data = allData.siswa[rowIndex];
                else if (sheetName === 'Guru') data = allData.guru[rowIndex];
                else if (sheetName === 'Jadwal') data = allData.jadwal[rowIndex];
            }
            
            switch (sheetName) {
                case 'Users':
                    fields = [
                        { name: 'username', label: 'Username', type: 'text', required: true, primaryKey: true },
                        { name: 'password', label: 'Password', type: 'password', required: true },
                        { name: 'nama', label: 'Nama', type: 'text', required: true },
                        { name: 'role', label: 'Role', type: 'select', options: ['Admin', 'Kepala Sekolah', 'Guru Piket'], required: true },
                        { name: 'hari_piket', label: 'Hari Piket', type: 'select', options: ['', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat'] }
                    ];
                    break;
                case 'Siswa':
                    fields = [
                        { name: 'nis', label: 'NIS (Primary Key)', type: 'text', required: true, primaryKey: true },
                        { name: 'nama', label: 'Nama', type: 'text', required: true },
                        { name: 'kelas', label: 'Kelas', type: 'text', required: true },
                        { name: 'jenis_kelamin', label: 'Jenis Kelamin', type: 'select', options: ['L', 'P'], required: true },
                        { name: 'alamat', label: 'Alamat', type: 'textarea', required: true }
                    ];
                    break;
                case 'Guru':
                    fields = [
                        { name: 'nip', label: 'NUPTK (Primary Key)', type: 'text', required: true, primaryKey: true },
                        { name: 'nama', label: 'Nama', type: 'text', required: true },
                        { name: 'mata_pelajaran', label: 'Mata Pelajaran', type: 'text', required: true },
                        { name: 'jenis_kelamin', label: 'Jenis Kelamin', type: 'select', options: ['L', 'P'], required: true },
                        { name: 'alamat', label: 'Alamat', type: 'textarea', required: true }
                    ];
                    break;
                case 'Jadwal':
                    fields = [
                        { name: 'hari', label: 'Hari', type: 'select', options: ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat'], required: true },
                        { name: 'jam_mulai', label: 'Jam Mulai', type: 'time', required: true },
                        { name: 'jam_selesai', label: 'Jam Selesai', type: 'time', required: true },
                        { name: 'kelas', label: 'Kelas', type: 'text', required: true },
                        { name: 'nuptk', label: 'NUPTK', type: 'text', required: true },
                        { name: 'nama_guru', label: 'Nama Guru', type: 'text', required: true },
                        { name: 'mapel', label: 'Mata Pelajaran', type: 'text', required: true }
                    ];
                    break;
            }
            
            fields.forEach(field => {
                const div = document.createElement('div');
                const isReadOnly = field.primaryKey && currentEditMode === 'edit';
                const readOnlyAttr = isReadOnly ? 'readonly' : '';
                const readOnlyClass = isReadOnly ? 'bg-gray-100 cursor-not-allowed' : '';
                
                div.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        ${field.label}
                        ${field.primaryKey ? '<span class="text-xs text-blue-600">(Primary Key)</span>' : ''}
                    </label>
                    ${field.type === 'select' ? 
                        `<select name="${field.name}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 ${readOnlyClass}" ${field.required ? 'required' : ''} ${isReadOnly ? 'disabled' : ''}>
                            ${field.options.map(option => 
                                `<option value="${option}" ${data && data[field.name] === option ? 'selected' : ''}>${option || 'Pilih...'}</option>`
                            ).join('')}
                        </select>` :
                        field.type === 'textarea' ?
                        `<textarea name="${field.name}" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 ${readOnlyClass}" ${field.required ? 'required' : ''} placeholder="${field.label}" ${readOnlyAttr}>${data ? data[field.name] || '' : ''}</textarea>` :
                        `<input type="${field.type}" name="${field.name}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 ${readOnlyClass}" ${field.required ? 'required' : ''} placeholder="${field.label}" value="${data ? data[field.name] || '' : ''}" ${readOnlyAttr}>`
                    }
                    ${isReadOnly ? '<p class="text-xs text-gray-500 mt-1">Primary key tidak dapat diubah saat edit</p>' : ''}
                `;
                formFields.appendChild(div);
            });
        }

        // Handle form submit with enhanced auto-update and guaranteed Google Sheets save
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            console.log('üìù Form data to save:', data);
            console.log('üîß Current edit mode:', currentEditMode);
            console.log('üìä Current sheet name:', currentSheetName);
            console.log('üìç Current row index:', currentRowIndex);
            
            // Validate primary key uniqueness for new records
            if (currentEditMode === 'add') {
                const primaryKeyField = getPrimaryKeyField(currentSheetName);
                if (primaryKeyField && data[primaryKeyField]) {
                    const isDuplicate = checkPrimaryKeyDuplicate(currentSheetName, primaryKeyField, data[primaryKeyField]);
                    if (isDuplicate) {
                        showToast(`‚ùå ${primaryKeyField.toUpperCase()} "${data[primaryKeyField]}" sudah ada! Gunakan ${primaryKeyField.toUpperCase()} yang berbeda.`, 'error');
                        return;
                    }
                }
            }
            
            const saveBtn = document.getElementById('saveBtn');
            const saveBtnText = document.getElementById('saveBtnText');
            const saveBtnLoader = document.getElementById('saveBtnLoader');
            
            // Show loading
            saveBtn.disabled = true;
            saveBtnText.textContent = 'üíæ Menyimpan ke Google Sheets...';
            saveBtnLoader.classList.remove('hidden');
            
            try {
                if (!appsScriptConfig.webAppUrl) {
                    throw new Error('Web App URL tidak dikonfigurasi. Silakan setup koneksi Google Sheets terlebih dahulu.');
                }
                
                const appsScript = new AppsScriptAPI(appsScriptConfig.webAppUrl);
                let result;
                
                // Convert data to array format for Google Sheets
                const rowData = convertDataToArray(currentSheetName, data);
                console.log('üìã Row data to save to Google Sheets:', rowData);
                
                // Show progress toast
                showToast('üîÑ Menyimpan data ke Google Sheets...', 'info');
                
                // CRITICAL: Always save to Google Sheets first - no local updates until confirmed
                if (currentEditMode === 'add') {
                    console.log('‚ûï Adding new data to Google Sheets:', currentSheetName);
                    result = await appsScript.saveData(currentSheetName, rowData);
                } else {
                    // For edit mode, we need to use the correct row index
                    // The row index should be based on the original data position + 1 (for header)
                    const actualRowIndex = currentRowIndex + 1; // +1 because Google Sheets is 1-indexed and has header
                    console.log('‚úèÔ∏è Updating data in Google Sheets at row index:', actualRowIndex, 'in sheet:', currentSheetName);
                    result = await appsScript.updateData(currentSheetName, rowData, actualRowIndex);
                }
                
                console.log('üì° Google Sheets API response:', result);
                
                if (result && result.success) {
                    const actionText = currentEditMode === 'add' ? 'ditambahkan ke' : 'diperbarui di';
                    showToast(`‚úÖ ${currentSheetName} berhasil ${actionText} Google Sheets!`, 'success');
                    closeModal();
                    
                    // ENHANCED: Immediate verification by refreshing from Google Sheets
                    console.log('üîÑ Verifying save by refreshing from Google Sheets...');
                    showToast('üîÑ Memverifikasi data tersimpan di Google Sheets...', 'info');
                    
                    // Force complete refresh from Google Sheets to verify save
                    await fastRefreshSingleSheet(currentSheetName);
                    
                    // Update local data with verified Google Sheets data
                    console.log('‚úÖ Data verified and updated from Google Sheets');
                    
                    // ENHANCED: Instant UI refresh with verified data
                    console.log('‚ö° Refreshing UI with verified Google Sheets data...');
                    refreshCurrentDataMasterTab();
                    
                    // Update dependent components with verified data
                    if (currentSheetName === 'Siswa') {
                        populateKelasOptions();
                        console.log('üìö Kelas options updated with verified siswa data');
                    }
                    
                    // Update statistics if needed with verified data
                    if (currentSheetName === 'Siswa' || currentSheetName === 'Guru') {
                        await updateInfoCards();
                        console.log('üìä Statistics updated with verified master data');
                    }
                    
                    showToast('‚úÖ Data berhasil tersimpan dan diverifikasi di Google Sheets!', 'success');
                    console.log('‚úÖ Save and verification completed successfully');
                    
                } else {
                    console.error('‚ùå Google Sheets save failed with result:', result);
                    const errorMsg = result && result.error ? result.error : 'Respons tidak valid dari Google Sheets';
                    showToast(`‚ùå Gagal menyimpan ke Google Sheets: ${errorMsg}`, 'error');
                    
                    // Show detailed error for troubleshooting
                    if (result && result.error) {
                        console.error('üìã Detailed error from Google Sheets:', result.error);
                        showToast(`üîç Detail error: ${result.error}`, 'error');
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Form submit error:', error);
                showToast(`‚ùå Error menyimpan data ke Google Sheets: ${error.message}`, 'error');
                
                // Show network/connection specific errors
                if (error.message.includes('fetch')) {
                    showToast('üåê Periksa koneksi internet dan URL Google Apps Script', 'error');
                }
            } finally {
                // Hide loading
                saveBtn.disabled = false;
                saveBtnText.textContent = 'Simpan';
                saveBtnLoader.classList.add('hidden');
            }
        }

        // Get primary key field for each sheet
        function getPrimaryKeyField(sheetName) {
            switch (sheetName) {
                case 'Users': return 'username';
                case 'Siswa': return 'nis';
                case 'Guru': return 'nip';
                default: return null;
            }
        }

        // Check if primary key already exists
        function checkPrimaryKeyDuplicate(sheetName, primaryKeyField, primaryKeyValue) {
            let dataArray = [];
            
            switch (sheetName) {
                case 'Users': dataArray = allData.users; break;
                case 'Siswa': dataArray = allData.siswa; break;
                case 'Guru': dataArray = allData.guru; break;
                default: return false;
            }
            
            return dataArray.some(item => item[primaryKeyField] === primaryKeyValue);
        }

        // Update local data immediately after save for instant UI response
        function updateLocalDataAfterSave(sheetName, formData, editMode, rowIndex) {
            console.log('‚ö° Updating local data for instant UI response...');
            
            try {
                if (editMode === 'add') {
                    // Add new item to local data
                    if (sheetName === 'Users') {
                        allData.users.push({
                            username: formData.username,
                            password: formData.password,
                            nama: formData.nama,
                            role: formData.role,
                            hari_piket: formData.hari_piket || ''
                        });
                    } else if (sheetName === 'Siswa') {
                        allData.siswa.push({
                            nis: formData.nis,
                            nama: formData.nama,
                            kelas: formData.kelas,
                            jenis_kelamin: formData.jenis_kelamin,
                            alamat: formData.alamat
                        });
                    } else if (sheetName === 'Guru') {
                        allData.guru.push({
                            nip: formData.nip,
                            nama: formData.nama,
                            mata_pelajaran: formData.mata_pelajaran,
                            jenis_kelamin: formData.jenis_kelamin,
                            alamat: formData.alamat
                        });
                    } else if (sheetName === 'Jadwal') {
                        allData.jadwal.push({
                            hari: formData.hari,
                            jam_mulai: formData.jam_mulai,
                            jam_selesai: formData.jam_selesai,
                            kelas: formData.kelas,
                            nuptk: formData.nuptk,
                            nama_guru: formData.nama_guru,
                            mapel: formData.mapel
                        });
                    }
                    console.log(`‚ûï Added new ${sheetName} to local data`);
                    
                } else if (editMode === 'edit' && rowIndex >= 0) {
                    // Update existing item in local data
                    if (sheetName === 'Users' && allData.users[rowIndex]) {
                        Object.assign(allData.users[rowIndex], {
                            username: formData.username,
                            password: formData.password,
                            nama: formData.nama,
                            role: formData.role,
                            hari_piket: formData.hari_piket || ''
                        });
                    } else if (sheetName === 'Siswa' && allData.siswa[rowIndex]) {
                        Object.assign(allData.siswa[rowIndex], {
                            nis: formData.nis,
                            nama: formData.nama,
                            kelas: formData.kelas,
                            jenis_kelamin: formData.jenis_kelamin,
                            alamat: formData.alamat
                        });
                    } else if (sheetName === 'Guru' && allData.guru[rowIndex]) {
                        Object.assign(allData.guru[rowIndex], {
                            nip: formData.nip,
                            nama: formData.nama,
                            mata_pelajaran: formData.mata_pelajaran,
                            jenis_kelamin: formData.jenis_kelamin,
                            alamat: formData.alamat
                        });
                    } else if (sheetName === 'Jadwal' && allData.jadwal[rowIndex]) {
                        Object.assign(allData.jadwal[rowIndex], {
                            hari: formData.hari,
                            jam_mulai: formData.jam_mulai,
                            jam_selesai: formData.jam_selesai,
                            kelas: formData.kelas,
                            nuptk: formData.nuptk,
                            nama_guru: formData.nama_guru,
                            mapel: formData.mapel
                        });
                    }
                    console.log(`‚úèÔ∏è Updated ${sheetName} at index ${rowIndex} in local data`);
                }
                
            } catch (error) {
                console.error('‚ùå Error updating local data:', error);
            }
        }

        // Refresh current data master tab instantly
        function refreshCurrentDataMasterTab() {
            console.log('‚ö° Refreshing current data master tab instantly...');
            
            try {
                // Determine which tab is currently active and refresh it
                const activeTab = document.querySelector('.data-tab-btn.active');
                if (!activeTab) return;
                
                const tabId = activeTab.id;
                console.log('üîÑ Active data master tab:', tabId);
                
                if (tabId === 'tabUsers') {
                    renderUsersDataTable();
                    console.log('üë• Users table refreshed instantly');
                } else if (tabId === 'tabSiswaData') {
                    renderSiswaDataTable();
                    console.log('üë®‚Äçüéì Siswa table refreshed instantly');
                } else if (tabId === 'tabGuruData') {
                    renderGuruDataTable();
                    console.log('üë®‚Äçüè´ Guru table refreshed instantly');
                } else if (tabId === 'tabJadwalData') {
                    renderJadwalDataTable();
                    console.log('üìÖ Jadwal table refreshed instantly');
                }
                
            } catch (error) {
                console.error('‚ùå Error refreshing current data master tab:', error);
            }
        }

        // Convert form data to array format for Google Sheets
        function convertDataToArray(sheetName, data) {
            switch (sheetName) {
                case 'Users':
                    return [data.username, data.password, data.nama, data.role, data.hari_piket || ''];
                case 'Siswa':
                    return [data.nis, data.nama, data.kelas, data.jenis_kelamin, data.alamat];
                case 'Guru':
                    return [data.nip, data.nama, data.mata_pelajaran, data.jenis_kelamin, data.alamat];
                case 'Jadwal':
                    return [data.hari, data.jam_mulai, data.jam_selesai, data.kelas, data.nuptk, data.nama_guru, data.mapel];
                default:
                    return [];
            }
        }

        // Open delete confirmation
        function openDeleteConfirm(sheetName, rowIndex, itemName) {
            document.getElementById('confirmMessage').textContent = `Apakah Anda yakin ingin menghapus "${itemName}"?`;
            currentDeleteCallback = () => deleteItem(sheetName, rowIndex);
            document.getElementById('confirmModal').classList.remove('hidden');
        }

        // Handle confirm delete
        async function handleConfirmDelete() {
            if (currentDeleteCallback) {
                await currentDeleteCallback();
                currentDeleteCallback = null;
            }
        }

        // Delete item with guaranteed Google Sheets deletion
        async function deleteItem(sheetName, rowIndex) {
            const deleteBtn = document.getElementById('confirmDeleteBtn');
            const deleteBtnText = document.getElementById('deleteBtnText');
            const deleteBtnLoader = document.getElementById('deleteBtnLoader');
            
            // Show loading
            deleteBtn.disabled = true;
            deleteBtnText.textContent = 'üóëÔ∏è Menghapus dari Google Sheets...';
            deleteBtnLoader.classList.remove('hidden');
            
            try {
                if (!appsScriptConfig.webAppUrl) {
                    throw new Error('Web App URL tidak dikonfigurasi. Silakan setup koneksi Google Sheets terlebih dahulu.');
                }
                
                // Store item info before deletion for logging
                let deletedItemInfo = null;
                if (sheetName === 'Users' && allData.users[rowIndex]) {
                    deletedItemInfo = { ...allData.users[rowIndex] };
                } else if (sheetName === 'Siswa' && allData.siswa[rowIndex]) {
                    deletedItemInfo = { ...allData.siswa[rowIndex] };
                } else if (sheetName === 'Guru' && allData.guru[rowIndex]) {
                    deletedItemInfo = { ...allData.guru[rowIndex] };
                } else if (sheetName === 'Jadwal' && allData.jadwal[rowIndex]) {
                    deletedItemInfo = { ...allData.jadwal[rowIndex] };
                }
                
                console.log('üóëÔ∏è Deleting item from Google Sheets:', sheetName, 'at index:', rowIndex);
                console.log('üìã Item to delete:', deletedItemInfo);
                
                // Show progress toast
                showToast('üîÑ Menghapus data dari Google Sheets...', 'info');
                
                const appsScript = new AppsScriptAPI(appsScriptConfig.webAppUrl);
                const result = await appsScript.deleteData(sheetName, rowIndex + 1); // +1 for header row
                
                console.log('üì° Google Sheets delete API response:', result);
                
                if (result && result.success) {
                    showToast(`‚úÖ ${sheetName} berhasil dihapus dari Google Sheets!`, 'success');
                    closeConfirmModal();
                    
                    // ENHANCED: Immediate verification by refreshing from Google Sheets
                    console.log('üîÑ Verifying deletion by refreshing from Google Sheets...');
                    showToast('üîÑ Memverifikasi penghapusan di Google Sheets...', 'info');
                    
                    // Force complete refresh from Google Sheets to verify deletion
                    await fastRefreshSingleSheet(sheetName);
                    
                    // Update local data with verified Google Sheets data
                    console.log('‚úÖ Deletion verified and data updated from Google Sheets');
                    
                    // ENHANCED: Instant UI refresh with verified data
                    console.log('‚ö° Refreshing UI with verified Google Sheets data...');
                    refreshCurrentDataMasterTab();
                    
                    // Update dependent components with verified data
                    if (sheetName === 'Siswa') {
                        populateKelasOptions();
                        console.log('üìö Kelas options updated with verified siswa data after deletion');
                    }
                    
                    // Update statistics if needed with verified data
                    if (sheetName === 'Siswa' || sheetName === 'Guru') {
                        await updateInfoCards();
                        console.log('üìä Statistics updated with verified master data after deletion');
                    }
                    
                    showToast('‚úÖ Data berhasil dihapus dan diverifikasi di Google Sheets!', 'success');
                    console.log('‚úÖ Delete and verification completed successfully');
                    
                } else {
                    console.error('‚ùå Google Sheets delete failed with result:', result);
                    const errorMsg = result && result.error ? result.error : 'Respons tidak valid dari Google Sheets';
                    showToast(`‚ùå Gagal menghapus dari Google Sheets: ${errorMsg}`, 'error');
                    
                    // Show detailed error for troubleshooting
                    if (result && result.error) {
                        console.error('üìã Detailed delete error from Google Sheets:', result.error);
                        showToast(`üîç Detail error: ${result.error}`, 'error');
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Delete error:', error);
                showToast(`‚ùå Error menghapus data dari Google Sheets: ${error.message}`, 'error');
                
                // Show network/connection specific errors
                if (error.message.includes('fetch')) {
                    showToast('üåê Periksa koneksi internet dan URL Google Apps Script', 'error');
                }
            } finally {
                // Hide loading
                deleteBtn.disabled = false;
                deleteBtnText.textContent = 'Hapus';
                deleteBtnLoader.classList.add('hidden');
            }
        }

        // Update local data immediately after delete for instant UI response
        function updateLocalDataAfterDelete(sheetName, rowIndex) {
            console.log('‚ö° Updating local data after deletion for instant UI response...');
            
            try {
                if (sheetName === 'Users' && allData.users[rowIndex]) {
                    const deletedItem = allData.users.splice(rowIndex, 1)[0];
                    console.log('üóëÔ∏è Removed user from local data:', deletedItem.nama);
                } else if (sheetName === 'Siswa' && allData.siswa[rowIndex]) {
                    const deletedItem = allData.siswa.splice(rowIndex, 1)[0];
                    console.log('üóëÔ∏è Removed siswa from local data:', deletedItem.nama);
                } else if (sheetName === 'Guru' && allData.guru[rowIndex]) {
                    const deletedItem = allData.guru.splice(rowIndex, 1)[0];
                    console.log('üóëÔ∏è Removed guru from local data:', deletedItem.nama);
                } else if (sheetName === 'Jadwal' && allData.jadwal[rowIndex]) {
                    const deletedItem = allData.jadwal.splice(rowIndex, 1)[0];
                    console.log('üóëÔ∏è Removed jadwal from local data:', deletedItem.nama_guru, '-', deletedItem.mapel);
                }
                
            } catch (error) {
                console.error('‚ùå Error updating local data after deletion:', error);
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('dataModal').classList.add('hidden');
            document.getElementById('dataForm').reset();
        }

        // Close confirm modal
        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.add('hidden');
            currentDeleteCallback = null;
        }

        // Update siswa table with edit/delete buttons
        function loadSiswaTable() {
            const tbody = document.getElementById('siswaTableBody');
            tbody.innerHTML = '';

            allData.siswa.forEach((siswa, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${siswa.nis}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${siswa.nama}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${siswa.kelas}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${siswa.jenis_kelamin}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${siswa.alamat}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="openEditModal('Siswa', ${index})" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                        <button onclick="openDeleteConfirm('Siswa', ${index}, '${siswa.nama}')" class="text-red-600 hover:text-red-900">Hapus</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update guru table with edit/delete buttons
        function loadGuruTable() {
            const tbody = document.getElementById('guruTableBody');
            tbody.innerHTML = '';

            allData.guru.forEach((guru, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${guru.nip}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${guru.nama}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${guru.mata_pelajaran}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${guru.jenis_kelamin}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${guru.alamat}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="openEditModal('Guru', ${index})" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                        <button onclick="openDeleteConfirm('Guru', ${index}, '${guru.nama}')" class="text-red-600 hover:text-red-900">Hapus</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Test Apps Script connection from admin panel
        async function testConnectionAdmin(e) {
            e.preventDefault();
            
            const webAppUrl = appsScriptConfig.webAppUrl;

            const testBtn = document.getElementById('testConnectionBtnAdmin');
            const testText = document.getElementById('testConnectionTextAdmin');
            const testLoader = document.getElementById('testConnectionLoaderAdmin');

            // Show loading
            testBtn.disabled = true;
            testText.textContent = 'Testing...';
            testLoader.classList.remove('hidden');

            try {
                const appsScript = new AppsScriptAPI(webAppUrl);
                const result = await appsScript.testConnection();
                
                if (result.success) {
                    appsScriptConfig.webAppUrl = webAppUrl;
                    
                    // Update config via ElementSdk
                    if (window.elementSdk) {
                        await window.elementSdk.setConfig({
                            web_app_url: webAppUrl
                        });
                    }
                    
                    document.getElementById('connectionStatusAdmin').classList.remove('hidden');
                    document.getElementById('initializeDataBtnAdmin').classList.remove('hidden');
                    showToast('Koneksi berhasil!', 'success');
                    
                    // Load existing data
                    await loadAllData();
                } else {
                    showToast(`Koneksi gagal: ${result.error}`, 'error');
                }
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                // Hide loading
                testBtn.disabled = false;
                testText.textContent = 'Test Koneksi';
                testLoader.classList.add('hidden');
            }
        }

        // Initialize sample data from admin panel
        async function initializeSampleDataAdmin() {
            const initBtn = document.getElementById('initializeDataBtnAdmin');
            const initText = document.getElementById('initializeDataTextAdmin');
            const initLoader = document.getElementById('initializeDataLoaderAdmin');

            // Show loading
            initBtn.disabled = true;
            initText.textContent = 'Menginisialisasi...';
            initLoader.classList.remove('hidden');

            try {
                const appsScript = new AppsScriptAPI(appsScriptConfig.webAppUrl);
                const result = await appsScript.initializeData();
                
                if (result.success) {
                    showToast('Data sample berhasil diinisialisasi!', 'success');
                    
                    // Load the initialized data
                    await loadAllData();
                    
                    // Refresh all data master tables
                    renderUsersDataTable();
                    renderSiswaDataTable();
                    renderGuruDataTable();
                    renderJadwalDataTable();
                    
                    // Update statistics
                    await updateInfoCards();
                    
                } else {
                    showToast(`Error inisialisasi: ${result.error}`, 'error');
                }
                
            } catch (error) {
                showToast(`Error inisialisasi: ${error.message}`, 'error');
            } finally {
                // Hide loading
                initBtn.disabled = false;
                initText.textContent = 'Inisialisasi Data Sample';
                initLoader.classList.add('hidden');
            }
        }



        // Check today's attendance status and display indicator
        async function checkTodayAttendanceStatus() {
            try {
                const today = getTodayDate();
                console.log('üîç Checking today attendance status for:', today);
                
                // Get today's attendance data
                const todayAbsensi = allData.absensi.filter(a => {
                    let absensiDateStr = a.tanggal;
                    
                    // Use enhanced Google Sheets date conversion
                    absensiDateStr = convertFromGoogleSheetsDateFormat(absensiDateStr);
                    
                    return absensiDateStr === today;
                });
                
                console.log('üìä Today attendance records found:', todayAbsensi.length);
                
                if (todayAbsensi.length > 0) {
                    // Group by jenis and kelas
                    const siswaAbsensi = todayAbsensi.filter(a => a.jenis === 'siswa');
                    const guruAbsensi = todayAbsensi.filter(a => a.jenis === 'guru');
                    
                    // Get unique classes for siswa
                    const siswaKelas = [...new Set(siswaAbsensi.map(a => a.kelas))].sort();
                    
                    // Build status content
                    let statusContent = '';
                    
                    if (siswaAbsensi.length > 0) {
                        statusContent += `<strong>Siswa:</strong> ${siswaKelas.length} kelas (${siswaAbsensi.length} record)`;
                        if (siswaKelas.length > 0) {
                            statusContent += ` - Kelas: ${siswaKelas.join(', ')}`;
                        }
                    }
                    
                    if (guruAbsensi.length > 0) {
                        if (statusContent) statusContent += '<br>';
                        statusContent += `<strong>Guru:</strong> ${guruAbsensi.length} record`;
                    }
                    
                    // Show the indicator
                    document.getElementById('attendanceStatusContent').innerHTML = statusContent;
                    document.getElementById('attendanceStatusIndicator').classList.remove('hidden');
                    
                    console.log('‚úÖ Attendance status indicator displayed');
                } else {
                    // Hide the indicator if no attendance today
                    document.getElementById('attendanceStatusIndicator').classList.add('hidden');
                    console.log('‚ÑπÔ∏è No attendance records for today - indicator hidden');
                }
                
            } catch (error) {
                console.error('‚ùå Error checking today attendance status:', error);
                document.getElementById('attendanceStatusIndicator').classList.add('hidden');
            }
        }



        // View today's attendance details
        function viewTodayAttendance() {
            // Switch to absensi tab and then to laporan sub-tab
            switchTab('tabAbsensi');
            switchAbsensiTab('tabLaporanAbsensi');
            
            // Set today's date in both fields
            const today = getTodayDate();
            document.getElementById('dariTanggal').value = today;
            document.getElementById('sampaiTanggal').value = today;
            
            // Show toast message
            showToast('üìä Gunakan filter untuk melihat detail absensi hari ini', 'info');
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'996c6ecb70614b6d',t:'MTc2MTg0MzI0OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
