<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Absensi Siswa</title>
  <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100%;
        }

        .login-box {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }

        .login-box h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .login-box p {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        /* Header */
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            display: none;
        }

        .header.show {
            display: block;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .user-info {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            margin-top: 10px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.3);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-left: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.5);
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .nav-tab {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .nav-tab:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: white;
            color: #667eea;
            border-color: white;
        }

        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        /* Main Content */
        .main-content {
            display: none;
        }

        .main-content.show {
            display: block;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
            margin-bottom: 25px;
            max-width: 1000px;
            margin: 0 auto 25px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            margin-top: 10px;
        }

        .btn-export {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            margin-top: 10px;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            display: none;
            animation: slideIn 0.3s ease;
            z-index: 1000;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .toast-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .toast-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .toast-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #856404;
        }

        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .student-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .student-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .student-item.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .student-name {
            font-weight: 600;
            font-size: 0.95em;
            margin-bottom: 3px;
        }

        .student-nis {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .bulletin-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .bulletin-info {
            flex: 1;
        }

        .bulletin-name {
            font-weight: 600;
            font-size: 0.95em;
            margin-bottom: 3px;
            color: #333;
        }

        .bulletin-nis {
            font-size: 0.8em;
            color: #666;
        }

        .bulletin-status {
            display: flex;
            gap: 5px;
        }

        .status-btn {
            padding: 6px 12px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .status-btn:hover {
            transform: translateY(-1px);
        }

        .status-btn.active-hadir {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .status-btn.active-sakit {
            background: #ffc107;
            color: #333;
            border-color: #ffc107;
        }

        .status-btn.active-izin {
            background: #17a2b8;
            color: white;
            border-color: #17a2b8;
        }

        .status-btn.active-alpa {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .status-option {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
            background: white;
        }

        .status-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .status-option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .status-option input[type="radio"] {
            display: none;
        }

        .selected-count {
            background: #667eea;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 12px 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #0c5460;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .required {
            color: #e74c3c;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .report-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
        }

        .report-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9em;
        }

        .report-table tr:hover {
            background: #f8f9fa;
        }

        .report-table tr:last-child td {
            border-bottom: none;
        }

        .report-table th.text-center,
        .report-table td.text-center {
            text-align: center;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            display: inline-block;
        }

        .status-hadir {
            background: #d4edda;
            color: #155724;
        }

        .status-sakit {
            background: #fff3cd;
            color: #856404;
        }

        .status-izin {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-alpa {
            background: #f8d7da;
            color: #721c24;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .summary-card h3 {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 8px;
        }

        .summary-card .value {
            font-size: 2em;
            font-weight: 700;
            color: #333;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .connection-status {
            margin-bottom: 20px;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9em;
            text-align: center;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .toggle-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .toggle-btn:hover {
            background: #f0f0f0;
        }

        .toggle-btn.active {
            background: #667eea;
            color: white;
        }

        .report-view {
            display: none;
        }

        .report-view.active {
            display: block;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .card {
                padding: 20px;
            }

            .student-grid {
                grid-template-columns: 1fr;
            }

            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .bulletin-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .bulletin-status {
                width: 100%;
                flex-wrap: wrap;
            }
            
            .status-btn {
                flex: 1;
                min-width: 70px;
            }

            .summary-cards {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div id="toast" class="toast"></div><!-- Login Page -->
  <div id="loginPage" class="login-container">
   <div class="login-box">
    <h1 style="font-size: 1.8em; margin-bottom: 5px;">üîê Login</h1>
    <p style="font-size: 1.1em; font-weight: 600; margin-bottom: 5px; color: #667eea;">Sistem Absensi Siswa</p>
    <p style="font-size: 1em; font-weight: 600; margin-bottom: 20px; color: #764ba2;">SMP PURNAWARMAN</p><!-- Status Koneksi -->
    <div id="connectionStatus" class="connection-status">
     <div class="spinner" style="width: 30px; height: 30px; margin: 0 auto 10px;"></div>
     <div>
      üîÑ Memeriksa koneksi...
     </div>
    </div>
    <form id="loginForm">
     <div class="form-group"><label for="username">Username <span class="required">*</span></label> <input type="text" id="username" name="username" required placeholder="Masukkan username">
     </div>
     <div class="form-group"><label for="password">Password <span class="required">*</span></label> <input type="password" id="password" name="password" required placeholder="Masukkan password">
     </div><button type="submit" class="btn" id="loginBtn"> üîì Login </button>
    </form>
    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 0.85em; text-align: center; color: #666;">
     Aplikasi dibuat oleh <strong style="color: #667eea;">purnawarman</strong> @2025
    </div>
   </div>
  </div><!-- Main Content -->
  <div id="mainContent" class="main-content">
   <div class="container">
    <header class="header show">
     <h1>üìö Sistem Absensi Siswa</h1>
     <p>Catat kehadiran siswa dengan mudah dan cepat</p>
     <div class="user-info"><span id="userDisplay">üë§ User</span> <button class="logout-btn" onclick="logout()">Logout</button>
     </div><!-- Navigation Tabs -->
     <div class="nav-tabs"><button class="nav-tab active" onclick="showPage('absensi')"> üìù Form Absensi </button> <button class="nav-tab" onclick="showPage('laporan')"> üìä Laporan </button> <button class="nav-tab" onclick="showPage('informasi')"> ‚ÑπÔ∏è Informasi </button>
     </div>
    </header><!-- Page: Form Absensi -->
    <div id="pageAbsensi" class="page-content active">
     <div class="main-grid"><!-- Form Absensi -->
      <div class="card">
       <h2>üìù Form Absensi</h2>
       <div class="info-box">
        ‚ÑπÔ∏è Pilih kelas terlebih dahulu, kemudian pilih siswa yang akan diabsen
       </div>
       <form id="absensiForm"><!-- Filter Kelas -->
        <div class="form-group"><label for="kelasSelect">Pilih Kelas <span class="required">*</span></label> <select id="kelasSelect" name="kelas" required> <option value="">-- Pilih Kelas --</option> </select>
        </div><!-- Tanggal -->
        <div class="form-group"><label for="tanggal">Tanggal <span class="required">*</span></label> <input type="date" id="tanggal" name="tanggal" required>
        </div><!-- Tombol Pilih Semua Hadir --> <button type="button" class="btn" id="selectAllHadirBtn" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); margin-bottom: 15px; display: none;"> ‚úÖ Pilih Semua Hadir </button> <!-- Loading Indicator -->
        <div id="loadingStudents" style="display: none; text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px;">
         <div class="spinner" style="width: 30px; height: 30px; margin: 0 auto 10px;"></div>
         <div style="color: #666;">
          Memuat data siswa...
         </div>
        </div><!-- Daftar Siswa -->
        <div class="form-group" id="selectedStudentsContainer" style="display: none;"><label>Daftar Siswa Kelas <span id="currentClassLabel"></span> <span class="required">*</span></label>
         <div id="selectedStudentsList" style="background: #f8f9fa; padding: 15px; border-radius: 8px; max-height: 400px; overflow-y: auto;">
         </div>
        </div><button type="submit" class="btn" id="submitBtn"> üíæ Simpan Absensi </button> <button type="button" class="btn btn-secondary" id="resetBtn"> üîÑ Reset Form </button>
       </form>
      </div>
     </div>
    </div><!-- Page: Informasi -->
    <div id="pageInformasi" class="page-content">
     <div class="main-grid">
      <div class="card">
       <h2>‚ÑπÔ∏è Informasi &amp; Statistik</h2>
       <div class="info-box">
        üìä Klik tombol "Tarik Data" pada setiap bagian untuk memuat statistik terbaru
       </div><!-- Rekap Data Siswa -->
       <div style="margin-bottom: 40px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
         <h3 style="color: #667eea; font-size: 1.5em; border-bottom: 2px solid #667eea; padding-bottom: 8px; margin: 0; flex: 1;">üë• Rekap Data Siswa</h3><button class="btn" onclick="loadRekapSiswa()" id="loadRekapBtn" style="margin: 0; width: auto; padding: 10px 20px; font-size: 0.9em;"> üîÑ Tarik Data </button>
        </div><!-- Loading Rekap -->
        <div id="rekapLoading" style="display: none; text-align: center; padding: 30px; background: #f8f9fa; border-radius: 8px;">
         <div class="spinner" style="width: 30px; height: 30px; margin: 0 auto 10px;"></div>
         <p style="color: #666; margin: 0;">Memuat data siswa...</p>
        </div><!-- Content Rekap -->
        <div id="rekapContent" style="display: none;">
         <div class="table-container">
          <table class="report-table" id="rekapSiswaTable">
           <thead>
            <tr>
             <th class="text-center">No</th>
             <th>Kelas</th>
             <th class="text-center">Jumlah Siswa</th>
            </tr>
           </thead>
           <tbody id="rekapSiswaBody">
           </tbody>
          </table>
         </div>
        </div><!-- Empty Rekap -->
        <div id="rekapEmpty" style="display: block; text-align: center; padding: 30px; background: #f8f9fa; border-radius: 8px; color: #666;">
         <div style="font-size: 2em; margin-bottom: 8px;">
          üë•
         </div>
         <p style="margin: 0;">Klik "Tarik Data" untuk memuat rekap siswa</p>
        </div>
       </div><!-- Peringkat Kelas -->
       <div style="margin-bottom: 40px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
         <h3 style="color: #667eea; font-size: 1.5em; border-bottom: 2px solid #667eea; padding-bottom: 8px; margin: 0; flex: 1;">üèÜ Peringkat Kelas Berdasarkan Kehadiran</h3>
        </div><!-- Filter Periode Kelas -->
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
         <div class="filter-row">
          <div class="form-group" style="margin-bottom: 0;"><label for="kelasPeriod">Periode</label> <select id="kelasPeriod" onchange="handleKelasPeriodChange()"> <option value="all">Semua Data</option> <option value="today">Hari Ini</option> <option value="week">Minggu Ini</option> <option value="month">Bulan Ini</option> <option value="custom">Rentang Waktu</option> </select>
          </div>
          <div class="form-group" id="kelasCustomDateRange" style="display: none; margin-bottom: 0;"><label for="kelasStartDate">Tanggal Mulai</label> <input type="date" id="kelasStartDate">
          </div>
          <div class="form-group" id="kelasCustomDateRange2" style="display: none; margin-bottom: 0;"><label for="kelasEndDate">Tanggal Akhir</label> <input type="date" id="kelasEndDate">
          </div>
         </div><button class="btn" onclick="loadPeringkatKelas()" id="loadKelasBtn" style="margin-top: 15px; width: 100%;"> üîÑ Tarik Data </button>
        </div><!-- Loading Kelas -->
        <div id="kelasLoading" style="display: none; text-align: center; padding: 30px; background: #f8f9fa; border-radius: 8px;">
         <div class="spinner" style="width: 30px; height: 30px; margin: 0 auto 10px;"></div>
         <p style="color: #666; margin: 0;">Memuat peringkat kelas...</p>
        </div><!-- Content Kelas -->
        <div id="kelasContent" style="display: none;"><!-- Kelas Terbaik -->
         <div style="margin-bottom: 25px;">
          <h4 style="color: #28a745; margin-bottom: 12px; font-size: 1.2em;">‚≠ê Top 3 Kelas Terbaik</h4>
          <div class="table-container">
           <table class="report-table" id="kelasTerbaikTable">
            <thead>
             <tr>
              <th class="text-center">Peringkat</th>
              <th>Kelas</th>
              <th class="text-center">Total Hadir</th>
              <th class="text-center">Total Absensi</th>
              <th class="text-center">Persentase Hadir</th>
             </tr>
            </thead>
            <tbody id="kelasTerbaikBody">
            </tbody>
           </table>
          </div>
         </div><!-- Kelas Terburuk -->
         <div>
          <h4 style="color: #dc3545; margin-bottom: 12px; font-size: 1.2em;">‚ö†Ô∏è Top 3 Kelas Terburuk</h4>
          <div class="table-container">
           <table class="report-table" id="kelasTerburukTable">
            <thead>
             <tr>
              <th class="text-center">Peringkat</th>
              <th>Kelas</th>
              <th class="text-center">Total Hadir</th>
              <th class="text-center">Total Absensi</th>
              <th class="text-center">Persentase Hadir</th>
             </tr>
            </thead>
            <tbody id="kelasTerburukBody">
            </tbody>
           </table>
          </div>
         </div>
        </div><!-- Empty Kelas -->
        <div id="kelasEmpty" style="display: block; text-align: center; padding: 30px; background: #f8f9fa; border-radius: 8px; color: #666;">
         <div style="font-size: 2em; margin-bottom: 8px;">
          üèÜ
         </div>
         <p style="margin: 0;">Klik "Tarik Data" untuk memuat peringkat kelas</p>
        </div>
       </div><!-- Peringkat Siswa -->
       <div style="margin-bottom: 40px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
         <h3 style="color: #667eea; font-size: 1.5em; border-bottom: 2px solid #667eea; padding-bottom: 8px; margin: 0; flex: 1;">üéì Peringkat Siswa Berdasarkan Kehadiran</h3>
        </div><!-- Filter Periode Siswa -->
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
         <div class="filter-row">
          <div class="form-group" style="margin-bottom: 0;"><label for="siswaPeriod">Periode</label> <select id="siswaPeriod" onchange="handleSiswaPeriodChange()"> <option value="all">Semua Data</option> <option value="today">Hari Ini</option> <option value="week">Minggu Ini</option> <option value="month">Bulan Ini</option> <option value="custom">Rentang Waktu</option> </select>
          </div>
          <div class="form-group" id="siswaCustomDateRange" style="display: none; margin-bottom: 0;"><label for="siswaStartDate">Tanggal Mulai</label> <input type="date" id="siswaStartDate">
          </div>
          <div class="form-group" id="siswaCustomDateRange2" style="display: none; margin-bottom: 0;"><label for="siswaEndDate">Tanggal Akhir</label> <input type="date" id="siswaEndDate">
          </div>
         </div><button class="btn" onclick="loadPeringkatSiswa()" id="loadSiswaBtn" style="margin-top: 15px; width: 100%;"> üîÑ Tarik Data </button>
        </div><!-- Loading Siswa -->
        <div id="siswaLoading" style="display: none; text-align: center; padding: 30px; background: #f8f9fa; border-radius: 8px;">
         <div class="spinner" style="width: 30px; height: 30px; margin: 0 auto 10px;"></div>
         <p style="color: #666; margin: 0;">Memuat peringkat siswa...</p>
        </div><!-- Content Siswa -->
        <div id="siswaContent" style="display: none;"><!-- Siswa Terbaik -->
         <div style="margin-bottom: 25px;">
          <h4 style="color: #28a745; margin-bottom: 12px; font-size: 1.2em;">‚≠ê Top 3 Siswa Terbaik</h4>
          <div class="table-container">
           <table class="report-table" id="siswaTerbaikTable">
            <thead>
             <tr>
              <th class="text-center">Peringkat</th>
              <th>Nama Siswa</th>
              <th>Kelas</th>
              <th class="text-center">Total Hadir</th>
              <th class="text-center">Total Absensi</th>
              <th class="text-center">Persentase Hadir</th>
             </tr>
            </thead>
            <tbody id="siswaTerbaikBody">
            </tbody>
           </table>
          </div>
         </div><!-- Siswa Terburuk -->
         <div>
          <h4 style="color: #dc3545; margin-bottom: 12px; font-size: 1.2em;">‚ö†Ô∏è Top 3 Siswa Terburuk</h4>
          <div class="table-container">
           <table class="report-table" id="siswaTerburukTable">
            <thead>
             <tr>
              <th class="text-center">Peringkat</th>
              <th>Nama Siswa</th>
              <th>Kelas</th>
              <th class="text-center">Total Hadir</th>
              <th class="text-center">Total Absensi</th>
              <th class="text-center">Persentase Hadir</th>
             </tr>
            </thead>
            <tbody id="siswaTerburukBody">
            </tbody>
           </table>
          </div>
         </div>
        </div><!-- Empty Siswa -->
        <div id="siswaEmpty" style="display: block; text-align: center; padding: 30px; background: #f8f9fa; border-radius: 8px; color: #666;">
         <div style="font-size: 2em; margin-bottom: 8px;">
          üéì
         </div>
         <p style="margin: 0;">Klik "Tarik Data" untuk memuat peringkat siswa</p>
        </div>
       </div>
      </div>
     </div>
    </div><!-- Page: Laporan -->
    <div id="pageLaporan" class="page-content">
     <div class="main-grid">
      <div class="card">
       <h2>üìä Laporan Absensi</h2><!-- Filter Laporan -->
       <div class="filter-row">
        <div class="form-group"><label for="reportKelas">Filter Kelas</label> <select id="reportKelas"> <option value="">Semua Kelas</option> </select>
        </div>
        <div class="form-group"><label for="reportPeriod">Periode</label> <select id="reportPeriod" onchange="handlePeriodChange()"> <option value="today">Hari Ini</option> <option value="week">Minggu Ini</option> <option value="month">Bulan Ini</option> <option value="custom">Rentang Waktu</option> </select>
        </div>
       </div><!-- Custom Date Range -->
       <div id="customDateRange" style="display: none;" class="filter-row">
        <div class="form-group"><label for="reportStartDate">Tanggal Mulai</label> <input type="date" id="reportStartDate">
        </div>
        <div class="form-group"><label for="reportEndDate">Tanggal Akhir</label> <input type="date" id="reportEndDate">
        </div>
       </div><button class="btn" onclick="loadReport()" style="margin-bottom: 20px;"> üîç Tampilkan Laporan </button> <!-- Summary Cards -->
       <div id="summaryCards" class="summary-cards" style="display: none;">
        <div class="summary-card" style="border-left-color: #28a745;">
         <h3>‚úÖ Hadir</h3>
         <div class="value" id="summaryHadir">
          0
         </div>
        </div>
        <div class="summary-card" style="border-left-color: #ffc107;">
         <h3>ü§í Sakit</h3>
         <div class="value" id="summarySakit">
          0
         </div>
        </div>
        <div class="summary-card" style="border-left-color: #17a2b8;">
         <h3>üìù Izin</h3>
         <div class="value" id="summaryIzin">
          0
         </div>
        </div>
        <div class="summary-card" style="border-left-color: #dc3545;">
         <h3>‚ùå Alpa</h3>
         <div class="value" id="summaryAlpa">
          0
         </div>
        </div>
        <div class="summary-card" style="border-left-color: #6c757d;">
         <h3>üö´ Tidak Hadir</h3>
         <div class="value" id="summaryTidakHadir">
          0
         </div>
        </div>
       </div><!-- View Toggle -->
       <div id="viewToggle" class="view-toggle" style="display: none;"><button class="toggle-btn active" onclick="switchView('detail')"> üìã Detail Absensi </button> <button class="toggle-btn" onclick="switchView('student')"> üë§ Detail Per Siswa </button> <button class="toggle-btn" onclick="switchView('summary')"> üìä Ringkasan Per Kelas </button>
       </div><!-- Loading -->
       <div id="reportLoading" style="display: none; text-align: center; padding: 40px;">
        <div class="spinner"></div>
        <p>Memuat laporan...</p>
       </div><!-- Detail View -->
       <div id="detailView" class="report-view active">
        <div id="reportTableContainer" style="display: none;">
         <div class="table-container">
          <table class="report-table" id="reportTable">
           <thead>
            <tr>
             <th>No</th>
             <th>Tanggal</th>
             <th>Nama Siswa</th>
             <th>Kelas</th>
             <th>Status</th>
             <th>Keterangan</th>
             <th>Input By</th>
            </tr>
           </thead>
           <tbody id="reportTableBody">
           </tbody>
          </table>
         </div><button class="btn btn-export" onclick="exportToCSV()" style="margin-top: 15px;"> üì• Export ke CSV </button>
        </div>
       </div><!-- Student View -->
       <div id="studentView" class="report-view">
        <div id="studentTableContainer" style="display: none;">
         <div class="table-container">
          <table class="report-table" id="studentTable">
           <thead>
            <tr>
             <th class="text-center">No</th>
             <th>Nama Siswa</th>
             <th>Kelas</th>
             <th class="text-center">Hadir</th>
             <th class="text-center">Sakit</th>
             <th class="text-center">Izin</th>
             <th class="text-center">Alpa</th>
             <th class="text-center">Total</th>
             <th class="text-center">Persentase Hadir</th>
            </tr>
           </thead>
           <tbody id="studentTableBody">
           </tbody>
          </table>
         </div><button class="btn btn-export" onclick="exportStudentToCSV()" style="margin-top: 15px;"> üì• Export Detail Per Siswa ke CSV </button>
        </div>
       </div><!-- Summary View -->
       <div id="summaryView" class="report-view">
        <div id="summaryTableContainer" style="display: none;">
         <div class="table-container">
          <table class="report-table" id="summaryTable">
           <thead>
            <tr>
             <th class="text-center">No</th>
             <th>Kelas</th>
             <th class="text-center">Hadir</th>
             <th class="text-center">Sakit</th>
             <th class="text-center">Izin</th>
             <th class="text-center">Alpa</th>
             <th class="text-center">Persentase Hadir</th>
            </tr>
           </thead>
           <tbody id="summaryTableBody">
           </tbody>
          </table>
         </div><button class="btn btn-export" onclick="exportSummaryToCSV()" style="margin-top: 15px;"> üì• Export Ringkasan ke CSV </button>
        </div>
       </div><!-- Empty State -->
       <div id="reportEmpty" style="display: none; text-align: center; padding: 40px; color: #666;">
        <div style="font-size: 3em; margin-bottom: 10px;">
         üì≠
        </div>
        <p>Tidak ada data absensi untuk filter yang dipilih</p>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
        // ============================================
        // KONFIGURASI - URL GOOGLE APPS SCRIPT
        // ============================================
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzVBPqQ4yru5Eav8MegQmtJvgTPSNB62CQkpZ77ZqtG1anZYIppd3FWdCtX-BkOEooZ/exec';
        
        // State management
        let allStudents = [];
        let selectedStudents = [];
        let currentClass = '';
        let currentUser = null;
        let currentReportData = [];
        let currentView = 'detail';

        // Check if user is logged in
        window.addEventListener('load', () => {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainContent();
            } else {
                showLoginPage();
                checkConnection();
            }
        });
        
        // ============================================
        // CEK KONEKSI KE GOOGLE APPS SCRIPT
        // ============================================
        async function checkConnection() {
            const statusDiv = document.getElementById('connectionStatus');
            const loginBtn = document.getElementById('loginBtn');
            
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getStudents`, {
                    method: 'GET',
                    redirect: 'follow'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Response bukan JSON:', text);
                    throw new Error('Server mengembalikan response yang tidak valid. Pastikan Google Apps Script sudah di-deploy dengan benar.');
                }
                
                const result = await response.json();
                
                if (result.success !== undefined) {
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.border = '1px solid #c3e6cb';
                    statusDiv.style.color = '#155724';
                    statusDiv.innerHTML = `
                        <div style="font-weight: 600;">‚úÖ Terhubung ke Google Apps Script</div>
                        <div style="font-size: 0.85em; margin-top: 5px;">
                            ${result.total || 0} siswa ditemukan di database
                        </div>
                    `;
                    loginBtn.disabled = false;
                } else {
                    throw new Error('Response tidak valid dari server');
                }
                
            } catch (error) {
                console.error('Connection error:', error);
                
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.border = '1px solid #f5c6cb';
                statusDiv.style.color = '#721c24';
                statusDiv.innerHTML = `
                    <div style="font-weight: 600;">‚ùå Gagal Terhubung</div>
                    <div style="font-size: 0.85em; margin-top: 8px; line-height: 1.5;">
                        ${error.message}
                    </div>
                    <div style="font-size: 0.8em; margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.05); border-radius: 5px; text-align: left;">
                        <strong>Troubleshooting:</strong><br>
                        1. Pastikan Apps Script sudah di-deploy sebagai Web App<br>
                        2. Execute as: <strong>Me</strong><br>
                        3. Who has access: <strong>Anyone</strong><br>
                        4. Cek console browser (F12) untuk detail error
                    </div>
                    <button onclick="checkConnection()" style="margin-top: 10px; padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
                        üîÑ Coba Lagi
                    </button>
                `;
                loginBtn.disabled = true;
            }
        }

        // ============================================
        // LOGIN FUNCTIONS
        // ============================================
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.textContent = '‚è≥ Memproses...';
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const params = new URLSearchParams({
                    action: 'login',
                    username: username,
                    password: password
                });
                
                const response = await fetch(`${SCRIPT_URL}?${params.toString()}`, {
                    method: 'GET',
                    redirect: 'follow'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentUser = result.user;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showToast('success', '‚úÖ ' + result.message);
                    setTimeout(() => {
                        showMainContent();
                    }, 500);
                } else {
                    showToast('error', '‚ùå ' + result.message);
                }
            } catch (error) {
                console.error('Error login:', error);
                showToast('error', '‚ùå Gagal login: ' + error.message);
            }
            
            loginBtn.disabled = false;
            loginBtn.textContent = 'üîì Login';
        });

        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            showLoginPage();
            showToast('info', '‚ÑπÔ∏è Anda telah logout');
        }

        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainContent').classList.remove('show');
        }

        function showMainContent() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainContent').classList.add('show');
            document.getElementById('userDisplay').textContent = `üë§ ${currentUser.nama} (${currentUser.role})`;
            
            document.getElementById('tanggal').valueAsDate = new Date();
            
            loadAllStudents();
            loadClassFilter();
        }

        // ============================================
        // FUNGSI UNTUK DISABLE/ENABLE FORM ELEMENTS
        // ============================================
        function disableFormElements(disable) {
            // Disable/enable all form inputs
            document.getElementById('kelasSelect').disabled = disable;
            document.getElementById('tanggal').disabled = disable;
            document.getElementById('selectAllHadirBtn').disabled = disable;
            document.getElementById('submitBtn').disabled = disable;
            document.getElementById('resetBtn').disabled = disable;
            
            // Disable/enable all status buttons and keterangan inputs
            const statusButtons = document.querySelectorAll('.status-btn');
            statusButtons.forEach(btn => {
                btn.disabled = disable;
                btn.style.cursor = disable ? 'not-allowed' : 'pointer';
                btn.style.opacity = disable ? '0.5' : '1';
            });
            
            const keteranganInputs = document.querySelectorAll('#selectedStudentsList input[type="text"]');
            keteranganInputs.forEach(input => {
                input.disabled = disable;
            });
        }
        
        // ============================================
        // FUNGSI UNTUK LOAD DATA SISWA
        // ============================================
        async function loadAllStudents() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getStudents`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    allStudents = result.data;
                    console.log('‚úÖ Loaded students:', allStudents.length);
                } else {
                    allStudents = [];
                    console.warn('‚ö†Ô∏è No students found');
                }
            } catch (error) {
                console.error('Error loading students:', error);
                allStudents = [];
            }
        }

        // ============================================
        // FUNGSI UNTUK LOAD FILTER KELAS
        // ============================================
        async function loadClassFilter() {
            const selectElement = document.getElementById('kelasSelect');
            
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getClasses`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    await checkTodayAttendance(result.data);
                } else {
                    selectElement.innerHTML = '<option value="">Tidak ada kelas tersedia</option>';
                }
            } catch (error) {
                console.error('Error loading classes:', error);
                selectElement.innerHTML = '<option value="">‚ùå Gagal memuat kelas</option>';
            }
        }

        async function checkTodayAttendance(classes) {
            const selectElement = document.getElementById('kelasSelect');
            const today = new Date().toISOString().split('T')[0];
            
            try {
                const params = new URLSearchParams({
                    action: 'getReport',
                    startDate: today,
                    endDate: today,
                    kelas: ''
                });
                
                const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
                const result = await response.json();
                
                const attendedClasses = new Set();
                if (result.success && result.data) {
                    result.data.forEach(record => {
                        attendedClasses.add(record.kelas);
                    });
                }
                
                let html = '<option value="">-- Pilih Kelas --</option>';
                classes.forEach(kelas => {
                    const isAttended = attendedClasses.has(kelas);
                    const label = isAttended ? `Kelas ${kelas} ‚úÖ (Sudah Diabsen)` : `Kelas ${kelas}`;
                    const disabled = isAttended ? 'disabled' : '';
                    html += `<option value="${kelas}" ${disabled}>${label}</option>`;
                });
                selectElement.innerHTML = html;
            } catch (error) {
                console.error('Error checking attendance:', error);
                let html = '<option value="">-- Pilih Kelas --</option>';
                classes.forEach(kelas => {
                    html += `<option value="${kelas}">Kelas ${kelas}</option>`;
                });
                selectElement.innerHTML = html;
            }
            
            selectElement.addEventListener('change', function() {
                currentClass = this.value;
                if (currentClass) {
                    loadStudentsByClass(currentClass);
                } else {
                    document.getElementById('selectAllHadirBtn').style.display = 'none';
                    document.getElementById('selectedStudentsContainer').style.display = 'none';
                    document.getElementById('loadingStudents').style.display = 'none';
                }
            });
        }

        // ============================================
        // FUNGSI UNTUK LOAD SISWA BERDASARKAN KELAS
        // ============================================
        async function loadStudentsByClass(kelas) {
            document.getElementById('loadingStudents').style.display = 'block';
            document.getElementById('selectedStudentsContainer').style.display = 'none';
            document.getElementById('selectAllHadirBtn').style.display = 'none';
            
            const filteredStudents = allStudents.filter(s => String(s.kelas) === String(kelas));
            
            if (filteredStudents.length === 0) {
                document.getElementById('loadingStudents').style.display = 'none';
                showToast('error', '‚ùå Tidak ada siswa di kelas ini!');
                return;
            }
            
            if (!window.studentAttendance) {
                window.studentAttendance = {};
            }
            if (!window.studentNotes) {
                window.studentNotes = {};
            }
            
            window.selectedStudentsList = filteredStudents.map(s => s.nis);
            
            window.selectedStudentsList.forEach(nis => {
                if (!window.studentAttendance[nis]) {
                    window.studentAttendance[nis] = null;
                }
            });
            
            setTimeout(() => {
                document.getElementById('loadingStudents').style.display = 'none';
                document.getElementById('currentClassLabel').textContent = kelas;
                renderSelectedStudents();
                document.getElementById('selectAllHadirBtn').style.display = 'block';
                showToast('success', `‚úÖ ${filteredStudents.length} siswa dimuat dari kelas ${kelas}`);
            }, 500);
        }
        
        function renderSelectedStudents() {
            const container = document.getElementById('selectedStudentsList');
            const containerDiv = document.getElementById('selectedStudentsContainer');
            
            if (!window.selectedStudentsList || window.selectedStudentsList.length === 0) {
                containerDiv.style.display = 'none';
                return;
            }
            
            containerDiv.style.display = 'block';
            
            let html = '';
            window.selectedStudentsList.forEach(nis => {
                const student = allStudents.find(s => s.nis === nis);
                if (!student) return;
                
                const currentStatus = window.studentAttendance[nis];
                const currentNote = window.studentNotes && window.studentNotes[nis] ? window.studentNotes[nis] : '';
                
                html += `
                    <div class="bulletin-item" style="flex-direction: column; align-items: stretch; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 15px; margin-bottom: 10px;">
                            <div class="bulletin-info">
                                <div class="bulletin-name">${student.nama_siswa}</div>
                                <div class="bulletin-nis">NIS: ${student.nis}</div>
                            </div>
                            <div class="bulletin-status" style="flex-wrap: wrap;">
                                <button type="button" class="status-btn ${currentStatus === 'Hadir' ? 'active-hadir' : ''}" 
                                        onclick="setStudentStatus('${student.nis}', 'Hadir')">
                                    ‚úÖ Hadir
                                </button>
                                <button type="button" class="status-btn ${currentStatus === 'Sakit' ? 'active-sakit' : ''}" 
                                        onclick="setStudentStatus('${student.nis}', 'Sakit')">
                                    ü§í Sakit
                                </button>
                                <button type="button" class="status-btn ${currentStatus === 'Izin' ? 'active-izin' : ''}" 
                                        onclick="setStudentStatus('${student.nis}', 'Izin')">
                                    üìù Izin
                                </button>
                                <button type="button" class="status-btn ${currentStatus === 'Alpa' ? 'active-alpa' : ''}" 
                                        onclick="setStudentStatus('${student.nis}', 'Alpa')">
                                    ‚ùå Alpa
                                </button>
                            </div>
                        </div>
                        <div>
                            <input type="text" 
                                   placeholder="Keterangan (opsional)..." 
                                   value="${currentNote}"
                                   onchange="setStudentNote('${student.nis}', this.value)"
                                   style="width: 100%; padding: 8px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 0.9em;">
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function setStudentStatus(nis, status) {
            if (!window.studentAttendance) {
                window.studentAttendance = {};
            }
            window.studentAttendance[nis] = status;
            renderSelectedStudents();
        }
        
        function setStudentNote(nis, note) {
            if (!window.studentNotes) {
                window.studentNotes = {};
            }
            window.studentNotes[nis] = note;
        }
        
        document.getElementById('selectAllHadirBtn').addEventListener('click', function() {
            if (!currentClass) {
                showToast('error', '‚ùå Pilih kelas terlebih dahulu!');
                return;
            }
            
            if (!window.selectedStudentsList || window.selectedStudentsList.length === 0) {
                showToast('error', '‚ùå Pilih siswa terlebih dahulu!');
                return;
            }
            
            if (!window.studentAttendance) {
                window.studentAttendance = {};
            }
            
            window.selectedStudentsList.forEach(nis => {
                window.studentAttendance[nis] = 'Hadir';
            });
            
            renderSelectedStudents();
            showToast('success', `‚úÖ Semua siswa terpilih (${window.selectedStudentsList.length}) ditandai HADIR`);
        });

        // ============================================
        // HANDLE FORM SUBMIT
        // ============================================
        document.getElementById('absensiForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentClass) {
                showToast('error', '‚ùå Pilih kelas terlebih dahulu!');
                return;
            }
            
            if (!window.studentAttendance || Object.keys(window.studentAttendance).length === 0) {
                showToast('error', '‚ùå Belum ada siswa yang diisi status kehadirannya!');
                return;
            }
            
            // Check if all students have status
            const totalStudents = window.selectedStudentsList ? window.selectedStudentsList.length : 0;
            const studentsWithStatus = Object.entries(window.studentAttendance)
                .filter(([nis, status]) => status !== null)
                .map(([nis, status]) => ({
                    student: allStudents.find(s => s.nis === nis),
                    status: status
                }));
            
            if (studentsWithStatus.length === 0) {
                showToast('error', '‚ùå Belum ada siswa yang diisi status kehadirannya!');
                return;
            }
            
            // Validate all students must have status
            if (studentsWithStatus.length < totalStudents) {
                const uncheckedCount = totalStudents - studentsWithStatus.length;
                showToast('error', `‚ùå Masih ada ${uncheckedCount} siswa yang belum diceklis! Semua siswa harus diisi status kehadirannya.`);
                return;
            }
            
            // Disable all form elements
            disableFormElements(true);
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Menyimpan...';
            
            const tanggal = document.getElementById('tanggal').value;
            
            await saveAttendance(studentsWithStatus, tanggal, submitBtn);
        });
        
        async function saveAttendance(studentsWithStatus, tanggal, submitBtn) {
            let successCount = 0;
            let errorCount = 0;
            
            for (const item of studentsWithStatus) {
                const studentNote = window.studentNotes && window.studentNotes[item.student.nis] ? window.studentNotes[item.student.nis] : '';
                
                const params = new URLSearchParams({
                    action: 'saveAbsensi',
                    nama_siswa: item.student.nama_siswa,
                    kelas: item.student.kelas,
                    status: item.status,
                    tanggal: tanggal,
                    keterangan: studentNote,
                    input_by: currentUser.nama,
                    user_role: currentUser.role
                });
                
                try {
                    const response = await fetch(`${SCRIPT_URL}?${params.toString()}`, {
                        method: 'GET',
                        redirect: 'follow'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        successCount++;
                    } else {
                        errorCount++;
                        console.error('Error for student:', item.student.nama_siswa, result.message);
                    }
                } catch (error) {
                    errorCount++;
                    console.error('Error for student:', item.student.nama_siswa, error);
                }
            }
            
            if (successCount > 0 && errorCount === 0) {
                showToast('success', `‚úÖ Berhasil menyimpan absensi ${successCount} siswa!`);
                resetForm();
            } else if (successCount > 0 && errorCount > 0) {
                showToast('info', `‚ö†Ô∏è Berhasil: ${successCount} siswa, Gagal: ${errorCount} siswa`);
                // Re-enable form if there are errors
                disableFormElements(false);
                submitBtn.disabled = false;
                submitBtn.textContent = 'üíæ Simpan Absensi';
            } else {
                showToast('error', `‚ùå Gagal menyimpan semua absensi!`);
                // Re-enable form if all failed
                disableFormElements(false);
                submitBtn.disabled = false;
                submitBtn.textContent = 'üíæ Simpan Absensi';
            }
        }

        document.getElementById('resetBtn').addEventListener('click', resetForm);

        function resetForm() {
            document.getElementById('absensiForm').reset();
            document.getElementById('tanggal').valueAsDate = new Date();
            currentClass = '';
            window.studentAttendance = {};
            window.studentNotes = {};
            window.selectedStudentsList = [];
            
            document.getElementById('kelasSelect').value = '';
            document.getElementById('selectAllHadirBtn').style.display = 'none';
            document.getElementById('selectedStudentsContainer').style.display = 'none';
            document.getElementById('loadingStudents').style.display = 'none';
            
            // Re-enable all form elements after reset
            disableFormElements(false);
            
            loadClassFilter();
            
            showToast('info', '‚ÑπÔ∏è Form telah direset');
        }

        function showToast(type, message) {
            const toast = document.getElementById('toast');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 5000);
        }

        // ============================================
        // NAVIGASI HALAMAN
        // ============================================
        function showPage(page) {
            document.querySelectorAll('.page-content').forEach(p => {
                p.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-tab').forEach(t => {
                t.classList.remove('active');
            });
            
            if (page === 'absensi') {
                document.getElementById('pageAbsensi').classList.add('active');
                document.querySelectorAll('.nav-tab')[0].classList.add('active');
            } else if (page === 'laporan') {
                document.getElementById('pageLaporan').classList.add('active');
                document.querySelectorAll('.nav-tab')[1].classList.add('active');
                
                loadReportClasses();
            } else if (page === 'informasi') {
                document.getElementById('pageInformasi').classList.add('active');
                document.querySelectorAll('.nav-tab')[2].classList.add('active');
            }
        }

        // ============================================
        // LAPORAN FUNCTIONS
        // ============================================
        async function loadReportClasses() {
            const selectElement = document.getElementById('reportKelas');
            
            if (selectElement.options.length > 1) return;
            
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getClasses`);
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    result.data.forEach(kelas => {
                        const option = document.createElement('option');
                        option.value = kelas;
                        option.textContent = `Kelas ${kelas}`;
                        selectElement.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading report classes:', error);
            }
        }

        function handlePeriodChange() {
            const period = document.getElementById('reportPeriod').value;
            const customRange = document.getElementById('customDateRange');
            
            if (period === 'custom') {
                customRange.style.display = 'grid';
            } else {
                customRange.style.display = 'none';
            }
        }

        function getDateRange() {
            const period = document.getElementById('reportPeriod').value;
            const today = new Date();
            let startDate, endDate;
            
            if (period === 'today') {
                startDate = endDate = today.toISOString().split('T')[0];
            } else if (period === 'week') {
                const firstDay = new Date(today.setDate(today.getDate() - today.getDay()));
                const lastDay = new Date(today.setDate(today.getDate() - today.getDay() + 6));
                startDate = firstDay.toISOString().split('T')[0];
                endDate = lastDay.toISOString().split('T')[0];
            } else if (period === 'month') {
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                startDate = firstDay.toISOString().split('T')[0];
                endDate = lastDay.toISOString().split('T')[0];
            } else if (period === 'custom') {
                startDate = document.getElementById('reportStartDate').value;
                endDate = document.getElementById('reportEndDate').value;
                
                if (!startDate || !endDate) {
                    showToast('error', '‚ùå Pilih tanggal mulai dan akhir!');
                    return null;
                }
            }
            
            return { startDate, endDate };
        }

        async function loadReport() {
            const dateRange = getDateRange();
            if (!dateRange) return;
            
            const kelas = document.getElementById('reportKelas').value;
            
            document.getElementById('reportLoading').style.display = 'block';
            document.getElementById('reportTableContainer').style.display = 'none';
            document.getElementById('summaryTableContainer').style.display = 'none';
            document.getElementById('reportEmpty').style.display = 'none';
            document.getElementById('summaryCards').style.display = 'none';
            document.getElementById('viewToggle').style.display = 'none';
            
            console.log('üìä Loading report with params:', {
                startDate: dateRange.startDate,
                endDate: dateRange.endDate,
                kelas: kelas || 'Semua'
            });
            
            try {
                const params = new URLSearchParams({
                    action: 'getReport',
                    startDate: dateRange.startDate,
                    endDate: dateRange.endDate,
                    kelas: kelas || ''
                });
                
                const response = await fetch(`${SCRIPT_URL}?${params.toString()}`, {
                    method: 'GET',
                    redirect: 'follow'
                });
                
                console.log('üì° Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('üì¶ Response data:', result);
                
                document.getElementById('reportLoading').style.display = 'none';
                
                if (result.success && result.data && result.data.length > 0) {
                    console.log('‚úÖ Data found:', result.data.length, 'records');
                    currentReportData = result.data;
                    
                    // Show view toggle if "Semua Kelas" selected
                    if (!kelas) {
                        document.getElementById('viewToggle').style.display = 'flex';
                    }
                    
                    renderReport(result.data);
                    showToast('success', `‚úÖ ${result.data.length} data absensi ditemukan`);
                } else {
                    console.log('‚ö†Ô∏è No data found');
                    document.getElementById('reportEmpty').style.display = 'block';
                    showToast('info', '‚ÑπÔ∏è Tidak ada data untuk filter yang dipilih');
                }
            } catch (error) {
                console.error('‚ùå Error loading report:', error);
                document.getElementById('reportLoading').style.display = 'none';
                document.getElementById('reportEmpty').style.display = 'block';
                showToast('error', '‚ùå Gagal memuat laporan: ' + error.message);
            }
        }

        function renderReport(data) {
            const kelas = document.getElementById('reportKelas').value;
            
            // Calculate summary
            const summary = {
                hadir: 0,
                sakit: 0,
                izin: 0,
                alpa: 0
            };
            
            // Count each status
            data.forEach(d => {
                if (d.status === 'Hadir') {
                    summary.hadir++;
                } else if (d.status === 'Sakit') {
                    summary.sakit++;
                } else if (d.status === 'Izin') {
                    summary.izin++;
                } else if (d.status === 'Alpa') {
                    summary.alpa++;
                }
            });
            
            // Calculate tidak hadir (Sakit + Izin + Alpa)
            const tidakHadir = summary.sakit + summary.izin + summary.alpa;
            
            console.log('üìä Summary:', {
                hadir: summary.hadir,
                sakit: summary.sakit,
                izin: summary.izin,
                alpa: summary.alpa,
                tidakHadir: tidakHadir,
                total: data.length
            });
            
            // Show summary cards
            document.getElementById('summaryCards').style.display = 'grid';
            document.getElementById('summaryHadir').textContent = summary.hadir;
            document.getElementById('summarySakit').textContent = summary.sakit;
            document.getElementById('summaryIzin').textContent = summary.izin;
            document.getElementById('summaryAlpa').textContent = summary.alpa;
            document.getElementById('summaryTidakHadir').textContent = tidakHadir;
            
            // Render based on current view
            if (currentView === 'detail') {
                renderDetailView(data);
            } else if (currentView === 'student') {
                renderStudentView(data);
            } else {
                renderSummaryView(data);
            }
        }

        function renderDetailView(data) {
            const tbody = document.getElementById('reportTableBody');
            tbody.innerHTML = '';
            
            // Sort data by student name alphabetically
            const sortedData = [...data].sort((a, b) => {
                return a.nama_siswa.localeCompare(b.nama_siswa, 'id');
            });
            
            sortedData.forEach((row, index) => {
                const tr = document.createElement('tr');
                
                let statusClass = '';
                if (row.status === 'Hadir') statusClass = 'status-hadir';
                else if (row.status === 'Sakit') statusClass = 'status-sakit';
                else if (row.status === 'Izin') statusClass = 'status-izin';
                else if (row.status === 'Alpa') statusClass = 'status-alpa';
                
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${row.tanggal}</td>
                    <td>${row.nama_siswa}</td>
                    <td>${row.kelas}</td>
                    <td><span class="status-badge ${statusClass}">${row.status}</span></td>
                    <td>${row.keterangan || '-'}</td>
                    <td>${row.input_by || '-'}</td>
                `;
                
                tbody.appendChild(tr);
            });
            
            document.getElementById('reportTableContainer').style.display = 'block';
        }

        function renderStudentView(data) {
            // Group by student
            const studentSummary = {};
            
            data.forEach(row => {
                const key = `${row.nama_siswa}|${row.kelas}`;
                
                if (!studentSummary[key]) {
                    studentSummary[key] = {
                        nama_siswa: row.nama_siswa,
                        kelas: row.kelas,
                        hadir: 0,
                        sakit: 0,
                        izin: 0,
                        alpa: 0,
                        total: 0
                    };
                }
                
                studentSummary[key].total++;
                
                if (row.status === 'Hadir') studentSummary[key].hadir++;
                else if (row.status === 'Sakit') studentSummary[key].sakit++;
                else if (row.status === 'Izin') studentSummary[key].izin++;
                else if (row.status === 'Alpa') studentSummary[key].alpa++;
            });
            
            const tbody = document.getElementById('studentTableBody');
            tbody.innerHTML = '';
            
            // Sort by student name alphabetically
            const sortedStudents = Object.values(studentSummary).sort((a, b) => {
                return a.nama_siswa.localeCompare(b.nama_siswa, 'id');
            });
            
            sortedStudents.forEach((student, index) => {
                const persentase = ((student.hadir / student.total) * 100).toFixed(1);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-center">${index + 1}</td>
                    <td><strong>${student.nama_siswa}</strong></td>
                    <td>${student.kelas}</td>
                    <td class="text-center"><span class="status-badge status-hadir">${student.hadir}</span></td>
                    <td class="text-center"><span class="status-badge status-sakit">${student.sakit}</span></td>
                    <td class="text-center"><span class="status-badge status-izin">${student.izin}</span></td>
                    <td class="text-center"><span class="status-badge status-alpa">${student.alpa}</span></td>
                    <td class="text-center"><strong>${student.total}</strong></td>
                    <td class="text-center"><strong>${persentase}%</strong></td>
                `;
                
                tbody.appendChild(tr);
            });
            
            document.getElementById('studentTableContainer').style.display = 'block';
        }

        function renderSummaryView(data) {
            // Group by class
            const classSummary = {};
            
            data.forEach(row => {
                if (!classSummary[row.kelas]) {
                    classSummary[row.kelas] = {
                        hadir: 0,
                        sakit: 0,
                        izin: 0,
                        alpa: 0,
                        total: 0
                    };
                }
                
                classSummary[row.kelas].total++;
                
                if (row.status === 'Hadir') classSummary[row.kelas].hadir++;
                else if (row.status === 'Sakit') classSummary[row.kelas].sakit++;
                else if (row.status === 'Izin') classSummary[row.kelas].izin++;
                else if (row.status === 'Alpa') classSummary[row.kelas].alpa++;
            });
            
            const tbody = document.getElementById('summaryTableBody');
            tbody.innerHTML = '';
            
            const sortedClasses = Object.keys(classSummary).sort();
            
            // Variables for total calculation
            let totalHadir = 0;
            let totalSakit = 0;
            let totalIzin = 0;
            let totalAlpa = 0;
            let totalAll = 0;
            
            sortedClasses.forEach((kelas, index) => {
                const summary = classSummary[kelas];
                const persentase = ((summary.hadir / summary.total) * 100).toFixed(1);
                
                // Add to totals
                totalHadir += summary.hadir;
                totalSakit += summary.sakit;
                totalIzin += summary.izin;
                totalAlpa += summary.alpa;
                totalAll += summary.total;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-center">${index + 1}</td>
                    <td><strong>${kelas}</strong></td>
                    <td class="text-center"><span class="status-badge status-hadir">${summary.hadir}</span></td>
                    <td class="text-center"><span class="status-badge status-sakit">${summary.sakit}</span></td>
                    <td class="text-center"><span class="status-badge status-izin">${summary.izin}</span></td>
                    <td class="text-center"><span class="status-badge status-alpa">${summary.alpa}</span></td>
                    <td class="text-center"><strong>${persentase}%</strong></td>
                `;
                
                tbody.appendChild(tr);
            });
            
            // Add total row if there are multiple classes
            if (sortedClasses.length > 1) {
                const totalPersentase = ((totalHadir / totalAll) * 100).toFixed(1);
                
                const totalTr = document.createElement('tr');
                totalTr.style.background = '#f8f9fa';
                totalTr.style.fontWeight = 'bold';
                totalTr.style.borderTop = '3px solid #667eea';
                totalTr.innerHTML = `
                    <td class="text-center" colspan="2"><strong>TOTAL</strong></td>
                    <td class="text-center"><span class="status-badge status-hadir">${totalHadir}</span></td>
                    <td class="text-center"><span class="status-badge status-sakit">${totalSakit}</span></td>
                    <td class="text-center"><span class="status-badge status-izin">${totalIzin}</span></td>
                    <td class="text-center"><span class="status-badge status-alpa">${totalAlpa}</span></td>
                    <td class="text-center"><strong>${totalPersentase}%</strong></td>
                `;
                
                tbody.appendChild(totalTr);
            }
            
            document.getElementById('summaryTableContainer').style.display = 'block';
        }

        function switchView(view) {
            currentView = view;
            
            // Update toggle buttons
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Hide all views
            document.getElementById('detailView').classList.remove('active');
            document.getElementById('studentView').classList.remove('active');
            document.getElementById('summaryView').classList.remove('active');
            
            if (view === 'detail') {
                document.querySelectorAll('.toggle-btn')[0].classList.add('active');
                document.getElementById('detailView').classList.add('active');
                renderDetailView(currentReportData);
            } else if (view === 'student') {
                document.querySelectorAll('.toggle-btn')[1].classList.add('active');
                document.getElementById('studentView').classList.add('active');
                renderStudentView(currentReportData);
            } else {
                document.querySelectorAll('.toggle-btn')[2].classList.add('active');
                document.getElementById('summaryView').classList.add('active');
                renderSummaryView(currentReportData);
            }
        }

        function exportToCSV() {
            if (currentReportData.length === 0) {
                showToast('error', '‚ùå Tidak ada data untuk di-export');
                return;
            }
            
            let csv = 'No,Tanggal,Nama Siswa,Kelas,Status,Keterangan,Input By\n';
            
            currentReportData.forEach((row, index) => {
                csv += `${index + 1},"${row.tanggal}","${row.nama_siswa}","${row.kelas}","${row.status}","${row.keterangan || '-'}","${row.input_by || '-'}"\n`;
            });
            
            downloadCSV(csv, 'laporan-absensi-detail.csv');
            showToast('success', '‚úÖ Data berhasil di-export!');
        }

        function exportStudentToCSV() {
            if (currentReportData.length === 0) {
                showToast('error', '‚ùå Tidak ada data untuk di-export');
                return;
            }
            
            // Group by student
            const studentSummary = {};
            
            currentReportData.forEach(row => {
                const key = `${row.nama_siswa}|${row.kelas}`;
                
                if (!studentSummary[key]) {
                    studentSummary[key] = {
                        nama_siswa: row.nama_siswa,
                        kelas: row.kelas,
                        hadir: 0,
                        sakit: 0,
                        izin: 0,
                        alpa: 0,
                        total: 0
                    };
                }
                
                studentSummary[key].total++;
                
                if (row.status === 'Hadir') studentSummary[key].hadir++;
                else if (row.status === 'Sakit') studentSummary[key].sakit++;
                else if (row.status === 'Izin') studentSummary[key].izin++;
                else if (row.status === 'Alpa') studentSummary[key].alpa++;
            });
            
            let csv = 'No,Nama Siswa,Kelas,Hadir,Sakit,Izin,Alpa,Total,Persentase Hadir\n';
            
            // Sort by student name alphabetically
            const sortedStudents = Object.values(studentSummary).sort((a, b) => {
                return a.nama_siswa.localeCompare(b.nama_siswa, 'id');
            });
            
            sortedStudents.forEach((student, index) => {
                const persentase = ((student.hadir / student.total) * 100).toFixed(1);
                
                csv += `${index + 1},"${student.nama_siswa}","${student.kelas}",${student.hadir},${student.sakit},${student.izin},${student.alpa},${student.total},${persentase}%\n`;
            });
            
            downloadCSV(csv, 'laporan-absensi-per-siswa.csv');
            showToast('success', '‚úÖ Detail per siswa berhasil di-export!');
        }

        function exportSummaryToCSV() {
            if (currentReportData.length === 0) {
                showToast('error', '‚ùå Tidak ada data untuk di-export');
                return;
            }
            
            // Group by class
            const classSummary = {};
            
            currentReportData.forEach(row => {
                if (!classSummary[row.kelas]) {
                    classSummary[row.kelas] = {
                        hadir: 0,
                        sakit: 0,
                        izin: 0,
                        alpa: 0,
                        total: 0
                    };
                }
                
                classSummary[row.kelas].total++;
                
                if (row.status === 'Hadir') classSummary[row.kelas].hadir++;
                else if (row.status === 'Sakit') classSummary[row.kelas].sakit++;
                else if (row.status === 'Izin') classSummary[row.kelas].izin++;
                else if (row.status === 'Alpa') classSummary[row.kelas].alpa++;
            });
            
            let csv = 'No,Kelas,Hadir,Sakit,Izin,Alpa,Persentase Hadir\n';
            
            const sortedClasses = Object.keys(classSummary).sort();
            
            sortedClasses.forEach((kelas, index) => {
                const summary = classSummary[kelas];
                const persentase = ((summary.hadir / summary.total) * 100).toFixed(1);
                
                csv += `${index + 1},"${kelas}",${summary.hadir},${summary.sakit},${summary.izin},${summary.alpa},${persentase}%\n`;
            });
            
            downloadCSV(csv, 'laporan-absensi-ringkasan.csv');
            showToast('success', '‚úÖ Ringkasan berhasil di-export!');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ============================================
        // INFORMASI PAGE FUNCTIONS - TERPISAH
        // ============================================
        
        // Handle period change for Peringkat Kelas
        function handleKelasPeriodChange() {
            const period = document.getElementById('kelasPeriod').value;
            const customRange1 = document.getElementById('kelasCustomDateRange');
            const customRange2 = document.getElementById('kelasCustomDateRange2');
            
            if (period === 'custom') {
                customRange1.style.display = 'block';
                customRange2.style.display = 'block';
            } else {
                customRange1.style.display = 'none';
                customRange2.style.display = 'none';
            }
        }
        
        // Handle period change for Peringkat Siswa
        function handleSiswaPeriodChange() {
            const period = document.getElementById('siswaPeriod').value;
            const customRange1 = document.getElementById('siswaCustomDateRange');
            const customRange2 = document.getElementById('siswaCustomDateRange2');
            
            if (period === 'custom') {
                customRange1.style.display = 'block';
                customRange2.style.display = 'block';
            } else {
                customRange1.style.display = 'none';
                customRange2.style.display = 'none';
            }
        }
        
        // Get date range for Peringkat Kelas
        function getKelasDateRange() {
            const period = document.getElementById('kelasPeriod').value;
            const today = new Date();
            let startDate = '', endDate = '';
            
            if (period === 'all') {
                // Return empty strings for all data
                return { startDate: '', endDate: '' };
            } else if (period === 'today') {
                startDate = endDate = today.toISOString().split('T')[0];
            } else if (period === 'week') {
                const firstDay = new Date(today.setDate(today.getDate() - today.getDay()));
                const lastDay = new Date(today.setDate(today.getDate() - today.getDay() + 6));
                startDate = firstDay.toISOString().split('T')[0];
                endDate = lastDay.toISOString().split('T')[0];
            } else if (period === 'month') {
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                startDate = firstDay.toISOString().split('T')[0];
                endDate = lastDay.toISOString().split('T')[0];
            } else if (period === 'custom') {
                startDate = document.getElementById('kelasStartDate').value;
                endDate = document.getElementById('kelasEndDate').value;
                
                if (!startDate || !endDate) {
                    showToast('error', '‚ùå Pilih tanggal mulai dan akhir!');
                    return null;
                }
            }
            
            return { startDate, endDate };
        }
        
        // Get date range for Peringkat Siswa
        function getSiswaDateRange() {
            const period = document.getElementById('siswaPeriod').value;
            const today = new Date();
            let startDate = '', endDate = '';
            
            if (period === 'all') {
                // Return empty strings for all data
                return { startDate: '', endDate: '' };
            } else if (period === 'today') {
                startDate = endDate = today.toISOString().split('T')[0];
            } else if (period === 'week') {
                const firstDay = new Date(today.setDate(today.getDate() - today.getDay()));
                const lastDay = new Date(today.setDate(today.getDate() - today.getDay() + 6));
                startDate = firstDay.toISOString().split('T')[0];
                endDate = lastDay.toISOString().split('T')[0];
            } else if (period === 'month') {
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                startDate = firstDay.toISOString().split('T')[0];
                endDate = lastDay.toISOString().split('T')[0];
            } else if (period === 'custom') {
                startDate = document.getElementById('siswaStartDate').value;
                endDate = document.getElementById('siswaEndDate').value;
                
                if (!startDate || !endDate) {
                    showToast('error', '‚ùå Pilih tanggal mulai dan akhir!');
                    return null;
                }
            }
            
            return { startDate, endDate };
        }
        
        // 1. Load Rekap Siswa
        async function loadRekapSiswa() {
            const loadBtn = document.getElementById('loadRekapBtn');
            const loading = document.getElementById('rekapLoading');
            const content = document.getElementById('rekapContent');
            const empty = document.getElementById('rekapEmpty');
            
            loadBtn.disabled = true;
            loadBtn.textContent = '‚è≥ Memuat...';
            loading.style.display = 'block';
            content.style.display = 'none';
            empty.style.display = 'none';
            
            try {
                // Ensure we have student data
                if (allStudents.length === 0) {
                    await loadAllStudents();
                }
                
                if (allStudents.length > 0) {
                    renderRekapSiswa();
                    loading.style.display = 'none';
                    content.style.display = 'block';
                    showToast('success', '‚úÖ Rekap siswa berhasil dimuat!');
                } else {
                    loading.style.display = 'none';
                    empty.style.display = 'block';
                    showToast('info', '‚ÑπÔ∏è Belum ada data siswa');
                }
            } catch (error) {
                console.error('‚ùå Error loading rekap siswa:', error);
                loading.style.display = 'none';
                empty.style.display = 'block';
                showToast('error', '‚ùå Gagal memuat rekap siswa: ' + error.message);
            }
            
            loadBtn.disabled = false;
            loadBtn.textContent = 'üîÑ Tarik Data';
        }
        
        // 2. Load Peringkat Kelas
        async function loadPeringkatKelas() {
            const loadBtn = document.getElementById('loadKelasBtn');
            const loading = document.getElementById('kelasLoading');
            const content = document.getElementById('kelasContent');
            const empty = document.getElementById('kelasEmpty');
            
            // Get date range from filter
            const dateRange = getKelasDateRange();
            if (!dateRange) return;
            
            loadBtn.disabled = true;
            loadBtn.textContent = '‚è≥ Memuat...';
            loading.style.display = 'block';
            content.style.display = 'none';
            empty.style.display = 'none';
            
            try {
                // Load attendance data with date filter
                const params = new URLSearchParams({
                    action: 'getReport',
                    startDate: dateRange.startDate,
                    endDate: dateRange.endDate,
                    kelas: ''
                });
                
                const response = await fetch(`${SCRIPT_URL}?${params.toString()}`, {
                    method: 'GET',
                    redirect: 'follow'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                console.log('üìä Peringkat Kelas - Response:', result);
                console.log('üìä Peringkat Kelas - Data length:', result.data ? result.data.length : 0);
                console.log('üìä Peringkat Kelas - Date Range:', dateRange);
                
                if (result.success && result.data && result.data.length > 0) {
                    renderPeringkatKelas(result.data);
                    loading.style.display = 'none';
                    content.style.display = 'block';
                    
                    const periodText = document.getElementById('kelasPeriod').selectedOptions[0].text;
                    showToast('success', `‚úÖ Peringkat kelas berhasil dimuat! (${result.data.length} data - ${periodText})`);
                } else {
                    console.warn('‚ö†Ô∏è Peringkat Kelas - No data or failed:', result);
                    loading.style.display = 'none';
                    empty.style.display = 'block';
                    showToast('info', '‚ÑπÔ∏è Belum ada data absensi untuk periode yang dipilih');
                }
            } catch (error) {
                console.error('‚ùå Error loading peringkat kelas:', error);
                loading.style.display = 'none';
                empty.style.display = 'block';
                showToast('error', '‚ùå Gagal memuat peringkat kelas: ' + error.message);
            }
            
            loadBtn.disabled = false;
            loadBtn.textContent = 'üîÑ Tarik Data';
        }
        
        // 3. Load Peringkat Siswa
        async function loadPeringkatSiswa() {
            const loadBtn = document.getElementById('loadSiswaBtn');
            const loading = document.getElementById('siswaLoading');
            const content = document.getElementById('siswaContent');
            const empty = document.getElementById('siswaEmpty');
            
            // Get date range from filter
            const dateRange = getSiswaDateRange();
            if (!dateRange) return;
            
            loadBtn.disabled = true;
            loadBtn.textContent = '‚è≥ Memuat...';
            loading.style.display = 'block';
            content.style.display = 'none';
            empty.style.display = 'none';
            
            try {
                // Load attendance data with date filter
                const params = new URLSearchParams({
                    action: 'getReport',
                    startDate: dateRange.startDate,
                    endDate: dateRange.endDate,
                    kelas: ''
                });
                
                const response = await fetch(`${SCRIPT_URL}?${params.toString()}`, {
                    method: 'GET',
                    redirect: 'follow'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                console.log('üìä Peringkat Siswa - Response:', result);
                console.log('üìä Peringkat Siswa - Data length:', result.data ? result.data.length : 0);
                console.log('üìä Peringkat Siswa - Date Range:', dateRange);
                
                if (result.success && result.data && result.data.length > 0) {
                    renderPeringkatSiswa(result.data);
                    loading.style.display = 'none';
                    content.style.display = 'block';
                    
                    const periodText = document.getElementById('siswaPeriod').selectedOptions[0].text;
                    showToast('success', `‚úÖ Peringkat siswa berhasil dimuat! (${result.data.length} data - ${periodText})`);
                } else {
                    console.warn('‚ö†Ô∏è Peringkat Siswa - No data or failed:', result);
                    loading.style.display = 'none';
                    empty.style.display = 'block';
                    showToast('info', '‚ÑπÔ∏è Belum ada data absensi untuk periode yang dipilih');
                }
            } catch (error) {
                console.error('‚ùå Error loading peringkat siswa:', error);
                loading.style.display = 'none';
                empty.style.display = 'block';
                showToast('error', '‚ùå Gagal memuat peringkat siswa: ' + error.message);
            }
            
            loadBtn.disabled = false;
            loadBtn.textContent = 'üîÑ Tarik Data';
        }

        function renderRekapSiswa() {
            const tbody = document.getElementById('rekapSiswaBody');
            tbody.innerHTML = '';
            
            // Group students by class
            const classCounts = {};
            
            allStudents.forEach(student => {
                if (!classCounts[student.kelas]) {
                    classCounts[student.kelas] = 0;
                }
                classCounts[student.kelas]++;
            });
            
            // Sort by class name
            const sortedClasses = Object.keys(classCounts).sort();
            
            let totalSiswa = 0;
            
            sortedClasses.forEach((kelas, index) => {
                const count = classCounts[kelas];
                totalSiswa += count;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-center">${index + 1}</td>
                    <td><strong>Kelas ${kelas}</strong></td>
                    <td class="text-center"><strong>${count}</strong> siswa</td>
                `;
                tbody.appendChild(tr);
            });
            
            // Add total row
            const totalTr = document.createElement('tr');
            totalTr.style.background = '#f8f9fa';
            totalTr.style.fontWeight = 'bold';
            totalTr.style.borderTop = '3px solid #667eea';
            totalTr.innerHTML = `
                <td class="text-center" colspan="2"><strong>TOTAL SELURUH SISWA</strong></td>
                <td class="text-center"><strong style="color: #667eea; font-size: 1.2em;">${totalSiswa}</strong> siswa</td>
            `;
            tbody.appendChild(totalTr);
        }

        function renderPeringkatKelas(attendanceData) {
            // Group by class
            const classStats = {};
            
            attendanceData.forEach(row => {
                if (!classStats[row.kelas]) {
                    classStats[row.kelas] = {
                        kelas: row.kelas,
                        hadir: 0,
                        total: 0
                    };
                }
                
                classStats[row.kelas].total++;
                if (row.status === 'Hadir') {
                    classStats[row.kelas].hadir++;
                }
            });
            
            // Calculate percentage and sort
            const classArray = Object.values(classStats).map(stat => ({
                ...stat,
                persentase: (stat.hadir / stat.total * 100).toFixed(2)
            }));
            
            // Sort by percentage descending
            classArray.sort((a, b) => b.persentase - a.persentase);
            
            // Render top 3
            const terbaikBody = document.getElementById('kelasTerbaikBody');
            terbaikBody.innerHTML = '';
            
            const top3 = classArray.slice(0, 3);
            top3.forEach((stat, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â';
                const tr = document.createElement('tr');
                tr.style.background = index === 0 ? '#d4edda' : '';
                tr.innerHTML = `
                    <td class="text-center"><strong>${medal} ${index + 1}</strong></td>
                    <td><strong>Kelas ${stat.kelas}</strong></td>
                    <td class="text-center">${stat.hadir}</td>
                    <td class="text-center">${stat.total}</td>
                    <td class="text-center"><strong style="color: #28a745;">${stat.persentase}%</strong></td>
                `;
                terbaikBody.appendChild(tr);
            });
            
            // Render bottom 3
            const terburukBody = document.getElementById('kelasTerburukBody');
            terburukBody.innerHTML = '';
            
            const bottom3 = classArray.slice(-3).reverse();
            bottom3.forEach((stat, index) => {
                const tr = document.createElement('tr');
                tr.style.background = index === 0 ? '#f8d7da' : '';
                tr.innerHTML = `
                    <td class="text-center"><strong>${index + 1}</strong></td>
                    <td><strong>Kelas ${stat.kelas}</strong></td>
                    <td class="text-center">${stat.hadir}</td>
                    <td class="text-center">${stat.total}</td>
                    <td class="text-center"><strong style="color: #dc3545;">${stat.persentase}%</strong></td>
                `;
                terburukBody.appendChild(tr);
            });
        }

        function renderPeringkatSiswa(attendanceData) {
            // Group by student
            const studentStats = {};
            
            attendanceData.forEach(row => {
                const key = `${row.nama_siswa}|${row.kelas}`;
                
                if (!studentStats[key]) {
                    studentStats[key] = {
                        nama_siswa: row.nama_siswa,
                        kelas: row.kelas,
                        hadir: 0,
                        total: 0
                    };
                }
                
                studentStats[key].total++;
                if (row.status === 'Hadir') {
                    studentStats[key].hadir++;
                }
            });
            
            // Calculate percentage and sort
            const studentArray = Object.values(studentStats).map(stat => ({
                ...stat,
                persentase: (stat.hadir / stat.total * 100).toFixed(2)
            }));
            
            // Sort by percentage descending
            studentArray.sort((a, b) => b.persentase - a.persentase);
            
            // Render top 3
            const terbaikBody = document.getElementById('siswaTerbaikBody');
            terbaikBody.innerHTML = '';
            
            const top3 = studentArray.slice(0, 3);
            top3.forEach((stat, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â';
                const tr = document.createElement('tr');
                tr.style.background = index === 0 ? '#d4edda' : '';
                tr.innerHTML = `
                    <td class="text-center"><strong>${medal} ${index + 1}</strong></td>
                    <td><strong>${stat.nama_siswa}</strong></td>
                    <td>Kelas ${stat.kelas}</td>
                    <td class="text-center">${stat.hadir}</td>
                    <td class="text-center">${stat.total}</td>
                    <td class="text-center"><strong style="color: #28a745;">${stat.persentase}%</strong></td>
                `;
                terbaikBody.appendChild(tr);
            });
            
            // Render bottom 3
            const terburukBody = document.getElementById('siswaTerburukBody');
            terburukBody.innerHTML = '';
            
            const bottom3 = studentArray.slice(-3).reverse();
            bottom3.forEach((stat, index) => {
                const tr = document.createElement('tr');
                tr.style.background = index === 0 ? '#f8d7da' : '';
                tr.innerHTML = `
                    <td class="text-center"><strong>${index + 1}</strong></td>
                    <td><strong>${stat.nama_siswa}</strong></td>
                    <td>Kelas ${stat.kelas}</td>
                    <td class="text-center">${stat.hadir}</td>
                    <td class="text-center">${stat.total}</td>
                    <td class="text-center"><strong style="color: #dc3545;">${stat.persentase}%</strong></td>
                `;
                terburukBody.appendChild(tr);
            });
        }
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99c6155326285888',t:'MTc2Mjc4MzMwMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
