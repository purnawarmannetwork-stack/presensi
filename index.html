<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Absensi Multi-User</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    * {
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    
    .status-badge {
      transition: all 0.2s ease;
    }
    
    .status-badge:hover {
      transform: scale(1.05);
    }
    
    .card-hover {
      transition: all 0.3s ease;
    }
    
    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    
    .btn-primary {
      transition: all 0.2s ease;
    }
    
    .btn-primary:active {
      transform: scale(0.98);
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .loading-spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .role-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }
    
    .admin-badge {
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      color: white;
    }
    
    .kepsek-badge {
      background: linear-gradient(135deg, #4834d4, #686de0);
      color: white;
    }
    
    .guru-badge {
      background: linear-gradient(135deg, #00d2d3, #01a3a4);
      color: white;
    }
    
    .login-container {
      min-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .permission-denied {
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      margin: 16px 0;
      text-align: center;
      font-weight: 600;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="min-h-full"><!-- Login Screen -->
  <div id="login-screen" class="login-container">
   <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4">
    <div class="text-center mb-8">
     <div class="text-6xl mb-4">
      ğŸ«
     </div>
     <h1 id="login-title" class="text-3xl font-bold text-gray-800 mb-2">Sistem Absensi Online</h1>
     <p id="login-school" class="text-gray-600">SMP Purnawarman</p>
    </div>
    <form id="login-form" class="space-y-6">
     <div><label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label> <input type="text" id="username" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Masukkan username">
     </div>
     <div><label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password</label> <input type="password" id="password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Masukkan password">
     </div><button type="submit" id="login-btn" class="w-full btn-primary text-white font-bold py-4 px-6 rounded-lg shadow-lg hover:shadow-xl" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"> <span id="login-text">Masuk</span> </button>
    </form>
    <div class="mt-8 p-4 bg-gray-50 rounded-lg">
     <h3 class="font-bold text-gray-700 mb-3">ğŸ‘¥ Akun Demo:</h3>
     <div class="space-y-2 text-sm">
      <div class="flex justify-between"><span class="font-medium">Admin:</span> <span class="text-gray-600">admin / admin123</span>
      </div>
      <div class="flex justify-between"><span class="font-medium">Kepsek:</span> <span class="text-gray-600">kepsek / kepsek123</span>
      </div>
      <div class="flex justify-between"><span class="font-medium">Guru Piket:</span> <span class="text-gray-600">guru / guru123</span>
      </div>
     </div>
    </div>
   </div>
  </div><!-- Main App -->
  <div id="main-app" class="min-h-full flex flex-col hidden" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><!-- Header -->
   <header class="bg-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4 py-6">
     <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div class="text-center md:text-left">
       <h1 id="app-title" class="text-3xl font-bold" style="color: #667eea;">Sistem Absensi Online</h1>
       <p id="school-name" class="text-gray-600 mt-2">SMP Purnawarman</p>
      </div>
      <div class="flex items-center gap-4">
       <div id="user-info" class="text-center md:text-right">
        <div id="user-role-badge" class="role-badge admin-badge mb-2">
         ğŸ‘¤ Admin
        </div>
        <p class="text-sm text-gray-600"><span id="current-time"></span> WIB</p>
       </div><button onclick="logout()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all font-medium"> ğŸšª Keluar </button>
      </div>
     </div><!-- Navigation Menu -->
     <div class="mt-6 border-t pt-4">
      <nav class="flex flex-wrap gap-2"><button onclick="showAbsensiPage()" id="nav-absensi" class="px-4 py-2 rounded-lg font-medium transition-all bg-blue-500 text-white"> ğŸ“ Absensi </button> <button onclick="showRekapPage()" id="nav-rekap" class="px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300"> ğŸ“Š Rekap Absensi </button> <button onclick="showPanduanPage()" id="nav-panduan" class="px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300"> ğŸ“š Panduan Input </button> <button onclick="showPengaturanPage()" id="nav-pengaturan" class="px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300"> âš™ï¸ Pengaturan </button>
      </nav>
     </div>
    </div>
   </header><!-- Main Content -->
   <main class="flex-1 max-w-7xl w-full mx-auto px-4 py-8"><!-- Absensi Page -->
    <div id="absensi-page"><!-- Stats Cards -->
     <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
      <div class="bg-white rounded-lg shadow-md p-6 card-hover">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-500 text-sm">Total</p>
         <p id="total-count" class="text-2xl md:text-3xl font-bold" style="color: #667eea;">0</p>
        </div>
        <div class="text-3xl md:text-4xl">
         ğŸ“Š
        </div>
       </div>
      </div>
      <div class="bg-white rounded-lg shadow-md p-6 card-hover">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-500 text-sm">Hadir</p>
         <p id="hadir-count" class="text-2xl md:text-3xl font-bold text-green-600">0</p>
        </div>
        <div class="text-3xl md:text-4xl">
         âœ…
        </div>
       </div>
      </div>
      <div class="bg-white rounded-lg shadow-md p-6 card-hover">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-500 text-sm">Izin</p>
         <p id="izin-count" class="text-2xl md:text-3xl font-bold text-yellow-600">0</p>
        </div>
        <div class="text-3xl md:text-4xl">
         ğŸ“
        </div>
       </div>
      </div>
      <div class="bg-white rounded-lg shadow-md p-6 card-hover">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-500 text-sm">Sakit</p>
         <p id="sakit-count" class="text-2xl md:text-3xl font-bold text-red-600">0</p>
        </div>
        <div class="text-3xl md:text-4xl">
         ğŸ¥
        </div>
       </div>
      </div>
      <div class="bg-white rounded-lg shadow-md p-6 card-hover">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-500 text-sm">Alpha</p>
         <p id="alpha-count" class="text-2xl md:text-3xl font-bold text-purple-600">0</p>
        </div>
        <div class="text-3xl md:text-4xl">
         âŒ
        </div>
       </div>
      </div>
     </div><!-- Form Absensi -->
     <div id="form-section" class="bg-white rounded-lg shadow-lg p-6 mb-8">
      <h2 class="text-2xl font-bold mb-6" style="color: #667eea;">ğŸ“ Form Absensi</h2><!-- Filter Kelas untuk Form -->
      <div class="mb-6 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-400">
       <h3 class="text-lg font-bold text-blue-800 mb-3">ğŸ¯ Pilih Kelas untuk Absensi</h3>
       <div class="flex flex-col md:flex-row gap-4">
        <div class="flex-1"><label for="form-filter-kelas" class="block text-sm font-medium text-gray-700 mb-2">Kelas</label> <select id="form-filter-kelas" onchange="loadStudentsByClass()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"> <option value="">Pilih Kelas</option> <option value="VII A">VII A</option> <option value="VII B">VII B</option> <option value="VII C">VII C</option> <option value="VIII A">VIII A</option> <option value="VIII B">VIII B</option> <option value="VIII C">VIII C</option> <option value="IX A">IX A</option> <option value="IX B">IX B</option> <option value="IX C">IX C</option> </select>
        </div>
       </div>
      </div><!-- Student List for Attendance -->
      <div id="student-attendance-list" class="hidden mb-6">
       <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ‘¥ Daftar Siswa</h3>
       <div id="students-container" class="space-y-3 max-h-96 overflow-y-auto"><!-- Students will be loaded here -->
       </div>
       <div class="mt-4 flex gap-3"><button type="button" onclick="markAllPresent()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all font-medium text-sm"> âœ… Tandai Semua Hadir </button> <button type="button" onclick="saveAllAttendance()" class="px-6 py-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-all font-medium"> ğŸ’¾ Simpan Semua Absensi </button>
       </div>
      </div><!-- Individual Form (Hidden when class mode active) -->
      <form id="absensi-form" class="space-y-4">
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label for="nama-siswa" class="block text-sm font-medium text-gray-700 mb-2">Nama Siswa</label> <input type="text" id="nama-siswa" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Masukkan nama siswa">
        </div>
        <div><label for="kelas" class="block text-sm font-medium text-gray-700 mb-2">Kelas</label> <input type="text" id="kelas" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Contoh: VII A">
        </div>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Status Kehadiran</label>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3"><label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-green-500 transition-all"> <input type="radio" name="status" value="Hadir" required class="mr-3"> <span class="text-lg">âœ… Hadir</span> </label> <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-yellow-500 transition-all"> <input type="radio" name="status" value="Izin" required class="mr-3"> <span class="text-lg">ğŸ“ Izin</span> </label> <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-red-500 transition-all"> <input type="radio" name="status" value="Sakit" required class="mr-3"> <span class="text-lg">ğŸ¥ Sakit</span> </label> <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-purple-500 transition-all"> <input type="radio" name="status" value="Alpha" required class="mr-3"> <span class="text-lg">âŒ Alpha</span> </label>
        </div>
       </div>
       <div><label for="keterangan" class="block text-sm font-medium text-gray-700 mb-2">Keterangan (Opsional)</label> <textarea id="keterangan" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Tambahkan keterangan jika diperlukan"></textarea>
       </div><button type="submit" id="submit-btn" class="w-full btn-primary text-white font-bold py-4 px-6 rounded-lg shadow-lg hover:shadow-xl" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"> <span id="submit-text">Simpan Absensi</span> </button>
      </form>
     </div><!-- Filter Section -->
     <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
      <h2 class="text-2xl font-bold mb-4" style="color: #667eea;">ğŸ” Filter Data</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
       <div><label for="filter-kelas" class="block text-sm font-medium text-gray-700 mb-2">Filter Kelas</label> <select id="filter-kelas" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"> <option value="">Semua Kelas</option> </select>
       </div>
       <div><label for="filter-status" class="block text-sm font-medium text-gray-700 mb-2">Filter Status</label> <select id="filter-status" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"> <option value="">Semua Status</option> <option value="Hadir">Hadir</option> <option value="Izin">Izin</option> <option value="Sakit">Sakit</option> <option value="Alpha">Alpha</option> </select>
       </div>
       <div><label for="filter-tanggal" class="block text-sm font-medium text-gray-700 mb-2">Filter Tanggal</label> <input type="date" id="filter-tanggal" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
       </div>
       <div><label for="filter-user" class="block text-sm font-medium text-gray-700 mb-2">Input Oleh</label> <select id="filter-user" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"> <option value="">Semua User</option> </select>
       </div>
      </div>
     </div><!-- Data Absensi -->
     <div class="bg-white rounded-lg shadow-lg p-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
       <h2 class="text-2xl font-bold" style="color: #667eea;">ğŸ“‹ Data Absensi</h2>
       <div class="flex items-center gap-4">
        <div class="text-sm text-gray-600">
         Total: <span id="filtered-count" class="font-bold">0</span> data
        </div>
        <div id="export-section" class="hidden"><button onclick="exportToCSV()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all font-medium text-sm"> ğŸ“Š Export CSV </button>
        </div>
       </div>
      </div>
      <div id="absensi-list" class="space-y-4">
       <div class="text-center py-12 text-gray-400">
        <div class="text-6xl mb-4">
         ğŸ“
        </div>
        <p class="text-lg">Belum ada data absensi</p>
        <p class="text-sm mt-2">Mulai dengan mengisi form absensi di atas</p>
       </div>
      </div>
     </div>
    </div><!-- Panduan Page -->
    <div id="panduan-page" class="hidden">
     <div class="space-y-8"><!-- Panduan Input Manual -->
      <div class="bg-white rounded-lg shadow-lg p-6">
       <h2 class="text-2xl font-bold mb-6" style="color: #667eea;">ğŸ“ Panduan Input Data Siswa</h2><!-- Input Manual Section -->
       <div class="mb-8 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-400">
        <h3 class="text-xl font-bold text-blue-800 mb-4">1ï¸âƒ£ Input Manual (Satu per Satu)</h3>
        <div class="space-y-4">
         <div class="bg-white p-4 rounded-lg border border-blue-200">
          <h4 class="font-bold text-blue-700 mb-3">ğŸ“‹ Langkah-langkah:</h4>
          <ol class="list-decimal list-inside space-y-2 text-gray-700">
           <li>Buka halaman <strong>"ğŸ“ Absensi"</strong></li>
           <li>Scroll ke bagian <strong>"Form Absensi"</strong></li>
           <li>Isi <strong>Nama Siswa</strong> dan <strong>Kelas</strong></li>
           <li>Pilih <strong>Status Kehadiran</strong> (Hadir/Izin/Sakit/Alpha)</li>
           <li>Tambahkan <strong>Keterangan</strong> jika diperlukan</li>
           <li>Klik tombol <strong>"Simpan Absensi"</strong></li>
          </ol>
         </div>
         <div class="bg-green-50 p-4 rounded-lg border border-green-200">
          <div class="flex items-start gap-3"><span class="text-green-600 text-xl">ğŸ’¡</span>
           <div>
            <h4 class="font-bold text-green-700 mb-2">Tips Input Manual:</h4>
            <ul class="list-disc list-inside space-y-1 text-green-700 text-sm">
             <li>Pastikan nama siswa ditulis dengan benar dan konsisten</li>
             <li>Format kelas: VII A, VII B, VIII A, dst.</li>
             <li>Gunakan keterangan untuk informasi tambahan (misal: terlambat 10 menit)</li>
             <li>Data akan otomatis tersimpan dengan timestamp saat ini</li>
            </ul>
           </div>
          </div>
         </div>
        </div>
       </div><!-- Input Per Kelas Section -->
       <div class="mb-8 p-4 bg-green-50 rounded-lg border-l-4 border-green-400">
        <h3 class="text-xl font-bold text-green-800 mb-4">2ï¸âƒ£ Input Per Kelas (Batch/Massal)</h3>
        <div class="space-y-4">
         <div class="bg-white p-4 rounded-lg border border-green-200">
          <h4 class="font-bold text-green-700 mb-3">ğŸ¯ Langkah-langkah:</h4>
          <ol class="list-decimal list-inside space-y-2 text-gray-700">
           <li>Buka halaman <strong>"ğŸ“ Absensi"</strong></li>
           <li>Di bagian <strong>"Pilih Kelas untuk Absensi"</strong>, pilih kelas yang diinginkan</li>
           <li>Sistem akan menampilkan <strong>daftar semua siswa</strong> di kelas tersebut</li>
           <li>Pilih status kehadiran untuk <strong>setiap siswa</strong></li>
           <li>Tambahkan keterangan jika diperlukan</li>
           <li>Gunakan tombol <strong>"âœ… Tandai Semua Hadir"</strong> untuk efisiensi</li>
           <li>Klik <strong>"ğŸ’¾ Simpan Semua Absensi"</strong> untuk menyimpan</li>
          </ol>
         </div>
         <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
          <div class="flex items-start gap-3"><span class="text-yellow-600 text-xl">âš¡</span>
           <div>
            <h4 class="font-bold text-yellow-700 mb-2">Tips Input Per Kelas:</h4>
            <ul class="list-disc list-inside space-y-1 text-yellow-700 text-sm">
             <li><strong>Lebih cepat</strong> untuk absensi harian rutin</li>
             <li>Gunakan "Tandai Semua Hadir" lalu ubah yang tidak hadir</li>
             <li>Pastikan semua siswa sudah dipilih statusnya sebelum menyimpan</li>
             <li>Data akan tersimpan dengan tanggal dan waktu yang sama untuk satu kelas</li>
            </ul>
           </div>
          </div>
         </div>
        </div>
       </div><!-- Data Siswa Available -->
       <div class="mb-8 p-4 bg-purple-50 rounded-lg border-l-4 border-purple-400">
        <h3 class="text-xl font-bold text-purple-800 mb-4">3ï¸âƒ£ Data Siswa yang Tersedia</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
         <div class="bg-white p-4 rounded-lg border border-purple-200">
          <h4 class="font-bold text-purple-700 mb-3">ğŸ“ Kelas VII</h4>
          <ul class="space-y-1 text-sm text-gray-700">
           <li>â€¢ <strong>VII A</strong> - 15 siswa</li>
           <li>â€¢ <strong>VII B</strong> - 15 siswa</li>
           <li>â€¢ <strong>VII C</strong> - 15 siswa</li>
          </ul>
          <div class="mt-2 text-xs text-purple-600 font-medium">
           Total: 45 siswa
          </div>
         </div>
         <div class="bg-white p-4 rounded-lg border border-purple-200">
          <h4 class="font-bold text-purple-700 mb-3">ğŸ“ Kelas VIII</h4>
          <ul class="space-y-1 text-sm text-gray-700">
           <li>â€¢ <strong>VIII A</strong> - 15 siswa</li>
           <li>â€¢ <strong>VIII B</strong> - 15 siswa</li>
           <li>â€¢ <strong>VIII C</strong> - 15 siswa</li>
          </ul>
          <div class="mt-2 text-xs text-purple-600 font-medium">
           Total: 45 siswa
          </div>
         </div>
         <div class="bg-white p-4 rounded-lg border border-purple-200">
          <h4 class="font-bold text-purple-700 mb-3">ğŸ“ Kelas IX</h4>
          <ul class="space-y-1 text-sm text-gray-700">
           <li>â€¢ <strong>IX A</strong> - 15 siswa</li>
           <li>â€¢ <strong>IX B</strong> - 15 siswa</li>
           <li>â€¢ <strong>IX C</strong> - 15 siswa</li>
          </ul>
          <div class="mt-2 text-xs text-purple-600 font-medium">
           Total: 45 siswa
          </div>
         </div>
        </div>
        <div class="mt-4 p-3 bg-purple-100 border border-purple-300 rounded-lg">
         <div class="flex items-start gap-2"><span class="text-purple-600 text-lg">ğŸ“Š</span>
          <div class="text-purple-800 text-sm"><strong>Total Keseluruhan:</strong> 135 siswa dari 9 kelas. Data siswa saat ini menggunakan data sample. Untuk data real, hubungkan ke Google Sheets di menu Pengaturan.
          </div>
         </div>
        </div>
       </div><!-- Status Kehadiran Guide -->
       <div class="mb-8 p-4 bg-gray-50 rounded-lg border-l-4 border-gray-400">
        <h3 class="text-xl font-bold text-gray-800 mb-4">4ï¸âƒ£ Panduan Status Kehadiran</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
         <div class="space-y-3">
          <div class="flex items-center gap-3 p-3 bg-green-100 rounded-lg border border-green-200"><span class="text-2xl">âœ…</span>
           <div>
            <h4 class="font-bold text-green-800">Hadir</h4>
            <p class="text-sm text-green-700">Siswa hadir tepat waktu atau terlambat</p>
           </div>
          </div>
          <div class="flex items-center gap-3 p-3 bg-yellow-100 rounded-lg border border-yellow-200"><span class="text-2xl">ğŸ“</span>
           <div>
            <h4 class="font-bold text-yellow-800">Izin</h4>
            <p class="text-sm text-yellow-700">Siswa tidak hadir dengan keterangan/surat izin</p>
           </div>
          </div>
         </div>
         <div class="space-y-3">
          <div class="flex items-center gap-3 p-3 bg-red-100 rounded-lg border border-red-200"><span class="text-2xl">ğŸ¥</span>
           <div>
            <h4 class="font-bold text-red-800">Sakit</h4>
            <p class="text-sm text-red-700">Siswa tidak hadir karena sakit (ada surat dokter)</p>
           </div>
          </div>
          <div class="flex items-center gap-3 p-3 bg-purple-100 rounded-lg border border-purple-200"><span class="text-2xl">âŒ</span>
           <div>
            <h4 class="font-bold text-purple-800">Alpha</h4>
            <p class="text-sm text-purple-700">Siswa tidak hadir tanpa keterangan</p>
           </div>
          </div>
         </div>
        </div>
       </div><!-- Best Practices -->
       <div class="p-4 bg-indigo-50 rounded-lg border-l-4 border-indigo-400">
        <h3 class="text-xl font-bold text-indigo-800 mb-4">5ï¸âƒ£ Tips &amp; Best Practices</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
         <div>
          <h4 class="font-bold text-indigo-700 mb-3">â° Waktu Input:</h4>
          <ul class="list-disc list-inside space-y-1 text-indigo-700 text-sm">
           <li>Input absensi di awal jam pelajaran pertama</li>
           <li>Update jika ada siswa datang terlambat</li>
           <li>Pastikan semua kelas sudah terinput sebelum jam 10:00</li>
           <li>Lakukan pengecekan ulang di akhir hari</li>
          </ul>
         </div>
         <div>
          <h4 class="font-bold text-indigo-700 mb-3">ğŸ“ Keterangan:</h4>
          <ul class="list-disc list-inside space-y-1 text-indigo-700 text-sm">
           <li>Tulis waktu keterlambatan (misal: "Terlambat 15 menit")</li>
           <li>Catat alasan izin singkat (misal: "Keperluan keluarga")</li>
           <li>Untuk sakit, catat gejala jika perlu (misal: "Demam")</li>
           <li>Alpha: catat jika ada informasi tambahan</li>
          </ul>
         </div>
         <div>
          <h4 class="font-bold text-indigo-700 mb-3">ğŸ”„ Konsistensi:</h4>
          <ul class="list-disc list-inside space-y-1 text-indigo-700 text-sm">
           <li>Gunakan format nama yang sama setiap hari</li>
           <li>Pastikan format kelas konsisten (VII A, bukan 7A)</li>
           <li>Input data setiap hari tanpa terlewat</li>
           <li>Backup data secara berkala</li>
          </ul>
         </div>
         <div>
          <h4 class="font-bold text-indigo-700 mb-3">ğŸ“Š Monitoring:</h4>
          <ul class="list-disc list-inside space-y-1 text-indigo-700 text-sm">
           <li>Cek rekap harian di menu "ğŸ“Š Rekap Absensi"</li>
           <li>Monitor siswa dengan tingkat alpha tinggi</li>
           <li>Export data untuk laporan bulanan</li>
           <li>Koordinasi dengan wali kelas untuk follow up</li>
          </ul>
         </div>
        </div>
       </div><!-- Quick Access Buttons -->
       <div class="mt-8 flex flex-wrap gap-4 justify-center"><button onclick="showAbsensiPage()" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all font-medium shadow-lg"> ğŸ“ Mulai Input Absensi </button> <button onclick="showRekapPage()" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all font-medium shadow-lg"> ğŸ“Š Lihat Rekap Data </button> <button onclick="showPengaturanPage()" class="px-6 py-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-all font-medium shadow-lg"> âš™ï¸ Pengaturan Sistem </button>
       </div>
      </div>
     </div>
    </div><!-- Rekap Page -->
    <div id="rekap-page" class="hidden">
     <div class="space-y-8"><!-- Rekap Navigation -->
      <div class="bg-white rounded-lg shadow-lg p-6">
       <h2 class="text-2xl font-bold mb-6" style="color: #667eea;">ğŸ“Š Rekap Absensi</h2><!-- Rekap Type Selector -->
       <div class="flex flex-wrap gap-2 mb-6"><button onclick="showRekapHarian()" id="rekap-nav-harian" class="px-4 py-2 rounded-lg font-medium transition-all bg-blue-500 text-white"> ğŸ“… Rekap Harian </button> <button onclick="showRekapBulanan()" id="rekap-nav-bulanan" class="px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300"> ğŸ“Š Rekap Bulanan </button>
       </div><!-- Rekap Harian Section -->
       <div id="rekap-harian-section">
        <div class="mb-6 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-400">
         <h3 class="text-lg font-bold text-blue-800 mb-3">ğŸ“… Pilih Tanggal Rekap</h3>
         <div class="flex flex-col md:flex-row gap-4">
          <div class="flex-1"><label for="rekap-tanggal" class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label> <input type="date" id="rekap-tanggal" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
          </div>
          <div class="flex items-end"><button type="button" onclick="generateRekapByDate()" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all font-medium"> ğŸ“Š Generate Rekap </button>
          </div>
         </div>
        </div>
       </div><!-- Rekap Bulanan Section -->
       <div id="rekap-bulanan-section" class="hidden">
        <div class="mb-6 p-4 bg-green-50 rounded-lg border-l-4 border-green-400">
         <h3 class="text-lg font-bold text-green-800 mb-3">ğŸ“Š Pilih Bulan &amp; Tahun Rekap</h3>
         <div class="flex flex-col md:flex-row gap-4">
          <div class="flex-1"><label for="rekap-bulan" class="block text-sm font-medium text-gray-700 mb-2">Bulan</label> <select id="rekap-bulan" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"> <option value="01">Januari</option> <option value="02">Februari</option> <option value="03">Maret</option> <option value="04">April</option> <option value="05">Mei</option> <option value="06">Juni</option> <option value="07">Juli</option> <option value="08">Agustus</option> <option value="09">September</option> <option value="10">Oktober</option> <option value="11">November</option> <option value="12">Desember</option> </select>
          </div>
          <div class="flex-1"><label for="rekap-tahun" class="block text-sm font-medium text-gray-700 mb-2">Tahun</label> <select id="rekap-tahun" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"> <option value="2024">2024</option> <option value="2025">2025</option> <option value="2026">2026</option> </select>
          </div>
          <div class="flex items-end"><button type="button" onclick="generateRekapBulanan()" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all font-medium"> ğŸ“Š Generate Rekap </button>
          </div>
         </div>
        </div>
       </div><!-- Rekap Results -->
       <div id="rekap-results">
        <div class="text-center py-12 text-gray-400">
         <div class="text-6xl mb-4">
          ğŸ“Š
         </div>
         <p class="text-lg">Pilih tanggal atau bulan untuk melihat rekap absensi</p>
         <p class="text-sm mt-2">Rekap akan menampilkan statistik lengkap per kelas</p>
        </div>
       </div>
      </div>
     </div>
    </div><!-- Pengaturan Page -->
    <div id="pengaturan-page" class="hidden">
     <div class="space-y-8"><!-- Manajemen User -->
      <div class="bg-white rounded-lg shadow-lg p-6">
       <h2 class="text-2xl font-bold mb-6" style="color: #667eea;">ğŸ‘¥ Manajemen User</h2><!-- Add User Form (Admin Only) -->
       <div id="add-user-section" class="mb-8 p-4 bg-gray-50 rounded-lg">
        <h3 class="text-lg font-bold mb-4 text-gray-800">â• Tambah User Baru</h3>
        <form id="add-user-form" class="space-y-4">
         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label for="new-username" class="block text-sm font-medium text-gray-700 mb-2">Username</label> <input type="text" id="new-username" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Username baru">
          </div>
          <div><label for="new-password" class="block text-sm font-medium text-gray-700 mb-2">Password</label> <input type="password" id="new-password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Password">
          </div>
         </div>
         <div><label for="new-role" class="block text-sm font-medium text-gray-700 mb-2">Role</label> <select id="new-role" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"> <option value="">Pilih Role</option> <option value="Admin">Admin</option> <option value="Kepala Sekolah">Kepala Sekolah</option> <option value="Guru Piket">Guru Piket</option> </select>
         </div><button type="submit" id="add-user-btn" class="w-full btn-primary text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"> <span id="add-user-text">Tambah User</span> </button>
        </form>
       </div><!-- User List -->
       <div>
        <h3 class="text-lg font-bold mb-4 text-gray-800">ğŸ“‹ Daftar User</h3>
        <div id="user-list" class="space-y-3"><!-- User items will be populated here -->
        </div>
       </div>
      </div><!-- Student Data Configuration -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
       <h2 class="text-2xl font-bold mb-6" style="color: #667eea;">ğŸ‘¥ Konfigurasi Data Siswa</h2>
       <div class="space-y-6"><!-- Current Status -->
        <div id="student-data-status" class="p-4 rounded-lg border-l-4">
         <div class="flex items-center gap-3"><span class="text-2xl">ğŸ“‹</span>
          <div>
           <h3 class="font-bold text-gray-800">Status Data Siswa</h3>
           <p class="text-gray-600 text-sm">Menggunakan data sample - belum terhubung ke Google Sheets</p>
          </div>
         </div>
        </div><!-- URL Configuration -->
        <div class="bg-blue-50 p-6 rounded-lg border border-blue-200">
         <h3 class="text-lg font-bold text-blue-800 mb-4">ğŸ”— Hubungkan ke Google Sheets Data Siswa</h3>
         <form id="student-data-form" class="space-y-4">
          <div><label for="student-data-url" class="block text-sm font-medium text-gray-700 mb-2">URL Google Apps Script (Data Siswa)</label> <input type="url" id="student-data-url" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec">
          </div>
          <div class="flex gap-3"><button type="submit" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all font-medium"> ğŸ”„ Muat Data Siswa </button> <button type="button" onclick="loadSampleStudentData()" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-all font-medium"> ğŸ“‹ Gunakan Data Sample </button>
          </div>
         </form>
         <div class="mt-4 p-3 bg-yellow-100 border border-yellow-300 rounded-lg">
          <div class="flex items-start gap-2"><span class="text-yellow-600 text-lg">ğŸ’¡</span>
           <div class="text-yellow-800 text-sm"><strong>Tips:</strong> Buat Google Sheets terpisah untuk data siswa dan data absensi. Data siswa hanya perlu dibuat sekali di awal tahun ajaran.
           </div>
          </div>
         </div>
        </div>
       </div>
      </div><!-- Attendance Sheets Status -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
       <h2 class="text-2xl font-bold mb-6" style="color: #667eea;">ğŸ“Š Status Google Sheets Absensi</h2>
       <div class="space-y-4"><!-- Attendance Sheets Status -->
        <div id="attendance-sheets-status" class="p-4 rounded-lg border-l-4 border-l-green-400 bg-green-50">
         <div class="flex items-center gap-3"><span class="text-2xl">âœ…</span>
          <div>
           <h3 class="font-bold text-green-800">Google Sheets Absensi Terhubung</h3>
           <p class="text-green-600 text-sm">Setiap data absensi otomatis tersimpan ke Google Sheets</p>
           <p class="text-green-500 text-xs mt-1 break-all">https://script.google.com/macros/s/AKfycbwTFf2vKfXdQz3CWLnj1Cm2Qo53iz_8aB0rdkZ7403og5pLcUe6l8xft1LBbPj1BNBi/exec</p>
          </div>
         </div>
        </div><!-- Test Connection -->
        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
         <h3 class="text-lg font-bold text-blue-800 mb-3">ğŸ§ª Test Koneksi Google Sheets</h3>
         <p class="text-blue-700 text-sm mb-4">Klik tombol di bawah untuk mengirim data test ke Google Sheets Anda</p><button onclick="testGoogleSheetsConnection()" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all font-medium"> ğŸš€ Test Koneksi Sekarang </button>
        </div><!-- Instructions -->
        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
         <h3 class="text-lg font-bold text-gray-800 mb-3">ğŸ“‹ Cara Kerja Integrasi</h3>
         <ul class="space-y-2 text-sm text-gray-700">
          <li>â€¢ <strong>Otomatis:</strong> Setiap input absensi langsung dikirim ke Google Sheets</li>
          <li>â€¢ <strong>Real-time:</strong> Data tersimpan secara bersamaan di sistem dan Google Sheets</li>
          <li>â€¢ <strong>Backup:</strong> Jika Google Sheets error, data tetap tersimpan di sistem</li>
          <li>â€¢ <strong>Format:</strong> Data dikirim sesuai struktur yang sudah Anda buat</li>
         </ul>
        </div>
       </div>
      </div><!-- Google Sheets Integration Guide -->
      <div class="bg-white rounded-lg shadow-lg p-6">
       <h2 class="text-2xl font-bold mb-6" style="color: #667eea;">ğŸ“Š Panduan Integrasi Google Sheets</h2>
       <div class="space-y-8"><!-- Step 1: Create Spreadsheets -->
        <div class="border-2 border-green-200 rounded-lg p-6">
         <h3 class="text-xl font-bold text-green-800 mb-4">1ï¸âƒ£ Buat 2 Google Spreadsheet Terpisah</h3>
         <div class="space-y-6"><!-- Student Data Spreadsheet -->
          <div class="border-l-4 border-blue-400 pl-4">
           <h4 class="text-lg font-bold text-blue-800 mb-2">ğŸ“š Spreadsheet 1: Data Siswa</h4>
           <ol class="list-decimal list-inside text-gray-700 space-y-2 mb-3">
            <li>Buka <a href="https://sheets.google.com" target="_blank" rel="noopener noreferrer" class="text-blue-600 underline font-medium">Google Sheets</a></li>
            <li>Klik tombol <strong>"+ Blank"</strong> untuk membuat spreadsheet baru</li>
            <li>Rename file menjadi <strong>"Data Siswa Sekolah"</strong></li>
            <li>Buat struktur header sesuai tabel di bawah</li>
           </ol><!-- Student Data Table Structure -->
           <div class="bg-blue-50 p-4 rounded-lg mt-3">
            <h5 class="font-bold text-blue-800 mb-3">ğŸ“Š Struktur Tabel Data Siswa:</h5>
            <div class="overflow-x-auto">
             <table class="w-full border-collapse border border-gray-300 text-sm">
              <thead>
               <tr class="bg-blue-100">
                <th class="border border-gray-300 px-3 py-2 text-left">Kolom</th>
                <th class="border border-gray-300 px-3 py-2 text-left">Header</th>
                <th class="border border-gray-300 px-3 py-2 text-left">Contoh Data</th>
                <th class="border border-gray-300 px-3 py-2 text-left">Keterangan</th>
               </tr>
              </thead>
              <tbody>
               <tr>
                <td class="border border-gray-300 px-3 py-2 font-mono">A1</td>
                <td class="border border-gray-300 px-3 py-2 font-bold">Nama Siswa</td>
                <td class="border border-gray-300 px-3 py-2">Ahmad Rizki Pratama</td>
                <td class="border border-gray-300 px-3 py-2">Nama lengkap siswa</td>
               </tr>
               <tr class="bg-gray-50">
                <td class="border border-gray-300 px-3 py-2 font-mono">B1</td>
                <td class="border border-gray-300 px-3 py-2 font-bold">Kelas</td>
                <td class="border border-gray-300 px-3 py-2">VII A</td>
                <td class="border border-gray-300 px-3 py-2">Kelas siswa (VII A, VII B, VIII A, dst.)</td>
               </tr>
               <tr>
                <td class="border border-gray-300 px-3 py-2 font-mono">C1</td>
                <td class="border border-gray-300 px-3 py-2 font-bold">NIS</td>
                <td class="border border-gray-300 px-3 py-2">2024001</td>
                <td class="border border-gray-300 px-3 py-2">Nomor Induk Siswa (opsional)</td>
               </tr>
               <tr class="bg-gray-50">
                <td class="border border-gray-300 px-3 py-2 font-mono">D1</td>
                <td class="border border-gray-300 px-3 py-2 font-bold">Jenis Kelamin</td>
                <td class="border border-gray-300 px-3 py-2">L</td>
                <td class="border border-gray-300 px-3 py-2">L untuk Laki-laki, P untuk Perempuan</td>
               </tr>
              </tbody>
             </table>
            </div>
            <div class="mt-3 p-3 bg-yellow-100 border border-yellow-300 rounded">
             <p class="text-yellow-800 text-sm"><strong>ğŸ’¡ Tips:</strong> Isi data siswa sekali di awal tahun ajaran. Data ini akan digunakan untuk memuat daftar siswa per kelas secara otomatis.</p>
            </div>
           </div>
          </div><!-- Attendance Data Spreadsheet -->
          <div class="border-l-4 border-green-400 pl-4">
           <h4 class="text-lg font-bold text-green-800 mb-2">ğŸ“ Spreadsheet 2: Data Absensi</h4>
           <ol class="list-decimal list-inside text-gray-700 space-y-2 mb-3">
            <li>Buat spreadsheet baru lagi</li>
            <li>Rename file menjadi <strong>"Data Absensi Harian"</strong></li>
            <li>Buat struktur header sesuai tabel di bawah</li>
            <li>Spreadsheet ini akan otomatis terisi saat input absensi</li>
           </ol><!-- Attendance Data Table Structure -->
           <div class="bg-green-50 p-4 rounded-lg mt-3">
            <h5 class="font-bold text-green-800 mb-3">ğŸ“Š Struktur Tabel Data Absensi:</h5>
            <div class="overflow-x-auto">
             <table class="w-full border-collapse border border-gray-300 text-sm">
              <thead>
               <tr class="bg-green-100">
                <th class="border border-gray-300 px-3 py-2 text-left">Kolom</th>
                <th class="border border-gray-300 px-3 py-2 text-left">Header</th>
                <th class="border border-gray-300 px-3 py-2 text-left">Contoh Data</th>
                <th class="border border-gray-300 px-3 py-2 text-left">Keterangan</th>
               </tr>
              </thead>
              <tbody>
               <tr>
                <td class="border border-gray-300 px-3 py-2 font-mono">A1</td>
                <td class="border border-gray-300 px-3 py-2 font-bold">Nama Siswa</td>
                <td class="border border-gray-300 px-3 py-2">Ahmad Rizki Pratama</td>
                <td class="border border-gray-300 px-3 py-2">Nama lengkap siswa</td>
               </tr>
               <tr class="bg-gray-50">
                <td class="border border-gray-300 px-3 py-2 font-mono">B1</td>
                <td class="border border-gray-300 px-3 py-2 font-bold">Kelas</td>
                <td class="border border-gray-300 px-3 py-2">VII A</td>
                <td class="border border-gray-300 px-3 py-2">Kelas siswa</td>
               </tr>
               <tr>
                <td class="border border-gray-300 px-3 py-2 font-mono">C1</td>
                <td class="border border-gray-300 px-3 py-2 font-bold">Status</td>
                <td class="border border-gray-300 px-3 py-2">Hadir</td>
                <td class="border border-gray-300 px-3 py-2">Hadir/Izin/Sakit/Alpha</td>
               </tr>
               <tr class="bg-gray-50">
                <td class="border border-gray-300 px-3 py-2 font-mono">D1</td>
                <td class="border border-gray-300 px-3 py-2 font-bold">Tanggal</td>
                <td class="border border-gray-300 px-3 py-2">2024-01-15</td>
                <td class="border border-gray-300 px-3 py-2">Format: YYYY-MM-DD</td>
               </tr>
               <tr>
                <td class="border border-gray-300 px-3 py-2 font-mono">E1</td>
                <td class="border border-gray-300 px-3 py-2 font-bold">Waktu</td>
                <td class="border border-gray-300 px-3 py-2">08:30</td>
                <td class="border border-gray-300 px-3 py-2">Format: HH:MM</td>
               </tr>
               <tr class="bg-gray-50">
                <td class="border border-gray-300 px-3 py-2 font-mono">F1</td>
                <td class="border border-gray-300 px-3 py-2 font-bold">Keterangan</td>
                <td class="border border-gray-300 px-3 py-2">Terlambat 5 menit</td>
                <td class="border border-gray-300 px-3 py-2">Catatan tambahan (opsional)</td>
               </tr>
               <tr>
                <td class="border border-gray-300 px-3 py-2 font-mono">G1</td>
                <td class="border border-gray-300 px-3 py-2 font-bold">Input Oleh</td>
                <td class="border border-gray-300 px-3 py-2">admin</td>
                <td class="border border-gray-300 px-3 py-2">Username yang input data</td>
               </tr>
               <tr class="bg-gray-50">
                <td class="border border-gray-300 px-3 py-2 font-mono">H1</td>
                <td class="border border-gray-300 px-3 py-2 font-bold">Role</td>
                <td class="border border-gray-300 px-3 py-2">Admin</td>
                <td class="border border-gray-300 px-3 py-2">Role user yang input</td>
               </tr>
              </tbody>
             </table>
            </div>
           </div>
          </div>
         </div>
        </div><!-- Step 2: Apps Script Setup -->
        <div class="border-2 border-purple-200 rounded-lg p-6">
         <h3 class="text-xl font-bold text-purple-800 mb-4">2ï¸âƒ£ Setup Google Apps Script (2 Script Terpisah)</h3>
         <div class="space-y-6"><!-- Student Data Apps Script -->
          <div class="border-l-4 border-blue-400 pl-4">
           <h4 class="text-lg font-bold text-blue-800 mb-2">ğŸ“š Apps Script untuk Data Siswa</h4>
           <ol class="list-decimal list-inside text-gray-700 space-y-2 mb-3">
            <li>Buka spreadsheet <strong>"Data Siswa Sekolah"</strong></li>
            <li>Klik menu <strong>"Extensions"</strong> â†’ <strong>"Apps Script"</strong></li>
            <li>Hapus semua kode default yang ada</li>
            <li>Copy dan paste kode <strong>"Student Data Script"</strong> di bawah ini</li>
            <li>Klik <strong>"Save"</strong> dan beri nama project <strong>"Student Data API"</strong></li>
            <li>Deploy sebagai Web app dengan akses <strong>"Anyone"</strong></li>
            <li><strong>PENTING:</strong> Copy URL untuk konfigurasi data siswa</li>
           </ol><!-- Student Data Apps Script Code -->
           <div class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm overflow-x-auto mt-3">
            <div class="flex justify-between items-center mb-2"><span class="text-gray-400">ğŸ“„ Student Data Script - Copy ke Apps Script Data Siswa</span> <button onclick="copyStudentDataScript()" class="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700"> ğŸ“‹ Copy Code </button>
            </div>
            <pre id="student-data-script">function doGet(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    const data = sheet.getDataRange().getValues();
    
    if (data.length &lt;= 1) {
      return ContentService
        .createTextOutput(JSON.stringify([]))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    const headers = data[0];
    const rows = data.slice(1);
    
    const result = rows.map(row =&gt; {
      const obj = {};
      headers.forEach((header, index) =&gt; {
        // Convert header to lowercase with underscores
        const key = header.toLowerCase().replace(/\s+/g, '_');
        obj[key] = row[index] || '';
      });
      return obj;
    });
    
    return ContentService
      .createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({error: error.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// Optional: Function to add new student (if needed)
function doPost(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    const data = JSON.parse(e.postData.contents);
    
    // Add new student data
    sheet.appendRow([
      data.nama_siswa || '',
      data.kelas || '',
      data.nis || '',
      data.jenis_kelamin || ''
    ]);
    
    return ContentService
      .createTextOutput(JSON.stringify({success: true}))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({success: false, error: error.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}</pre>
           </div>
          </div><!-- Attendance Data Apps Script -->
          <div class="border-l-4 border-green-400 pl-4">
           <h4 class="text-lg font-bold text-green-800 mb-2">ğŸ“ Apps Script untuk Data Absensi</h4>
           <ol class="list-decimal list-inside text-gray-700 space-y-2 mb-3">
            <li>Buka spreadsheet <strong>"Data Absensi Harian"</strong></li>
            <li>Klik menu <strong>"Extensions"</strong> â†’ <strong>"Apps Script"</strong></li>
            <li>Hapus semua kode default yang ada</li>
            <li>Copy dan paste kode <strong>"Attendance Script"</strong> di bawah ini</li>
            <li>Klik <strong>"Save"</strong> dan beri nama project <strong>"Attendance API"</strong></li>
            <li>Deploy sebagai Web app dengan akses <strong>"Anyone"</strong></li>
            <li><strong>PENTING:</strong> URL ini akan otomatis digunakan sistem absensi</li>
           </ol><!-- Attendance Apps Script Code -->
           <div class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm overflow-x-auto mt-3">
            <div class="flex justify-between items-center mb-2"><span class="text-gray-400">ğŸ“„ Attendance Script - Copy ke Apps Script Data Absensi</span> <button onclick="copyAttendanceScript()" class="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700"> ğŸ“‹ Copy Code </button>
            </div>
            <pre id="attendance-script">function doPost(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    const data = JSON.parse(e.postData.contents);
    
    // Add attendance data to sheet
    sheet.appendRow([
      data.nama_siswa || '',
      data.kelas || '',
      data.status || '',
      data.tanggal || '',
      data.waktu || '',
      data.keterangan || '',
      data.input_by || '',
      data.user_role || ''
    ]);
    
    return ContentService
      .createTextOutput(JSON.stringify({success: true}))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({success: false, error: error.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    const data = sheet.getDataRange().getValues();
    
    if (data.length &lt;= 1) {
      return ContentService
        .createTextOutput(JSON.stringify([]))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    const headers = data[0];
    const rows = data.slice(1);
    
    const result = rows.map(row =&gt; {
      const obj = {};
      headers.forEach((header, index) =&gt; {
        // Convert header to lowercase with underscores
        const key = header.toLowerCase().replace(/\s+/g, '_');
        obj[key] = row[index] || '';
      });
      return obj;
    });
    
    return ContentService
      .createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({error: error.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}</pre>
           </div>
          </div>
         </div>
        </div><!-- Step 3: Integration -->
        <div class="border-2 border-blue-200 rounded-lg p-6">
         <h3 class="text-xl font-bold text-blue-800 mb-4">3ï¸âƒ£ Integrasi dengan Sistem Absensi</h3>
         <div class="space-y-6"><!-- Step 3A: Deploy Apps Script -->
          <div class="border-l-4 border-blue-400 pl-4">
           <h4 class="text-lg font-bold text-blue-800 mb-3">ğŸ“¤ Langkah A: Deploy Apps Script sebagai Web App</h4>
           <div class="bg-blue-50 p-4 rounded-lg mb-3">
            <p class="text-blue-800 font-medium mb-2">âš ï¸ PENTING: Lakukan untuk KEDUA Apps Script (Data Siswa &amp; Data Absensi)</p>
           </div>
           <ol class="list-decimal list-inside text-gray-700 space-y-3 mb-4">
            <li><strong>Buka Apps Script Editor</strong>
             <ul class="list-disc list-inside ml-6 mt-1 text-sm text-gray-600">
              <li>Pastikan kode sudah di-paste dan di-save</li>
              <li>Tidak ada error di editor (garis merah)</li>
             </ul></li>
            <li><strong>Klik tombol "Deploy" â†’ "New deployment"</strong>
             <ul class="list-disc list-inside ml-6 mt-1 text-sm text-gray-600">
              <li>Tombol Deploy ada di pojok kanan atas</li>
              <li>Pilih "New deployment" dari dropdown</li>
             </ul></li>
            <li><strong>Pilih Type: "Web app"</strong>
             <ul class="list-disc list-inside ml-6 mt-1 text-sm text-gray-600">
              <li>Klik icon gear âš™ï¸ di sebelah "Type"</li>
              <li>Pilih "Web app" dari daftar</li>
             </ul></li>
            <li><strong>Atur konfigurasi deployment:</strong>
             <div class="bg-yellow-50 p-3 rounded mt-2 border border-yellow-200">
              <ul class="list-disc list-inside text-sm text-gray-700 space-y-1">
               <li><strong>Description:</strong> "Attendance API" atau "Student Data API"</li>
               <li><strong>Execute as:</strong> "Me (email@gmail.com)"</li>
               <li><strong>Who has access:</strong> "Anyone" âš ï¸ PENTING!</li>
              </ul>
             </div></li>
            <li><strong>Klik "Deploy"</strong>
             <ul class="list-disc list-inside ml-6 mt-1 text-sm text-gray-600">
              <li>Google akan meminta authorize permissions</li>
              <li>Klik "Authorize access"</li>
              <li>Login dengan akun Google Anda</li>
              <li>Klik "Allow" untuk semua permissions</li>
             </ul></li>
            <li><strong>Copy URL Web App</strong>
             <ul class="list-disc list-inside ml-6 mt-1 text-sm text-gray-600">
              <li>Setelah deploy berhasil, akan muncul URL panjang</li>
              <li>Format: https://script.google.com/macros/s/SCRIPT_ID/exec</li>
              <li><strong>SIMPAN URL ini!</strong> Akan digunakan untuk integrasi</li>
             </ul></li>
           </ol>
           <div class="bg-green-50 p-3 rounded border border-green-200">
            <div class="flex items-start gap-2"><span class="text-green-600 text-lg">ğŸ’¡</span>
             <div class="text-green-800 text-sm"><strong>Tips:</strong> Ulangi proses ini untuk kedua Apps Script. Anda akan mendapat 2 URL berbeda: <br>
              â€¢ URL untuk Data Siswa (GET request) <br>
              â€¢ URL untuk Data Absensi (POST request)
             </div>
            </div>
           </div>
          </div><!-- Step 3B: Test Connection -->
          <div class="border-l-4 border-green-400 pl-4">
           <h4 class="text-lg font-bold text-green-800 mb-3">ğŸ§ª Langkah B: Test Koneksi Apps Script</h4>
           <div class="space-y-4"><!-- Test Data Siswa -->
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
             <h5 class="font-bold text-blue-800 mb-2">1ï¸âƒ£ Test Apps Script Data Siswa (GET Request)</h5>
             <ol class="list-decimal list-inside text-gray-700 space-y-2 text-sm">
              <li>Buka browser baru (tab baru)</li>
              <li>Paste URL Apps Script Data Siswa di address bar</li>
              <li>Tekan Enter</li>
              <li><strong>Hasil yang diharapkan:</strong> JSON array dengan data siswa</li>
             </ol>
             <div class="mt-3 p-3 bg-white border border-blue-300 rounded">
              <p class="text-xs text-gray-600 mb-1">Contoh hasil yang benar:</p><code class="text-xs text-green-600"> [{"nama_siswa":"Ahmad Rizki","kelas":"VII A","nis":"001","jenis_kelamin":"L"}] </code>
             </div>
            </div><!-- Test Data Absensi -->
            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
             <h5 class="font-bold text-green-800 mb-2">2ï¸âƒ£ Test Apps Script Data Absensi (POST Request)</h5>
             <ol class="list-decimal list-inside text-gray-700 space-y-2 text-sm">
              <li>Buka <strong>Developer Console</strong> di browser (tekan F12)</li>
              <li>Pilih tab <strong>"Console"</strong></li>
              <li>Copy kode test di bawah ini</li>
              <li>Ganti <code class="bg-gray-200 px-1 rounded">YOUR_ATTENDANCE_APPS_SCRIPT_URL</code> dengan URL Apps Script Data Absensi</li>
              <li>Paste di console dan tekan Enter</li>
              <li>Cek Google Sheets Data Absensi - harus ada baris baru dengan data test</li>
             </ol>
            </div>
           </div>
           <div class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm overflow-x-auto mt-4">
            <div class="flex justify-between items-center mb-2"><span class="text-gray-400">ğŸ”§ Kode Test Data Absensi - Jalankan di Console Browser</span> <button onclick="copyTestCode()" class="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700"> ğŸ“‹ Copy Code </button>
            </div>
            <pre id="test-code">// GANTI dengan URL Apps Script Data Absensi Anda
const ATTENDANCE_APPS_SCRIPT_URL = 'YOUR_ATTENDANCE_APPS_SCRIPT_URL';

// Data test untuk absensi
const testAttendanceData = {
  nama_siswa: "Test Student",
  kelas: "VII A", 
  status: "Hadir",
  tanggal: "2024-01-15",
  waktu: "08:00",
  keterangan: "Test koneksi Google Sheets",
  input_by: "admin",
  user_role: "Admin"
};

console.log('ğŸš€ Mengirim data test ke Google Sheets...');
console.log('ğŸ“Š Data yang dikirim:', testAttendanceData);

// Kirim data ke Google Sheets
fetch(ATTENDANCE_APPS_SCRIPT_URL, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify(testAttendanceData)
})
.then(response =&gt; {
  console.log('ğŸ“¡ Response status:', response.status);
  return response.json();
})
.then(data =&gt; {
  console.log('âœ… Berhasil! Response dari server:', data);
  console.log('ğŸ‰ Cek Google Sheets Anda - data test harus sudah muncul!');
  
  // Success notification
  const successMsg = 'âœ… KONEKSI BERHASIL!\\n\\n' +
    'ğŸ“Š Data test berhasil dikirim ke Google Sheets\\n' +
    'ğŸ” Silakan cek spreadsheet Anda\\n\\n' +
    'Langkah selanjutnya:\\n' +
    '1. Cek Google Sheets Data Absensi\\n' +
    '2. Pastikan ada baris baru dengan data "Test Student"\\n' +
    '3. Jika ada, koneksi sudah siap digunakan!';
  
  alert(successMsg);
})
.catch(error =&gt; {
  console.error('âŒ Error detail:', error);
  console.log('ğŸ”§ Troubleshooting:');
  console.log('1. Pastikan URL Apps Script benar');
  console.log('2. Pastikan deployment setting "Who has access: Anyone"');
  console.log('3. Pastikan Apps Script sudah di-authorize');
  
  const errorMsg = 'âŒ KONEKSI GAGAL!\\n\\n' +
    'Error: ' + error.message + '\\n\\n' +
    'Solusi:\\n' +
    '1. Cek URL Apps Script sudah benar\\n' +
    '2. Pastikan setting "Who has access: Anyone"\\n' +
    '3. Coba deploy ulang Apps Script\\n' +
    '4. Lihat console untuk detail error';
  
  alert(errorMsg);
});</pre>
           </div>
          </div><!-- Step 3C: Integration with System -->
          <div class="border-l-4 border-purple-400 pl-4">
           <h4 class="text-lg font-bold text-purple-800 mb-3">ğŸ”— Langkah C: Integrasi dengan Sistem Absensi</h4>
           <div class="space-y-4">
            <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
             <h5 class="font-bold text-purple-800 mb-2">ğŸ“ Konfigurasi Data Siswa</h5>
             <ol class="list-decimal list-inside text-gray-700 space-y-2 text-sm">
              <li>Buka halaman <strong>"âš™ï¸ Pengaturan"</strong> di sistem absensi</li>
              <li>Scroll ke bagian <strong>"Konfigurasi Data Siswa"</strong></li>
              <li>Paste <strong>URL Apps Script Data Siswa</strong> di field "URL Google Apps Script"</li>
              <li>Klik tombol <strong>"ğŸ”„ Muat Data Siswa"</strong></li>
              <li>Tunggu hingga muncul notifikasi berhasil</li>
              <li>Sistem akan otomatis memuat daftar siswa per kelas</li>
             </ol>
            </div>
            <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
             <h5 class="font-bold text-indigo-800 mb-2">ğŸ’¾ Otomatis Sync Data Absensi</h5>
             <div class="text-sm text-gray-700 space-y-2">
              <p><strong>Sistem akan otomatis:</strong></p>
              <ul class="list-disc list-inside ml-4 space-y-1">
               <li>Mengirim setiap data absensi ke Google Sheets</li>
               <li>Menggunakan URL Apps Script Data Absensi</li>
               <li>Tidak perlu konfigurasi manual</li>
               <li>Real-time sync setiap kali input absensi</li>
              </ul>
             </div>
            </div>
           </div>
          </div><!-- Step 3D: Verification -->
          <div class="border-l-4 border-orange-400 pl-4">
           <h4 class="text-lg font-bold text-orange-800 mb-3">âœ… Langkah D: Verifikasi Integrasi Lengkap</h4>
           <div class="space-y-3">
            <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
             <h5 class="font-bold text-orange-800 mb-2">ğŸ§ª Test End-to-End</h5>
             <ol class="list-decimal list-inside text-gray-700 space-y-2 text-sm">
              <li><strong>Test Load Data Siswa:</strong>
               <ul class="list-disc list-inside ml-6 mt-1 text-xs text-gray-600">
                <li>Buka halaman "ğŸ“ Absensi"</li>
                <li>Pilih kelas di dropdown "Pilih Kelas untuk Absensi"</li>
                <li>Pastikan daftar siswa muncul otomatis</li>
               </ul></li>
              <li><strong>Test Input Absensi:</strong>
               <ul class="list-disc list-inside ml-6 mt-1 text-xs text-gray-600">
                <li>Pilih status kehadiran untuk beberapa siswa</li>
                <li>Klik "ğŸ’¾ Simpan Semua Absensi"</li>
                <li>Tunggu notifikasi berhasil</li>
               </ul></li>
              <li><strong>Verifikasi di Google Sheets:</strong>
               <ul class="list-disc list-inside ml-6 mt-1 text-xs text-gray-600">
                <li>Buka Google Sheets Data Absensi</li>
                <li>Pastikan data baru sudah muncul</li>
                <li>Cek semua kolom terisi dengan benar</li>
               </ul></li>
              <li><strong>Test Rekap Data:</strong>
               <ul class="list-disc list-inside ml-6 mt-1 text-xs text-gray-600">
                <li>Buka halaman "ğŸ“Š Rekap Absensi"</li>
                <li>Generate rekap harian</li>
                <li>Pastikan statistik sesuai dengan data yang diinput</li>
               </ul></li>
             </ol>
            </div>
           </div>
          </div><!-- Advanced Configuration -->
          <div class="border-l-4 border-gray-400 pl-4">
           <h4 class="text-lg font-bold text-gray-800 mb-3">âš™ï¸ Konfigurasi Lanjutan (Opsional)</h4>
           <div class="space-y-3">
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
             <h5 class="font-bold text-gray-800 mb-2">ğŸ”„ Auto-Refresh Data Siswa</h5>
             <p class="text-sm text-gray-700 mb-2">Untuk memperbarui data siswa secara berkala:</p>
             <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
              <li>Klik "ğŸ”„ Muat Data Siswa" setiap ada siswa baru/pindah</li>
              <li>Sistem akan otomatis update dropdown kelas</li>
              <li>Data lama tidak akan hilang, hanya ditambahkan</li>
             </ul>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
             <h5 class="font-bold text-gray-800 mb-2">ğŸ“Š Multiple Sheets Support</h5>
             <p class="text-sm text-gray-700 mb-2">Untuk sekolah dengan banyak data:</p>
             <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
              <li>Buat spreadsheet terpisah per semester/tahun ajaran</li>
              <li>Ganti URL Apps Script sesuai periode aktif</li>
              <li>Backup data lama sebelum ganti periode</li>
             </ul>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
             <h5 class="font-bold text-gray-800 mb-2">ğŸ” Security Best Practices</h5>
             <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
              <li>Jangan share URL Apps Script ke pihak lain</li>
              <li>Backup Google Sheets secara berkala</li>
              <li>Monitor akses Google Sheets dari dashboard Google</li>
              <li>Gunakan akun Google khusus sekolah jika memungkinkan</li>
             </ul>
            </div>
           </div>
          </div>
         </div>
        </div><!-- Success Indicators -->
        <div class="bg-green-50 p-6 rounded-lg border border-green-200">
         <h3 class="text-xl font-bold text-green-800 mb-4">âœ… Tanda Koneksi Berhasil</h3>
         <div class="space-y-3">
          <div class="flex items-start gap-3"><span class="text-green-600 text-xl">âœ…</span>
           <div>
            <h4 class="font-bold text-gray-700">Data Test Muncul di Sheets</h4>
            <p class="text-gray-600 text-sm">Baris baru dengan data "Test Student" muncul di Google Sheets</p>
           </div>
          </div>
          <div class="flex items-start gap-3"><span class="text-green-600 text-xl">âœ…</span>
           <div>
            <h4 class="font-bold text-gray-700">Console Menampilkan "Berhasil"</h4>
            <p class="text-gray-600 text-sm">Browser console menampilkan pesan sukses tanpa error</p>
           </div>
          </div>
          <div class="flex items-start gap-3"><span class="text-green-600 text-xl">âœ…</span>
           <div>
            <h4 class="font-bold text-gray-700">Sistem Absensi Otomatis Tersinkron</h4>
            <p class="text-gray-600 text-sm">Setiap data absensi yang diinput akan langsung masuk ke Google Sheets</p>
           </div>
          </div>
         </div>
        </div><!-- Troubleshooting -->
        <div class="bg-red-50 p-6 rounded-lg border border-red-200">
         <h3 class="text-xl font-bold text-red-800 mb-4">ğŸ”§ Troubleshooting</h3>
         <div class="space-y-4">
          <div>
           <h4 class="font-bold text-gray-700">â“ Error "Script function not found"?</h4>
           <ul class="list-disc list-inside text-gray-600 text-sm space-y-1 ml-4">
            <li>Pastikan kode Apps Script sudah di-save dengan benar</li>
            <li>Cek nama function adalah <code>doPost</code> dan <code>doGet</code></li>
            <li>Deploy ulang Apps Script sebagai Web app</li>
           </ul>
          </div>
          <div>
           <h4 class="font-bold text-gray-700">â“ Error "Permission denied"?</h4>
           <ul class="list-disc list-inside text-gray-600 text-sm space-y-1 ml-4">
            <li>Set "Execute as: Me" saat deployment</li>
            <li>Set "Who has access: Anyone" saat deployment</li>
            <li>Authorize semua permission yang diminta Google</li>
           </ul>
          </div>
          <div>
           <h4 class="font-bold text-gray-700">â“ Data tidak masuk ke Sheets?</h4>
           <ul class="list-disc list-inside text-gray-600 text-sm space-y-1 ml-4">
            <li>Cek header spreadsheet sesuai dengan struktur tabel</li>
            <li>Pastikan URL Apps Script sudah benar</li>
            <li>Lihat log error di Apps Script editor (View â†’ Logs)</li>
           </ul>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div>
    </div>
   </main>
  </div> <!-- Footer -->
  <footer class="bg-white shadow-lg mt-8">
   <div class="max-w-7xl mx-auto px-4 py-4">
    <p id="footer-text" class="text-center text-gray-600 text-sm">Â© 2024 Sistem Absensi Multi-User</p>
   </div>
  </footer>
  <script>
    let allRecords = [];
    let recordCount = 0;
    let currentUser = null;
    
    const defaultConfig = {
      judul_aplikasi: "Sistem Absensi Multi-User",
      nama_sekolah: "Nama Sekolah Anda",
      footer_text: "Â© 2024 Sistem Absensi Multi-User",
      admin_username: "admin",
      admin_password: "admin123",
      background_color: "#667eea",
      surface_color: "#ffffff",
      text_color: "#1f2937",
      primary_action_color: "#667eea",
      secondary_action_color: "#764ba2",
      font_family: "system-ui",
      font_size: 16
    };

    let users = {
      admin: { password: "admin123", role: "Admin", permissions: ["create", "read", "update", "delete", "export", "manage_users"] },
      kepsek: { password: "kepsek123", role: "Kepala Sekolah", permissions: ["read", "export", "view_reports"] },
      guru: { password: "guru123", role: "Guru Piket", permissions: ["create", "read", "update"] }
    };

    const dataHandler = {
      onDataChanged(data) {
        allRecords = data;
        recordCount = data.length;
        updateStats(data);
        updateFilterOptions(data);
        updateClassDropdowns(); // Update class dropdown when data changes
        applyFilters();
      }
    };

    async function onConfigChange(config) {
      const appTitle = document.getElementById('app-title');
      const loginTitle = document.getElementById('login-title');
      const schoolName = document.getElementById('school-name');
      const loginSchool = document.getElementById('login-school');
      const footerText = document.getElementById('footer-text');
      
      if (appTitle) {
        appTitle.textContent = config.judul_aplikasi || defaultConfig.judul_aplikasi;
        appTitle.style.color = config.primary_action_color || defaultConfig.primary_action_color;
        appTitle.style.fontFamily = `${config.font_family || defaultConfig.font_family}, system-ui, sans-serif`;
        appTitle.style.fontSize = `${(config.font_size || defaultConfig.font_size) * 1.875}px`;
      }
      
      if (loginTitle) {
        loginTitle.textContent = config.judul_aplikasi || defaultConfig.judul_aplikasi;
        loginTitle.style.fontFamily = `${config.font_family || defaultConfig.font_family}, system-ui, sans-serif`;
        loginTitle.style.fontSize = `${(config.font_size || defaultConfig.font_size) * 1.875}px`;
      }
      
      if (schoolName) {
        schoolName.textContent = config.nama_sekolah || defaultConfig.nama_sekolah;
        schoolName.style.color = config.text_color || defaultConfig.text_color;
        schoolName.style.fontFamily = `${config.font_family || defaultConfig.font_family}, system-ui, sans-serif`;
        schoolName.style.fontSize = `${(config.font_size || defaultConfig.font_size) * 0.875}px`;
      }
      
      if (loginSchool) {
        loginSchool.textContent = config.nama_sekolah || defaultConfig.nama_sekolah;
        loginSchool.style.fontFamily = `${config.font_family || defaultConfig.font_family}, system-ui, sans-serif`;
        loginSchool.style.fontSize = `${(config.font_size || defaultConfig.font_size) * 0.875}px`;
      }
      
      if (footerText) {
        footerText.textContent = config.footer_text || defaultConfig.footer_text;
        footerText.style.color = config.text_color || defaultConfig.text_color;
        footerText.style.fontFamily = `${config.font_family || defaultConfig.font_family}, system-ui, sans-serif`;
        footerText.style.fontSize = `${(config.font_size || defaultConfig.font_size) * 0.875}px`;
      }
      
      const loginScreen = document.getElementById('login-screen');
      const mainApp = document.getElementById('main-app');
      if (loginScreen && mainApp) {
        loginScreen.style.background = `linear-gradient(135deg, ${config.background_color || defaultConfig.background_color} 0%, ${config.secondary_action_color || defaultConfig.secondary_action_color} 100%)`;
        mainApp.style.background = `linear-gradient(135deg, ${config.background_color || defaultConfig.background_color} 0%, ${config.secondary_action_color || defaultConfig.secondary_action_color} 100%)`;
      }
      
      const submitBtn = document.getElementById('submit-btn');
      const loginBtn = document.getElementById('login-btn');
      if (submitBtn) {
        submitBtn.style.background = `linear-gradient(135deg, ${config.primary_action_color || defaultConfig.primary_action_color} 0%, ${config.secondary_action_color || defaultConfig.secondary_action_color} 100%)`;
      }
      if (loginBtn) {
        loginBtn.style.background = `linear-gradient(135deg, ${config.primary_action_color || defaultConfig.primary_action_color} 0%, ${config.secondary_action_color || defaultConfig.secondary_action_color} 100%)`;
      }
      
      const allHeadings = document.querySelectorAll('h2, h3');
      allHeadings.forEach(heading => {
        heading.style.color = config.primary_action_color || defaultConfig.primary_action_color;
        heading.style.fontFamily = `${config.font_family || defaultConfig.font_family}, system-ui, sans-serif`;
        heading.style.fontSize = `${(config.font_size || defaultConfig.font_size) * 1.5}px`;
      });
      
      const allText = document.querySelectorAll('p, label, input, textarea, select, button');
      allText.forEach(el => {
        el.style.fontFamily = `${config.font_family || defaultConfig.font_family}, system-ui, sans-serif`;
        el.style.fontSize = `${config.font_size || defaultConfig.font_size}px`;
      });
      
      // Update user credentials
      if (config.admin_username && config.admin_password) {
        // Remove old admin user if username changed
        if (config.admin_username !== defaultConfig.admin_username) {
          delete users[defaultConfig.admin_username];
        }
        
        // Update users object
        users[config.admin_username] = { 
          password: config.admin_password, 
          role: "Admin", 
          permissions: ["create", "read", "update", "delete", "export", "manage_users"] 
        };
      }
    }

    function getWIBTime() {
      const now = new Date();
      const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
      const wib = new Date(utc + (7 * 3600000)); // UTC+7
      return wib;
    }

    function formatWIBTime(date) {
      return date.toLocaleString('id-ID', {
        timeZone: 'Asia/Jakarta',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    function updateCurrentTime() {
      const currentTimeEl = document.getElementById('current-time');
      if (currentTimeEl) {
        const wibTime = getWIBTime();
        currentTimeEl.textContent = formatWIBTime(wibTime);
      }
    }

    function login(username, password) {
      const user = users[username];
      if (user && user.password === password) {
        currentUser = { username, ...user };
        showMainApp();
        updateUserInterface();
        
        // Custom alert for successful login
        const alertDiv = document.createElement('div');
        alertDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        alertDiv.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-sm mx-4 text-center shadow-2xl">
            <div class="text-6xl mb-4">âœ…</div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Login Berhasil!</h3>
            <p class="text-gray-600 mb-4">Selamat datang, ${user.role}</p>
            <button onclick="this.parentElement.parentElement.remove()" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all font-medium">
              OK
            </button>
          </div>
        `;
        document.body.appendChild(alertDiv);
        
        // Auto close after 3 seconds
        setTimeout(() => {
          if (alertDiv.parentElement) {
            alertDiv.remove();
          }
        }, 3000);
        
        return true;
      } else {
        // Custom alert for failed login
        const alertDiv = document.createElement('div');
        alertDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        alertDiv.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-sm mx-4 text-center shadow-2xl">
            <div class="text-6xl mb-4">âŒ</div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Login Gagal!</h3>
            <p class="text-gray-600 mb-4">Username atau password salah</p>
            <button onclick="this.parentElement.parentElement.remove()" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all font-medium">
              Coba Lagi
            </button>
          </div>
        `;
        document.body.appendChild(alertDiv);
        
        // Auto close after 3 seconds
        setTimeout(() => {
          if (alertDiv.parentElement) {
            alertDiv.remove();
          }
        }, 3000);
        
        return false;
      }
    }

    function logout() {
      currentUser = null;
      showLoginScreen();
    }

    function showLoginScreen() {
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('main-app').classList.add('hidden');
    }

    function showMainApp() {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('main-app').classList.remove('hidden');
    }

    function updateUserInterface() {
      if (!currentUser) return;
      
      const userRoleBadge = document.getElementById('user-role-badge');
      const formSection = document.getElementById('form-section');
      const exportSection = document.getElementById('export-section');
      
      // Update role badge
      const roleIcons = {
        'Admin': 'ğŸ‘‘',
        'Kepala Sekolah': 'ğŸ“',
        'Guru Piket': 'ğŸ‘¨â€ğŸ«'
      };
      
      const roleClasses = {
        'Admin': 'admin-badge',
        'Kepala Sekolah': 'kepsek-badge',
        'Guru Piket': 'guru-badge'
      };
      
      if (userRoleBadge) {
        userRoleBadge.textContent = `${roleIcons[currentUser.role]} ${currentUser.role}`;
        userRoleBadge.className = `role-badge ${roleClasses[currentUser.role]}`;
      }
      
      // Show/hide form based on permissions
      if (formSection) {
        if (currentUser.permissions.includes('create')) {
          formSection.classList.remove('hidden');
        } else {
          formSection.classList.add('hidden');
        }
      }
      
      // Show/hide export button
      if (exportSection) {
        if (currentUser.permissions.includes('export')) {
          exportSection.classList.remove('hidden');
        } else {
          exportSection.classList.add('hidden');
        }
      }
      
      // Add permission notice for read-only users
      if (!currentUser.permissions.includes('create')) {
        const notice = document.createElement('div');
        notice.className = 'permission-denied';
        notice.innerHTML = `
          <div class="flex items-center justify-center gap-2">
            <span>ğŸ‘ï¸</span>
            <span>Anda login sebagai ${currentUser.role} - Hanya dapat melihat data</span>
          </div>
        `;
        
        const main = document.querySelector('main');
        if (main && !main.querySelector('.permission-denied')) {
          main.insertBefore(notice, main.firstChild);
        }
      }
    }

    function hasPermission(action) {
      return currentUser && currentUser.permissions.includes(action);
    }

    function updateStats(data) {
      const totalCount = document.getElementById('total-count');
      const hadirCount = document.getElementById('hadir-count');
      const izinCount = document.getElementById('izin-count');
      const sakitCount = document.getElementById('sakit-count');
      const alphaCount = document.getElementById('alpha-count');
      
      const hadir = data.filter(r => r.status === 'Hadir').length;
      const izin = data.filter(r => r.status === 'Izin').length;
      const sakit = data.filter(r => r.status === 'Sakit').length;
      const alpha = data.filter(r => r.status === 'Alpha').length;
      
      if (totalCount) totalCount.textContent = data.length;
      if (hadirCount) hadirCount.textContent = hadir;
      if (izinCount) izinCount.textContent = izin;
      if (sakitCount) sakitCount.textContent = sakit;
      if (alphaCount) alphaCount.textContent = alpha;
    }

    function updateFilterOptions(data) {
      const filterKelas = document.getElementById('filter-kelas');
      const filterUser = document.getElementById('filter-user');
      
      if (filterKelas) {
        const kelasSet = new Set(data.map(r => r.kelas));
        const currentValue = filterKelas.value;
        
        filterKelas.innerHTML = '<option value="">Semua Kelas</option>';
        Array.from(kelasSet).sort().forEach(kelas => {
          const option = document.createElement('option');
          option.value = kelas;
          option.textContent = kelas;
          filterKelas.appendChild(option);
        });
        
        filterKelas.value = currentValue;
      }
      
      if (filterUser) {
        const userSet = new Set(data.map(r => r.input_by).filter(Boolean));
        const currentValue = filterUser.value;
        
        filterUser.innerHTML = '<option value="">Semua User</option>';
        Array.from(userSet).sort().forEach(user => {
          const option = document.createElement('option');
          option.value = user;
          option.textContent = user;
          filterUser.appendChild(option);
        });
        
        filterUser.value = currentValue;
      }
    }

    function applyFilters() {
      const filterKelas = document.getElementById('filter-kelas').value;
      const filterStatus = document.getElementById('filter-status').value;
      const filterTanggal = document.getElementById('filter-tanggal').value;
      const filterUser = document.getElementById('filter-user').value;
      
      let filtered = allRecords;
      
      if (filterKelas) {
        filtered = filtered.filter(r => r.kelas === filterKelas);
      }
      
      if (filterStatus) {
        filtered = filtered.filter(r => r.status === filterStatus);
      }
      
      if (filterTanggal) {
        filtered = filtered.filter(r => r.tanggal === filterTanggal);
      }
      
      if (filterUser) {
        filtered = filtered.filter(r => r.input_by === filterUser);
      }
      
      renderAbsensiList(filtered);
    }

    function renderAbsensiList(data) {
      const list = document.getElementById('absensi-list');
      const filteredCount = document.getElementById('filtered-count');
      
      if (!list) return;
      
      if (filteredCount) {
        filteredCount.textContent = data.length;
      }
      
      if (data.length === 0) {
        list.innerHTML = `
          <div class="text-center py-12 text-gray-400">
            <div class="text-6xl mb-4">ğŸ“</div>
            <p class="text-lg">Tidak ada data yang sesuai filter</p>
            <p class="text-sm mt-2">Coba ubah filter atau tambahkan data baru</p>
          </div>
        `;
        return;
      }
      
      const sortedData = [...data].sort((a, b) => {
        const dateA = new Date(a.timestamp || a.tanggal + ' ' + a.waktu);
        const dateB = new Date(b.timestamp || b.tanggal + ' ' + b.waktu);
        return dateB - dateA;
      });
      
      list.innerHTML = sortedData.map(record => {
        const statusColors = {
          'Hadir': 'bg-green-100 text-green-800',
          'Izin': 'bg-yellow-100 text-yellow-800',
          'Sakit': 'bg-red-100 text-red-800',
          'Alpha': 'bg-purple-100 text-purple-800'
        };
        
        const statusIcons = {
          'Hadir': 'âœ…',
          'Izin': 'ğŸ“',
          'Sakit': 'ğŸ¥',
          'Alpha': 'âŒ'
        };
        
        const canEdit = hasPermission('update');
        const canDelete = hasPermission('delete');
        
        return `
          <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all fade-in" data-id="${record.__backendId}">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
              <div class="flex-1">
                <div class="flex flex-wrap items-center gap-3 mb-2">
                  <h3 class="text-lg font-bold text-gray-800">${record.nama_siswa}</h3>
                  <span class="status-badge px-3 py-1 rounded-full text-sm font-medium ${statusColors[record.status]}">
                    ${statusIcons[record.status]} ${record.status}
                  </span>
                </div>
                <div class="text-sm text-gray-600 space-y-1">
                  <p>ğŸ“ Kelas: <span class="font-medium">${record.kelas}</span></p>
                  <p>ğŸ“… ${record.tanggal} â€¢ â° ${record.waktu} WIB</p>
                  ${record.keterangan ? `<p>ğŸ“ ${record.keterangan}</p>` : ''}
                  ${record.input_by ? `<p>ğŸ‘¤ Input oleh: <span class="font-medium">${record.input_by}</span> (${record.user_role || 'Unknown'})</p>` : ''}
                </div>
              </div>
              <div class="flex gap-2">
                ${canDelete ? `
                  <button onclick="deleteRecord('${record.__backendId}')" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all text-sm font-medium">
                    ğŸ—‘ï¸ Hapus
                  </button>
                ` : ''}
                <div class="px-4 py-2 bg-gray-300 text-gray-500 rounded-lg text-sm font-medium cursor-not-allowed" title="Edit dinonaktifkan untuk mencegah duplikasi di Google Sheets">
                  âœï¸ Edit (Nonaktif)
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function setLoading(isLoading, buttonId = 'submit-btn', textId = 'submit-text') {
      const btn = document.getElementById(buttonId);
      const text = document.getElementById(textId);
      
      if (btn) {
        btn.disabled = isLoading;
        btn.style.opacity = isLoading ? '0.7' : '1';
      }
      
      if (text) {
        if (isLoading) {
          text.innerHTML = '<div class="loading-spinner mx-auto"></div>';
        } else {
          if (buttonId === 'login-btn') {
            text.textContent = 'Masuk';
          } else if (buttonId === 'add-user-btn') {
            text.textContent = 'Tambah User';
          } else {
            text.textContent = 'Simpan Absensi';
          }
        }
      }
    }

    async function handleLogin(e) {
      e.preventDefault();
      
      setLoading(true, 'login-btn', 'login-text');
      
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      // Simulate loading delay
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      const loginSuccess = login(username, password);
      
      if (loginSuccess) {
        document.getElementById('login-form').reset();
      }
      
      setLoading(false, 'login-btn', 'login-text');
    }

    // Function to send data to Google Sheets
    async function sendToGoogleSheets(attendanceData) {
      if (!isAttendanceSheetConnected || !attendanceSheetUrl) {
        console.log('Google Sheets not connected, skipping...');
        return { success: true }; // Skip if not connected
      }
      
      try {
        console.log('ğŸš€ Sending data to Google Sheets:', attendanceData);
        console.log('ğŸ“¡ URL:', attendanceSheetUrl);
        
        const response = await fetch(attendanceSheetUrl, {
          method: 'POST',
          mode: 'no-cors', // Important for Google Apps Script
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(attendanceData)
        });
        
        console.log('ğŸ“¡ Response status:', response.status);
        
        // With no-cors mode, we can't read the response
        // But if no error is thrown, we assume success
        console.log('âœ… Data sent successfully to Google Sheets');
        return { success: true };
        
      } catch (error) {
        console.error('âŒ Error sending to Google Sheets:', error);
        return { success: false, error: error.message };
      }
    }

    async function handleSubmit(e) {
      e.preventDefault();
      
      if (!hasPermission('create')) {
        showToast('âŒ Anda tidak memiliki izin untuk menambah data!', 'error');
        return;
      }
      
      if (recordCount >= 999) {
        showToast('Batas maksimal 999 data tercapai. Hapus beberapa data terlebih dahulu.', 'error');
        return;
      }
      
      setLoading(true);
      
      const namaSiswa = document.getElementById('nama-siswa').value;
      const kelas = document.getElementById('kelas').value;
      const status = document.querySelector('input[name="status"]:checked').value;
      const keterangan = document.getElementById('keterangan').value;
      
      const wibTime = getWIBTime();
      const tanggal = wibTime.toISOString().split('T')[0];
      const waktu = wibTime.toTimeString().split(' ')[0].substring(0, 5);
      
      const newRecord = {
        id: Date.now().toString(),
        nama_siswa: namaSiswa,
        kelas: kelas,
        status: status,
        tanggal: tanggal,
        waktu: waktu,
        keterangan: keterangan,
        input_by: currentUser.username,
        user_role: currentUser.role,
        timestamp: wibTime.toISOString()
      };
      
      // Send to Google Sheets first
      const sheetsResult = await sendToGoogleSheets(newRecord);
      
      // Then save to local Data SDK
      const result = await window.dataSdk.create(newRecord);
      
      setLoading(false);
      
      if (result.isOk) {
        if (sheetsResult.success) {
          showToast('âœ… Absensi berhasil disimpan ke sistem dan Google Sheets!', 'success');
        } else {
          showToast('âœ… Absensi disimpan ke sistem. âš ï¸ Gagal kirim ke Google Sheets.', 'success');
        }
        document.getElementById('absensi-form').reset();
      } else {
        showToast('âŒ Gagal menyimpan absensi. Silakan coba lagi.', 'error');
      }
    }

    window.editRecord = async function(backendId) {
      if (!hasPermission('update')) {
        showToast('âŒ Anda tidak memiliki izin untuk mengedit data!', 'error');
        return;
      }
      
      // Show notification that edit is temporarily disabled
      const notificationDiv = document.createElement('div');
      notificationDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      notificationDiv.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md mx-4 text-center shadow-2xl">
          <div class="text-6xl mb-4">âš ï¸</div>
          <h3 class="text-xl font-bold text-orange-800 mb-2">Fitur Edit Sementara Dinonaktifkan</h3>
          <p class="text-gray-600 mb-4">Fitur edit data absensi sementara dinonaktifkan untuk mencegah duplikasi data di Google Sheets.</p>
          <div class="bg-yellow-50 p-3 rounded-lg mb-4 text-left">
            <p class="text-sm text-yellow-800"><strong>ğŸ’¡ Alasan:</strong></p>
            <ul class="text-xs text-yellow-700 mt-1 space-y-1 list-disc list-inside">
              <li>Edit data akan menyebabkan duplikasi di Google Sheets</li>
              <li>Google Sheets tidak mendukung update data yang sudah ada</li>
              <li>Setiap edit akan menambah baris baru di Google Sheets</li>
            </ul>
          </div>
          <div class="bg-blue-50 p-3 rounded-lg mb-4 text-left">
            <p class="text-sm text-blue-800"><strong>ğŸ”§ Alternatif:</strong></p>
            <ul class="text-xs text-blue-700 mt-1 space-y-1 list-disc list-inside">
              <li>Hapus data yang salah, lalu input ulang dengan data yang benar</li>
              <li>Edit manual di Google Sheets jika diperlukan</li>
              <li>Pastikan data sudah benar sebelum menyimpan</li>
            </ul>
          </div>
          <button onclick="this.parentElement.parentElement.remove()" class="px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-all font-medium">
            Mengerti
          </button>
        </div>
      `;
      document.body.appendChild(notificationDiv);
    };

    window.deleteRecord = async function(backendId) {
      if (!hasPermission('delete')) {
        showToast('âŒ Anda tidak memiliki izin untuk menghapus data!', 'error');
        return;
      }
      
      const record = allRecords.find(r => r.__backendId === backendId);
      if (!record) return;
      
      const card = document.querySelector(`[data-id="${backendId}"]`);
      const deleteBtn = card.querySelector('button[onclick*="deleteRecord"]');
      
      if (deleteBtn.textContent.includes('Konfirmasi')) {
        setLoading(true);
        
        const result = await window.dataSdk.delete(record);
        
        setLoading(false);
        
        if (result.isOk) {
          showToast('âœ… Data berhasil dihapus!', 'success');
        } else {
          showToast('âŒ Gagal menghapus data. Silakan coba lagi.', 'error');
        }
      } else {
        deleteBtn.textContent = 'âœ”ï¸ Konfirmasi Hapus';
        deleteBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
        deleteBtn.classList.add('bg-orange-500', 'hover:bg-orange-600');
        
        setTimeout(() => {
          deleteBtn.textContent = 'ğŸ—‘ï¸ Hapus';
          deleteBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
          deleteBtn.classList.add('bg-red-500', 'hover:bg-red-600');
        }, 3000);
      }
    };

    window.exportToCSV = function() {
      if (!hasPermission('export')) {
        showToast('âŒ Anda tidak memiliki izin untuk export data!', 'error');
        return;
      }
      
      if (allRecords.length === 0) {
        showToast('âŒ Tidak ada data untuk di-export!', 'error');
        return;
      }
      
      const headers = ['Nama Siswa', 'Kelas', 'Status', 'Tanggal', 'Waktu', 'Keterangan', 'Input Oleh', 'Role'];
      const csvContent = [
        headers.join(','),
        ...allRecords.map(record => [
          `"${record.nama_siswa}"`,
          `"${record.kelas}"`,
          `"${record.status}"`,
          `"${record.tanggal}"`,
          `"${record.waktu}"`,
          `"${record.keterangan || ''}"`,
          `"${record.input_by || ''}"`,
          `"${record.user_role || ''}"`
        ].join(','))
      ].join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `absensi_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast('âœ… Data berhasil di-export!', 'success');
    };

    // Student data will be loaded from Google Sheets
    let studentsByClass = {};
    let isStudentDataLoaded = false;
    let studentDataUrl = ''; // Will be set from config or manual input

    // Attendance Google Sheets integration
    let attendanceSheetUrl = 'https://script.google.com/macros/s/AKfycbwTFf2vKfXdQz3CWLnj1Cm2Qo53iz_8aB0rdkZ7403og5pLcUe6l8xft1LBbPj1BNBi/exec';
    let isAttendanceSheetConnected = true;

    let currentClassStudents = [];
    let attendanceData = {};

    // Function to load student data from Google Sheets
    async function loadStudentDataFromSheets(url) {
      try {
        showToast('ğŸ“¥ Memuat data siswa dari Google Sheets...', 'success');
        
        const response = await fetch(url);
        const data = await response.json();
        
        // Reset studentsByClass
        studentsByClass = {};
        
        // Group students by class
        data.forEach(student => {
          if (student.nama_siswa && student.kelas) {
            if (!studentsByClass[student.kelas]) {
              studentsByClass[student.kelas] = [];
            }
            
            // Avoid duplicates
            if (!studentsByClass[student.kelas].includes(student.nama_siswa)) {
              studentsByClass[student.kelas].push(student.nama_siswa);
            }
          }
        });
        
        // Sort students in each class
        Object.keys(studentsByClass).forEach(kelas => {
          studentsByClass[kelas].sort();
        });
        
        isStudentDataLoaded = true;
        updateClassDropdowns();
        
        const totalStudents = Object.values(studentsByClass).reduce((sum, students) => sum + students.length, 0);
        const totalClasses = Object.keys(studentsByClass).length;
        
        showToast(`âœ… Berhasil memuat ${totalStudents} siswa dari ${totalClasses} kelas!`, 'success');
        
        return true;
      } catch (error) {
        console.error('Error loading student data:', error);
        showToast('âŒ Gagal memuat data siswa. Periksa URL Google Sheets.', 'error');
        
        // Fallback to sample data
        loadSampleStudentData();
        return false;
      }
    }

    // Fallback sample data
    function loadSampleStudentData() {
      studentsByClass = {
        'VII A': ['Ahmad Rizki', 'Siti Nurhaliza', 'Budi Santoso', 'Dewi Sartika', 'Eko Prasetyo', 'Fitri Handayani', 'Gilang Ramadhan', 'Hana Pertiwi', 'Indra Gunawan', 'Jihan Aulia', 'Krisna Wijaya', 'Lestari Putri', 'Muhammad Fadil', 'Nadia Safira', 'Oki Setiawan'],
        'VII B': ['Putri Maharani', 'Qori Syahputra', 'Rina Melati', 'Surya Pratama', 'Tania Sari', 'Umar Faruq', 'Vina Amelia', 'Wahyu Hidayat', 'Xenia Putri', 'Yoga Pratama', 'Zahra Aulia', 'Arif Rahman', 'Bella Safitri', 'Candra Kirana', 'Dimas Aditya'],
        'VII C': ['Elsa Permata', 'Fajar Nugraha', 'Gita Savitri', 'Hendra Kusuma', 'Ika Rahmawati', 'Joko Susilo', 'Kartika Dewi', 'Lukman Hakim', 'Maya Sari', 'Noval Pratama', 'Olivia Putri', 'Pandu Winata', 'Qonita Zahara', 'Reza Mahendra', 'Sari Indah'],
        'VIII A': ['Taufik Hidayat', 'Ulfa Khoiriyah', 'Vicky Pratama', 'Winda Sari', 'Xavier Putra', 'Yuni Astuti', 'Zaki Rahman', 'Aida Fitria', 'Bayu Setiawan', 'Citra Dewi', 'Doni Prasetya', 'Evi Susanti', 'Fandi Kurniawan', 'Gina Marlina', 'Hadi Wijaya'],
        'VIII B': ['Ira Puspita', 'Jefri Nichol', 'Kania Dewi', 'Luki Hermawan', 'Mira Handayani', 'Nanda Pratama', 'Oki Setiani', 'Prita Maharani', 'Qomar Zaman', 'Rini Suryani', 'Sandi Permana', 'Tika Rahayu', 'Udin Sedunia', 'Vera Safitri', 'Wawan Kurniawan'],
        'VIII C': ['Xara Putri', 'Yanto Basuki', 'Zara Amelia', 'Andi Pratama', 'Bela Purnama', 'Coki Pardede', 'Dina Mariana', 'Egi Maulana', 'Fira Azzahra', 'Galih Pratama', 'Hesti Purnamasari', 'Imam Santoso', 'Jesi Ramadhan', 'Kiki Amalia', 'Lina Marlina'],
        'IX A': ['Manda Safitri', 'Niko Pratama', 'Ocha Maharani', 'Piko Aditama', 'Qila Ramadhani', 'Riko Setiawan', 'Sinta Dewi', 'Toni Kurniawan', 'Umi Kalsum', 'Vero Pratama', 'Wulan Dari', 'Xavi Maulana', 'Yesi Purnama', 'Zidan Akbar', 'Alya Putri'],
        'IX B': ['Bagas Pratama', 'Cinta Laura', 'Dedi Setiawan', 'Eka Rahayu', 'Farel Prayoga', 'Gaby Spanic', 'Haris Pratama', 'Intan Permata', 'Jihan Mirdad', 'Kenzo Alvaro', 'Luna Maya', 'Maudy Ayunda', 'Nino Fernandez', 'Olla Ramlan', 'Prilly Latuconsina'],
        'IX C': ['Quincy Jones', 'Raisa Andriana', 'Sheila Dara', 'Tulus Rusydi', 'Ussy Sulistiawaty', 'Vidi Aldiano', 'Wulan Guritno', 'Xabiru Oshe', 'Yura Yunita', 'Zaskia Gotik', 'Afgan Syahreza', 'Bunga Zainal', 'Chand Kelvin', 'Dian Sastro', 'Enzy Storia']
      };
      
      isStudentDataLoaded = true;
      updateClassDropdowns();
      showToast('ğŸ“‹ Menggunakan data siswa sample. Hubungkan ke Google Sheets untuk data real.', 'success');
    }

    // Update class dropdowns when student data is loaded
    function updateClassDropdowns() {
      const formFilterKelas = document.getElementById('form-filter-kelas');
      const filterKelas = document.getElementById('filter-kelas');
      
      if (formFilterKelas) {
        const currentValue = formFilterKelas.value;
        formFilterKelas.innerHTML = '<option value="">Pilih Kelas</option>';
        
        // Get today's date for filtering
        const today = new Date().toISOString().split('T')[0];
        
        // Get classes that already have attendance today
        const classesWithAttendanceToday = new Set(
          allRecords
            .filter(record => record.tanggal === today)
            .map(record => record.kelas)
        );
        
        Object.keys(studentsByClass).sort().forEach(kelas => {
          const option = document.createElement('option');
          option.value = kelas;
          
          if (classesWithAttendanceToday.has(kelas)) {
            option.textContent = `${kelas} (${studentsByClass[kelas].length} siswa) - Sudah Diabsen`;
            option.style.color = '#6b7280';
            option.style.fontStyle = 'italic';
            option.disabled = true;
          } else {
            option.textContent = `${kelas} (${studentsByClass[kelas].length} siswa)`;
          }
          
          formFilterKelas.appendChild(option);
        });
        
        formFilterKelas.value = currentValue;
      }
      
      // Update filter dropdown as well
      if (filterKelas && allRecords.length > 0) {
        updateFilterOptions(allRecords);
      }
    }

    // Copy functions for Apps Script code
    window.copyStudentDataScript = function() {
      const code = document.getElementById('student-data-script').textContent;
      navigator.clipboard.writeText(code).then(() => {
        showToast('âœ… Kode Student Data Script berhasil di-copy!', 'success');
      }).catch(() => {
        showToast('âŒ Gagal copy kode. Silakan copy manual.', 'error');
      });
    };

    window.copyAttendanceScript = function() {
      const code = document.getElementById('attendance-script').textContent;
      navigator.clipboard.writeText(code).then(() => {
        showToast('âœ… Kode Attendance Script berhasil di-copy!', 'success');
      }).catch(() => {
        showToast('âŒ Gagal copy kode. Silakan copy manual.', 'error');
      });
    };

    window.copyTestCode = function() {
      const code = document.getElementById('test-code').textContent;
      navigator.clipboard.writeText(code).then(() => {
        showToast('âœ… Kode test berhasil di-copy!', 'success');
      }).catch(() => {
        showToast('âŒ Gagal copy kode. Silakan copy manual.', 'error');
      });
    };

    // Load students by class
    window.loadStudentsByClass = function() {
      const selectedClass = document.getElementById('form-filter-kelas').value;
      
      if (!selectedClass) {
        showToast('âŒ Pilih kelas terlebih dahulu!', 'error');
        return;
      }
      
      if (!hasPermission('create')) {
        showToast('âŒ Anda tidak memiliki izin untuk input absensi!', 'error');
        return;
      }
      
      currentClassStudents = studentsByClass[selectedClass] || [];
      attendanceData = {};
      
      if (currentClassStudents.length === 0) {
        showToast('âŒ Data siswa untuk kelas ini belum tersedia!', 'error');
        return;
      }
      
      // Show student list and hide individual form
      document.getElementById('student-attendance-list').classList.remove('hidden');
      document.getElementById('absensi-form').classList.add('hidden');
      
      renderStudentList(selectedClass);
      showToast(`âœ… Berhasil memuat ${currentClassStudents.length} siswa kelas ${selectedClass}`, 'success');
    };

    function renderStudentList(className) {
      const container = document.getElementById('students-container');
      
      container.innerHTML = currentClassStudents.map((student, index) => `
        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all" data-student="${student}">
          <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div class="flex-1">
              <h4 class="text-lg font-bold text-gray-800">${student}</h4>
              <p class="text-sm text-gray-600">Kelas: ${className}</p>
            </div>
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-2">
              <label class="flex items-center justify-center p-2 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-green-500 transition-all text-sm">
                <input type="radio" name="status-${index}" value="Hadir" onchange="updateAttendance('${student}', 'Hadir')" class="mr-2">
                <span>âœ… Hadir</span>
              </label>
              
              <label class="flex items-center justify-center p-2 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-yellow-500 transition-all text-sm">
                <input type="radio" name="status-${index}" value="Izin" onchange="updateAttendance('${student}', 'Izin')" class="mr-2">
                <span>ğŸ“ Izin</span>
              </label>
              
              <label class="flex items-center justify-center p-2 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-red-500 transition-all text-sm">
                <input type="radio" name="status-${index}" value="Sakit" onchange="updateAttendance('${student}', 'Sakit')" class="mr-2">
                <span>ğŸ¥ Sakit</span>
              </label>
              
              <label class="flex items-center justify-center p-2 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-purple-500 transition-all text-sm">
                <input type="radio" name="status-${index}" value="Alpha" onchange="updateAttendance('${student}', 'Alpha')" class="mr-2">
                <span>âŒ Alpha</span>
              </label>
            </div>
          </div>
          <div class="mt-3">
            <input type="text" placeholder="Keterangan (opsional)" onchange="updateAttendanceNote('${student}', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm">
          </div>
        </div>
      `).join('');
    }

    window.updateAttendance = function(student, status) {
      if (!attendanceData[student]) {
        attendanceData[student] = {};
      }
      attendanceData[student].status = status;
    };

    window.updateAttendanceNote = function(student, note) {
      if (!attendanceData[student]) {
        attendanceData[student] = {};
      }
      attendanceData[student].keterangan = note;
    };

    window.markAllPresent = function() {
      currentClassStudents.forEach((student, index) => {
        const radio = document.querySelector(`input[name="status-${index}"][value="Hadir"]`);
        if (radio) {
          radio.checked = true;
          updateAttendance(student, 'Hadir');
        }
      });
      showToast('âœ… Semua siswa ditandai hadir!', 'success');
    };

    window.saveAllAttendance = function() {
      if (!hasPermission('create')) {
        showToast('âŒ Anda tidak memiliki izin untuk menyimpan absensi!', 'error');
        return;
      }
      
      const selectedClass = document.getElementById('form-filter-kelas').value;
      const studentsWithStatus = currentClassStudents.filter(student => 
        attendanceData[student] && attendanceData[student].status
      );
      
      if (studentsWithStatus.length === 0) {
        showToast('âŒ Belum ada siswa yang dipilih statusnya!', 'error');
        return;
      }
      
      if (recordCount + studentsWithStatus.length > 999) {
        showToast(`âŒ Batas maksimal 999 data tercapai. Hanya bisa menambah ${999 - recordCount} data lagi.`, 'error');
        return;
      }
      
      // Show confirmation
      const confirmDiv = document.createElement('div');
      confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      confirmDiv.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md mx-4 text-center shadow-2xl">
          <div class="text-6xl mb-4">ğŸ’¾</div>
          <h3 class="text-xl font-bold text-gray-800 mb-2">Konfirmasi Simpan</h3>
          <p class="text-gray-600 mb-4">Simpan absensi untuk ${studentsWithStatus.length} siswa kelas ${selectedClass}?</p>
          <div class="flex gap-3">
            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-all font-medium">
              Batal
            </button>
            <button onclick="confirmSaveAllAttendance(); this.parentElement.parentElement.parentElement.remove();" class="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all font-medium">
              Simpan
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmDiv);
    };

    window.confirmSaveAllAttendance = async function() {
      const selectedClass = document.getElementById('form-filter-kelas').value;
      const wibTime = getWIBTime();
      const tanggal = wibTime.toISOString().split('T')[0];
      const waktu = wibTime.toTimeString().split(' ')[0].substring(0, 5);
      
      let successCount = 0;
      let errorCount = 0;
      let sheetsSuccessCount = 0;
      
      // Show loading
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      loadingDiv.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-sm mx-4 text-center shadow-2xl">
          <div class="loading-spinner mx-auto mb-4"></div>
          <h3 class="text-xl font-bold text-gray-800 mb-2">Menyimpan Absensi...</h3>
          <p class="text-gray-600">Mohon tunggu sebentar</p>
          <p class="text-sm text-gray-500 mt-2">Mengirim ke Google Sheets...</p>
        </div>
      `;
      document.body.appendChild(loadingDiv);
      
      for (const student of currentClassStudents) {
        if (attendanceData[student] && attendanceData[student].status) {
          const newRecord = {
            id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
            nama_siswa: student,
            kelas: selectedClass,
            status: attendanceData[student].status,
            tanggal: tanggal,
            waktu: waktu,
            keterangan: attendanceData[student].keterangan || '',
            input_by: currentUser.username,
            user_role: currentUser.role,
            timestamp: wibTime.toISOString()
          };
          
          // Send to Google Sheets first
          const sheetsResult = await sendToGoogleSheets(newRecord);
          if (sheetsResult.success) {
            sheetsSuccessCount++;
          }
          
          // Then save to local Data SDK
          const result = await window.dataSdk.create(newRecord);
          
          if (result.isOk) {
            successCount++;
          } else {
            errorCount++;
          }
          
          // Small delay to prevent overwhelming the system
          await new Promise(resolve => setTimeout(resolve, 200));
        }
      }
      
      loadingDiv.remove();
      
      if (successCount > 0) {
        if (sheetsSuccessCount === successCount) {
          showToast(`âœ… Berhasil menyimpan ${successCount} absensi ke sistem dan Google Sheets!`, 'success');
        } else if (sheetsSuccessCount > 0) {
          showToast(`âœ… Berhasil menyimpan ${successCount} absensi. ${sheetsSuccessCount} berhasil ke Google Sheets.`, 'success');
        } else {
          showToast(`âœ… Berhasil menyimpan ${successCount} absensi ke sistem. âš ï¸ Gagal kirim ke Google Sheets.`, 'success');
        }
        
        // Reset form
        document.getElementById('student-attendance-list').classList.add('hidden');
        document.getElementById('absensi-form').classList.remove('hidden');
        document.getElementById('form-filter-kelas').value = '';
        attendanceData = {};
        currentClassStudents = [];
        
        // Update class dropdown to reflect completed attendance
        updateClassDropdowns();
      }
      
      if (errorCount > 0) {
        showToast(`âš ï¸ ${errorCount} data gagal disimpan. Silakan coba lagi.`, 'error');
      }
    };

    // Navigation functions
    window.showAbsensiPage = function() {
      document.getElementById('absensi-page').classList.remove('hidden');
      document.getElementById('rekap-page').classList.add('hidden');
      document.getElementById('panduan-page').classList.add('hidden');
      document.getElementById('pengaturan-page').classList.add('hidden');
      
      // Update navigation buttons
      document.getElementById('nav-absensi').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-blue-500 text-white';
      document.getElementById('nav-rekap').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
      document.getElementById('nav-panduan').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
      document.getElementById('nav-pengaturan').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
    };

    window.showRekapPage = function() {
      document.getElementById('absensi-page').classList.add('hidden');
      document.getElementById('rekap-page').classList.remove('hidden');
      document.getElementById('panduan-page').classList.add('hidden');
      document.getElementById('pengaturan-page').classList.add('hidden');
      
      // Update navigation buttons
      document.getElementById('nav-absensi').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
      document.getElementById('nav-rekap').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-blue-500 text-white';
      document.getElementById('nav-panduan').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
      document.getElementById('nav-pengaturan').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
    };

    window.showPanduanPage = function() {
      document.getElementById('absensi-page').classList.add('hidden');
      document.getElementById('rekap-page').classList.add('hidden');
      document.getElementById('panduan-page').classList.remove('hidden');
      document.getElementById('pengaturan-page').classList.add('hidden');
      
      // Update navigation buttons
      document.getElementById('nav-absensi').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
      document.getElementById('nav-rekap').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
      document.getElementById('nav-panduan').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-blue-500 text-white';
      document.getElementById('nav-pengaturan').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
    };

    window.showPengaturanPage = function() {
      document.getElementById('absensi-page').classList.add('hidden');
      document.getElementById('rekap-page').classList.add('hidden');
      document.getElementById('panduan-page').classList.add('hidden');
      document.getElementById('pengaturan-page').classList.remove('hidden');
      
      // Update navigation buttons
      document.getElementById('nav-absensi').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
      document.getElementById('nav-rekap').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
      document.getElementById('nav-panduan').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
      document.getElementById('nav-pengaturan').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-blue-500 text-white';
      
      // Update user management interface
      updateUserManagementInterface();
      renderUserList();
    };

    // User management functions
    function updateUserManagementInterface() {
      const addUserSection = document.getElementById('add-user-section');
      
      if (hasPermission('manage_users')) {
        addUserSection.classList.remove('hidden');
      } else {
        addUserSection.classList.add('hidden');
      }
    }

    function renderUserList() {
      const userList = document.getElementById('user-list');
      if (!userList) return;
      
      const userEntries = Object.entries(users);
      
      if (userEntries.length === 0) {
        userList.innerHTML = `
          <div class="text-center py-8 text-gray-400">
            <div class="text-4xl mb-2">ğŸ‘¥</div>
            <p>Belum ada user terdaftar</p>
          </div>
        `;
        return;
      }
      
      userList.innerHTML = userEntries.map(([username, userData]) => {
        const roleColors = {
          'Admin': 'bg-red-100 text-red-800',
          'Kepala Sekolah': 'bg-purple-100 text-purple-800',
          'Guru Piket': 'bg-blue-100 text-blue-800'
        };
        
        const roleIcons = {
          'Admin': 'ğŸ‘‘',
          'Kepala Sekolah': 'ğŸ“',
          'Guru Piket': 'ğŸ‘¨â€ğŸ«'
        };
        
        const canDelete = hasPermission('manage_users') && username !== currentUser?.username;
        
        return `
          <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="text-2xl">${roleIcons[userData.role]}</div>
                <div>
                  <h4 class="font-bold text-gray-800">${username}</h4>
                  <span class="px-2 py-1 rounded-full text-xs font-medium ${roleColors[userData.role]}">
                    ${userData.role}
                  </span>
                </div>
              </div>
              <div class="flex items-center gap-2">
                ${username === currentUser?.username ? 
                  '<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">Anda</span>' : 
                  ''
                }
                ${canDelete ? `
                  <button onclick="deleteUser('${username}')" class="px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all text-xs font-medium">
                    ğŸ—‘ï¸ Hapus
                  </button>
                ` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    async function handleAddUser(e) {
      e.preventDefault();
      
      if (!hasPermission('manage_users')) {
        showToast('âŒ Anda tidak memiliki izin untuk mengelola user!', 'error');
        return;
      }
      
      setLoading(true, 'add-user-btn', 'add-user-text');
      
      const username = document.getElementById('new-username').value;
      const password = document.getElementById('new-password').value;
      const role = document.getElementById('new-role').value;
      
      // Check if username already exists
      if (users[username]) {
        showToast('âŒ Username sudah digunakan!', 'error');
        setLoading(false, 'add-user-btn', 'add-user-text');
        return;
      }
      
      // Define permissions based on role
      const rolePermissions = {
        'Admin': ['create', 'read', 'update', 'delete', 'export', 'manage_users'],
        'Kepala Sekolah': ['read', 'export', 'view_reports'],
        'Guru Piket': ['create', 'read', 'update']
      };
      
      // Add new user
      users[username] = {
        password: password,
        role: role,
        permissions: rolePermissions[role]
      };
      
      // Simulate loading delay
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      showToast(`âœ… User ${username} berhasil ditambahkan!`, 'success');
      document.getElementById('add-user-form').reset();
      renderUserList();
      
      setLoading(false, 'add-user-btn', 'add-user-text');
    }

    window.deleteUser = async function(username) {
      if (!hasPermission('manage_users')) {
        showToast('âŒ Anda tidak memiliki izin untuk mengelola user!', 'error');
        return;
      }
      
      if (username === currentUser?.username) {
        showToast('âŒ Anda tidak dapat menghapus akun sendiri!', 'error');
        return;
      }
      
      // Custom confirmation dialog
      const confirmDiv = document.createElement('div');
      confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      confirmDiv.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-sm mx-4 text-center shadow-2xl">
          <div class="text-6xl mb-4">âš ï¸</div>
          <h3 class="text-xl font-bold text-gray-800 mb-2">Konfirmasi Hapus</h3>
          <p class="text-gray-600 mb-4">Yakin ingin menghapus user "${username}"?</p>
          <div class="flex gap-3">
            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-all font-medium">
              Batal
            </button>
            <button onclick="confirmDeleteUser('${username}'); this.parentElement.parentElement.parentElement.remove();" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all font-medium">
              Hapus
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmDiv);
    };

    window.confirmDeleteUser = function(username) {
      delete users[username];
      showToast(`âœ… User ${username} berhasil dihapus!`, 'success');
      renderUserList();
    };

    // Handle student data form submission
    async function handleStudentDataForm(e) {
      e.preventDefault();
      
      const url = document.getElementById('student-data-url').value;
      
      if (!url) {
        showToast('âŒ Masukkan URL Google Apps Script terlebih dahulu!', 'error');
        return;
      }
      
      studentDataUrl = url;
      const success = await loadStudentDataFromSheets(url);
      
      if (success) {
        updateStudentDataStatus(true, url);
      }
    }

    // Update student data status display
    function updateStudentDataStatus(isConnected, url = '') {
      const statusDiv = document.getElementById('student-data-status');
      
      if (isConnected) {
        statusDiv.className = 'p-4 rounded-lg border-l-4 border-l-green-400 bg-green-50';
        statusDiv.innerHTML = `
          <div class="flex items-center gap-3">
            <span class="text-2xl">âœ…</span>
            <div>
              <h3 class="font-bold text-green-800">Terhubung ke Google Sheets</h3>
              <p class="text-green-600 text-sm">Data siswa berhasil dimuat dari Google Sheets</p>
              <p class="text-green-500 text-xs mt-1 break-all">${url}</p>
            </div>
          </div>
        `;
      } else {
        statusDiv.className = 'p-4 rounded-lg border-l-4 border-l-yellow-400 bg-yellow-50';
        statusDiv.innerHTML = `
          <div class="flex items-center gap-3">
            <span class="text-2xl">ğŸ“‹</span>
            <div>
              <h3 class="font-bold text-yellow-800">Menggunakan Data Sample</h3>
              <p class="text-yellow-600 text-sm">Belum terhubung ke Google Sheets - menggunakan data sample</p>
            </div>
          </div>
        `;
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      if (window.elementSdk) {
        await window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.background_color || defaultConfig.background_color,
                set: (value) => {
                  config.background_color = value;
                  window.elementSdk.setConfig({ background_color: value });
                }
              },
              {
                get: () => config.surface_color || defaultConfig.surface_color,
                set: (value) => {
                  config.surface_color = value;
                  window.elementSdk.setConfig({ surface_color: value });
                }
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  config.text_color = value;
                  window.elementSdk.setConfig({ text_color: value });
                }
              },
              {
                get: () => config.primary_action_color || defaultConfig.primary_action_color,
                set: (value) => {
                  config.primary_action_color = value;
                  window.elementSdk.setConfig({ primary_action_color: value });
                }
              },
              {
                get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
                set: (value) => {
                  config.secondary_action_color = value;
                  window.elementSdk.setConfig({ secondary_action_color: value });
                }
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => config.font_family || defaultConfig.font_family,
              set: (value) => {
                config.font_family = value;
                window.elementSdk.setConfig({ font_family: value });
              }
            },
            fontSizeable: {
              get: () => config.font_size || defaultConfig.font_size,
              set: (value) => {
                config.font_size = value;
                window.elementSdk.setConfig({ font_size: value });
              }
            }
          }),
          mapToEditPanelValues: (config) => new Map([
            ["judul_aplikasi", config.judul_aplikasi || defaultConfig.judul_aplikasi],
            ["nama_sekolah", config.nama_sekolah || defaultConfig.nama_sekolah],
            ["admin_username", config.admin_username || defaultConfig.admin_username],
            ["admin_password", config.admin_password || defaultConfig.admin_password],
            ["footer_text", config.footer_text || defaultConfig.footer_text]
          ])
        });
      }
      
      if (window.dataSdk) {
        const initResult = await window.dataSdk.init(dataHandler);
        if (!initResult.isOk) {
          showToast('âŒ Gagal menginisialisasi sistem. Refresh halaman.', 'error');
        }
      }
      
      const loginForm = document.getElementById('login-form');
      if (loginForm) {
        loginForm.addEventListener('submit', handleLogin);
      }
      
      const form = document.getElementById('absensi-form');
      if (form) {
        form.addEventListener('submit', handleSubmit);
      }
      
      const addUserForm = document.getElementById('add-user-form');
      if (addUserForm) {
        addUserForm.addEventListener('submit', handleAddUser);
      }
      
      const studentDataForm = document.getElementById('student-data-form');
      if (studentDataForm) {
        studentDataForm.addEventListener('submit', handleStudentDataForm);
      }
      
      const filterKelas = document.getElementById('filter-kelas');
      const filterStatus = document.getElementById('filter-status');
      const filterTanggal = document.getElementById('filter-tanggal');
      const filterUser = document.getElementById('filter-user');
      
      if (filterKelas) filterKelas.addEventListener('change', applyFilters);
      if (filterStatus) filterStatus.addEventListener('change', applyFilters);
      if (filterTanggal) filterTanggal.addEventListener('change', applyFilters);
      if (filterUser) filterUser.addEventListener('change', applyFilters);
      
      // Set today's date as default for rekap
      const today = new Date().toISOString().split('T')[0];
      const rekapTanggal = document.getElementById('rekap-tanggal');
      if (rekapTanggal) {
        rekapTanggal.value = today;
      }
      
      // Auto-generate rekap for today when data is available
      setTimeout(() => {
        if (allRecords.length > 0) {
          generateRekapForDate(today);
        }
      }, 1000);
      
      // Rekap navigation functions
      window.showRekapHarian = function() {
        document.getElementById('rekap-harian-section').classList.remove('hidden');
        document.getElementById('rekap-bulanan-section').classList.add('hidden');
        
        // Update navigation buttons
        document.getElementById('rekap-nav-harian').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-blue-500 text-white';
        document.getElementById('rekap-nav-bulanan').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
      };

      window.showRekapBulanan = function() {
        document.getElementById('rekap-harian-section').classList.add('hidden');
        document.getElementById('rekap-bulanan-section').classList.remove('hidden');
        
        // Update navigation buttons
        document.getElementById('rekap-nav-harian').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
        document.getElementById('rekap-nav-bulanan').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-green-500 text-white';
        
        // Set current month and year as default
        const now = new Date();
        const currentMonth = String(now.getMonth() + 1).padStart(2, '0');
        const currentYear = now.getFullYear();
        
        document.getElementById('rekap-bulan').value = currentMonth;
        document.getElementById('rekap-tahun').value = currentYear;
      };

      // Generate rekap functions
      window.generateRekapByDate = function() {
        const selectedDate = document.getElementById('rekap-tanggal').value;
        
        if (!selectedDate) {
          showToast('âŒ Pilih tanggal terlebih dahulu!', 'error');
          return;
        }
        
        generateRekapForDate(selectedDate);
      };

      window.generateRekapBulanan = function() {
        const selectedMonth = document.getElementById('rekap-bulan').value;
        const selectedYear = document.getElementById('rekap-tahun').value;
        
        if (!selectedMonth || !selectedYear) {
          showToast('âŒ Pilih bulan dan tahun terlebih dahulu!', 'error');
          return;
        }
        
        generateRekapForMonth(selectedYear, selectedMonth);
      };

      function generateRekapForDate(date) {
        const filteredData = allRecords.filter(record => record.tanggal === date);
        
        if (filteredData.length === 0) {
          document.getElementById('rekap-results').innerHTML = `
            <div class="text-center py-12 text-gray-400">
              <div class="text-6xl mb-4">ğŸ“…</div>
              <p class="text-lg">Tidak ada data absensi untuk tanggal ${date}</p>
              <p class="text-sm mt-2">Pilih tanggal lain atau tambahkan data absensi</p>
            </div>
          `;
          return;
        }
        
        // Group data by class
        const dataByClass = {};
        // Get classes from loaded student data, fallback to default if not loaded
        const allClasses = Object.keys(studentsByClass).length > 0 ? 
          Object.keys(studentsByClass).sort() : 
          ['VII A', 'VII B', 'VII C', 'VIII A', 'VIII B', 'VIII C', 'IX A', 'IX B', 'IX C'];
        
        // Initialize all classes
        allClasses.forEach(kelas => {
          const totalSiswa = studentsByClass[kelas] ? studentsByClass[kelas].length : 15;
          dataByClass[kelas] = {
            hadir: 0,
            izin: 0,
            sakit: 0,
            alpha: 0,
            total_siswa: totalSiswa,
            belum_absen: totalSiswa
          };
        });
        
        // Count attendance by class
        filteredData.forEach(record => {
          if (dataByClass[record.kelas]) {
            dataByClass[record.kelas][record.status.toLowerCase()]++;
            dataByClass[record.kelas].belum_absen--;
          }
        });
        
        // Calculate overall statistics
        let totalSiswa = 0;
        let totalHadir = 0;
        let totalIzin = 0;
        let totalSakit = 0;
        let totalAlpha = 0;
        let totalBelumAbsen = 0;
        
        Object.values(dataByClass).forEach(classData => {
          totalSiswa += classData.total_siswa;
          totalHadir += classData.hadir;
          totalIzin += classData.izin;
          totalSakit += classData.sakit;
          totalAlpha += classData.alpha;
          totalBelumAbsen += classData.belum_absen;
        });
        
        const overallPercentage = totalSiswa > 0 ? Math.round((totalHadir / totalSiswa) * 100) : 0;
        
        // Render rekap
        const rekapHtml = `
          <!-- Overall Summary -->
          <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg p-6 mb-6">
            <h3 class="text-2xl font-bold mb-4">ğŸ“Š Ringkasan Keseluruhan - ${date}</h3>
            <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
              <div class="text-center">
                <div class="text-3xl font-bold">${totalSiswa}</div>
                <div class="text-sm opacity-90">Total Siswa</div>
              </div>
              <div class="text-center">
                <div class="text-3xl font-bold text-green-300">${totalHadir}</div>
                <div class="text-sm opacity-90">Hadir</div>
              </div>
              <div class="text-center">
                <div class="text-3xl font-bold text-yellow-300">${totalIzin}</div>
                <div class="text-sm opacity-90">Izin</div>
              </div>
              <div class="text-center">
                <div class="text-3xl font-bold text-red-300">${totalSakit}</div>
                <div class="text-sm opacity-90">Sakit</div>
              </div>
              <div class="text-center">
                <div class="text-3xl font-bold text-purple-300">${totalAlpha}</div>
                <div class="text-sm opacity-90">Alpha</div>
              </div>
              <div class="text-center">
                <div class="text-3xl font-bold text-gray-300">${totalBelumAbsen}</div>
                <div class="text-sm opacity-90">Belum Absen</div>
              </div>
            </div>
            <div class="mt-4 text-center">
              <div class="text-4xl font-bold">${overallPercentage}%</div>
              <div class="text-lg opacity-90">Persentase Kehadiran Keseluruhan</div>
            </div>
          </div>
          
          <!-- Per Class Breakdown -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            ${allClasses.map(kelas => {
              const classData = dataByClass[kelas];
              const attendancePercentage = classData.total_siswa > 0 ? 
                Math.round((classData.hadir / classData.total_siswa) * 100) : 0;
              
              let statusColor = 'bg-red-500';
              if (attendancePercentage >= 90) statusColor = 'bg-green-500';
              else if (attendancePercentage >= 75) statusColor = 'bg-yellow-500';
              
              return `
                <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-lg transition-all">
                  <div class="flex items-center justify-between mb-4">
                    <h4 class="text-xl font-bold text-gray-800">ğŸ“ ${kelas}</h4>
                    <div class="text-right">
                      <div class="text-2xl font-bold ${attendancePercentage >= 90 ? 'text-green-600' : attendancePercentage >= 75 ? 'text-yellow-600' : 'text-red-600'}">${attendancePercentage}%</div>
                      <div class="text-sm text-gray-500">Kehadiran</div>
                    </div>
                  </div>
                  
                  <div class="space-y-3">
                    <div class="flex justify-between items-center">
                      <span class="text-gray-600">ğŸ‘¥ Total Siswa:</span>
                      <span class="font-bold">${classData.total_siswa}</span>
                    </div>
                    
                    <div class="flex justify-between items-center">
                      <span class="text-green-600">âœ… Hadir:</span>
                      <span class="font-bold text-green-600">${classData.hadir}</span>
                    </div>
                    
                    <div class="flex justify-between items-center">
                      <span class="text-yellow-600">ğŸ“ Izin:</span>
                      <span class="font-bold text-yellow-600">${classData.izin}</span>
                    </div>
                    
                    <div class="flex justify-between items-center">
                      <span class="text-red-600">ğŸ¥ Sakit:</span>
                      <span class="font-bold text-red-600">${classData.sakit}</span>
                    </div>
                    
                    <div class="flex justify-between items-center">
                      <span class="text-purple-600">âŒ Alpha:</span>
                      <span class="font-bold text-purple-600">${classData.alpha}</span>
                    </div>
                    
                    <div class="flex justify-between items-center">
                      <span class="text-gray-500">â³ Belum Absen:</span>
                      <span class="font-bold text-gray-500">${classData.belum_absen}</span>
                    </div>
                  </div>
                  
                  <!-- Progress Bar -->
                  <div class="mt-4">
                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                      <span>Progress Kehadiran</span>
                      <span>${attendancePercentage}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                      <div class="${statusColor} h-3 rounded-full transition-all duration-500" style="width: ${attendancePercentage}%"></div>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
        
        document.getElementById('rekap-results').innerHTML = rekapHtml;
        showToast(`âœ… Rekap berhasil di-generate untuk ${date}!`, 'success');
      }

      function generateRekapForMonth(year, month) {
        // Filter data for the selected month
        const filteredData = allRecords.filter(record => {
          const recordDate = new Date(record.tanggal);
          return recordDate.getFullYear() == year && String(recordDate.getMonth() + 1).padStart(2, '0') === month;
        });
        
        const monthNames = {
          '01': 'Januari', '02': 'Februari', '03': 'Maret', '04': 'April',
          '05': 'Mei', '06': 'Juni', '07': 'Juli', '08': 'Agustus',
          '09': 'September', '10': 'Oktober', '11': 'November', '12': 'Desember'
        };
        
        if (filteredData.length === 0) {
          document.getElementById('rekap-results').innerHTML = `
            <div class="text-center py-12 text-gray-400">
              <div class="text-6xl mb-4">ğŸ“…</div>
              <p class="text-lg">Tidak ada data absensi untuk ${monthNames[month]} ${year}</p>
              <p class="text-sm mt-2">Pilih bulan lain atau tambahkan data absensi</p>
            </div>
          `;
          return;
        }
        
        // Group data by class and calculate monthly statistics
        const dataByClass = {};
        // Get classes from loaded student data, fallback to default if not loaded
        const allClasses = Object.keys(studentsByClass).length > 0 ? 
          Object.keys(studentsByClass).sort() : 
          ['VII A', 'VII B', 'VII C', 'VIII A', 'VIII B', 'VIII C', 'IX A', 'IX B', 'IX C'];
        
        // Get number of school days in the month (excluding weekends)
        const daysInMonth = new Date(year, month, 0).getDate();
        const schoolDays = getSchoolDaysInMonth(year, month);
        
        // Initialize all classes
        allClasses.forEach(kelas => {
          const totalSiswa = studentsByClass[kelas] ? studentsByClass[kelas].length : 15;
          dataByClass[kelas] = {
            hadir: 0,
            izin: 0,
            sakit: 0,
            alpha: 0,
            total_siswa: totalSiswa,
            total_possible_attendance: totalSiswa * schoolDays, // actual students Ã— school days
            attendance_days: new Set(), // Track unique attendance days
            student_attendance: {} // Track individual student attendance
          };
          
          // Initialize student attendance tracking
          const students = studentsByClass[kelas] || [];
          students.forEach(student => {
            dataByClass[kelas].student_attendance[student] = {
              hadir: 0,
              izin: 0,
              sakit: 0,
              alpha: 0,
              total_days: 0
            };
          });
        });
        
        // Count attendance by class and track individual students
        filteredData.forEach(record => {
          if (dataByClass[record.kelas]) {
            dataByClass[record.kelas][record.status.toLowerCase()]++;
            dataByClass[record.kelas].attendance_days.add(record.tanggal);
            
            // Track individual student attendance
            if (dataByClass[record.kelas].student_attendance[record.nama_siswa]) {
              dataByClass[record.kelas].student_attendance[record.nama_siswa][record.status.toLowerCase()]++;
              dataByClass[record.kelas].student_attendance[record.nama_siswa].total_days++;
            }
          }
        });
        
        // Calculate overall statistics
        let totalPossibleAttendance = 0;
        let totalHadir = 0;
        let totalIzin = 0;
        let totalSakit = 0;
        let totalAlpha = 0;
        let totalRecorded = 0;
        
        Object.values(dataByClass).forEach(classData => {
          totalPossibleAttendance += classData.total_possible_attendance;
          totalHadir += classData.hadir;
          totalIzin += classData.izin;
          totalSakit += classData.sakit;
          totalAlpha += classData.alpha;
          totalRecorded += (classData.hadir + classData.izin + classData.sakit + classData.alpha);
        });
        
        const overallPercentage = totalPossibleAttendance > 0 ? Math.round((totalHadir / totalPossibleAttendance) * 100) : 0;
        const recordedPercentage = totalPossibleAttendance > 0 ? Math.round((totalRecorded / totalPossibleAttendance) * 100) : 0;
        
        // Generate monthly summary
        const rekapHtml = `
          <!-- Monthly Summary Header -->
          <div class="bg-gradient-to-r from-green-500 to-blue-600 text-white rounded-lg p-6 mb-6">
            <h3 class="text-3xl font-bold mb-4">ğŸ“Š Rekap Bulanan - ${monthNames[month]} ${year}</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
              <div class="text-center">
                <div class="text-2xl font-bold">${schoolDays}</div>
                <div class="text-sm opacity-90">Hari Sekolah</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold">${totalPossibleAttendance}</div>
                <div class="text-sm opacity-90">Total Kemungkinan Kehadiran</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold">${totalRecorded}</div>
                <div class="text-sm opacity-90">Data Tercatat</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold">${recordedPercentage}%</div>
                <div class="text-sm opacity-90">Kelengkapan Data</div>
              </div>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
              <div class="text-center">
                <div class="text-3xl font-bold text-green-300">${totalHadir}</div>
                <div class="text-sm opacity-90">Total Hadir</div>
              </div>
              <div class="text-center">
                <div class="text-3xl font-bold text-yellow-300">${totalIzin}</div>
                <div class="text-sm opacity-90">Total Izin</div>
              </div>
              <div class="text-center">
                <div class="text-3xl font-bold text-red-300">${totalSakit}</div>
                <div class="text-sm opacity-90">Total Sakit</div>
              </div>
              <div class="text-center">
                <div class="text-3xl font-bold text-purple-300">${totalAlpha}</div>
                <div class="text-sm opacity-90">Total Alpha</div>
              </div>
            </div>
            
            <div class="text-center">
              <div class="text-5xl font-bold">${overallPercentage}%</div>
              <div class="text-xl opacity-90">Persentase Kehadiran Keseluruhan</div>
            </div>
          </div>
          
          <!-- Monthly Class Statistics -->
          <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 mb-6">
            ${allClasses.map(kelas => {
              const classData = dataByClass[kelas];
              const classAttendancePercentage = classData.total_possible_attendance > 0 ? 
                Math.round((classData.hadir / classData.total_possible_attendance) * 100) : 0;
              const classRecordedPercentage = classData.total_possible_attendance > 0 ? 
                Math.round(((classData.hadir + classData.izin + classData.sakit + classData.alpha) / classData.total_possible_attendance) * 100) : 0;
              
              let statusColor = 'bg-red-500';
              if (classAttendancePercentage >= 90) statusColor = 'bg-green-500';
              else if (classAttendancePercentage >= 75) statusColor = 'bg-yellow-500';
              
              return `
                <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-lg transition-all">
                  <div class="flex items-center justify-between mb-4">
                    <h4 class="text-xl font-bold text-gray-800">ğŸ“ ${kelas}</h4>
                    <div class="text-right">
                      <div class="text-2xl font-bold ${classAttendancePercentage >= 90 ? 'text-green-600' : classAttendancePercentage >= 75 ? 'text-yellow-600' : 'text-red-600'}">${classAttendancePercentage}%</div>
                      <div class="text-sm text-gray-500">Kehadiran</div>
                    </div>
                  </div>
                  
                  <div class="space-y-2 mb-4">
                    <div class="flex justify-between items-center text-sm">
                      <span class="text-gray-600">ğŸ“Š Kelengkapan Data:</span>
                      <span class="font-bold ${classRecordedPercentage >= 80 ? 'text-green-600' : classRecordedPercentage >= 60 ? 'text-yellow-600' : 'text-red-600'}">${classRecordedPercentage}%</span>
                    </div>
                    
                    <div class="flex justify-between items-center text-sm">
                      <span class="text-green-600">âœ… Hadir:</span>
                      <span class="font-bold text-green-600">${classData.hadir}</span>
                    </div>
                    
                    <div class="flex justify-between items-center text-sm">
                      <span class="text-yellow-600">ğŸ“ Izin:</span>
                      <span class="font-bold text-yellow-600">${classData.izin}</span>
                    </div>
                    
                    <div class="flex justify-between items-center text-sm">
                      <span class="text-red-600">ğŸ¥ Sakit:</span>
                      <span class="font-bold text-red-600">${classData.sakit}</span>
                    </div>
                    
                    <div class="flex justify-between items-center text-sm">
                      <span class="text-purple-600">âŒ Alpha:</span>
                      <span class="font-bold text-purple-600">${classData.alpha}</span>
                    </div>
                  </div>
                  
                  <!-- Progress Bar -->
                  <div class="mb-3">
                    <div class="flex justify-between text-xs text-gray-600 mb-1">
                      <span>Kehadiran</span>
                      <span>${classAttendancePercentage}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                      <div class="${statusColor} h-2 rounded-full transition-all duration-500" style="width: ${classAttendancePercentage}%"></div>
                    </div>
                  </div>
                  
                  <!-- Data Completeness Bar -->
                  <div>
                    <div class="flex justify-between text-xs text-gray-600 mb-1">
                      <span>Kelengkapan Data</span>
                      <span>${classRecordedPercentage}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                      <div class="bg-blue-500 h-2 rounded-full transition-all duration-500" style="width: ${classRecordedPercentage}%"></div>
                    </div>
                  </div>
                  
                  <div class="mt-3 text-xs text-gray-500">
                    Hari tercatat: ${classData.attendance_days.size} dari ${schoolDays} hari sekolah
                  </div>
                </div>
              `;
            }).join('')}
          </div>
          
          <!-- Top Performers & Concerns -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Best Attendance Classes -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-6">
              <h4 class="text-xl font-bold text-green-800 mb-4">ğŸ† Kelas Terbaik (Kehadiran)</h4>
              ${(() => {
                const sortedClasses = allClasses
                  .map(kelas => ({
                    kelas,
                    percentage: dataByClass[kelas].total_possible_attendance > 0 ? 
                      Math.round((dataByClass[kelas].hadir / dataByClass[kelas].total_possible_attendance) * 100) : 0
                  }))
                  .sort((a, b) => b.percentage - a.percentage)
                  .slice(0, 3);
                
                return sortedClasses.map((item, index) => `
                  <div class="flex items-center justify-between py-2 ${index < sortedClasses.length - 1 ? 'border-b border-green-200' : ''}">
                    <div class="flex items-center gap-2">
                      <span class="text-lg">${index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : 'ğŸ¥‰'}</span>
                      <span class="font-medium text-green-800">${item.kelas}</span>
                    </div>
                    <span class="font-bold text-green-600">${item.percentage}%</span>
                  </div>
                `).join('');
              })()}
            </div>
            
            <!-- Classes Needing Attention -->
            <div class="bg-red-50 border border-red-200 rounded-lg p-6">
              <h4 class="text-xl font-bold text-red-800 mb-4">âš ï¸ Perlu Perhatian (Kehadiran Rendah)</h4>
              ${(() => {
                const concernClasses = allClasses
                  .map(kelas => ({
                    kelas,
                    percentage: dataByClass[kelas].total_possible_attendance > 0 ? 
                      Math.round((dataByClass[kelas].hadir / dataByClass[kelas].total_possible_attendance) * 100) : 0
                  }))
                  .filter(item => item.percentage < 80)
                  .sort((a, b) => a.percentage - b.percentage)
                  .slice(0, 3);
                
                if (concernClasses.length === 0) {
                  return '<div class="text-center py-4 text-gray-500">ğŸ‰ Semua kelas memiliki kehadiran baik!</div>';
                }
                
                return concernClasses.map((item, index) => `
                  <div class="flex items-center justify-between py-2 ${index < concernClasses.length - 1 ? 'border-b border-red-200' : ''}">
                    <div class="flex items-center gap-2">
                      <span class="text-lg">âš ï¸</span>
                      <span class="font-medium text-red-800">${item.kelas}</span>
                    </div>
                    <span class="font-bold text-red-600">${item.percentage}%</span>
                  </div>
                `).join('');
              })()}
            </div>
          </div>
          
          <!-- Monthly Trends -->
          <div class="bg-white border border-gray-200 rounded-lg p-6">
            <h4 class="text-xl font-bold text-gray-800 mb-4">ğŸ“ˆ Ringkasan & Rekomendasi</h4>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <h5 class="font-bold text-gray-700 mb-3">ğŸ“Š Statistik Utama:</h5>
                <ul class="space-y-2 text-sm text-gray-600">
                  <li>â€¢ <strong>Rata-rata kehadiran:</strong> ${overallPercentage}%</li>
                  <li>â€¢ <strong>Kelengkapan data:</strong> ${recordedPercentage}%</li>
                  <li>â€¢ <strong>Total hari sekolah:</strong> ${schoolDays} hari</li>
                  <li>â€¢ <strong>Kelas terbaik:</strong> ${(() => {
                    const best = allClasses
                      .map(kelas => ({
                        kelas,
                        percentage: dataByClass[kelas].total_possible_attendance > 0 ? 
                          Math.round((dataByClass[kelas].hadir / dataByClass[kelas].total_possible_attendance) * 100) : 0
                      }))
                      .sort((a, b) => b.percentage - a.percentage)[0];
                    return `${best.kelas} (${best.percentage}%)`;
                  })()}</li>
                </ul>
              </div>
              
              <div>
                <h5 class="font-bold text-gray-700 mb-3">ğŸ’¡ Rekomendasi:</h5>
                <ul class="space-y-2 text-sm text-gray-600">
                  ${overallPercentage >= 90 ? 
                    '<li>â€¢ âœ… <strong>Kehadiran sangat baik!</strong> Pertahankan konsistensi.</li>' : 
                    overallPercentage >= 75 ? 
                      '<li>â€¢ âš ï¸ <strong>Kehadiran cukup baik</strong>, tingkatkan motivasi siswa.</li>' : 
                      '<li>â€¢ ğŸš¨ <strong>Kehadiran perlu ditingkatkan</strong>, evaluasi faktor penyebab.</li>'
                  }
                  ${recordedPercentage < 80 ? 
                    '<li>â€¢ ğŸ“ <strong>Tingkatkan konsistensi input data</strong> absensi harian.</li>' : 
                    '<li>â€¢ âœ… <strong>Input data sudah konsisten</strong>, pertahankan.</li>'
                  }
                  <li>â€¢ ğŸ“ <strong>Follow up</strong> siswa dengan tingkat alpha tinggi.</li>
                  <li>â€¢ ğŸ“Š <strong>Monitor tren</strong> kehadiran secara berkala.</li>
                </ul>
              </div>
            </div>
          </div>
        `;
        
        document.getElementById('rekap-results').innerHTML = rekapHtml;
        showToast(`âœ… Rekap bulanan berhasil di-generate untuk ${monthNames[month]} ${year}!`, 'success');
      }

      // Helper function to calculate school days in a month (excluding weekends)
      function getSchoolDaysInMonth(year, month) {
        const daysInMonth = new Date(year, month, 0).getDate();
        let schoolDays = 0;
        
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, month - 1, day);
          const dayOfWeek = date.getDay();
          
          // Count Monday (1) to Friday (5) as school days
          if (dayOfWeek >= 1 && dayOfWeek <= 5) {
            schoolDays++;
          }
        }
        
        return schoolDays;
      }
      
      // Update time every second
      setInterval(updateCurrentTime, 1000);
      updateCurrentTime();
      
      // Test Google Sheets connection function
      window.testGoogleSheetsConnection = async function() {
        const testData = {
          nama_siswa: "Test Student - " + new Date().toLocaleTimeString(),
          kelas: "TEST",
          status: "Hadir",
          tanggal: new Date().toISOString().split('T')[0],
          waktu: new Date().toTimeString().split(' ')[0].substring(0, 5),
          keterangan: "Test koneksi Google Sheets - " + new Date().toLocaleString(),
          input_by: currentUser ? currentUser.username : "test_user",
          user_role: currentUser ? currentUser.role : "Test"
        };
        
        // Show loading
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        loadingDiv.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-sm mx-4 text-center shadow-2xl">
            <div class="loading-spinner mx-auto mb-4"></div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Testing Connection...</h3>
            <p class="text-gray-600">Mengirim data test ke Google Sheets</p>
            <p class="text-xs text-gray-500 mt-2">Tunggu 3 detik untuk hasil...</p>
          </div>
        `;
        document.body.appendChild(loadingDiv);
        
        console.log('ğŸ§ª Starting Google Sheets connection test...');
        console.log('ğŸ“Š Test data:', testData);
        console.log('ğŸ”— Apps Script URL:', attendanceSheetUrl);
        
        try {
          // Test with no-cors mode (same as actual implementation)
          console.log('ğŸ“¡ Sending POST request to Google Apps Script...');
          
          const response = await fetch(attendanceSheetUrl, {
            method: 'POST',
            mode: 'no-cors', // Same as production implementation
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(testData)
          });
          
          console.log('ğŸ“¡ Response received (no-cors mode):', response);
          console.log('ğŸ“¡ Response status:', response.status);
          console.log('ğŸ“¡ Response type:', response.type);
          
          // Wait a bit to ensure data is processed
          await new Promise(resolve => setTimeout(resolve, 2000));
          
          loadingDiv.remove();
          
          // With no-cors mode, we can't read response details, but no error means likely success
          // Show success dialog since the request was sent without throwing an error
          const successDiv = document.createElement('div');
          successDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
          successDiv.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-lg mx-4 text-center shadow-2xl max-h-96 overflow-y-auto">
              <div class="text-6xl mb-4">âœ…</div>
              <h3 class="text-xl font-bold text-green-800 mb-2">Test Koneksi Berhasil!</h3>
              <p class="text-gray-600 mb-4">Data test berhasil dikirim ke Google Apps Script</p>
              
              <div class="bg-blue-50 p-3 rounded-lg mb-4 text-left">
                <p class="text-sm text-blue-800"><strong>ğŸ“Š Data yang dikirim:</strong></p>
                <p class="text-xs text-blue-700 mt-1">Nama: ${testData.nama_siswa}</p>
                <p class="text-xs text-blue-700">Kelas: ${testData.kelas}</p>
                <p class="text-xs text-blue-700">Status: ${testData.status}</p>
                <p class="text-xs text-blue-700">Waktu: ${testData.tanggal} ${testData.waktu}</p>
              </div>
              
              <div class="bg-green-50 p-3 rounded-lg mb-4 text-left">
                <p class="text-sm text-green-800"><strong>ğŸ“¡ Status Koneksi:</strong></p>
                <p class="text-xs text-green-700 mt-1">âœ… Request berhasil dikirim tanpa error</p>
                <p class="text-xs text-green-700">âœ… Mode: no-cors (sesuai implementasi produksi)</p>
                <p class="text-xs text-green-700">âœ… Tidak ada exception yang terjadi</p>
              </div>
              
              <div class="bg-yellow-50 p-3 rounded-lg mb-4 text-left">
                <p class="text-sm text-yellow-800"><strong>âœ… Verifikasi Manual:</strong></p>
                <ol class="text-xs text-yellow-700 mt-1 space-y-1 list-decimal list-inside">
                  <li><strong>Buka Google Sheets "Data Absensi Harian"</strong></li>
                  <li><strong>Cek baris terbaru</strong> - harus ada data dengan kelas "TEST"</li>
                  <li><strong>Jika ada data baru</strong> = Koneksi 100% berhasil! ğŸ‰</li>
                  <li><strong>Jika tidak ada</strong> = Cek deployment Apps Script</li>
                </ol>
              </div>
              
              <div class="bg-gray-50 p-3 rounded-lg mb-4 text-left">
                <p class="text-sm text-gray-800"><strong>â„¹ï¸ Catatan Teknis:</strong></p>
                <p class="text-xs text-gray-700 mt-1">Sistem menggunakan mode "no-cors" untuk kompatibilitas dengan Google Apps Script. Response detail tidak dapat dibaca, tapi tidak ada error berarti kemungkinan besar berhasil.</p>
              </div>
              
              <div class="flex gap-2">
                <button onclick="this.parentElement.parentElement.remove()" class="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all font-medium text-sm">
                  âœ… OK, Saya Cek Sheets
                </button>
                <button onclick="window.open('https://sheets.google.com', '_blank')" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all font-medium text-sm">
                  ğŸ”— Buka Google Sheets
                </button>
              </div>
            </div>
          `;
          document.body.appendChild(successDiv);
          
          console.log('âœ… Test completed successfully. No errors thrown.');
          console.log('ğŸ“‹ Please check your Google Sheets for the test data.');
          showToast('âœ… Test berhasil! Cek Google Sheets untuk memastikan data masuk.', 'success');
          
        } catch (error) {
          console.error('âŒ Test failed with error:', error);
          loadingDiv.remove();
          
          // Error dialog with detailed troubleshooting
          const errorDiv = document.createElement('div');
          errorDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
          errorDiv.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-lg mx-4 text-center shadow-2xl max-h-96 overflow-y-auto">
              <div class="text-6xl mb-4">âŒ</div>
              <h3 class="text-xl font-bold text-red-800 mb-2">Test Koneksi Gagal</h3>
              <p class="text-gray-600 mb-4">Terjadi error saat mengirim data ke Google Apps Script</p>
              
              <div class="bg-red-50 p-3 rounded-lg mb-4 text-left">
                <p class="text-sm text-red-800"><strong>âŒ Error Detail:</strong></p>
                <p class="text-xs text-red-700 mt-1 break-all">${error.message}</p>
                <p class="text-xs text-red-700 mt-1">Error Type: ${error.name}</p>
              </div>
              
              <div class="bg-yellow-50 p-3 rounded-lg mb-4 text-left">
                <p class="text-sm text-yellow-800"><strong>ğŸ”§ Kemungkinan Penyebab:</strong></p>
                <ol class="text-xs text-yellow-700 mt-1 space-y-1 list-decimal list-inside">
                  <li><strong>URL Apps Script salah</strong> atau tidak dapat diakses</li>
                  <li><strong>Apps Script belum di-deploy</strong> sebagai "Web app"</li>
                  <li><strong>Permission salah:</strong> Harus "Who has access: Anyone"</li>
                  <li><strong>Apps Script belum di-authorize</strong> dengan benar</li>
                  <li><strong>Network error:</strong> Koneksi internet bermasalah</li>
                  <li><strong>CORS policy:</strong> Browser memblokir request</li>
                </ol>
              </div>
              
              <div class="bg-blue-50 p-3 rounded-lg mb-4 text-left">
                <p class="text-sm text-blue-800"><strong>ğŸ”— URL yang digunakan:</strong></p>
                <p class="text-xs text-blue-700 mt-1 break-all">${attendanceSheetUrl}</p>
              </div>
              
              <div class="bg-gray-50 p-3 rounded-lg mb-4 text-left">
                <p class="text-sm text-gray-800"><strong>ğŸ’¡ Solusi Cepat:</strong></p>
                <ol class="text-xs text-gray-700 mt-1 space-y-1 list-decimal list-inside">
                  <li>Coba input absensi normal - jika berhasil, berarti koneksi OK</li>
                  <li>Buka Apps Script editor dan cek deployment</li>
                  <li>Re-deploy Apps Script dengan setting yang benar</li>
                  <li>Pastikan authorize semua permission yang diminta</li>
                </ol>
              </div>
              
              <div class="flex gap-2">
                <button onclick="this.parentElement.parentElement.remove()" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all font-medium text-sm">
                  OK
                </button>
                <button onclick="showPanduanPage(); this.parentElement.parentElement.remove();" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all font-medium text-sm">
                  Lihat Panduan
                </button>
              </div>
            </div>
          `;
          document.body.appendChild(errorDiv);
          
          showToast('âŒ Test gagal. Coba input absensi normal untuk memastikan.', 'error');
        }
      };
      
      // Initialize student data (fallback to sample data)
      loadSampleStudentData();
      updateStudentDataStatus(false);
      
      // Show login screen initially
      showLoginScreen();
    });
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'997114bf60cd5cec',t:'MTc2MTg5MTk4OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
