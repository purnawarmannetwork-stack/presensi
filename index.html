<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Absensi Multi-User</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    * {
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    
    .status-badge {
      transition: all 0.2s ease;
    }
    
    .status-badge:hover {
      transform: scale(1.05);
    }
    
    .card-hover {
      transition: all 0.3s ease;
    }
    
    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    
    .btn-primary {
      transition: all 0.2s ease;
    }
    
    .btn-primary:active {
      transform: scale(0.98);
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 9999;
      animation: slideIn 0.3s ease-out;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      max-width: 400px;
      word-wrap: break-word;
    }
    
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .loading-spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .role-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }
    
    .admin-badge {
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      color: white;
    }
    
    .kepsek-badge {
      background: linear-gradient(135deg, #4834d4, #686de0);
      color: white;
    }
    
    .guru-badge {
      background: linear-gradient(135deg, #00d2d3, #01a3a4);
      color: white;
    }
    
    .login-container {
      min-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .permission-denied {
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      margin: 16px 0;
      text-align: center;
      font-weight: 600;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="min-h-full"><!-- Login Screen -->
  <div id="login-screen" class="login-container">
   <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4">
    <div class="text-center mb-8">
     <div class="text-6xl mb-4">
      ğŸ«
     </div>
     <h1 id="login-title" class="text-3xl font-bold text-gray-800 mb-2">Sistem Absensi Online</h1>
     <p id="login-school" class="text-gray-600">SMP Purnawarman</p>
    </div>
    <form id="login-form" class="space-y-6">
     <div><label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label> <input type="text" id="username" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Masukkan username">
     </div>
     <div><label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password</label> <input type="password" id="password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Masukkan password">
     </div><button type="submit" id="login-btn" class="w-full btn-primary text-white font-bold py-4 px-6 rounded-lg shadow-lg hover:shadow-xl" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"> <span id="login-text">Masuk</span> </button>
    </form>
    <div class="mt-8 p-4 bg-gray-50 rounded-lg text-center">
     <p class="text-sm text-gray-600">Â© 2024 Copyright <span class="font-semibold text-gray-800">@irfanismailjamil</span></p>
     <p class="text-xs text-gray-500 mt-1">Sistem Absensi Online - All Rights Reserved</p>
    </div>
   </div>
  </div><!-- Main App -->
  <div id="main-app" class="min-h-full flex flex-col hidden" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><!-- Header -->
   <header class="bg-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4 py-6">
     <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div class="text-center md:text-left">
       <h1 id="app-title" class="text-3xl font-bold" style="color: #667eea;">Sistem Absensi Online</h1>
       <p id="school-name" class="text-gray-600 mt-2">SMP Purnawarman</p>
      </div>
      <div class="flex items-center gap-4">
       <div id="user-info" class="text-center md:text-right">
        <div id="user-role-badge" class="role-badge admin-badge mb-2">
         ğŸ‘¤ Admin
        </div>
        <p class="text-sm text-gray-600"><span id="current-time"></span> WIB</p>
       </div><button onclick="logout()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all font-medium"> ğŸšª Keluar </button>
      </div>
     </div><!-- Navigation Menu -->
     <div class="mt-6 border-t pt-4">
      <nav class="flex flex-wrap gap-2"><button onclick="showAbsensiPage()" id="nav-absensi" class="px-4 py-2 rounded-lg font-medium transition-all bg-blue-500 text-white"> ğŸ“ Absensi </button> <button onclick="showRekapPage()" id="nav-rekap" class="px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300"> ğŸ“Š Rekap Absensi </button> <button onclick="showPanduanPage()" id="nav-panduan" class="px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300"> ğŸ“š Panduan Input </button> <button onclick="showPengaturanPage()" id="nav-pengaturan" class="px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300"> âš™ï¸ Pengaturan </button>
      </nav>
     </div>
    </div>
   </header><!-- Main Content -->
   <main class="flex-1 max-w-7xl w-full mx-auto px-4 py-8"><!-- Absensi Page -->
    <div id="absensi-page"><!-- Stats Cards -->
     <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-8">
      <div class="bg-white rounded-lg shadow-md p-6 card-hover">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-500 text-sm">Total Siswa</p>
         <p id="total-students-count" class="text-2xl md:text-3xl font-bold" style="color: #667eea;">0</p>
        </div>
        <div class="text-3xl md:text-4xl">
         ğŸ‘¥
        </div>
       </div>
      </div>
      <div class="bg-white rounded-lg shadow-md p-6 card-hover">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-500 text-sm">Total Absensi</p>
         <p id="total-count" class="text-2xl md:text-3xl font-bold" style="color: #667eea;">0</p>
        </div>
        <div class="text-3xl md:text-4xl">
         ğŸ“Š
        </div>
       </div>
      </div>
      <div class="bg-white rounded-lg shadow-md p-6 card-hover">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-500 text-sm">Hadir</p>
         <p id="hadir-count" class="text-2xl md:text-3xl font-bold text-green-600">0</p>
        </div>
        <div class="text-3xl md:text-4xl">
         âœ…
        </div>
       </div>
      </div>
      <div class="bg-white rounded-lg shadow-md p-6 card-hover">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-500 text-sm">Izin</p>
         <p id="izin-count" class="text-2xl md:text-3xl font-bold text-yellow-600">0</p>
        </div>
        <div class="text-3xl md:text-4xl">
         ğŸ“
        </div>
       </div>
      </div>
      <div class="bg-white rounded-lg shadow-md p-6 card-hover">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-500 text-sm">Sakit</p>
         <p id="sakit-count" class="text-2xl md:text-3xl font-bold text-red-600">0</p>
        </div>
        <div class="text-3xl md:text-4xl">
         ğŸ¥
        </div>
       </div>
      </div>
      <div class="bg-white rounded-lg shadow-md p-6 card-hover">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-500 text-sm">Alpha</p>
         <p id="alpha-count" class="text-2xl md:text-3xl font-bold text-purple-600">0</p>
        </div>
        <div class="text-3xl md:text-4xl">
         âŒ
        </div>
       </div>
      </div>
     </div><!-- Form Absensi -->
     <div id="form-section" class="bg-white rounded-lg shadow-lg p-6 mb-8">
      <h2 class="text-2xl font-bold mb-6" style="color: #667eea;">ğŸ“ Input Absensi Per Kelas</h2><!-- Info Panel -->
      <div class="mb-6 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-400">
       <div class="flex items-start gap-3"><span class="text-blue-600 text-xl">â„¹ï¸</span>
        <div>
         <h3 class="text-lg font-bold text-blue-800 mb-2">Input Absensi Melalui Data Google Sheets</h3>
         <p class="text-blue-700 text-sm mb-2">Sistem ini menggunakan data siswa dari Google Sheets untuk memastikan konsistensi dan akurasi data.</p>
         <ul class="text-blue-700 text-sm space-y-1 list-disc list-inside">
          <li><strong>Pilih kelas</strong> dari dropdown di bawah untuk memuat daftar siswa</li>
          <li><strong>Data siswa</strong> diambil langsung dari Google Sheets "Data Siswa"</li>
          <li><strong>Untuk menambah siswa baru:</strong> Edit Google Sheets â†’ Klik "Muat Data Siswa" di Pengaturan</li>
         </ul>
        </div>
       </div>
      </div><!-- Filter Kelas untuk Form -->
      <div class="mb-6 p-4 bg-green-50 rounded-lg border-l-4 border-green-400">
       <h3 class="text-lg font-bold text-green-800 mb-3">ğŸ¯ Pilih Kelas untuk Absensi</h3>
       <div class="flex flex-col md:flex-row gap-4">
        <div class="flex-1"><label for="form-filter-kelas" class="block text-sm font-medium text-gray-700 mb-2">Kelas</label> <select id="form-filter-kelas" onchange="loadStudentsByClass()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"> <option value="">Pilih Kelas</option> <option value="VII A">VII A</option> <option value="VII B">VII B</option> <option value="VII C">VII C</option> <option value="VIII A">VIII A</option> <option value="VIII B">VIII B</option> <option value="VIII C">VIII C</option> <option value="IX A">IX A</option> <option value="IX B">IX B</option> <option value="IX C">IX C</option> </select>
        </div>
       </div>
      </div><!-- Student List for Attendance -->
      <div id="student-attendance-list" class="hidden mb-6">
       <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ‘¥ Daftar Siswa</h3>
       <div id="students-container" class="space-y-3 max-h-96 overflow-y-auto"><!-- Students will be loaded here -->
       </div>
       <div class="mt-4 flex gap-3"><button type="button" onclick="markAllPresent()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all font-medium text-sm"> âœ… Tandai Semua Hadir </button> <button type="button" onclick="saveAllAttendance()" class="px-6 py-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-all font-medium"> ğŸ’¾ Simpan Semua Absensi </button>
       </div>
      </div><!-- No Manual Input Message -->
      <div id="no-manual-input" class="text-center py-8 text-gray-400">
       <div class="text-6xl mb-4">
        ğŸ“‹
       </div>
       <p class="text-lg mb-2">Pilih kelas di atas untuk memulai input absensi</p>
       <p class="text-sm">Data siswa akan dimuat otomatis dari Google Sheets</p>
      </div>
     </div><!-- Filter Section -->
     <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
      <h2 class="text-2xl font-bold mb-4" style="color: #667eea;">ğŸ” Filter Data</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
       <div><label for="filter-kelas" class="block text-sm font-medium text-gray-700 mb-2">Filter Kelas</label> <select id="filter-kelas" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"> <option value="">Semua Kelas</option> </select>
       </div>
       <div><label for="filter-status" class="block text-sm font-medium text-gray-700 mb-2">Filter Status</label> <select id="filter-status" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"> <option value="">Semua Status</option> <option value="Hadir">Hadir</option> <option value="Izin">Izin</option> <option value="Sakit">Sakit</option> <option value="Alpha">Alpha</option> </select>
       </div>
       <div><label for="filter-tanggal" class="block text-sm font-medium text-gray-700 mb-2">Filter Tanggal</label> <input type="date" id="filter-tanggal" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
       </div>
       <div><label for="filter-user" class="block text-sm font-medium text-gray-700 mb-2">Input Oleh</label> <select id="filter-user" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"> <option value="">Semua User</option> </select>
       </div>
      </div>
     </div><!-- Data Absensi -->
     <div class="bg-white rounded-lg shadow-lg p-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
       <h2 class="text-2xl font-bold" style="color: #667eea;">ğŸ“‹ Data Absensi</h2>
       <div class="flex items-center gap-4">
        <div class="text-sm text-gray-600">
         Total: <span id="filtered-count" class="font-bold">0</span> data
        </div>
        <div id="export-section" class="hidden"><button onclick="exportToCSV()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all font-medium text-sm"> ğŸ“Š Export CSV </button>
        </div>
       </div>
      </div>
      <div id="absensi-list" class="space-y-4">
       <div class="text-center py-12 text-gray-400">
        <div class="text-6xl mb-4">
         ğŸ“
        </div>
        <p class="text-lg">Belum ada data absensi</p>
        <p class="text-sm mt-2">Mulai dengan memilih kelas dan input absensi di atas</p>
       </div>
      </div>
     </div>
    </div><!-- Panduan Page -->
    <div id="panduan-page" class="hidden">
     <div class="space-y-8"><!-- Panduan Lengkap Aplikasi -->
      <div class="bg-white rounded-lg shadow-lg p-6">
       <h2 class="text-2xl font-bold mb-6" style="color: #667eea;">ğŸ“š Panduan Lengkap Sistem Absensi Online</h2><!-- Login Section -->
       <div class="mb-8 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-400">
        <h3 class="text-xl font-bold text-blue-800 mb-4">ğŸ” 1. Login ke Sistem</h3>
        <div class="space-y-4">
         <div class="bg-white p-4 rounded-lg border border-blue-200">
          <h4 class="font-bold text-blue-700 mb-3">ğŸ“‹ Langkah Login:</h4>
          <ol class="list-decimal list-inside space-y-2 text-gray-700">
           <li>Buka aplikasi Sistem Absensi Online</li>
           <li>Masukkan <strong>Username</strong> dan <strong>Password</strong> sesuai role Anda</li>
           <li>Klik tombol <strong>"Masuk"</strong></li>
           <li>Sistem akan mengarahkan ke halaman utama sesuai hak akses</li>
          </ol>
         </div>
         <div class="bg-green-50 p-4 rounded-lg border border-green-200">
          <h4 class="font-bold text-green-700 mb-3">ğŸ‘¥ Akun Demo yang Tersedia:</h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
           <div class="bg-white p-3 rounded border">
            <h5 class="font-bold text-red-700">ğŸ‘‘ Admin</h5>
            <p class="text-sm text-gray-600">Username: <code>admin</code></p>
            <p class="text-sm text-gray-600">Password: <code>admin123</code></p>
            <p class="text-xs text-red-600 mt-1">Akses: Semua fitur</p>
           </div>
           <div class="bg-white p-3 rounded border">
            <h5 class="font-bold text-blue-700">ğŸ‘¨â€ğŸ« Guru Piket</h5>
            <p class="text-sm text-gray-600">Username: <code>guru</code></p>
            <p class="text-sm text-gray-600">Password: <code>guru123</code></p>
            <p class="text-xs text-blue-600 mt-1">Akses: Input &amp; Lihat Absensi</p>
           </div>
           <div class="bg-white p-3 rounded border">
            <h5 class="font-bold text-purple-700">ğŸ“ Kepala Sekolah</h5>
            <p class="text-sm text-gray-600">Username: <code>kepsek</code></p>
            <p class="text-sm text-gray-600">Password: <code>kepsek123</code></p>
            <p class="text-xs text-purple-600 mt-1">Akses: Hanya Lihat Data</p>
           </div>
          </div>
         </div>
        </div>
       </div><!-- Role & Permissions -->
       <div class="mb-8 p-4 bg-purple-50 rounded-lg border-l-4 border-purple-400">
        <h3 class="text-xl font-bold text-purple-800 mb-4">ğŸ‘¥ 2. Hak Akses Berdasarkan Role</h3>
        <div class="space-y-4">
         <div class="bg-white p-4 rounded-lg border border-purple-200">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
           <div class="border-l-4 border-red-400 pl-4">
            <h4 class="font-bold text-red-700 mb-2">ğŸ‘‘ Admin (Full Access)</h4>
            <ul class="text-sm text-gray-700 space-y-1">
             <li>âœ… Input Absensi</li>
             <li>âœ… Lihat &amp; Edit Data Absensi</li>
             <li>âœ… Hapus Data Absensi</li>
             <li>âœ… Export Data (CSV/Excel)</li>
             <li>âœ… Rekap Harian &amp; Bulanan</li>
             <li>âœ… Kelola User (Tambah/Hapus)</li>
             <li>âœ… Pengaturan Sistem</li>
             <li>âœ… Konfigurasi Google Sheets</li>
            </ul>
           </div>
           <div class="border-l-4 border-blue-400 pl-4">
            <h4 class="font-bold text-blue-700 mb-2">ğŸ‘¨â€ğŸ« Guru Piket</h4>
            <ul class="text-sm text-gray-700 space-y-1">
             <li>âœ… Input Absensi</li>
             <li>âœ… Lihat Data Absensi</li>
             <li>âœ… Rekap Harian &amp; Bulanan</li>
             <li>âœ… Panduan Aplikasi</li>
             <li>âŒ Hapus Data</li>
             <li>âŒ Export Data</li>
             <li>âŒ Kelola User</li>
             <li>âŒ Pengaturan Sistem</li>
            </ul>
           </div>
           <div class="border-l-4 border-purple-400 pl-4">
            <h4 class="font-bold text-purple-700 mb-2">ğŸ“ Kepala Sekolah</h4>
            <ul class="text-sm text-gray-700 space-y-1">
             <li>âœ… Lihat Data Absensi</li>
             <li>âœ… Rekap Harian &amp; Bulanan</li>
             <li>âœ… Export Data (CSV/Excel)</li>
             <li>âœ… Panduan Aplikasi</li>
             <li>âŒ Input Absensi</li>
             <li>âŒ Edit/Hapus Data</li>
             <li>âŒ Kelola User</li>
             <li>âŒ Pengaturan Sistem</li>
            </ul>
           </div>
          </div>
         </div>
        </div>
       </div><!-- Menu Navigation -->
       <div class="mb-8 p-4 bg-green-50 rounded-lg border-l-4 border-green-400">
        <h3 class="text-xl font-bold text-green-800 mb-4">ğŸ§­ 3. Navigasi Menu Aplikasi</h3>
        <div class="space-y-4">
         <div class="bg-white p-4 rounded-lg border border-green-200">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
           <div class="text-center p-3 bg-blue-50 rounded-lg">
            <div class="text-3xl mb-2">
             ğŸ“
            </div>
            <h4 class="font-bold text-blue-700">Absensi</h4>
            <p class="text-xs text-gray-600 mt-1">Input absensi harian per kelas</p>
           </div>
           <div class="text-center p-3 bg-green-50 rounded-lg">
            <div class="text-3xl mb-2">
             ğŸ“Š
            </div>
            <h4 class="font-bold text-green-700">Rekap Absensi</h4>
            <p class="text-xs text-gray-600 mt-1">Lihat rekap harian &amp; bulanan</p>
           </div>
           <div class="text-center p-3 bg-yellow-50 rounded-lg">
            <div class="text-3xl mb-2">
             ğŸ“š
            </div>
            <h4 class="font-bold text-yellow-700">Panduan Input</h4>
            <p class="text-xs text-gray-600 mt-1">Panduan lengkap aplikasi</p>
           </div>
           <div class="text-center p-3 bg-purple-50 rounded-lg">
            <div class="text-3xl mb-2">
             âš™ï¸
            </div>
            <h4 class="font-bold text-purple-700">Pengaturan</h4>
            <p class="text-xs text-gray-600 mt-1">Kelola user &amp; konfigurasi</p>
           </div>
          </div>
         </div>
        </div>
       </div><!-- Input Absensi Guide -->
       <div class="mb-8 p-4 bg-orange-50 rounded-lg border-l-4 border-orange-400">
        <h3 class="text-xl font-bold text-orange-800 mb-4">ğŸ“ 4. Cara Input Absensi (Admin &amp; Guru Piket)</h3>
        <div class="space-y-4">
         <div class="bg-white p-4 rounded-lg border border-orange-200">
          <h4 class="font-bold text-orange-700 mb-3">ğŸ“‹ Langkah-langkah Input Absensi:</h4>
          <ol class="list-decimal list-inside space-y-2 text-gray-700">
           <li>Klik menu <strong>"ğŸ“ Absensi"</strong> di navigasi atas</li>
           <li>Lihat statistik kehadiran di bagian atas (Total Siswa, Hadir, Izin, Sakit, Alpha)</li>
           <li>Di bagian <strong>"Pilih Kelas untuk Absensi"</strong>, pilih kelas dari dropdown</li>
           <li>Sistem akan menampilkan <strong>daftar semua siswa</strong> di kelas tersebut</li>
           <li>Untuk setiap siswa, pilih status kehadiran:</li>
           <ul class="list-disc list-inside ml-6 mt-1 text-sm text-gray-600">
            <li><strong>âœ… Hadir:</strong> Siswa hadir tepat waktu atau terlambat</li>
            <li><strong>ğŸ“ Izin:</strong> Siswa tidak hadir dengan surat izin</li>
            <li><strong>ğŸ¥ Sakit:</strong> Siswa tidak hadir karena sakit</li>
            <li><strong>âŒ Alpha:</strong> Siswa tidak hadir tanpa keterangan</li>
           </ul>
           <li>Tambahkan <strong>keterangan</strong> jika diperlukan (misal: "Terlambat 15 menit")</li>
           <li>Gunakan tombol <strong>"âœ… Tandai Semua Hadir"</strong> untuk efisiensi</li>
           <li>Klik <strong>"ğŸ’¾ Simpan Semua Absensi"</strong> untuk menyimpan ke database</li>
           <li>Data akan otomatis tersimpan ke Google Sheets (jika terhubung)</li>
          </ol>
         </div>
         <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
          <div class="flex items-start gap-3"><span class="text-yellow-600 text-xl">âš¡</span>
           <div>
            <h4 class="font-bold text-yellow-700 mb-2">Tips Input Cepat:</h4>
            <ul class="list-disc list-inside space-y-1 text-yellow-700 text-sm">
             <li>Klik <strong>"Tandai Semua Hadir"</strong> terlebih dahulu</li>
             <li>Ubah status siswa yang tidak hadir saja</li>
             <li>Pastikan semua siswa sudah dipilih statusnya sebelum menyimpan</li>
             <li>Sistem menggunakan <strong>batch processing</strong> untuk penyimpanan cepat</li>
             <li>Data tersimpan dengan tanggal dan waktu yang sama untuk satu kelas</li>
            </ul>
           </div>
          </div>
         </div>
        </div>
       </div><!-- View Data Guide -->
       <div class="mb-8 p-4 bg-indigo-50 rounded-lg border-l-4 border-indigo-400">
        <h3 class="text-xl font-bold text-indigo-800 mb-4">ğŸ‘€ 5. Cara Melihat Data Absensi (Semua Role)</h3>
        <div class="space-y-4">
         <div class="bg-white p-4 rounded-lg border border-indigo-200">
          <h4 class="font-bold text-indigo-700 mb-3">ğŸ“Š Melihat Data di Halaman Absensi:</h4>
          <ol class="list-decimal list-inside space-y-2 text-gray-700">
           <li>Di halaman <strong>"ğŸ“ Absensi"</strong>, scroll ke bawah ke bagian <strong>"Filter Data"</strong></li>
           <li>Gunakan filter untuk menyaring data:</li>
           <ul class="list-disc list-inside ml-6 mt-1 text-sm text-gray-600">
            <li><strong>Filter Kelas:</strong> Pilih kelas tertentu</li>
            <li><strong>Filter Status:</strong> Pilih status kehadiran (Hadir/Izin/Sakit/Alpha)</li>
            <li><strong>Filter Tanggal:</strong> Pilih tanggal tertentu</li>
            <li><strong>Input Oleh:</strong> Filter berdasarkan user yang input</li>
           </ul>
           <li>Data akan ditampilkan di bagian <strong>"Data Absensi"</strong></li>
           <li>Setiap data menampilkan: Nama siswa, kelas, status, tanggal, waktu, keterangan</li>
          </ol>
         </div>
         <div class="bg-white p-4 rounded-lg border border-indigo-200">
          <h4 class="font-bold text-indigo-700 mb-3">ğŸ“ˆ Melihat Rekap di Menu Rekap Absensi:</h4>
          <ol class="list-decimal list-inside space-y-2 text-gray-700">
           <li>Klik menu <strong>"ğŸ“Š Rekap Absensi"</strong></li>
           <li>Pilih jenis rekap:</li>
           <ul class="list-disc list-inside ml-6 mt-1 text-sm text-gray-600">
            <li><strong>ğŸ“… Rekap Harian:</strong> Pilih tanggal â†’ Klik "Generate Rekap"</li>
            <li><strong>ğŸ“Š Rekap Bulanan:</strong> Pilih bulan &amp; tahun â†’ Klik "Generate Rekap"</li>
           </ul>
           <li>Sistem akan menampilkan:</li>
           <ul class="list-disc list-inside ml-6 mt-1 text-sm text-gray-600">
            <li>Ringkasan total (Total, Hadir, Izin, Sakit, Alpha)</li>
            <li>Rekap per kelas dengan persentase kehadiran</li>
            <li>Analisis kehadiran per kelas</li>
           </ul>
           <li>Gunakan tombol <strong>"ğŸ“Š Export Excel"</strong> atau <strong>"ğŸ–¨ï¸ Print"</strong> untuk laporan</li>
          </ol>
         </div>
        </div>
       </div><!-- Admin Features -->
       <div class="mb-8 p-4 bg-red-50 rounded-lg border-l-4 border-red-400">
        <h3 class="text-xl font-bold text-red-800 mb-4">ğŸ‘‘ 6. Fitur Khusus Admin</h3>
        <div class="space-y-4">
         <div class="bg-white p-4 rounded-lg border border-red-200">
          <h4 class="font-bold text-red-700 mb-3">ğŸ‘¥ Kelola User:</h4>
          <ol class="list-decimal list-inside space-y-2 text-gray-700">
           <li>Buka menu <strong>"âš™ï¸ Pengaturan"</strong></li>
           <li>Di bagian <strong>"Manajemen User"</strong>:</li>
           <ul class="list-disc list-inside ml-6 mt-1 text-sm text-gray-600">
            <li>Isi form <strong>"Tambah User Baru"</strong> (Username, Password, Role)</li>
            <li>Klik <strong>"Tambah User"</strong></li>
            <li>User baru akan muncul di <strong>"Daftar User"</strong></li>
            <li>Klik <strong>"ğŸ—‘ï¸ Hapus"</strong> untuk menghapus user (kecuali akun sendiri)</li>
           </ul>
          </ol>
         </div>
         <div class="bg-white p-4 rounded-lg border border-red-200">
          <h4 class="font-bold text-red-700 mb-3">ğŸ—‘ï¸ Hapus Data Absensi:</h4>
          <ol class="list-decimal list-inside space-y-2 text-gray-700">
           <li>Di halaman <strong>"ğŸ“ Absensi"</strong>, cari data yang ingin dihapus</li>
           <li>Klik tombol <strong>"ğŸ—‘ï¸ Hapus"</strong> pada data tersebut</li>
           <li>Klik <strong>"âœ”ï¸ Konfirmasi Hapus"</strong> untuk menghapus permanen</li>
           <li>Data akan terhapus dari database dan Google Sheets</li>
          </ol>
         </div>
         <div class="bg-white p-4 rounded-lg border border-red-200">
          <h4 class="font-bold text-red-700 mb-3">ğŸ“Š Konfigurasi Google Sheets:</h4>
          <ol class="list-decimal list-inside space-y-2 text-gray-700">
           <li>Di menu <strong>"âš™ï¸ Pengaturan"</strong>, scroll ke <strong>"Konfigurasi Data Siswa"</strong></li>
           <li>Masukkan URL Google Apps Script untuk data siswa</li>
           <li>Klik <strong>"ğŸ’¾ Simpan URL"</strong> dan <strong>"ğŸ”„ Muat Data Siswa"</strong></li>
           <li>Di bagian <strong>"Konfigurasi Google Sheets Absensi"</strong>:</li>
           <ul class="list-disc list-inside ml-6 mt-1 text-sm text-gray-600">
            <li>Masukkan URL Google Apps Script untuk data absensi</li>
            <li>Klik <strong>"ğŸ’¾ Simpan URL Absensi"</strong></li>
            <li>Klik <strong>"ğŸ§ª Test Koneksi"</strong> untuk memastikan koneksi berhasil</li>
           </ul>
          </ol>
         </div>
        </div>
       </div><!-- Data Management -->
       <div class="mb-8 p-4 bg-teal-50 rounded-lg border-l-4 border-teal-400">
        <h3 class="text-xl font-bold text-teal-800 mb-4">ğŸ“Š 7. Pengelolaan Data Siswa</h3>
        <div class="space-y-4">
         <div class="bg-white p-4 rounded-lg border border-teal-200">
          <h4 class="font-bold text-teal-700 mb-3">ğŸ“‹ Data Siswa Saat Ini:</h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
           <div class="bg-teal-50 p-3 rounded border">
            <h5 class="font-bold text-teal-700">ğŸ“ Kelas VII</h5>
            <p class="text-sm">VII A, VII B, VII C</p>
            <p class="text-xs text-teal-600">15 siswa per kelas = 45 siswa</p>
           </div>
           <div class="bg-teal-50 p-3 rounded border">
            <h5 class="font-bold text-teal-700">ğŸ“ Kelas VIII</h5>
            <p class="text-sm">VIII A, VIII B, VIII C</p>
            <p class="text-xs text-teal-600">15 siswa per kelas = 45 siswa</p>
           </div>
           <div class="bg-teal-50 p-3 rounded border">
            <h5 class="font-bold text-teal-700">ğŸ“ Kelas IX</h5>
            <p class="text-sm">IX A, IX B, IX C</p>
            <p class="text-xs text-teal-600">15 siswa per kelas = 45 siswa</p>
           </div>
          </div>
          <div class="mt-3 p-2 bg-teal-100 rounded text-center">
           <p class="text-teal-800 font-medium">Total: 135 siswa dari 9 kelas</p>
          </div>
         </div>
         <div class="bg-white p-4 rounded-lg border border-teal-200">
          <h4 class="font-bold text-teal-700 mb-3">â• Menambah Siswa Baru (Admin):</h4>
          <ol class="list-decimal list-inside space-y-2 text-gray-700">
           <li>Buka <strong>Google Sheets "Data Siswa"</strong> yang sudah dikonfigurasi</li>
           <li>Tambahkan baris baru dengan format:</li>
           <ul class="list-disc list-inside ml-6 mt-1 text-sm text-gray-600">
            <li><strong>Kolom A:</strong> Nama Siswa (contoh: "Ahmad Rizki Pratama")</li>
            <li><strong>Kolom B:</strong> Kelas (contoh: "VII A", "VIII B", "IX C")</li>
            <li><strong>Kolom C:</strong> NIS - opsional (contoh: "2024001")</li>
            <li><strong>Kolom D:</strong> Jenis Kelamin (L atau P)</li>
           </ul>
           <li>Simpan perubahan di Google Sheets</li>
           <li>Kembali ke aplikasi â†’ Menu <strong>"âš™ï¸ Pengaturan"</strong></li>
           <li>Klik tombol <strong>"ğŸ”„ Muat Data Siswa"</strong></li>
           <li>Data siswa baru akan muncul di dropdown kelas</li>
          </ol>
         </div>
        </div>
       </div><!-- Best Practices -->
       <div class="p-4 bg-gray-50 rounded-lg border-l-4 border-gray-400">
        <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ’¡ 8. Tips &amp; Best Practices</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
         <div>
          <h4 class="font-bold text-gray-700 mb-3">â° Waktu Input Absensi:</h4>
          <ul class="list-disc list-inside space-y-1 text-gray-700 text-sm">
           <li>Input absensi di awal jam pelajaran pertama (07:30-08:00)</li>
           <li>Update jika ada siswa datang terlambat</li>
           <li>Pastikan semua kelas sudah terinput sebelum jam 10:00</li>
           <li>Lakukan pengecekan ulang di akhir hari</li>
          </ul>
         </div>
         <div>
          <h4 class="font-bold text-gray-700 mb-3">ğŸ“ Penulisan Keterangan:</h4>
          <ul class="list-disc list-inside space-y-1 text-gray-700 text-sm">
           <li>Tulis waktu keterlambatan: "Terlambat 15 menit"</li>
           <li>Catat alasan izin: "Keperluan keluarga", "Acara keluarga"</li>
           <li>Untuk sakit: "Demam", "Flu", "Sakit perut"</li>
           <li>Alpha: "Tidak ada kabar", "Bolos"</li>
          </ul>
         </div>
         <div>
          <h4 class="font-bold text-gray-700 mb-3">ğŸ”„ Konsistensi Data:</h4>
          <ul class="list-disc list-inside space-y-1 text-gray-700 text-sm">
           <li>Gunakan format kelas yang konsisten (VII A, bukan 7A)</li>
           <li>Input data setiap hari tanpa terlewat</li>
           <li>Backup data secara berkala melalui export</li>
           <li>Koordinasi antar guru piket untuk konsistensi</li>
          </ul>
         </div>
         <div>
          <h4 class="font-bold text-gray-700 mb-3">ğŸ“Š Monitoring &amp; Laporan:</h4>
          <ul class="list-disc list-inside space-y-1 text-gray-700 text-sm">
           <li>Cek rekap harian setiap hari di menu "Rekap Absensi"</li>
           <li>Buat rekap bulanan untuk laporan ke kepala sekolah</li>
           <li>Monitor siswa dengan tingkat alpha tinggi</li>
           <li>Export data untuk arsip dan backup</li>
          </ul>
         </div>
        </div>
       </div><!-- Quick Access Buttons -->
       <div class="mt-8 flex flex-wrap gap-4 justify-center"><button onclick="showAbsensiPage()" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all font-medium shadow-lg"> ğŸ“ Mulai Input Absensi </button> <button onclick="showRekapPage()" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all font-medium shadow-lg"> ğŸ“Š Lihat Rekap Data </button>
        <div id="panduan-pengaturan-btn"><button onclick="showPengaturanPage()" class="px-6 py-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-all font-medium shadow-lg"> âš™ï¸ Pengaturan Sistem </button>
        </div>
       </div>
      </div>
     </div>
    </div><!-- Rekap Page -->
    <div id="rekap-page" class="hidden">
     <div class="space-y-8"><!-- Rekap Navigation -->
      <div class="bg-white rounded-lg shadow-lg p-6">
       <h2 class="text-2xl font-bold mb-6" style="color: #667eea;">ğŸ“Š Rekap Absensi</h2><!-- Rekap Type Selector -->
       <div class="flex flex-wrap gap-2 mb-6"><button onclick="showRekapHarian()" id="rekap-nav-harian" class="px-4 py-2 rounded-lg font-medium transition-all bg-blue-500 text-white"> ğŸ“… Rekap Harian </button> <button onclick="showRekapBulanan()" id="rekap-nav-bulanan" class="px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300"> ğŸ“Š Rekap Bulanan </button>
       </div><!-- Rekap Harian Section -->
       <div id="rekap-harian-section">
        <div class="mb-6 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-400">
         <h3 class="text-lg font-bold text-blue-800 mb-3">ğŸ“… Pilih Tanggal Rekap</h3>
         <div class="flex flex-col md:flex-row gap-4">
          <div class="flex-1"><label for="rekap-tanggal" class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label> <input type="date" id="rekap-tanggal" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
          </div>
          <div class="flex items-end"><button type="button" onclick="generateRekapByDate()" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all font-medium"> ğŸ“Š Generate Rekap </button>
          </div>
         </div>
        </div>
       </div><!-- Rekap Bulanan Section -->
       <div id="rekap-bulanan-section" class="hidden">
        <div class="mb-6 p-4 bg-green-50 rounded-lg border-l-4 border-green-400">
         <h3 class="text-lg font-bold text-green-800 mb-3">ğŸ“Š Pilih Bulan &amp; Tahun Rekap</h3>
         <div class="flex flex-col md:flex-row gap-4">
          <div class="flex-1"><label for="rekap-bulan" class="block text-sm font-medium text-gray-700 mb-2">Bulan</label> <select id="rekap-bulan" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"> <option value="01">Januari</option> <option value="02">Februari</option> <option value="03">Maret</option> <option value="04">April</option> <option value="05">Mei</option> <option value="06">Juni</option> <option value="07">Juli</option> <option value="08">Agustus</option> <option value="09">September</option> <option value="10">Oktober</option> <option value="11">November</option> <option value="12">Desember</option> </select>
          </div>
          <div class="flex-1"><label for="rekap-tahun" class="block text-sm font-medium text-gray-700 mb-2">Tahun</label> <select id="rekap-tahun" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"> <option value="2024">2024</option> <option value="2025">2025</option> <option value="2026">2026</option> </select>
          </div>
          <div class="flex items-end"><button type="button" onclick="generateRekapBulanan()" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all font-medium"> ğŸ“Š Generate Rekap </button>
          </div>
         </div>
        </div>
       </div><!-- Rekap Results -->
       <div id="rekap-results">
        <div class="text-center py-12 text-gray-400">
         <div class="text-6xl mb-4">
          ğŸ“Š
         </div>
         <p class="text-lg">Pilih tanggal atau bulan untuk melihat rekap absensi</p>
         <p class="text-sm mt-2">Rekap akan menampilkan statistik lengkap per kelas</p>
        </div>
       </div>
      </div>
     </div>
    </div><!-- Pengaturan Page -->
    <div id="pengaturan-page" class="hidden">
     <div class="space-y-8"><!-- Manajemen User -->
      <div class="bg-white rounded-lg shadow-lg p-6">
       <h2 class="text-2xl font-bold mb-6" style="color: #667eea;">ğŸ‘¥ Manajemen User</h2><!-- Add User Form (Admin Only) -->
       <div id="add-user-section" class="mb-8 p-4 bg-gray-50 rounded-lg">
        <h3 class="text-lg font-bold mb-4 text-gray-800">â• Tambah User Baru</h3>
        <form id="add-user-form" class="space-y-4">
         <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div><label for="new-nama-user" class="block text-sm font-medium text-gray-700 mb-2">Nama User</label> <input type="text" id="new-nama-user" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Nama lengkap user">
          </div>
          <div><label for="new-username" class="block text-sm font-medium text-gray-700 mb-2">Username</label> <input type="text" id="new-username" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Username login">
          </div>
          <div><label for="new-password" class="block text-sm font-medium text-gray-700 mb-2">Password</label> <input type="password" id="new-password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Password">
          </div>
         </div>
         <div><label for="new-role" class="block text-sm font-medium text-gray-700 mb-2">Role</label> <select id="new-role" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"> <option value="">Pilih Role</option> <option value="Admin">Admin</option> <option value="Kepala Sekolah">Kepala Sekolah</option> <option value="Guru Piket">Guru Piket</option> </select>
         </div><button type="submit" id="add-user-btn" class="w-full btn-primary text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"> <span id="add-user-text">Tambah User</span> </button>
        </form>
       </div><!-- User List -->
       <div>
        <h3 class="text-lg font-bold mb-4 text-gray-800">ğŸ“‹ Daftar User</h3>
        <div id="user-list" class="space-y-3"><!-- User items will be populated here -->
        </div>
       </div>
      </div><!-- Student Data Configuration -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
       <h2 class="text-2xl font-bold mb-6" style="color: #667eea;">ğŸ‘¥ Konfigurasi Data Siswa</h2>
       <div class="space-y-6"><!-- Current Status -->
        <div id="student-data-status" class="p-4 rounded-lg border-l-4">
         <div class="flex items-center gap-3"><span class="text-2xl">ğŸ“‹</span>
          <div>
           <h3 class="font-bold text-gray-800">Status Data Siswa</h3>
           <p class="text-gray-600 text-sm">Menggunakan data sample - belum terhubung ke Google Sheets</p>
          </div>
         </div>
        </div><!-- URL Configuration -->
        <div class="bg-blue-50 p-6 rounded-lg border border-blue-200">
         <h3 class="text-lg font-bold text-blue-800 mb-4">ğŸ”— Hubungkan ke Google Sheets Data Siswa</h3>
         <form id="student-data-form" class="space-y-4">
          <div><label for="student-data-url" class="block text-sm font-medium text-gray-700 mb-2">URL Google Apps Script (Data Siswa)</label> <input type="url" id="student-data-url" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec">
          </div>
          <div class="flex gap-3"><button type="submit" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all font-medium"> ğŸ”„ Muat Data Siswa </button> <button type="button" onclick="saveStudentDataUrl()" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all font-medium"> ğŸ’¾ Simpan URL </button> <button type="button" onclick="loadSampleStudentData()" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-all font-medium"> ğŸ“‹ Gunakan Data Sample </button>
          </div>
         </form>
         <div class="mt-4 p-3 bg-yellow-100 border border-yellow-300 rounded-lg">
          <div class="flex items-start gap-2"><span class="text-yellow-600 text-lg">ğŸ’¡</span>
           <div class="text-yellow-800 text-sm"><strong>Tips:</strong> Buat Google Sheets terpisah untuk data siswa dan data absensi. Data siswa hanya perlu dibuat sekali di awal tahun ajaran. URL akan tersimpan otomatis setelah disimpan.
           </div>
          </div>
         </div>
        </div>
       </div>
      </div><!-- Attendance Sheets Configuration -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
       <h2 class="text-2xl font-bold mb-6" style="color: #667eea;">ğŸ“Š Konfigurasi Google Sheets Absensi</h2>
       <div class="space-y-4"><!-- Current Attendance Sheets Status -->
        <div id="attendance-sheets-status" class="p-4 rounded-lg border-l-4 border-l-green-400 bg-green-50">
         <div class="flex items-center gap-3"><span class="text-2xl">âœ…</span>
          <div>
           <h3 class="font-bold text-green-800">Google Sheets Absensi Terhubung</h3>
           <p class="text-green-600 text-sm">Setiap data absensi otomatis tersimpan ke Google Sheets</p>
           <p class="text-green-500 text-xs mt-1 break-all" id="current-attendance-url">https://script.google.com/macros/s/AKfycbwTFf2vKfXdQz3CWLnj1Cm2Qo53iz_8aB0rdkZ7403og5pLcUe6l8xft1LBbPj1BNBi/exec</p>
          </div>
         </div>
        </div><!-- URL Configuration Form -->
        <div class="bg-purple-50 p-6 rounded-lg border border-purple-200">
         <h3 class="text-lg font-bold text-purple-800 mb-4">ğŸ”§ Update URL Google Apps Script Absensi</h3>
         <form id="attendance-url-form" class="space-y-4">
          <div><label for="attendance-data-url" class="block text-sm font-medium text-gray-700 mb-2">URL Google Apps Script (Data Absensi)</label> <input type="url" id="attendance-data-url" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec">
          </div>
          <div class="flex gap-3"><button type="button" onclick="saveAttendanceUrl()" class="px-6 py-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-all font-medium"> ğŸ’¾ Simpan URL Absensi </button> <button type="button" onclick="testGoogleSheetsConnection()" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all font-medium"> ğŸ§ª Test Koneksi </button>
          </div>
         </form>
         <div class="mt-4 p-3 bg-yellow-100 border border-yellow-300 rounded-lg">
          <div class="flex items-start gap-2"><span class="text-yellow-600 text-lg">ğŸ’¡</span>
           <div class="text-yellow-800 text-sm"><strong>Catatan:</strong> URL Apps Script untuk absensi berbeda dengan URL untuk data siswa. Pastikan menggunakan URL yang benar untuk setiap fungsi. URL akan tersimpan otomatis.
           </div>
          </div>
         </div>
        </div>
       </div>
      </div><!-- Google Sheets Integration Guide -->
      <div class="bg-white rounded-lg shadow-lg p-6">
       <h2 class="text-2xl font-bold mb-6" style="color: #667eea;">ğŸ“Š Panduan Integrasi Google Sheets</h2>
       <div class="space-y-8"><!-- Step 1: Create Spreadsheets -->
        <div class="border-2 border-green-200 rounded-lg p-6">
         <h3 class="text-xl font-bold text-green-800 mb-4">1ï¸âƒ£ Buat 2 Google Spreadsheet Terpisah</h3>
         <div class="space-y-6"><!-- Student Data Spreadsheet -->
          <div class="border-l-4 border-blue-400 pl-4">
           <h4 class="text-lg font-bold text-blue-800 mb-2">ğŸ“š Spreadsheet 1: Data Siswa</h4>
           <ol class="list-decimal list-inside text-gray-700 space-y-2 mb-3">
            <li>Buka <a href="https://sheets.google.com" target="_blank" rel="noopener noreferrer" class="text-blue-600 underline font-medium">Google Sheets</a></li>
            <li>Klik tombol <strong>"+ Blank"</strong> untuk membuat spreadsheet baru</li>
            <li>Rename file menjadi <strong>"Data Siswa Sekolah"</strong></li>
            <li>Buat struktur header sesuai tabel di bawah</li>
           </ol><!-- Student Data Table Structure -->
           <div class="bg-blue-50 p-4 rounded-lg mt-3">
            <h5 class="font-bold text-blue-800 mb-3">ğŸ“Š Struktur Tabel Data Siswa:</h5>
            <div class="overflow-x-auto">
             <table class="w-full border-collapse border border-gray-300 text-sm">
              <thead>
               <tr class="bg-blue-100">
                <th class="border border-gray-300 px-3 py-2 text-left">Kolom</th>
                <th class="border border-gray-300 px-3 py-2 text-left">Header</th>
                <th class="border border-gray-300 px-3 py-2 text-left">Contoh Data</th>
                <th class="border border-gray-300 px-3 py-2 text-left">Keterangan</th>
               </tr>
              </thead>
              <tbody>
               <tr>
                <td class="border border-gray-300 px-3 py-2 font-mono">A1</td>
                <td class="border border-gray-300 px-3 py-2 font-bold">Nama Siswa</td>
                <td class="border border-gray-300 px-3 py-2">Ahmad Rizki Pratama</td>
                <td class="border border-gray-300 px-3 py-2">Nama lengkap siswa</td>
               </tr>
               <tr class="bg-gray-50">
                <td class="border border-gray-300 px-3 py-2 font-mono">B1</td>
                <td class="border border-gray-300 px-3 py-2 font-bold">Kelas</td>
                <td class="border border-gray-300 px-3 py-2">VII A</td>
                <td class="border border-gray-300 px-3 py-2">Kelas siswa (VII A, VII B, VIII A, dst.)</td>
               </tr>
               <tr>
                <td class="border border-gray-300 px-3 py-2 font-mono">C1</td>
                <td class="border border-gray-300 px-3 py-2 font-bold">NIS</td>
                <td class="border border-gray-300 px-3 py-2">2024001</td>
                <td class="border border-gray-300 px-3 py-2">Nomor Induk Siswa (opsional)</td>
               </tr>
               <tr class="bg-gray-50">
                <td class="border border-gray-300 px-3 py-2 font-mono">D1</td>
                <td class="border border-gray-300 px-3 py-2 font-bold">Jenis Kelamin</td>
                <td class="border border-gray-300 px-3 py-2">L</td>
                <td class="border border-gray-300 px-3 py-2">L untuk Laki-laki, P untuk Perempuan</td>
               </tr>
              </tbody>
             </table>
            </div>
            <div class="mt-3 p-3 bg-yellow-100 border border-yellow-300 rounded">
             <p class="text-yellow-800 text-sm"><strong>ğŸ’¡ Tips:</strong> Isi data siswa sekali di awal tahun ajaran. Data ini akan digunakan untuk memuat daftar siswa per kelas secara otomatis.</p>
            </div>
           </div>
          </div><!-- Attendance Data Spreadsheet -->
          <div class="border-l-4 border-green-400 pl-4">
           <h4 class="text-lg font-bold text-green-800 mb-2">ğŸ“ Spreadsheet 2: Data Absensi</h4>
           <ol class="list-decimal list-inside text-gray-700 space-y-2 mb-3">
            <li>Buat spreadsheet baru lagi</li>
            <li>Rename file menjadi <strong>"Data Absensi Harian"</strong></li>
            <li>Buat struktur header sesuai tabel di bawah</li>
            <li>Spreadsheet ini akan otomatis terisi saat input absensi</li>
           </ol><!-- Attendance Data Table Structure -->
           <div class="bg-green-50 p-4 rounded-lg mt-3">
            <h5 class="font-bold text-green-800 mb-3">ğŸ“Š Struktur Tabel Data Absensi:</h5>
            <div class="overflow-x-auto">
             <table class="w-full border-collapse border border-gray-300 text-sm">
              <thead>
               <tr class="bg-green-100">
                <th class="border border-gray-300 px-3 py-2 text-left">Kolom</th>
                <th class="border border-gray-300 px-3 py-2 text-left">Header</th>
                <th class="border border-gray-300 px-3 py-2 text-left">Contoh Data</th>
                <th class="border border-gray-300 px-3 py-2 text-left">Keterangan</th>
               </tr>
              </thead>
              <tbody>
               <tr>
                <td class="border border-gray-300 px-3 py-2 font-mono">A1</td>
                <td class="border border-gray-300 px-3 py-2 font-bold">Nama Siswa</td>
                <td class="border border-gray-300 px-3 py-2">Ahmad Rizki Pratama</td>
                <td class="border border-gray-300 px-3 py-2">Nama lengkap siswa</td>
               </tr>
               <tr class="bg-gray-50">
                <td class="border border-gray-300 px-3 py-2 font-mono">B1</td>
                <td class="border border-gray-300 px-3 py-2 font-bold">Kelas</td>
                <td class="border border-gray-300 px-3 py-2">VII A</td>
                <td class="border border-gray-300 px-3 py-2">Kelas siswa</td>
               </tr>
               <tr>
                <td class="border border-gray-300 px-3 py-2 font-mono">C1</td>
                <td class="border border-gray-300 px-3 py-2 font-bold">Status</td>
                <td class="border border-gray-300 px-3 py-2">Hadir</td>
                <td class="border border-gray-300 px-3 py-2">Hadir/Izin/Sakit/Alpha</td>
               </tr>
               <tr class="bg-gray-50">
                <td class="border border-gray-300 px-3 py-2 font-mono">D1</td>
                <td class="border border-gray-300 px-3 py-2 font-bold">Tanggal</td>
                <td class="border border-gray-300 px-3 py-2">2024-01-15</td>
                <td class="border border-gray-300 px-3 py-2">Format: YYYY-MM-DD</td>
               </tr>
               <tr>
                <td class="border border-gray-300 px-3 py-2 font-mono">E1</td>
                <td class="border border-gray-300 px-3 py-2 font-bold">Waktu</td>
                <td class="border border-gray-300 px-3 py-2">08:30</td>
                <td class="border border-gray-300 px-3 py-2">Format: HH:MM</td>
               </tr>
               <tr class="bg-gray-50">
                <td class="border border-gray-300 px-3 py-2 font-mono">F1</td>
                <td class="border border-gray-300 px-3 py-2 font-bold">Keterangan</td>
                <td class="border border-gray-300 px-3 py-2">Terlambat 5 menit</td>
                <td class="border border-gray-300 px-3 py-2">Catatan tambahan (opsional)</td>
               </tr>
               <tr>
                <td class="border border-gray-300 px-3 py-2 font-mono">G1</td>
                <td class="border border-gray-300 px-3 py-2 font-bold">Input Oleh</td>
                <td class="border border-gray-300 px-3 py-2">admin</td>
                <td class="border border-gray-300 px-3 py-2">Username yang input data</td>
               </tr>
               <tr class="bg-gray-50">
                <td class="border border-gray-300 px-3 py-2 font-mono">H1</td>
                <td class="border border-gray-300 px-3 py-2 font-bold">Role</td>
                <td class="border border-gray-300 px-3 py-2">Admin</td>
                <td class="border border-gray-300 px-3 py-2">Role user yang input</td>
               </tr>
              </tbody>
             </table>
            </div>
           </div>
          </div>
         </div>
        </div><!-- Step 2: Apps Script Setup -->
        <div class="border-2 border-purple-200 rounded-lg p-6">
         <h3 class="text-xl font-bold text-purple-800 mb-4">2ï¸âƒ£ Setup Google Apps Script (2 Script Terpisah)</h3>
         <div class="space-y-6"><!-- Student Data Apps Script -->
          <div class="border-l-4 border-blue-400 pl-4">
           <h4 class="text-lg font-bold text-blue-800 mb-2">ğŸ“š Apps Script untuk Data Siswa</h4>
           <ol class="list-decimal list-inside text-gray-700 space-y-2 mb-3">
            <li>Buka spreadsheet <strong>"Data Siswa Sekolah"</strong></li>
            <li>Klik menu <strong>"Extensions"</strong> â†’ <strong>"Apps Script"</strong></li>
            <li>Hapus semua kode default yang ada</li>
            <li>Copy dan paste kode <strong>"Student Data Script"</strong> di bawah ini</li>
            <li>Klik <strong>"Save"</strong> dan beri nama project <strong>"Student Data API"</strong></li>
            <li>Deploy sebagai Web app dengan akses <strong>"Anyone"</strong></li>
            <li><strong>PENTING:</strong> Copy URL untuk konfigurasi data siswa</li>
           </ol><!-- Student Data Apps Script Code -->
           <div class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm overflow-x-auto mt-3">
            <div class="flex justify-between items-center mb-2"><span class="text-gray-400">ğŸ“„ Student Data Script - Copy ke Apps Script Data Siswa</span> <button onclick="copyStudentDataScript()" class="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700"> ğŸ“‹ Copy Code </button>
            </div>
            <pre id="student-data-script">function doGet(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    const data = sheet.getDataRange().getValues();
    
    if (data.length &lt;= 1) {
      return ContentService
        .createTextOutput(JSON.stringify([]))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    const headers = data[0];
    const rows = data.slice(1);
    
    const result = rows.map(row =&gt; {
      const obj = {};
      headers.forEach((header, index) =&gt; {
        // Convert header to lowercase with underscores
        const key = header.toLowerCase().replace(/\s+/g, '_');
        obj[key] = row[index] || '';
      });
      return obj;
    });
    
    return ContentService
      .createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({error: error.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// Optional: Function to add new student (if needed)
function doPost(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    const data = JSON.parse(e.postData.contents);
    
    // Add new student data
    sheet.appendRow([
      data.nama_siswa || '',
      data.kelas || '',
      data.nis || '',
      data.jenis_kelamin || ''
    ]);
    
    return ContentService
      .createTextOutput(JSON.stringify({success: true}))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({success: false, error: error.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}</pre>
           </div>
          </div><!-- Attendance Data Apps Script -->
          <div class="border-l-4 border-green-400 pl-4">
           <h4 class="text-lg font-bold text-green-800 mb-2">ğŸ“ Apps Script untuk Data Absensi</h4>
           <ol class="list-decimal list-inside text-gray-700 space-y-2 mb-3">
            <li>Buka spreadsheet <strong>"Data Absensi Harian"</strong></li>
            <li>Klik menu <strong>"Extensions"</strong> â†’ <strong>"Apps Script"</strong></li>
            <li>Hapus semua kode default yang ada</li>
            <li>Copy dan paste kode <strong>"Attendance Script"</strong> di bawah ini</li>
            <li>Klik <strong>"Save"</strong> dan beri nama project <strong>"Attendance API"</strong></li>
            <li>Deploy sebagai Web app dengan akses <strong>"Anyone"</strong></li>
            <li><strong>PENTING:</strong> URL ini akan otomatis digunakan sistem absensi</li>
           </ol><!-- Attendance Apps Script Code -->
           <div class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm overflow-x-auto mt-3">
            <div class="flex justify-between items-center mb-2"><span class="text-gray-400">ğŸ“„ Attendance Script - Copy ke Apps Script Data Absensi (Optimized)</span> <button onclick="copyAttendanceScript()" class="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700"> ğŸ“‹ Copy Code </button>
            </div>
            <pre id="attendance-script">function doPost(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    const requestData = JSON.parse(e.postData.contents);
    
    // Check if this is a batch request (multiple records)
    if (requestData.batch &amp;&amp; Array.isArray(requestData.data)) {
      // Batch processing for faster performance
      const rows = requestData.data.map(data =&gt; [
        data.nama_siswa || '',
        data.kelas || '',
        data.status || '',
        data.tanggal || '',
        data.waktu || '',
        data.keterangan || '',
        data.input_by || '',
        data.user_role || ''
      ]);
      
      // Use batch append for much faster performance
      if (rows.length &gt; 0) {
        const range = sheet.getRange(sheet.getLastRow() + 1, 1, rows.length, 8);
        range.setValues(rows);
      }
      
      return ContentService
        .createTextOutput(JSON.stringify({
          success: true, 
          processed: rows.length,
          message: `Batch processed ${rows.length} records successfully`
        }))
        .setMimeType(ContentService.MimeType.JSON);
        
    } else {
      // Single record processing (backward compatibility)
      sheet.appendRow([
        requestData.nama_siswa || '',
        requestData.kelas || '',
        requestData.status || '',
        requestData.tanggal || '',
        requestData.waktu || '',
        requestData.keterangan || '',
        requestData.input_by || '',
        requestData.user_role || ''
      ]);
      
      return ContentService
        .createTextOutput(JSON.stringify({success: true}))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false, 
        error: error.toString(),
        timestamp: new Date().toISOString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    
    // Use more efficient data retrieval
    const lastRow = sheet.getLastRow();
    if (lastRow &lt;= 1) {
      return ContentService
        .createTextOutput(JSON.stringify([]))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // Get data in one operation for better performance
    const range = sheet.getRange(1, 1, lastRow, sheet.getLastColumn());
    const data = range.getValues();
    
    const headers = data[0];
    const rows = data.slice(1);
    
    // Optimize object creation
    const result = rows.map(row =&gt; {
      const obj = {};
      for (let i = 0; i &lt; headers.length; i++) {
        const key = headers[i].toLowerCase().replace(/\s+/g, '_');
        obj[key] = row[i] || '';
      }
      return obj;
    });
    
    return ContentService
      .createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({
        error: error.toString(),
        timestamp: new Date().toISOString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// Optional: Function to get statistics (faster than downloading all data)
function getStats(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    const lastRow = sheet.getLastRow();
    
    if (lastRow &lt;= 1) {
      return ContentService
        .createTextOutput(JSON.stringify({
          total: 0,
          hadir: 0,
          izin: 0,
          sakit: 0,
          alpha: 0
        }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // Get only the status column for faster processing
    const statusRange = sheet.getRange(2, 3, lastRow - 1, 1);
    const statusValues = statusRange.getValues().flat();
    
    const stats = {
      total: statusValues.length,
      hadir: statusValues.filter(s =&gt; s === 'Hadir').length,
      izin: statusValues.filter(s =&gt; s === 'Izin').length,
      sakit: statusValues.filter(s =&gt; s === 'Sakit').length,
      alpha: statusValues.filter(s =&gt; s === 'Alpha').length
    };
    
    return ContentService
      .createTextOutput(JSON.stringify(stats))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({
        error: error.toString(),
        timestamp: new Date().toISOString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}</pre>
           </div>
          </div>
         </div>
        </div><!-- Step 3: Integration -->
        <div class="border-2 border-blue-200 rounded-lg p-6">
         <h3 class="text-xl font-bold text-blue-800 mb-4">3ï¸âƒ£ Integrasi dengan Sistem Absensi</h3>
         <div class="space-y-6"><!-- Step 3A: Deploy Apps Script -->
          <div class="border-l-4 border-blue-400 pl-4">
           <h4 class="text-lg font-bold text-blue-800 mb-3">ğŸ“¤ Langkah A: Deploy Apps Script sebagai Web App</h4>
           <div class="bg-blue-50 p-4 rounded-lg mb-3">
            <p class="text-blue-800 font-medium mb-2">âš ï¸ PENTING: Lakukan untuk KEDUA Apps Script (Data Siswa &amp; Data Absensi)</p>
           </div>
           <ol class="list-decimal list-inside text-gray-700 space-y-3 mb-4">
            <li><strong>Buka Apps Script Editor</strong>
             <ul class="list-disc list-inside ml-6 mt-1 text-sm text-gray-600">
              <li>Pastikan kode sudah di-paste dan di-save</li>
              <li>Tidak ada error di editor (garis merah)</li>
             </ul></li>
            <li><strong>Klik tombol "Deploy" â†’ "New deployment"</strong>
             <ul class="list-disc list-inside ml-6 mt-1 text-sm text-gray-600">
              <li>Tombol Deploy ada di pojok kanan atas</li>
              <li>Pilih "New deployment" dari dropdown</li>
             </ul></li>
            <li><strong>Pilih Type: "Web app"</strong>
             <ul class="list-disc list-inside ml-6 mt-1 text-sm text-gray-600">
              <li>Klik icon gear âš™ï¸ di sebelah "Type"</li>
              <li>Pilih "Web app" dari daftar</li>
             </ul></li>
            <li><strong>Atur konfigurasi deployment:</strong>
             <div class="bg-yellow-50 p-3 rounded mt-2 border border-yellow-200">
              <ul class="list-disc list-inside text-sm text-gray-700 space-y-1">
               <li><strong>Description:</strong> "Attendance API" atau "Student Data API"</li>
               <li><strong>Execute as:</strong> "Me (email@gmail.com)"</li>
               <li><strong>Who has access:</strong> "Anyone" âš ï¸ PENTING!</li>
              </ul>
             </div></li>
            <li><strong>Klik "Deploy"</strong>
             <ul class="list-disc list-inside ml-6 mt-1 text-sm text-gray-600">
              <li>Google akan meminta authorize permissions</li>
              <li>Klik "Authorize access"</li>
              <li>Login dengan akun Google Anda</li>
              <li>Klik "Allow" untuk semua permissions</li>
             </ul></li>
            <li><strong>Copy URL Web App</strong>
             <ul class="list-disc list-inside ml-6 mt-1 text-sm text-gray-600">
              <li>Setelah deploy berhasil, akan muncul URL panjang</li>
              <li>Format: https://script.google.com/macros/s/SCRIPT_ID/exec</li>
              <li><strong>SIMPAN URL ini!</strong> Akan digunakan untuk integrasi</li>
             </ul></li>
           </ol>
           <div class="bg-green-50 p-3 rounded border border-green-200">
            <div class="flex items-start gap-2"><span class="text-green-600 text-lg">ğŸ’¡</span>
             <div class="text-green-800 text-sm"><strong>Tips:</strong> Ulangi proses ini untuk kedua Apps Script. Anda akan mendapat 2 URL berbeda: <br>
              â€¢ URL untuk Data Siswa (GET request) <br>
              â€¢ URL untuk Data Absensi (POST request)
             </div>
            </div>
           </div>
          </div><!-- Step 3C: Integration with System -->
          <div class="border-l-4 border-purple-400 pl-4">
           <h4 class="text-lg font-bold text-purple-800 mb-3">ğŸ”— Langkah B: Integrasi dengan Sistem Absensi</h4>
           <div class="space-y-4">
            <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
             <h5 class="font-bold text-purple-800 mb-2">ğŸ“ Konfigurasi Data Siswa</h5>
             <ol class="list-decimal list-inside text-gray-700 space-y-2 text-sm">
              <li>Buka halaman <strong>"âš™ï¸ Pengaturan"</strong> di sistem absensi</li>
              <li>Scroll ke bagian <strong>"Konfigurasi Data Siswa"</strong></li>
              <li>Paste <strong>URL Apps Script Data Siswa</strong> di field "URL Google Apps Script"</li>
              <li>Klik tombol <strong>"ğŸ’¾ Simpan URL"</strong> untuk menyimpan permanen</li>
              <li>Klik tombol <strong>"ğŸ”„ Muat Data Siswa"</strong></li>
              <li>Sistem akan otomatis memuat daftar siswa per kelas</li>
             </ol>
            </div>
            <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
             <h5 class="font-bold text-indigo-800 mb-2">ğŸ“Š Konfigurasi Data Absensi</h5>
             <ol class="list-decimal list-inside text-gray-700 space-y-2 text-sm">
              <li>Di bagian <strong>"Konfigurasi Google Sheets Absensi"</strong></li>
              <li>Paste <strong>URL Apps Script Data Absensi</strong> di field URL</li>
              <li>Klik tombol <strong>"ğŸ’¾ Simpan URL Absensi"</strong></li>
              <li>Klik tombol <strong>"ğŸ§ª Test Koneksi"</strong> untuk memastikan</li>
              <li>Sistem akan otomatis mengirim data absensi ke Google Sheets</li>
             </ol>
            </div>
           </div>
          </div>
         </div>
        </div><!-- Success Indicators -->
        <div class="bg-green-50 p-6 rounded-lg border border-green-200">
         <h3 class="text-xl font-bold text-green-800 mb-4">âœ… Tanda Koneksi Berhasil</h3>
         <div class="space-y-3">
          <div class="flex items-start gap-3"><span class="text-green-600 text-xl">âœ…</span>
           <div>
            <h4 class="font-bold text-gray-700">URL Tersimpan Otomatis</h4>
            <p class="text-gray-600 text-sm">URL Apps Script tersimpan dan tidak perlu input berulang</p>
           </div>
          </div>
          <div class="flex items-start gap-3"><span class="text-green-600 text-xl">âœ…</span>
           <div>
            <h4 class="font-bold text-gray-700">Data Siswa Termuat</h4>
            <p class="text-gray-600 text-sm">Dropdown kelas menampilkan siswa dari Google Sheets</p>
           </div>
          </div>
          <div class="flex items-start gap-3"><span class="text-green-600 text-xl">âœ…</span>
           <div>
            <h4 class="font-bold text-gray-700">Absensi Tersinkron Otomatis</h4>
            <p class="text-gray-600 text-sm">Setiap data absensi langsung masuk ke Google Sheets</p>
           </div>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div>
    </div>
   </main>
  </div> <!-- Footer -->
  <footer class="bg-white shadow-lg mt-8">
   <div class="max-w-7xl mx-auto px-4 py-4">
    <p id="footer-text" class="text-center text-gray-600 text-sm">Â© 2024 Sistem Absensi Multi-User</p>
   </div>
  </footer>
  <script>
    let allRecords = [];
    let recordCount = 0;
    let currentUser = null;
    
    const defaultConfig = {
      judul_aplikasi: "Sistem Absensi Online",
      nama_sekolah: "SMP Purnawarman",
      footer_text: "Â© 2024 Sistem Absensi Multi-User",
      admin_username: "admin",
      admin_password: "admin123",
      background_color: "#667eea",
      surface_color: "#ffffff",
      text_color: "#1f2937",
      primary_action_color: "#667eea",
      secondary_action_color: "#764ba2",
      font_family: "system-ui",
      font_size: 16
    };

    let users = {
      admin: { nama: "Administrator", password: "admin123", role: "Admin", permissions: ["create", "read", "update", "delete", "export", "manage_users"] },
      kepsek: { nama: "Kepala Sekolah", password: "kepsek123", role: "Kepala Sekolah", permissions: ["read", "export", "view_reports"] },
      guru: { nama: "Guru Piket", password: "guru123", role: "Guru Piket", permissions: ["create", "read", "update"] }
    };

    // Initialize with config values if available
    function initializeUsers() {
      // Always ensure default users exist
      users = {
        admin: { nama: "Administrator", password: "admin123", role: "Admin", permissions: ["create", "read", "update", "delete", "export", "manage_users"] },
        kepsek: { nama: "Kepala Sekolah", password: "kepsek123", role: "Kepala Sekolah", permissions: ["read", "export", "view_reports"] },
        guru: { nama: "Guru Piket", password: "guru123", role: "Guru Piket", permissions: ["create", "read", "update"] }
      };
      
      console.log('ğŸ” Users initialized with defaults:', Object.keys(users));
      console.log('ğŸ”‘ User details:', users);
    }
    
    // Initialize users on page load
    initializeUsers();

    const dataHandler = {
      onDataChanged(data) {
        allRecords = data;
        recordCount = data.length;
        updateStats(data);
        updateFilterOptions(data);
        updateClassDropdowns();
        applyFilters();
      }
    };

    async function onConfigChange(config) {
      const appTitle = document.getElementById('app-title');
      const loginTitle = document.getElementById('login-title');
      const schoolName = document.getElementById('school-name');
      const loginSchool = document.getElementById('login-school');
      const footerText = document.getElementById('footer-text');
      
      if (appTitle) {
        appTitle.textContent = config.judul_aplikasi || defaultConfig.judul_aplikasi;
        appTitle.style.color = config.primary_action_color || defaultConfig.primary_action_color;
        appTitle.style.fontFamily = `${config.font_family || defaultConfig.font_family}, system-ui, sans-serif`;
        appTitle.style.fontSize = `${(config.font_size || defaultConfig.font_size) * 1.875}px`;
      }
      
      if (loginTitle) {
        loginTitle.textContent = config.judul_aplikasi || defaultConfig.judul_aplikasi;
        loginTitle.style.fontFamily = `${config.font_family || defaultConfig.font_family}, system-ui, sans-serif`;
        loginTitle.style.fontSize = `${(config.font_size || defaultConfig.font_size) * 1.875}px`;
      }
      
      if (schoolName) {
        schoolName.textContent = config.nama_sekolah || defaultConfig.nama_sekolah;
        schoolName.style.color = config.text_color || defaultConfig.text_color;
        schoolName.style.fontFamily = `${config.font_family || defaultConfig.font_family}, system-ui, sans-serif`;
        schoolName.style.fontSize = `${(config.font_size || defaultConfig.font_size) * 0.875}px`;
      }
      
      if (loginSchool) {
        loginSchool.textContent = config.nama_sekolah || defaultConfig.nama_sekolah;
        loginSchool.style.fontFamily = `${config.font_family || defaultConfig.font_family}, system-ui, sans-serif`;
        loginSchool.style.fontSize = `${(config.font_size || defaultConfig.font_size) * 0.875}px`;
      }
      
      if (footerText) {
        footerText.textContent = config.footer_text || defaultConfig.footer_text;
        footerText.style.color = config.text_color || defaultConfig.text_color;
        footerText.style.fontFamily = `${config.font_family || defaultConfig.font_family}, system-ui, sans-serif`;
        footerText.style.fontSize = `${(config.font_size || defaultConfig.font_size) * 0.875}px`;
      }
      
      const loginScreen = document.getElementById('login-screen');
      const mainApp = document.getElementById('main-app');
      if (loginScreen && mainApp) {
        loginScreen.style.background = `linear-gradient(135deg, ${config.background_color || defaultConfig.background_color} 0%, ${config.secondary_action_color || defaultConfig.secondary_action_color} 100%)`;
        mainApp.style.background = `linear-gradient(135deg, ${config.background_color || defaultConfig.background_color} 0%, ${config.secondary_action_color || defaultConfig.secondary_action_color} 100%)`;
      }
      
      const submitBtn = document.getElementById('submit-btn');
      const loginBtn = document.getElementById('login-btn');
      if (submitBtn) {
        submitBtn.style.background = `linear-gradient(135deg, ${config.primary_action_color || defaultConfig.primary_action_color} 0%, ${config.secondary_action_color || defaultConfig.secondary_action_color} 100%)`;
      }
      if (loginBtn) {
        loginBtn.style.background = `linear-gradient(135deg, ${config.primary_action_color || defaultConfig.primary_action_color} 0%, ${config.secondary_action_color || defaultConfig.secondary_action_color} 100%)`;
      }
      
      const allHeadings = document.querySelectorAll('h2, h3');
      allHeadings.forEach(heading => {
        heading.style.color = config.primary_action_color || defaultConfig.primary_action_color;
        heading.style.fontFamily = `${config.font_family || defaultConfig.font_family}, system-ui, sans-serif`;
        heading.style.fontSize = `${(config.font_size || defaultConfig.font_size) * 1.5}px`;
      });
      
      const allText = document.querySelectorAll('p, label, input, textarea, select, button');
      allText.forEach(el => {
        el.style.fontFamily = `${config.font_family || defaultConfig.font_family}, system-ui, sans-serif`;
        el.style.fontSize = `${config.font_size || defaultConfig.font_size}px`;
      });
      
      // Update users with config values if they exist
      if (config.admin_username && config.admin_password) {
        if (config.admin_username !== defaultConfig.admin_username) {
          delete users[defaultConfig.admin_username];
        }
        
        users[config.admin_username] = { 
          password: config.admin_password, 
          role: "Admin", 
          permissions: ["create", "read", "update", "delete", "export", "manage_users"] 
        };
        
        console.log('ğŸ”„ Users updated from config:', Object.keys(users));
      }
    }

    function getWIBTime() {
      const now = new Date();
      const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
      const wib = new Date(utc + (7 * 3600000));
      return wib;
    }

    function formatWIBTime(date) {
      return date.toLocaleString('id-ID', {
        timeZone: 'Asia/Jakarta',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    function updateCurrentTime() {
      const currentTimeEl = document.getElementById('current-time');
      if (currentTimeEl) {
        const wibTime = getWIBTime();
        currentTimeEl.textContent = formatWIBTime(wibTime);
      }
    }

    function login(username, password) {
      // Always ensure default users exist with exact credentials
      const defaultUsers = {
        admin: { nama: "Administrator", password: "admin123", role: "Admin", permissions: ["create", "read", "update", "delete", "export", "manage_users"] },
        kepsek: { nama: "Kepala Sekolah", password: "kepsek123", role: "Kepala Sekolah", permissions: ["read", "export", "view_reports"] },
        guru: { nama: "Guru Piket", password: "guru123", role: "Guru Piket", permissions: ["create", "read", "update"] }
      };
      
      // Merge with existing users, but always keep defaults
      users = { ...users, ...defaultUsers };
      
      // Clean inputs
      const cleanUsername = (username || '').toString().trim().toLowerCase();
      const cleanPassword = (password || '').toString().trim();
      
      console.log('ğŸ” LOGIN DEBUG:');
      console.log('Input username:', `"${username}" -> cleaned: "${cleanUsername}"`);
      console.log('Input password:', `"${password}" -> cleaned: "${cleanPassword}"`);
      console.log('Available users:', Object.keys(users));
      
      // Check each user manually
      for (const [userKey, userData] of Object.entries(users)) {
        console.log(`Checking user "${userKey}":`, userData);
        console.log(`Username match: "${cleanUsername}" === "${userKey.toLowerCase()}" = ${cleanUsername === userKey.toLowerCase()}`);
        console.log(`Password match: "${cleanPassword}" === "${userData.password}" = ${cleanPassword === userData.password}`);
        
        if (cleanUsername === userKey.toLowerCase() && cleanPassword === userData.password) {
          console.log('âœ… LOGIN SUCCESS!');
          
          currentUser = { username: userKey, ...userData };
          showMainApp();
          updateUserInterface();
          
          // Show success message
          const successDiv = document.createElement('div');
          successDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
          successDiv.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-sm mx-4 text-center shadow-2xl">
              <div class="text-6xl mb-4">âœ…</div>
              <h3 class="text-xl font-bold text-green-800 mb-2">Login Berhasil!</h3>
              <p class="text-gray-600 mb-4">Selamat datang, ${userData.role}!</p>
              <button onclick="this.parentElement.parentElement.remove()" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all font-medium">
                Lanjutkan
              </button>
            </div>
          `;
          document.body.appendChild(successDiv);
          
          setTimeout(() => {
            if (successDiv.parentElement) {
              successDiv.remove();
            }
          }, 3000);
          
          return true;
        }
      }
      
      // Login failed
      console.log('âŒ LOGIN FAILED');
      
      const errorDiv = document.createElement('div');
      errorDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      errorDiv.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-lg mx-4 text-center shadow-2xl">
          <div class="text-6xl mb-4">âŒ</div>
          <h3 class="text-xl font-bold text-red-800 mb-2">Login Gagal!</h3>
          <p class="text-gray-600 mb-4">Username atau password tidak sesuai</p>
          
          <div class="bg-blue-50 p-4 rounded-lg mb-4 text-left">
            <h4 class="font-bold text-blue-800 mb-2">ğŸ” Debug Info:</h4>
            <p class="text-sm text-blue-700">Username yang dimasukkan: "${cleanUsername}"</p>
            <p class="text-sm text-blue-700">Password yang dimasukkan: "${cleanPassword}"</p>
            <p class="text-sm text-blue-700">User tersedia: ${Object.keys(users).join(', ')}</p>
          </div>
          
          <div class="bg-green-50 p-4 rounded-lg mb-4 text-left">
            <h4 class="font-bold text-green-800 mb-2">âœ… Akun yang Tersedia:</h4>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="font-medium">Admin:</span>
                <span class="text-gray-600">admin / admin123</span>
              </div>
              <div class="flex justify-between">
                <span class="font-medium">Kepsek:</span>
                <span class="text-gray-600">kepsek / kepsek123</span>
              </div>
              <div class="flex justify-between">
                <span class="font-medium">Guru:</span>
                <span class="text-gray-600">guru / guru123</span>
              </div>
            </div>
          </div>
          
          <button onclick="this.parentElement.parentElement.remove()" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all font-medium">
            Coba Lagi
          </button>
        </div>
      `;
      document.body.appendChild(errorDiv);
      
      return false;
    }

    function logout() {
      currentUser = null;
      showLoginScreen();
    }

    function showLoginScreen() {
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('main-app').classList.add('hidden');
    }

    function showMainApp() {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('main-app').classList.remove('hidden');
    }

    function updateUserInterface() {
      if (!currentUser) return;
      
      const userRoleBadge = document.getElementById('user-role-badge');
      const formSection = document.getElementById('form-section');
      const exportSection = document.getElementById('export-section');
      
      const roleIcons = {
        'Admin': 'ğŸ‘‘',
        'Kepala Sekolah': 'ğŸ“',
        'Guru Piket': 'ğŸ‘¨â€ğŸ«'
      };
      
      const roleClasses = {
        'Admin': 'admin-badge',
        'Kepala Sekolah': 'kepsek-badge',
        'Guru Piket': 'guru-badge'
      };
      
      if (userRoleBadge) {
        userRoleBadge.textContent = `${roleIcons[currentUser.role]} ${currentUser.role}`;
        userRoleBadge.className = `role-badge ${roleClasses[currentUser.role]}`;
      }
      
      // Update form section visibility (Admin & Guru Piket can input)
      if (formSection) {
        if (currentUser.permissions.includes('create')) {
          formSection.classList.remove('hidden');
        } else {
          formSection.classList.add('hidden');
        }
      }
      
      // Update export section visibility (Admin & Kepsek can export)
      if (exportSection) {
        if (currentUser.permissions.includes('export')) {
          exportSection.classList.remove('hidden');
        } else {
          exportSection.classList.add('hidden');
        }
      }
      
      // Update navigation menu visibility based on role
      updateNavigationAccess();
      
      // Show permission notice for view-only users
      if (!currentUser.permissions.includes('create') && !currentUser.permissions.includes('manage_users')) {
        const notice = document.createElement('div');
        notice.className = 'permission-denied';
        
        if (currentUser.role === 'Kepala Sekolah') {
          notice.innerHTML = `
            <div class="flex items-center justify-center gap-2">
              <span>ğŸ‘ï¸</span>
              <span>Anda login sebagai ${currentUser.role} - Dapat melihat data dan export laporan</span>
            </div>
          `;
        } else {
          notice.innerHTML = `
            <div class="flex items-center justify-center gap-2">
              <span>ğŸ‘ï¸</span>
              <span>Anda login sebagai ${currentUser.role} - Hanya dapat melihat data</span>
            </div>
          `;
        }
        
        const main = document.querySelector('main');
        if (main && !main.querySelector('.permission-denied')) {
          main.insertBefore(notice, main.firstChild);
        }
      }
    }
    
    function updateNavigationAccess() {
      const navAbsensi = document.getElementById('nav-absensi');
      const navRekap = document.getElementById('nav-rekap');
      const navPanduan = document.getElementById('nav-panduan');
      const navPengaturan = document.getElementById('nav-pengaturan');
      const panduanPengaturanBtn = document.getElementById('panduan-pengaturan-btn');
      
      if (!currentUser) return;
      
      // Admin: Full access to all menus
      if (currentUser.role === 'Admin') {
        if (navAbsensi) navAbsensi.style.display = 'block';
        if (navRekap) navRekap.style.display = 'block';
        if (navPanduan) navPanduan.style.display = 'block';
        if (navPengaturan) navPengaturan.style.display = 'block';
        if (panduanPengaturanBtn) panduanPengaturanBtn.style.display = 'block';
      }
      
      // Guru Piket: Absensi, Rekap, Panduan only
      else if (currentUser.role === 'Guru Piket') {
        if (navAbsensi) navAbsensi.style.display = 'block';
        if (navRekap) navRekap.style.display = 'block';
        if (navPanduan) navPanduan.style.display = 'block';
        if (navPengaturan) navPengaturan.style.display = 'none';
        if (panduanPengaturanBtn) panduanPengaturanBtn.style.display = 'none';
      }
      
      // Kepala Sekolah: View only (Rekap, Panduan)
      else if (currentUser.role === 'Kepala Sekolah') {
        if (navAbsensi) navAbsensi.style.display = 'block'; // Can view data
        if (navRekap) navRekap.style.display = 'block';
        if (navPanduan) navPanduan.style.display = 'block';
        if (navPengaturan) navPengaturan.style.display = 'none';
        if (panduanPengaturanBtn) panduanPengaturanBtn.style.display = 'none';
      }
    }

    function hasPermission(action) {
      return currentUser && currentUser.permissions.includes(action);
    }

    function updateStats(data) {
      const totalStudentsCount = document.getElementById('total-students-count');
      const totalCount = document.getElementById('total-count');
      const hadirCount = document.getElementById('hadir-count');
      const izinCount = document.getElementById('izin-count');
      const sakitCount = document.getElementById('sakit-count');
      const alphaCount = document.getElementById('alpha-count');
      
      const hadir = data.filter(r => r.status === 'Hadir').length;
      const izin = data.filter(r => r.status === 'Izin').length;
      const sakit = data.filter(r => r.status === 'Sakit').length;
      const alpha = data.filter(r => r.status === 'Alpha').length;
      
      // Calculate total students from Google Sheets data
      const totalStudents = Object.values(studentsByClass).reduce((sum, students) => sum + students.length, 0);
      
      if (totalStudentsCount) {
        totalStudentsCount.textContent = totalStudents;
        
        // Add tooltip showing breakdown by class
        const classBreakdown = Object.entries(studentsByClass)
          .map(([kelas, students]) => `${kelas}: ${students.length}`)
          .join('\n');
        
        totalStudentsCount.parentElement.parentElement.title = `Breakdown per kelas:\n${classBreakdown}`;
      }
      
      if (totalCount) totalCount.textContent = data.length;
      if (hadirCount) hadirCount.textContent = hadir;
      if (izinCount) izinCount.textContent = izin;
      if (sakitCount) sakitCount.textContent = sakit;
      if (alphaCount) alphaCount.textContent = alpha;
    }

    function updateFilterOptions(data) {
      const filterKelas = document.getElementById('filter-kelas');
      const filterUser = document.getElementById('filter-user');
      
      if (filterKelas) {
        const kelasSet = new Set(data.map(r => r.kelas));
        const currentValue = filterKelas.value;
        
        filterKelas.innerHTML = '<option value="">Semua Kelas</option>';
        Array.from(kelasSet).sort().forEach(kelas => {
          const option = document.createElement('option');
          option.value = kelas;
          option.textContent = kelas;
          filterKelas.appendChild(option);
        });
        
        filterKelas.value = currentValue;
      }
      
      if (filterUser) {
        const userSet = new Set(data.map(r => r.input_by).filter(Boolean));
        const currentValue = filterUser.value;
        
        filterUser.innerHTML = '<option value="">Semua User</option>';
        Array.from(userSet).sort().forEach(user => {
          const option = document.createElement('option');
          option.value = user;
          option.textContent = user;
          filterUser.appendChild(option);
        });
        
        filterUser.value = currentValue;
      }
    }

    function applyFilters() {
      const filterKelas = document.getElementById('filter-kelas').value;
      const filterStatus = document.getElementById('filter-status').value;
      const filterTanggal = document.getElementById('filter-tanggal').value;
      const filterUser = document.getElementById('filter-user').value;
      
      let filtered = allRecords;
      
      if (filterKelas) {
        filtered = filtered.filter(r => r.kelas === filterKelas);
      }
      
      if (filterStatus) {
        filtered = filtered.filter(r => r.status === filterStatus);
      }
      
      if (filterTanggal) {
        filtered = filtered.filter(r => r.tanggal === filterTanggal);
      }
      
      if (filterUser) {
        filtered = filtered.filter(r => r.input_by === filterUser);
      }
      
      renderAbsensiList(filtered);
    }

    function renderAbsensiList(data) {
      const list = document.getElementById('absensi-list');
      const filteredCount = document.getElementById('filtered-count');
      
      if (!list) return;
      
      if (filteredCount) {
        filteredCount.textContent = data.length;
      }
      
      if (data.length === 0) {
        list.innerHTML = `
          <div class="text-center py-12 text-gray-400">
            <div class="text-6xl mb-4">ğŸ“</div>
            <p class="text-lg">Tidak ada data yang sesuai filter</p>
            <p class="text-sm mt-2">Coba ubah filter atau tambahkan data baru</p>
          </div>
        `;
        return;
      }
      
      const sortedData = [...data].sort((a, b) => {
        const dateA = new Date(a.timestamp || a.tanggal + ' ' + a.waktu);
        const dateB = new Date(b.timestamp || b.tanggal + ' ' + b.waktu);
        return dateB - dateA;
      });
      
      list.innerHTML = sortedData.map(record => {
        const statusColors = {
          'Hadir': 'bg-green-100 text-green-800',
          'Izin': 'bg-yellow-100 text-yellow-800',
          'Sakit': 'bg-red-100 text-red-800',
          'Alpha': 'bg-purple-100 text-purple-800'
        };
        
        const statusIcons = {
          'Hadir': 'âœ…',
          'Izin': 'ğŸ“',
          'Sakit': 'ğŸ¥',
          'Alpha': 'âŒ'
        };
        
        const canDelete = hasPermission('delete');
        
        return `
          <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all fade-in" data-id="${record.__backendId}">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
              <div class="flex-1">
                <div class="flex flex-wrap items-center gap-3 mb-2">
                  <h3 class="text-lg font-bold text-gray-800">${record.nama_siswa}</h3>
                  <span class="status-badge px-3 py-1 rounded-full text-sm font-medium ${statusColors[record.status]}">
                    ${statusIcons[record.status]} ${record.status}
                  </span>
                </div>
                <div class="text-sm text-gray-600 space-y-1">
                  <p>ğŸ“ Kelas: <span class="font-medium">${record.kelas}</span></p>
                  <p>ğŸ“… ${record.tanggal} â€¢ â° ${record.waktu} WIB</p>
                  ${record.keterangan ? `<p>ğŸ“ ${record.keterangan}</p>` : ''}
                  ${record.input_by ? `<p>ğŸ‘¤ Input oleh: <span class="font-medium">${record.input_by}</span> (${record.user_role || 'Unknown'})</p>` : ''}
                </div>
              </div>
              <div class="flex gap-2">
                ${canDelete ? `
                  <button onclick="deleteRecord('${record.__backendId}')" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all text-sm font-medium">
                    ğŸ—‘ï¸ Hapus
                  </button>
                ` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function showToast(message, type = 'success') {
      // Remove any existing toasts first
      const existingToasts = document.querySelectorAll('.toast');
      existingToasts.forEach(toast => toast.remove());
      
      const toast = document.createElement('div');
      toast.className = `toast ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
      toast.textContent = message;
      toast.style.zIndex = '9999'; // Ensure toast is on top
      toast.style.pointerEvents = 'none'; // Don't block clicks
      
      document.body.appendChild(toast);
      
      // Auto remove after 3 seconds
      const timeoutId = setTimeout(() => {
        if (toast && toast.parentElement) {
          toast.style.animation = 'slideIn 0.3s ease-out reverse';
          setTimeout(() => {
            if (toast && toast.parentElement) {
              toast.remove();
            }
          }, 300);
        }
      }, 3000);
      
      // Allow manual click to dismiss
      toast.addEventListener('click', () => {
        clearTimeout(timeoutId);
        if (toast && toast.parentElement) {
          toast.style.animation = 'slideIn 0.3s ease-out reverse';
          setTimeout(() => {
            if (toast && toast.parentElement) {
              toast.remove();
            }
          }, 300);
        }
      });
    }

    function setLoading(isLoading, buttonId = 'submit-btn', textId = 'submit-text') {
      const btn = document.getElementById(buttonId);
      const text = document.getElementById(textId);
      
      if (btn) {
        btn.disabled = isLoading;
        btn.style.opacity = isLoading ? '0.7' : '1';
      }
      
      if (text) {
        if (isLoading) {
          text.innerHTML = '<div class="loading-spinner mx-auto"></div>';
        } else {
          if (buttonId === 'login-btn') {
            text.textContent = 'Masuk';
          } else if (buttonId === 'add-user-btn') {
            text.textContent = 'Tambah User';
          } else {
            text.textContent = 'Simpan Absensi';
          }
        }
      }
    }

    async function handleLogin(e) {
      e.preventDefault();
      
      setLoading(true, 'login-btn', 'login-text');
      
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      const loginSuccess = login(username, password);
      
      if (loginSuccess) {
        document.getElementById('login-form').reset();
      }
      
      setLoading(false, 'login-btn', 'login-text');
    }

    async function sendToGoogleSheets(attendanceData) {
      if (!isAttendanceSheetConnected || !attendanceSheetUrl) {
        console.log('Google Sheets not connected, skipping...');
        return { success: true };
      }
      
      try {
        console.log('ğŸš€ Sending data to Google Sheets:', attendanceData);
        console.log('ğŸ“¡ URL:', attendanceSheetUrl);
        
        const response = await fetch(attendanceSheetUrl, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(attendanceData)
        });
        
        console.log('ğŸ“¡ Response status:', response.status);
        console.log('âœ… Data sent successfully to Google Sheets');
        return { success: true };
        
      } catch (error) {
        console.error('âŒ Error sending to Google Sheets:', error);
        return { success: false, error: error.message };
      }
    }

    window.deleteRecord = async function(backendId) {
      if (!hasPermission('delete')) {
        showToast('âŒ Anda tidak memiliki izin untuk menghapus data!', 'error');
        return;
      }
      
      const record = allRecords.find(r => r.__backendId === backendId);
      if (!record) return;
      
      const card = document.querySelector(`[data-id="${backendId}"]`);
      const deleteBtn = card.querySelector('button[onclick*="deleteRecord"]');
      
      if (deleteBtn.textContent.includes('Konfirmasi')) {
        setLoading(true);
        
        const result = await window.dataSdk.delete(record);
        
        setLoading(false);
        
        if (result.isOk) {
          showToast('âœ… Data berhasil dihapus!', 'success');
        } else {
          showToast('âŒ Gagal menghapus data. Silakan coba lagi.', 'error');
        }
      } else {
        deleteBtn.textContent = 'âœ”ï¸ Konfirmasi Hapus';
        deleteBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
        deleteBtn.classList.add('bg-orange-500', 'hover:bg-orange-600');
        
        setTimeout(() => {
          deleteBtn.textContent = 'ğŸ—‘ï¸ Hapus';
          deleteBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
          deleteBtn.classList.add('bg-red-500', 'hover:bg-red-600');
        }, 3000);
      }
    };

    window.exportToCSV = function() {
      if (!hasPermission('export')) {
        showToast('âŒ Anda tidak memiliki izin untuk export data!', 'error');
        return;
      }
      
      if (allRecords.length === 0) {
        showToast('âŒ Tidak ada data untuk di-export!', 'error');
        return;
      }
      
      const headers = ['Nama Siswa', 'Kelas', 'Status', 'Tanggal', 'Waktu', 'Keterangan', 'Input Oleh', 'Role'];
      const csvContent = [
        headers.join(','),
        ...allRecords.map(record => [
          `"${record.nama_siswa}"`,
          `"${record.kelas}"`,
          `"${record.status}"`,
          `"${record.tanggal}"`,
          `"${record.waktu}"`,
          `"${record.keterangan || ''}"`,
          `"${record.input_by || ''}"`,
          `"${record.user_role || ''}"`
        ].join(','))
      ].join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `absensi_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast('âœ… Data berhasil di-export!', 'success');
    };

    let studentsByClass = {};
    let isStudentDataLoaded = false;
    let studentDataUrl = '';

    let attendanceSheetUrl = 'https://script.google.com/macros/s/AKfycbwTFf2vKfXdQz3CWLnj1Cm2Qo53iz_8aB0rdkZ7403og5pLcUe6l8xft1LBbPj1BNBi/exec';
    let isAttendanceSheetConnected = true;

    let currentClassStudents = [];
    let attendanceData = {};

    async function loadStudentDataFromSheets(url) {
      try {
        showToast('ğŸ“¥ Memuat data siswa dari Google Sheets...', 'success');
        
        const response = await fetch(url);
        const data = await response.json();
        
        studentsByClass = {};
        
        data.forEach(student => {
          if (student.nama_siswa && student.kelas) {
            if (!studentsByClass[student.kelas]) {
              studentsByClass[student.kelas] = [];
            }
            
            if (!studentsByClass[student.kelas].includes(student.nama_siswa)) {
              studentsByClass[student.kelas].push(student.nama_siswa);
            }
          }
        });
        
        Object.keys(studentsByClass).forEach(kelas => {
          studentsByClass[kelas].sort();
        });
        
        isStudentDataLoaded = true;
        updateClassDropdowns();
        
        // Update stats to show new student count
        updateStats(allRecords);
        
        const totalStudents = Object.values(studentsByClass).reduce((sum, students) => sum + students.length, 0);
        const totalClasses = Object.keys(studentsByClass).length;
        
        showToast(`âœ… Berhasil memuat ${totalStudents} siswa dari ${totalClasses} kelas!`, 'success');
        
        return true;
      } catch (error) {
        console.error('Error loading student data:', error);
        showToast('âŒ Gagal memuat data siswa. Periksa URL Google Sheets.', 'error');
        
        loadSampleStudentData();
        return false;
      }
    }

    function loadSampleStudentData() {
      console.log('ğŸ“‹ Loading sample student data...');
      
      studentsByClass = {
        'VII A': ['Ahmad Rizki', 'Siti Nurhaliza', 'Budi Santoso', 'Dewi Sartika', 'Eko Prasetyo', 'Fitri Handayani', 'Gilang Ramadhan', 'Hana Pertiwi', 'Indra Gunawan', 'Jihan Aulia', 'Krisna Wijaya', 'Lestari Putri', 'Muhammad Fadil', 'Nadia Safira', 'Oki Setiawan'],
        'VII B': ['Putri Maharani', 'Qori Syahputra', 'Rina Melati', 'Surya Pratama', 'Tania Sari', 'Umar Faruq', 'Vina Amelia', 'Wahyu Hidayat', 'Xenia Putri', 'Yoga Pratama', 'Zahra Aulia', 'Arif Rahman', 'Bella Safitri', 'Candra Kirana', 'Dimas Aditya'],
        'VII C': ['Elsa Permata', 'Fajar Nugraha', 'Gita Savitri', 'Hendra Kusuma', 'Ika Rahmawati', 'Joko Susilo', 'Kartika Dewi', 'Lukman Hakim', 'Maya Sari', 'Noval Pratama', 'Olivia Putri', 'Pandu Winata', 'Qonita Zahara', 'Reza Mahendra', 'Sari Indah'],
        'VIII A': ['Taufik Hidayat', 'Ulfa Khoiriyah', 'Vicky Pratama', 'Winda Sari', 'Xavier Putra', 'Yuni Astuti', 'Zaki Rahman', 'Aida Fitria', 'Bayu Setiawan', 'Citra Dewi', 'Doni Prasetya', 'Evi Susanti', 'Fandi Kurniawan', 'Gina Marlina', 'Hadi Wijaya'],
        'VIII B': ['Ira Puspita', 'Jefri Nichol', 'Kania Dewi', 'Luki Hermawan', 'Mira Handayani', 'Nanda Pratama', 'Oki Setiani', 'Prita Maharani', 'Qomar Zaman', 'Rini Suryani', 'Sandi Permana', 'Tika Rahayu', 'Udin Sedunia', 'Vera Safitri', 'Wawan Kurniawan'],
        'VIII C': ['Xara Putri', 'Yanto Basuki', 'Zara Amelia', 'Andi Pratama', 'Bela Purnama', 'Coki Pardede', 'Dina Mariana', 'Egi Maulana', 'Fira Azzahra', 'Galih Pratama', 'Hesti Purnamasari', 'Imam Santoso', 'Jesi Ramadhan', 'Kiki Amalia', 'Lina Marlina'],
        'IX A': ['Manda Safitri', 'Niko Pratama', 'Ocha Maharani', 'Piko Aditama', 'Qila Ramadhani', 'Riko Setiawan', 'Sinta Dewi', 'Toni Kurniawan', 'Umi Kalsum', 'Vero Pratama', 'Wulan Dari', 'Xavi Maulana', 'Yesi Purnama', 'Zidan Akbar', 'Alya Putri'],
        'IX B': ['Bagas Pratama', 'Cinta Laura', 'Dedi Setiawan', 'Eka Rahayu', 'Farel Prayoga', 'Gaby Spanic', 'Haris Pratama', 'Intan Permata', 'Jihan Mirdad', 'Kenzo Alvaro', 'Luna Maya', 'Maudy Ayunda', 'Nino Fernandez', 'Olla Ramlan', 'Prilly Latuconsina'],
        'IX C': ['Quincy Jones', 'Raisa Andriana', 'Sheila Dara', 'Tulus Rusydi', 'Ussy Sulistiawaty', 'Vidi Aldiano', 'Wulan Guritno', 'Xabiru Oshe', 'Yura Yunita', 'Zaskia Gotik', 'Afgan Syahreza', 'Bunga Zainal', 'Chand Kelvin', 'Dian Sastro', 'Enzy Storia']
      };
      
      isStudentDataLoaded = true;
      updateClassDropdowns();
      
      // Update stats to show student count
      updateStats(allRecords);
      
      const totalStudents = Object.values(studentsByClass).reduce((sum, students) => sum + students.length, 0);
      
      console.log('âœ… Sample student data loaded successfully');
      showToast(`ğŸ“‹ Data sample dimuat: ${totalStudents} siswa dari 9 kelas. Hubungkan ke Google Sheets untuk data real.`, 'success');
    }

    function updateClassDropdowns() {
      const formFilterKelas = document.getElementById('form-filter-kelas');
      const filterKelas = document.getElementById('filter-kelas');
      
      if (formFilterKelas) {
        const currentValue = formFilterKelas.value;
        formFilterKelas.innerHTML = '<option value="">Pilih Kelas</option>';
        
        const today = new Date().toISOString().split('T')[0];
        
        const classesWithAttendanceToday = new Set(
          allRecords
            .filter(record => record.tanggal === today)
            .map(record => record.kelas)
        );
        
        Object.keys(studentsByClass).sort().forEach(kelas => {
          const option = document.createElement('option');
          option.value = kelas;
          
          if (classesWithAttendanceToday.has(kelas)) {
            option.textContent = `${kelas} (${studentsByClass[kelas].length} siswa) - Sudah Diabsen`;
            option.style.color = '#6b7280';
            option.style.fontStyle = 'italic';
            option.disabled = true;
          } else {
            option.textContent = `${kelas} (${studentsByClass[kelas].length} siswa)`;
          }
          
          formFilterKelas.appendChild(option);
        });
        
        formFilterKelas.value = currentValue;
      }
      
      if (filterKelas && allRecords.length > 0) {
        updateFilterOptions(allRecords);
      }
    }

    window.copyStudentDataScript = function() {
      const code = document.getElementById('student-data-script').textContent;
      navigator.clipboard.writeText(code).then(() => {
        showToast('âœ… Kode Student Data Script berhasil di-copy!', 'success');
      }).catch(() => {
        showToast('âŒ Gagal copy kode. Silakan copy manual.', 'error');
      });
    };

    window.copyAttendanceScript = function() {
      const code = document.getElementById('attendance-script').textContent;
      navigator.clipboard.writeText(code).then(() => {
        showToast('âœ… Kode Attendance Script berhasil di-copy!', 'success');
      }).catch(() => {
        showToast('âŒ Gagal copy kode. Silakan copy manual.', 'error');
      });
    };

    window.loadStudentsByClass = function() {
      const selectedClass = document.getElementById('form-filter-kelas').value;
      
      if (!selectedClass) {
        showToast('âŒ Pilih kelas terlebih dahulu!', 'error');
        return;
      }
      
      if (!hasPermission('create')) {
        showToast('âŒ Anda tidak memiliki izin untuk input absensi!', 'error');
        return;
      }
      
      currentClassStudents = studentsByClass[selectedClass] || [];
      attendanceData = {};
      
      if (currentClassStudents.length === 0) {
        showToast('âŒ Data siswa untuk kelas ini belum tersedia!', 'error');
        return;
      }
      
      document.getElementById('student-attendance-list').classList.remove('hidden');
      document.getElementById('no-manual-input').classList.add('hidden');
      
      renderStudentList(selectedClass);
      showToast(`âœ… Berhasil memuat ${currentClassStudents.length} siswa kelas ${selectedClass}`, 'success');
    };

    function renderStudentList(className) {
      const container = document.getElementById('students-container');
      
      container.innerHTML = currentClassStudents.map((student, index) => `
        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all" data-student="${student}">
          <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div class="flex-1">
              <h4 class="text-lg font-bold text-gray-800">${student}</h4>
              <p class="text-sm text-gray-600">Kelas: ${className}</p>
            </div>
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-2">
              <label class="flex items-center justify-center p-2 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-green-500 transition-all text-sm">
                <input type="radio" name="status-${index}" value="Hadir" onchange="updateAttendance('${student}', 'Hadir')" class="mr-2">
                <span>âœ… Hadir</span>
              </label>
              
              <label class="flex items-center justify-center p-2 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-yellow-500 transition-all text-sm">
                <input type="radio" name="status-${index}" value="Izin" onchange="updateAttendance('${student}', 'Izin')" class="mr-2">
                <span>ğŸ“ Izin</span>
              </label>
              
              <label class="flex items-center justify-center p-2 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-red-500 transition-all text-sm">
                <input type="radio" name="status-${index}" value="Sakit" onchange="updateAttendance('${student}', 'Sakit')" class="mr-2">
                <span>ğŸ¥ Sakit</span>
              </label>
              
              <label class="flex items-center justify-center p-2 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-purple-500 transition-all text-sm">
                <input type="radio" name="status-${index}" value="Alpha" onchange="updateAttendance('${student}', 'Alpha')" class="mr-2">
                <span>âŒ Alpha</span>
              </label>
            </div>
          </div>
          <div class="mt-3">
            <input type="text" placeholder="Keterangan (opsional)" onchange="updateAttendanceNote('${student}', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm">
          </div>
        </div>
      `).join('');
    }

    window.updateAttendance = function(student, status) {
      if (!attendanceData[student]) {
        attendanceData[student] = {};
      }
      attendanceData[student].status = status;
    };

    window.updateAttendanceNote = function(student, note) {
      if (!attendanceData[student]) {
        attendanceData[student] = {};
      }
      attendanceData[student].keterangan = note;
    };

    window.markAllPresent = function() {
      currentClassStudents.forEach((student, index) => {
        const radio = document.querySelector(`input[name="status-${index}"][value="Hadir"]`);
        if (radio) {
          radio.checked = true;
          updateAttendance(student, 'Hadir');
        }
      });
      showToast('âœ… Semua siswa ditandai hadir!', 'success');
    };

    window.saveAllAttendance = function() {
      if (!hasPermission('create')) {
        showToast('âŒ Anda tidak memiliki izin untuk menyimpan absensi!', 'error');
        return;
      }
      
      const selectedClass = document.getElementById('form-filter-kelas').value;
      const studentsWithStatus = currentClassStudents.filter(student => 
        attendanceData[student] && attendanceData[student].status
      );
      
      if (studentsWithStatus.length === 0) {
        showToast('âŒ Belum ada siswa yang dipilih statusnya!', 'error');
        return;
      }
      
      if (recordCount + studentsWithStatus.length > 999) {
        showToast(`âŒ Batas maksimal 999 data tercapai. Hanya bisa menambah ${999 - recordCount} data lagi.`, 'error');
        return;
      }
      
      const confirmDiv = document.createElement('div');
      confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      confirmDiv.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md mx-4 text-center shadow-2xl">
          <div class="text-6xl mb-4">ğŸ’¾</div>
          <h3 class="text-xl font-bold text-gray-800 mb-2">Konfirmasi Simpan</h3>
          <p class="text-gray-600 mb-4">Simpan absensi untuk ${studentsWithStatus.length} siswa kelas ${selectedClass}?</p>
          <div class="flex gap-3">
            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-all font-medium">
              Batal
            </button>
            <button onclick="confirmSaveAllAttendance(); this.parentElement.parentElement.parentElement.remove();" class="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all font-medium">
              Simpan
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmDiv);
    };

    // Optimized batch processing system for faster saves
    let saveQueue = [];
    let isSaving = false;
    
    async function processSaveQueue() {
      if (isSaving || saveQueue.length === 0) return;
      
      isSaving = true;
      const BATCH_SIZE = 10; // Process 10 records at once
      const startTime = Date.now();
      
      console.log(`ğŸš€ Starting batch processing: ${saveQueue.length} records in queue`);
      
      try {
        // Process Google Sheets in batches (much faster)
        if (isAttendanceSheetConnected && attendanceSheetUrl) {
          const batches = [];
          for (let i = 0; i < saveQueue.length; i += BATCH_SIZE) {
            batches.push(saveQueue.slice(i, i + BATCH_SIZE));
          }
          
          console.log(`ğŸ“Š Sending ${batches.length} batches to Google Sheets`);
          
          // Send all batches to Google Sheets in parallel
          const sheetsPromises = batches.map(async (batch, index) => {
            try {
              const response = await fetch(attendanceSheetUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  batch: true,
                  data: batch
                })
              });
              console.log(`âœ… Batch ${index + 1} sent to Google Sheets`);
              return { success: true, count: batch.length };
            } catch (error) {
              console.error(`âŒ Batch ${index + 1} failed:`, error);
              return { success: false, count: 0 };
            }
          });
          
          await Promise.all(sheetsPromises);
        }
        
        // Process Data SDK in parallel (much faster than sequential)
        console.log(`ğŸ’¾ Saving ${saveQueue.length} records to Data SDK in parallel`);
        
        const sdkPromises = saveQueue.map(async (record) => {
          try {
            const result = await window.dataSdk.create(record);
            return { success: result.isOk, record };
          } catch (error) {
            console.error('SDK save error:', error);
            return { success: false, record };
          }
        });
        
        const results = await Promise.all(sdkPromises);
        const successCount = results.filter(r => r.success).length;
        const errorCount = results.filter(r => !r.success).length;
        
        const endTime = Date.now();
        const duration = ((endTime - startTime) / 1000).toFixed(2);
        
        console.log(`âš¡ Batch processing completed in ${duration}s: ${successCount} success, ${errorCount} errors`);
        
        // Clear queue
        saveQueue = [];
        
        return { successCount, errorCount, duration };
        
      } catch (error) {
        console.error('âŒ Batch processing error:', error);
        saveQueue = [];
        return { successCount: 0, errorCount: saveQueue.length, duration: 0 };
      } finally {
        isSaving = false;
      }
    }

    window.confirmSaveAllAttendance = async function() {
      const selectedClass = document.getElementById('form-filter-kelas').value;
      const wibTime = getWIBTime();
      const tanggal = wibTime.toISOString().split('T')[0];
      const waktu = wibTime.toTimeString().split(' ')[0].substring(0, 5);
      
      // Prepare all records for batch processing
      saveQueue = [];
      
      currentClassStudents.forEach(student => {
        if (attendanceData[student] && attendanceData[student].status) {
          const newRecord = {
            id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
            nama_siswa: student,
            kelas: selectedClass,
            status: attendanceData[student].status,
            tanggal: tanggal,
            waktu: waktu,
            keterangan: attendanceData[student].keterangan || '',
            input_by: currentUser.username,
            user_role: currentUser.role,
            timestamp: wibTime.toISOString()
          };
          saveQueue.push(newRecord);
        }
      });
      
      if (saveQueue.length === 0) {
        showToast('âŒ Tidak ada data untuk disimpan!', 'error');
        return;
      }
      
      // Show optimized loading screen
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      loadingDiv.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md mx-4 text-center shadow-2xl">
          <div class="loading-spinner mx-auto mb-4"></div>
          <h3 class="text-xl font-bold text-gray-800 mb-2">âš¡ Menyimpan ${saveQueue.length} Absensi</h3>
          <p class="text-gray-600 mb-2">Menggunakan sistem batch processing...</p>
          <div class="bg-blue-50 p-3 rounded-lg text-sm text-blue-800">
            <p>ğŸš€ Optimized: ${Math.ceil(saveQueue.length / 10)} batch ke Google Sheets</p>
            <p>ğŸ’¾ Parallel processing ke sistem database</p>
          </div>
          <p class="text-xs text-gray-500 mt-3">Estimasi: 2-5 detik</p>
        </div>
      `;
      document.body.appendChild(loadingDiv);
      
      // Process the queue with optimized batch system
      const result = await processSaveQueue();
      
      loadingDiv.remove();
      
      if (result.successCount > 0) {
        showToast(`âš¡ Berhasil menyimpan ${result.successCount} absensi dalam ${result.duration}s! (${Math.ceil(result.successCount / parseFloat(result.duration))}/detik)`, 'success');
        
        // Reset form
        document.getElementById('student-attendance-list').classList.add('hidden');
        document.getElementById('no-manual-input').classList.remove('hidden');
        document.getElementById('form-filter-kelas').value = '';
        attendanceData = {};
        currentClassStudents = [];
        
        updateClassDropdowns();
      }
      
      if (result.errorCount > 0) {
        showToast(`âš ï¸ ${result.errorCount} data gagal disimpan. Silakan coba lagi.`, 'error');
      }
    };

    // Navigation functions
    window.showAbsensiPage = function() {
      document.getElementById('absensi-page').classList.remove('hidden');
      document.getElementById('rekap-page').classList.add('hidden');
      document.getElementById('panduan-page').classList.add('hidden');
      document.getElementById('pengaturan-page').classList.add('hidden');
      
      document.getElementById('nav-absensi').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-blue-500 text-white';
      document.getElementById('nav-rekap').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
      document.getElementById('nav-panduan').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
      document.getElementById('nav-pengaturan').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
    };

    window.showRekapPage = function() {
      document.getElementById('absensi-page').classList.add('hidden');
      document.getElementById('rekap-page').classList.remove('hidden');
      document.getElementById('panduan-page').classList.add('hidden');
      document.getElementById('pengaturan-page').classList.add('hidden');
      
      document.getElementById('nav-absensi').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
      document.getElementById('nav-rekap').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-blue-500 text-white';
      document.getElementById('nav-panduan').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
      document.getElementById('nav-pengaturan').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
    };

    window.showPanduanPage = function() {
      document.getElementById('absensi-page').classList.add('hidden');
      document.getElementById('rekap-page').classList.add('hidden');
      document.getElementById('panduan-page').classList.remove('hidden');
      document.getElementById('pengaturan-page').classList.add('hidden');
      
      document.getElementById('nav-absensi').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
      document.getElementById('nav-rekap').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
      document.getElementById('nav-panduan').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-blue-500 text-white';
      document.getElementById('nav-pengaturan').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
    };

    window.showPengaturanPage = function() {
      document.getElementById('absensi-page').classList.add('hidden');
      document.getElementById('rekap-page').classList.add('hidden');
      document.getElementById('panduan-page').classList.add('hidden');
      document.getElementById('pengaturan-page').classList.remove('hidden');
      
      document.getElementById('nav-absensi').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
      document.getElementById('nav-rekap').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
      document.getElementById('nav-panduan').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
      document.getElementById('nav-pengaturan').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-blue-500 text-white';
      
      updateUserManagementInterface();
      renderUserList();
      loadSavedUrls();
    };

    function updateUserManagementInterface() {
      const addUserSection = document.getElementById('add-user-section');
      
      if (hasPermission('manage_users')) {
        addUserSection.classList.remove('hidden');
      } else {
        addUserSection.classList.add('hidden');
      }
    }

    function renderUserList() {
      const userList = document.getElementById('user-list');
      if (!userList) return;
      
      const userEntries = Object.entries(users);
      
      if (userEntries.length === 0) {
        userList.innerHTML = `
          <div class="text-center py-8 text-gray-400">
            <div class="text-4xl mb-2">ğŸ‘¥</div>
            <p>Belum ada user terdaftar</p>
          </div>
        `;
        return;
      }
      
      userList.innerHTML = userEntries.map(([username, userData]) => {
        const roleColors = {
          'Admin': 'bg-red-100 text-red-800',
          'Kepala Sekolah': 'bg-purple-100 text-purple-800',
          'Guru Piket': 'bg-blue-100 text-blue-800'
        };
        
        const roleIcons = {
          'Admin': 'ğŸ‘‘',
          'Kepala Sekolah': 'ğŸ“',
          'Guru Piket': 'ğŸ‘¨â€ğŸ«'
        };
        
        const canDelete = hasPermission('manage_users') && username !== currentUser?.username;
        const canEdit = hasPermission('manage_users');
        
        return `
          <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
              <div class="flex items-center gap-3">
                <div class="text-2xl">${roleIcons[userData.role]}</div>
                <div>
                  <h4 class="font-bold text-gray-800">${userData.nama || username}</h4>
                  <p class="text-sm text-gray-600">Username: ${username}</p>
                  <span class="px-2 py-1 rounded-full text-xs font-medium ${roleColors[userData.role]}">
                    ${userData.role}
                  </span>
                </div>
              </div>
              <div class="flex items-center gap-2">
                ${username === currentUser?.username ? 
                  '<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">Anda</span>' : 
                  ''
                }
                ${canEdit ? `
                  <button onclick="editUserPassword('${username}')" class="px-3 py-1 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all text-xs font-medium">
                    ğŸ”‘ Edit Password
                  </button>
                ` : ''}
                ${canDelete ? `
                  <button onclick="deleteUser('${username}')" class="px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all text-xs font-medium">
                    ğŸ—‘ï¸ Hapus
                  </button>
                ` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    async function handleAddUser(e) {
      e.preventDefault();
      
      if (!hasPermission('manage_users')) {
        showToast('âŒ Anda tidak memiliki izin untuk mengelola user!', 'error');
        return;
      }
      
      setLoading(true, 'add-user-btn', 'add-user-text');
      
      const namaUser = document.getElementById('new-nama-user').value;
      const username = document.getElementById('new-username').value;
      const password = document.getElementById('new-password').value;
      const role = document.getElementById('new-role').value;
      
      if (users[username]) {
        showToast('âŒ Username sudah digunakan!', 'error');
        setLoading(false, 'add-user-btn', 'add-user-text');
        return;
      }
      
      const rolePermissions = {
        'Admin': ['create', 'read', 'update', 'delete', 'export', 'manage_users'],
        'Kepala Sekolah': ['read', 'export', 'view_reports'],
        'Guru Piket': ['create', 'read', 'update']
      };
      
      users[username] = {
        nama: namaUser,
        password: password,
        role: role,
        permissions: rolePermissions[role]
      };
      
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      showToast(`âœ… User ${namaUser} (${username}) berhasil ditambahkan!`, 'success');
      document.getElementById('add-user-form').reset();
      renderUserList();
      
      setLoading(false, 'add-user-btn', 'add-user-text');
    }

    window.deleteUser = async function(username) {
      if (!hasPermission('manage_users')) {
        showToast('âŒ Anda tidak memiliki izin untuk mengelola user!', 'error');
        return;
      }
      
      if (username === currentUser?.username) {
        showToast('âŒ Anda tidak dapat menghapus akun sendiri!', 'error');
        return;
      }
      
      const confirmDiv = document.createElement('div');
      confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      confirmDiv.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-sm mx-4 text-center shadow-2xl">
          <div class="text-6xl mb-4">âš ï¸</div>
          <h3 class="text-xl font-bold text-gray-800 mb-2">Konfirmasi Hapus</h3>
          <p class="text-gray-600 mb-4">Yakin ingin menghapus user "${username}"?</p>
          <div class="flex gap-3">
            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-all font-medium">
              Batal
            </button>
            <button onclick="confirmDeleteUser('${username}'); this.parentElement.parentElement.parentElement.remove();" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all font-medium">
              Hapus
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmDiv);
    };

    window.confirmDeleteUser = function(username) {
      delete users[username];
      showToast(`âœ… User ${username} berhasil dihapus!`, 'success');
      renderUserList();
    };

    // Edit User Password Function
    window.editUserPassword = function(username) {
      if (!hasPermission('manage_users')) {
        showToast('âŒ Anda tidak memiliki izin untuk mengelola user!', 'error');
        return;
      }
      
      const user = users[username];
      if (!user) {
        showToast('âŒ User tidak ditemukan!', 'error');
        return;
      }
      
      const editDiv = document.createElement('div');
      editDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      editDiv.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md mx-4 shadow-2xl">
          <div class="text-center mb-6">
            <div class="text-4xl mb-2">ğŸ”‘</div>
            <h3 class="text-xl font-bold text-gray-800">Edit Password User</h3>
            <p class="text-gray-600 mt-2">
              <strong>Nama:</strong> ${user.nama || username}<br>
              <strong>Username:</strong> ${username}<br>
              <strong>Role:</strong> ${user.role}
            </p>
          </div>
          
          <form id="edit-password-form" class="space-y-4">
            <div>
              <label for="edit-current-password" class="block text-sm font-medium text-gray-700 mb-2">Password Saat Ini</label>
              <input type="password" id="edit-current-password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Masukkan password saat ini">
            </div>
            
            <div>
              <label for="edit-new-password" class="block text-sm font-medium text-gray-700 mb-2">Password Baru</label>
              <input type="password" id="edit-new-password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Masukkan password baru">
            </div>
            
            <div>
              <label for="edit-confirm-password" class="block text-sm font-medium text-gray-700 mb-2">Konfirmasi Password Baru</label>
              <input type="password" id="edit-confirm-password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Konfirmasi password baru">
            </div>
            
            <div class="flex gap-3 mt-6">
              <button type="button" onclick="closeEditPasswordModal()" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-all font-medium">
                Batal
              </button>
              <button type="submit" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all font-medium">
                Update Password
              </button>
            </div>
          </form>
        </div>
      `;
      
      document.body.appendChild(editDiv);
      
      // Handle form submission
      document.getElementById('edit-password-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const currentPassword = document.getElementById('edit-current-password').value;
        const newPassword = document.getElementById('edit-new-password').value;
        const confirmPassword = document.getElementById('edit-confirm-password').value;
        
        // Validate current password
        if (currentPassword !== user.password) {
          showToast('âŒ Password saat ini tidak sesuai!', 'error');
          return;
        }
        
        // Validate new password confirmation
        if (newPassword !== confirmPassword) {
          showToast('âŒ Konfirmasi password tidak sesuai!', 'error');
          return;
        }
        
        // Validate new password length
        if (newPassword.length < 6) {
          showToast('âŒ Password baru minimal 6 karakter!', 'error');
          return;
        }
        
        // Update password
        users[username].password = newPassword;
        
        // Close modal
        editDiv.remove();
        
        // Show success message
        showToast(`âœ… Password user ${user.nama || username} berhasil diupdate!`, 'success');
        
        // Refresh user list
        renderUserList();
      });
    };

    // Close Edit Password Modal
    window.closeEditPasswordModal = function() {
      const modal = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
      if (modal) {
        modal.remove();
      }
    };

    // Save URL functions
    window.saveStudentDataUrl = function() {
      const url = document.getElementById('student-data-url').value;
      
      if (!url) {
        showToast('âŒ Masukkan URL terlebih dahulu!', 'error');
        return;
      }
      
      localStorage.setItem('studentDataUrl', url);
      studentDataUrl = url;
      
      showToast('âœ… URL Data Siswa berhasil disimpan!', 'success');
      updateStudentDataStatus(true, url);
    };

    window.saveAttendanceUrl = function() {
      const url = document.getElementById('attendance-data-url').value;
      
      if (!url) {
        showToast('âŒ Masukkan URL terlebih dahulu!', 'error');
        return;
      }
      
      try {
        localStorage.setItem('attendanceSheetUrl', url);
        attendanceSheetUrl = url;
        isAttendanceSheetConnected = true;
        
        // Update display immediately
        updateAttendanceUrlDisplay();
        
        // Show success message
        showToast('âœ… URL Data Absensi berhasil disimpan!', 'success');
        
        console.log('âœ… Attendance URL saved successfully:', url);
        
      } catch (error) {
        console.error('âŒ Error saving attendance URL:', error);
        showToast('âŒ Gagal menyimpan URL. Silakan coba lagi.', 'error');
      }
    };

    function loadSavedUrls() {
      // Load student data URL
      const savedStudentUrl = localStorage.getItem('studentDataUrl');
      if (savedStudentUrl) {
        studentDataUrl = savedStudentUrl;
        document.getElementById('student-data-url').value = savedStudentUrl;
        updateStudentDataStatus(true, savedStudentUrl);
        
        // Auto-load student data if URL is saved
        loadStudentDataFromSheets(savedStudentUrl);
      }
      
      // Load attendance URL
      const savedAttendanceUrl = localStorage.getItem('attendanceSheetUrl');
      if (savedAttendanceUrl) {
        attendanceSheetUrl = savedAttendanceUrl;
        document.getElementById('attendance-data-url').value = savedAttendanceUrl;
        isAttendanceSheetConnected = true;
      }
      
      updateAttendanceUrlDisplay();
    }

    function updateAttendanceUrlDisplay() {
      const currentUrlElement = document.getElementById('current-attendance-url');
      if (currentUrlElement) {
        currentUrlElement.textContent = attendanceSheetUrl;
      }
    }

    async function handleStudentDataForm(e) {
      e.preventDefault();
      
      const url = document.getElementById('student-data-url').value;
      
      if (!url) {
        showToast('âŒ Masukkan URL Google Apps Script terlebih dahulu!', 'error');
        return;
      }
      
      studentDataUrl = url;
      const success = await loadStudentDataFromSheets(url);
      
      if (success) {
        updateStudentDataStatus(true, url);
      }
    }

    function updateStudentDataStatus(isConnected, url = '') {
      const statusDiv = document.getElementById('student-data-status');
      
      if (isConnected) {
        statusDiv.className = 'p-4 rounded-lg border-l-4 border-l-green-400 bg-green-50';
        statusDiv.innerHTML = `
          <div class="flex items-center gap-3">
            <span class="text-2xl">âœ…</span>
            <div>
              <h3 class="font-bold text-green-800">Terhubung ke Google Sheets</h3>
              <p class="text-green-600 text-sm">Data siswa berhasil dimuat dari Google Sheets</p>
              <p class="text-green-500 text-xs mt-1 break-all">${url}</p>
            </div>
          </div>
        `;
      } else {
        statusDiv.className = 'p-4 rounded-lg border-l-4 border-l-yellow-400 bg-yellow-50';
        statusDiv.innerHTML = `
          <div class="flex items-center gap-3">
            <span class="text-2xl">ğŸ“‹</span>
            <div>
              <h3 class="font-bold text-yellow-800">Menggunakan Data Sample</h3>
              <p class="text-yellow-600 text-sm">Belum terhubung ke Google Sheets - menggunakan data sample</p>
            </div>
          </div>
        `;
      }
    }

    // Test Google Sheets connection function
    window.testGoogleSheetsConnection = async function() {
      const testData = {
        nama_siswa: "Test Student - " + new Date().toLocaleTimeString(),
        kelas: "TEST",
        status: "Hadir",
        tanggal: new Date().toISOString().split('T')[0],
        waktu: new Date().toTimeString().split(' ')[0].substring(0, 5),
        keterangan: "Test koneksi Google Sheets - " + new Date().toLocaleString(),
        input_by: currentUser ? currentUser.username : "test_user",
        user_role: currentUser ? currentUser.role : "Test"
      };
      
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center';
      loadingDiv.style.zIndex = '10000';
      loadingDiv.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-sm mx-4 text-center shadow-2xl">
          <div class="loading-spinner mx-auto mb-4"></div>
          <h3 class="text-xl font-bold text-gray-800 mb-2">Testing Connection...</h3>
          <p class="text-gray-600">Mengirim data test ke Google Sheets</p>
          <p class="text-xs text-gray-500 mt-2">Tunggu 3 detik untuk hasil...</p>
        </div>
      `;
      document.body.appendChild(loadingDiv);
      
      console.log('ğŸ§ª Starting Google Sheets connection test...');
      console.log('ğŸ“Š Test data:', testData);
      console.log('ğŸ”— Apps Script URL:', attendanceSheetUrl);
      
      try {
        console.log('ğŸ“¡ Sending POST request to Google Apps Script...');
        
        const response = await fetch(attendanceSheetUrl, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(testData)
        });
        
        console.log('ğŸ“¡ Response received (no-cors mode):', response);
        console.log('ğŸ“¡ Response status:', response.status);
        console.log('ğŸ“¡ Response type:', response.type);
        
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Remove loading div safely
        if (loadingDiv && loadingDiv.parentElement) {
          loadingDiv.remove();
        }
        
        const successDiv = document.createElement('div');
        successDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center';
        successDiv.style.zIndex = '10001';
        successDiv.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-lg mx-4 text-center shadow-2xl max-h-96 overflow-y-auto">
            <div class="text-6xl mb-4">âœ…</div>
            <h3 class="text-xl font-bold text-green-800 mb-2">Test Koneksi Berhasil!</h3>
            <p class="text-gray-600 mb-4">Data test berhasil dikirim ke Google Apps Script</p>
            
            <div class="bg-blue-50 p-3 rounded-lg mb-4 text-left">
              <p class="text-sm text-blue-800"><strong>ğŸ“Š Data yang dikirim:</strong></p>
              <p class="text-xs text-blue-700 mt-1">Nama: ${testData.nama_siswa}</p>
              <p class="text-xs text-blue-700">Kelas: ${testData.kelas}</p>
              <p class="text-xs text-blue-700">Status: ${testData.status}</p>
              <p class="text-xs text-blue-700">Waktu: ${testData.tanggal} ${testData.waktu}</p>
            </div>
            
            <div class="bg-green-50 p-3 rounded-lg mb-4 text-left">
              <p class="text-sm text-green-800"><strong>ğŸ“¡ Status Koneksi:</strong></p>
              <p class="text-xs text-green-700 mt-1">âœ… Request berhasil dikirim tanpa error</p>
              <p class="text-xs text-green-700">âœ… Mode: no-cors (sesuai implementasi produksi)</p>
              <p class="text-xs text-green-700">âœ… Tidak ada exception yang terjadi</p>
            </div>
            
            <div class="bg-yellow-50 p-3 rounded-lg mb-4 text-left">
              <p class="text-sm text-yellow-800"><strong>âœ… Verifikasi Manual:</strong></p>
              <ol class="text-xs text-yellow-700 mt-1 space-y-1 list-decimal list-inside">
                <li><strong>Buka Google Sheets "Data Absensi Harian"</strong></li>
                <li><strong>Cek baris terbaru</strong> - harus ada data dengan kelas "TEST"</li>
                <li><strong>Jika ada data baru</strong> = Koneksi 100% berhasil! ğŸ‰</li>
                <li><strong>Jika tidak ada</strong> = Cek deployment Apps Script</li>
              </ol>
            </div>
            
            <div class="flex gap-2">
              <button onclick="closeTestModal(this)" class="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all font-medium text-sm">
                OK
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(successDiv);
        
        // Auto close after 10 seconds if user doesn't click
        setTimeout(() => {
          if (successDiv && successDiv.parentElement) {
            successDiv.remove();
          }
        }, 10000);
        
      } catch (error) {
        console.error('âŒ Error during connection test:', error);
        
        // Remove loading div safely
        if (loadingDiv && loadingDiv.parentElement) {
          loadingDiv.remove();
        }
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center';
        errorDiv.style.zIndex = '10001';
        errorDiv.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-md mx-4 text-center shadow-2xl">
            <div class="text-6xl mb-4">âŒ</div>
            <h3 class="text-xl font-bold text-red-800 mb-2">Test Koneksi Gagal</h3>
            <p class="text-gray-600 mb-4">Terjadi error saat mengirim data ke Google Sheets</p>
            
            <div class="bg-red-50 p-3 rounded-lg mb-4 text-left">
              <p class="text-sm text-red-800"><strong>Error:</strong></p>
              <p class="text-xs text-red-700 mt-1">${error.message}</p>
            </div>
            
            <button onclick="closeTestModal(this)" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all font-medium">
              Tutup
            </button>
          </div>
        `;
        document.body.appendChild(errorDiv);
        
        // Auto close after 10 seconds if user doesn't click
        setTimeout(() => {
          if (errorDiv && errorDiv.parentElement) {
            errorDiv.remove();
          }
        }, 10000);
      }
    };

    // Helper function to close test modal safely
    window.closeTestModal = function(button) {
      try {
        const modal = button.closest('.fixed');
        if (modal && modal.parentElement) {
          modal.remove();
        }
      } catch (error) {
        console.error('Error closing modal:', error);
        // Force remove all modals as fallback
        const allModals = document.querySelectorAll('.fixed.inset-0.bg-black.bg-opacity-50');
        allModals.forEach(modal => {
          if (modal.parentElement) {
            modal.remove();
          }
        });
      }
    };

    window.loadSampleStudentData = function() {
      console.log('ğŸ”„ Manual load sample student data triggered');
      
      studentsByClass = {
        'VII A': ['Ahmad Rizki', 'Siti Nurhaliza', 'Budi Santoso', 'Dewi Sartika', 'Eko Prasetyo', 'Fitri Handayani', 'Gilang Ramadhan', 'Hana Pertiwi', 'Indra Gunawan', 'Jihan Aulia', 'Krisna Wijaya', 'Lestari Putri', 'Muhammad Fadil', 'Nadia Safira', 'Oki Setiawan'],
        'VII B': ['Putri Maharani', 'Qori Syahputra', 'Rina Melati', 'Surya Pratama', 'Tania Sari', 'Umar Faruq', 'Vina Amelia', 'Wahyu Hidayat', 'Xenia Putri', 'Yoga Pratama', 'Zahra Aulia', 'Arif Rahman', 'Bella Safitri', 'Candra Kirana', 'Dimas Aditya'],
        'VII C': ['Elsa Permata', 'Fajar Nugraha', 'Gita Savitri', 'Hendra Kusuma', 'Ika Rahmawati', 'Joko Susilo', 'Kartika Dewi', 'Lukman Hakim', 'Maya Sari', 'Noval Pratama', 'Olivia Putri', 'Pandu Winata', 'Qonita Zahara', 'Reza Mahendra', 'Sari Indah'],
        'VIII A': ['Taufik Hidayat', 'Ulfa Khoiriyah', 'Vicky Pratama', 'Winda Sari', 'Xavier Putra', 'Yuni Astuti', 'Zaki Rahman', 'Aida Fitria', 'Bayu Setiawan', 'Citra Dewi', 'Doni Prasetya', 'Evi Susanti', 'Fandi Kurniawan', 'Gina Marlina', 'Hadi Wijaya'],
        'VIII B': ['Ira Puspita', 'Jefri Nichol', 'Kania Dewi', 'Luki Hermawan', 'Mira Handayani', 'Nanda Pratama', 'Oki Setiani', 'Prita Maharani', 'Qomar Zaman', 'Rini Suryani', 'Sandi Permana', 'Tika Rahayu', 'Udin Sedunia', 'Vera Safitri', 'Wawan Kurniawan'],
        'VIII C': ['Xara Putri', 'Yanto Basuki', 'Zara Amelia', 'Andi Pratama', 'Bela Purnama', 'Coki Pardede', 'Dina Mariana', 'Egi Maulana', 'Fira Azzahra', 'Galih Pratama', 'Hesti Purnamasari', 'Imam Santoso', 'Jesi Ramadhan', 'Kiki Amalia', 'Lina Marlina'],
        'IX A': ['Manda Safitri', 'Niko Pratama', 'Ocha Maharani', 'Piko Aditama', 'Qila Ramadhani', 'Riko Setiawan', 'Sinta Dewi', 'Toni Kurniawan', 'Umi Kalsum', 'Vero Pratama', 'Wulan Dari', 'Xavi Maulana', 'Yesi Purnama', 'Zidan Akbar', 'Alya Putri'],
        'IX B': ['Bagas Pratama', 'Cinta Laura', 'Dedi Setiawan', 'Eka Rahayu', 'Farel Prayoga', 'Gaby Spanic', 'Haris Pratama', 'Intan Permata', 'Jihan Mirdad', 'Kenzo Alvaro', 'Luna Maya', 'Maudy Ayunda', 'Nino Fernandez', 'Olla Ramlan', 'Prilly Latuconsina'],
        'IX C': ['Quincy Jones', 'Raisa Andriana', 'Sheila Dara', 'Tulus Rusydi', 'Ussy Sulistiawaty', 'Vidi Aldiano', 'Wulan Guritno', 'Xabiru Oshe', 'Yura Yunita', 'Zaskia Gotik', 'Afgan Syahreza', 'Bunga Zainal', 'Chand Kelvin', 'Dian Sastro', 'Enzy Storia']
      };
      
      isStudentDataLoaded = true;
      updateClassDropdowns();
      updateStudentDataStatus(false);
      
      // Update stats to show student count
      updateStats(allRecords);
      
      const totalStudents = Object.values(studentsByClass).reduce((sum, students) => sum + students.length, 0);
      
      showToast(`ğŸ“‹ Data sample dimuat ulang: ${totalStudents} siswa dari 9 kelas!`, 'success');
    };

    // Rekap functions
    window.showRekapHarian = function() {
      document.getElementById('rekap-harian-section').classList.remove('hidden');
      document.getElementById('rekap-bulanan-section').classList.add('hidden');
      
      document.getElementById('rekap-nav-harian').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-blue-500 text-white';
      document.getElementById('rekap-nav-bulanan').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
    };

    window.showRekapBulanan = function() {
      document.getElementById('rekap-harian-section').classList.add('hidden');
      document.getElementById('rekap-bulanan-section').classList.remove('hidden');
      
      document.getElementById('rekap-nav-harian').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
      document.getElementById('rekap-nav-bulanan').className = 'px-4 py-2 rounded-lg font-medium transition-all bg-blue-500 text-white';
    };

    window.generateRekapByDate = function() {
      const selectedDate = document.getElementById('rekap-tanggal').value;
      
      if (!selectedDate) {
        showToast('âŒ Pilih tanggal terlebih dahulu!', 'error');
        return;
      }
      
      const filteredData = allRecords.filter(record => record.tanggal === selectedDate);
      
      if (filteredData.length === 0) {
        document.getElementById('rekap-results').innerHTML = `
          <div class="text-center py-12 text-gray-400">
            <div class="text-6xl mb-4">ğŸ“…</div>
            <p class="text-lg">Tidak ada data absensi untuk tanggal ${selectedDate}</p>
            <p class="text-sm mt-2">Pilih tanggal lain atau tambahkan data absensi</p>
          </div>
        `;
        return;
      }
      
      generateRekapDisplay(filteredData, `Rekap Harian - ${selectedDate}`);
    };

    window.generateRekapBulanan = function() {
      const selectedMonth = document.getElementById('rekap-bulan').value;
      const selectedYear = document.getElementById('rekap-tahun').value;
      
      const monthNames = {
        '01': 'Januari', '02': 'Februari', '03': 'Maret', '04': 'April',
        '05': 'Mei', '06': 'Juni', '07': 'Juli', '08': 'Agustus',
        '09': 'September', '10': 'Oktober', '11': 'November', '12': 'Desember'
      };
      
      const filteredData = allRecords.filter(record => {
        const recordDate = new Date(record.tanggal);
        return recordDate.getFullYear() == selectedYear && 
               (recordDate.getMonth() + 1).toString().padStart(2, '0') === selectedMonth;
      });
      
      if (filteredData.length === 0) {
        document.getElementById('rekap-results').innerHTML = `
          <div class="text-center py-12 text-gray-400">
            <div class="text-6xl mb-4">ğŸ“Š</div>
            <p class="text-lg">Tidak ada data absensi untuk ${monthNames[selectedMonth]} ${selectedYear}</p>
            <p class="text-sm mt-2">Pilih bulan lain atau tambahkan data absensi</p>
          </div>
        `;
        return;
      }
      
      generateRekapDisplay(filteredData, `Rekap Bulanan - ${monthNames[selectedMonth]} ${selectedYear}`);
    };

    function generateRekapDisplay(data, title) {
      const classSummary = {};
      
      data.forEach(record => {
        if (!classSummary[record.kelas]) {
          classSummary[record.kelas] = {
            hadir: 0,
            izin: 0,
            sakit: 0,
            alpha: 0,
            total: 0
          };
        }
        
        classSummary[record.kelas][record.status.toLowerCase()]++;
        classSummary[record.kelas].total++;
      });
      
      const totalStats = {
        hadir: data.filter(r => r.status === 'Hadir').length,
        izin: data.filter(r => r.status === 'Izin').length,
        sakit: data.filter(r => r.status === 'Sakit').length,
        alpha: data.filter(r => r.status === 'Alpha').length,
        total: data.length
      };
      
      document.getElementById('rekap-results').innerHTML = `
        <div class="space-y-6">
          <!-- Header -->
          <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-2xl font-bold text-purple-800 mb-4">${title}</h3>
            
            <!-- Total Summary -->
            <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-6">
              <div class="bg-blue-50 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-blue-800">${Object.values(studentsByClass).reduce((sum, students) => sum + students.length, 0)}</div>
                <div class="text-sm text-gray-600">Total Siswa</div>
              </div>
              <div class="bg-gray-50 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-gray-800">${totalStats.total}</div>
                <div class="text-sm text-gray-600">Total Absensi</div>
              </div>
              <div class="bg-green-50 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-green-600">${totalStats.hadir}</div>
                <div class="text-sm text-gray-600">Hadir</div>
              </div>
              <div class="bg-yellow-50 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-yellow-600">${totalStats.izin}</div>
                <div class="text-sm text-gray-600">Izin</div>
              </div>
              <div class="bg-red-50 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-red-600">${totalStats.sakit}</div>
                <div class="text-sm text-gray-600">Sakit</div>
              </div>
              <div class="bg-purple-50 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-purple-600">${totalStats.alpha}</div>
                <div class="text-sm text-gray-600">Alpha</div>
              </div>
            </div>
          </div>
          
          <!-- Per Class Summary -->
          <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
              <h4 class="text-xl font-bold text-gray-800">ğŸ“Š Rekap Per Kelas</h4>
              <div class="flex gap-2">
                <button onclick="exportRekapToExcel('${title}', ${JSON.stringify(classSummary).replace(/"/g, '&quot;')}, ${JSON.stringify(totalStats).replace(/"/g, '&quot;')})" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all font-medium text-sm">
                  ğŸ“Š Export Excel
                </button>
                <button onclick="printRekap()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all font-medium text-sm">
                  ğŸ–¨ï¸ Print
                </button>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full border-collapse border border-gray-300">
                <thead>
                  <tr class="bg-gray-100">
                    <th class="border border-gray-300 px-4 py-2 text-left">Kelas</th>
                    <th class="border border-gray-300 px-4 py-2 text-center">Jumlah Siswa</th>
                    <th class="border border-gray-300 px-4 py-2 text-center">Total Absensi</th>
                    <th class="border border-gray-300 px-4 py-2 text-center">Hadir</th>
                    <th class="border border-gray-300 px-4 py-2 text-center">Izin</th>
                    <th class="border border-gray-300 px-4 py-2 text-center">Sakit</th>
                    <th class="border border-gray-300 px-4 py-2 text-center">Alpha</th>
                    <th class="border border-gray-300 px-4 py-2 text-center">% Hadir</th>
                  </tr>
                </thead>
                <tbody>
                  ${Object.entries(classSummary).sort().map(([kelas, stats]) => {
                    const hadirPercentage = stats.total > 0 ? ((stats.hadir / stats.total) * 100).toFixed(1) : 0;
                    const jumlahSiswaKelas = studentsByClass[kelas] ? studentsByClass[kelas].length : 0;
                    return `
                      <tr class="hover:bg-gray-50">
                        <td class="border border-gray-300 px-4 py-2 font-medium">${kelas}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center text-blue-600 font-medium">${jumlahSiswaKelas}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${stats.total}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center text-green-600 font-medium">${stats.hadir}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center text-yellow-600">${stats.izin}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center text-red-600">${stats.sakit}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center text-purple-600">${stats.alpha}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center font-medium ${hadirPercentage >= 80 ? 'text-green-600' : hadirPercentage >= 60 ? 'text-yellow-600' : 'text-red-600'}">${hadirPercentage}%</td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    // Initialize app
    async function initializeApp() {
      try {
        console.log('ğŸš€ Starting app initialization...');
        
        // Initialize users first (no SDK dependency)
        initializeUsers();
        
        // Initialize Data SDK first
        console.log('ğŸ“Š Initializing Data SDK...');
        const initResult = await window.dataSdk.init(dataHandler);
        if (!initResult.isOk) {
          console.error("Failed to initialize data SDK:", initResult.error);
          showToast('âš ï¸ Gagal menginisialisasi sistem data', 'error');
        } else {
          console.log('âœ… Data SDK initialized successfully');
        }
        
        // Initialize Element SDK if available (after Data SDK)
        if (window.elementSdk) {
          console.log('ğŸ¨ Initializing Element SDK...');
          await window.elementSdk.init({
            defaultConfig,
            onConfigChange,
            mapToCapabilities: (config) => ({
              recolorables: [
                {
                  get: () => config.background_color || defaultConfig.background_color,
                  set: (value) => {
                    config.background_color = value;
                    if (window.elementSdk) window.elementSdk.setConfig({ background_color: value });
                  }
                },
                {
                  get: () => config.surface_color || defaultConfig.surface_color,
                  set: (value) => {
                    config.surface_color = value;
                    if (window.elementSdk) window.elementSdk.setConfig({ surface_color: value });
                  }
                },
                {
                  get: () => config.text_color || defaultConfig.text_color,
                  set: (value) => {
                    config.text_color = value;
                    if (window.elementSdk) window.elementSdk.setConfig({ text_color: value });
                  }
                },
                {
                  get: () => config.primary_action_color || defaultConfig.primary_action_color,
                  set: (value) => {
                    config.primary_action_color = value;
                    if (window.elementSdk) window.elementSdk.setConfig({ primary_action_color: value });
                  }
                },
                {
                  get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
                  set: (value) => {
                    config.secondary_action_color = value;
                    if (window.elementSdk) window.elementSdk.setConfig({ secondary_action_color: value });
                  }
                }
              ],
              borderables: [],
              fontEditable: {
                get: () => config.font_family || defaultConfig.font_family,
                set: (value) => {
                  config.font_family = value;
                  if (window.elementSdk) window.elementSdk.setConfig({ font_family: value });
                }
              },
              fontSizeable: {
                get: () => config.font_size || defaultConfig.font_size,
                set: (value) => {
                  config.font_size = value;
                  if (window.elementSdk) window.elementSdk.setConfig({ font_size: value });
                }
              }
            }),
            mapToEditPanelValues: (config) => new Map([
              ["judul_aplikasi", config.judul_aplikasi || defaultConfig.judul_aplikasi],
              ["nama_sekolah", config.nama_sekolah || defaultConfig.nama_sekolah],
              ["footer_text", config.footer_text || defaultConfig.footer_text],
              ["admin_username", config.admin_username || defaultConfig.admin_username],
              ["admin_password", config.admin_password || defaultConfig.admin_password]
            ])
          });
          console.log('âœ… Element SDK initialized successfully');
        } else {
          console.log('âš ï¸ Element SDK not available');
        }
        
        // Load sample student data
        loadSampleStudentData();
        
        // Set up event listeners
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('add-user-form').addEventListener('submit', handleAddUser);
        document.getElementById('student-data-form').addEventListener('submit', handleStudentDataForm);
        
        // Set up filter listeners
        document.getElementById('filter-kelas').addEventListener('change', applyFilters);
        document.getElementById('filter-status').addEventListener('change', applyFilters);
        document.getElementById('filter-tanggal').addEventListener('change', applyFilters);
        document.getElementById('filter-user').addEventListener('change', applyFilters);
        
        // Set current date for filters
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('rekap-tanggal').value = today;
        
        // Set current month/year for monthly recap
        const now = new Date();
        document.getElementById('rekap-bulan').value = (now.getMonth() + 1).toString().padStart(2, '0');
        document.getElementById('rekap-tahun').value = now.getFullYear().toString();
        
        // Start time updates
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);
        
        console.log('âœ… App initialized successfully');
        
      } catch (error) {
        console.error('âŒ Error initializing app:', error);
        showToast('âŒ Gagal menginisialisasi aplikasi', 'error');
      }
    }

    // Export functions for rekap
    window.exportRekapToExcel = function(title, classSummary, totalStats) {
      if (!hasPermission('export')) {
        showToast('âŒ Anda tidak memiliki izin untuk export data!', 'error');
        return;
      }
      
      try {
        // Parse the JSON strings back to objects
        const classData = typeof classSummary === 'string' ? JSON.parse(classSummary.replace(/&quot;/g, '"')) : classSummary;
        const totals = typeof totalStats === 'string' ? JSON.parse(totalStats.replace(/&quot;/g, '"')) : totalStats;
        
        // Create Excel-compatible CSV with UTF-8 BOM
        const BOM = '\uFEFF';
        
        // Header information
        let csvContent = BOM;
        csvContent += `"${title}"\n`;
        csvContent += `"Tanggal Export: ${new Date().toLocaleDateString('id-ID')}"\n`;
        csvContent += `"Waktu Export: ${new Date().toLocaleTimeString('id-ID')}"\n`;
        csvContent += `"Exported by: ${currentUser ? currentUser.username : 'System'}"\n\n`;
        
        // Summary totals
        csvContent += '"RINGKASAN TOTAL"\n';
        csvContent += '"Status","Jumlah","Persentase"\n';
        csvContent += `"Total Keseluruhan","${totals.total}","100%"\n`;
        csvContent += `"Hadir","${totals.hadir}","${totals.total > 0 ? ((totals.hadir / totals.total) * 100).toFixed(1) : 0}%"\n`;
        csvContent += `"Izin","${totals.izin}","${totals.total > 0 ? ((totals.izin / totals.total) * 100).toFixed(1) : 0}%"\n`;
        csvContent += `"Sakit","${totals.sakit}","${totals.total > 0 ? ((totals.sakit / totals.total) * 100).toFixed(1) : 0}%"\n`;
        csvContent += `"Alpha","${totals.alpha}","${totals.total > 0 ? ((totals.alpha / totals.total) * 100).toFixed(1) : 0}%"\n\n`;
        
        // Per class breakdown
        csvContent += '"REKAP PER KELAS"\n';
        csvContent += '"Kelas","Jumlah Siswa","Total Absensi","Hadir","Izin","Sakit","Alpha","% Hadir","Status Kehadiran"\n';
        
        Object.entries(classData).sort().forEach(([kelas, stats]) => {
          const hadirPercentage = stats.total > 0 ? ((stats.hadir / stats.total) * 100).toFixed(1) : 0;
          const statusKehadiran = hadirPercentage >= 90 ? 'Sangat Baik' : 
                                 hadirPercentage >= 80 ? 'Baik' : 
                                 hadirPercentage >= 70 ? 'Cukup' : 
                                 hadirPercentage >= 60 ? 'Kurang' : 'Sangat Kurang';
          const jumlahSiswaKelas = studentsByClass[kelas] ? studentsByClass[kelas].length : 0;
          
          csvContent += `"${kelas}","${jumlahSiswaKelas}","${stats.total}","${stats.hadir}","${stats.izin}","${stats.sakit}","${stats.alpha}","${hadirPercentage}%","${statusKehadiran}"\n`;
        });
        
        // Add analysis section
        csvContent += '\n"ANALISIS KEHADIRAN"\n';
        const excellentClasses = Object.entries(classData).filter(([_, stats]) => 
          stats.total > 0 && ((stats.hadir / stats.total) * 100) >= 90
        ).length;
        const goodClasses = Object.entries(classData).filter(([_, stats]) => 
          stats.total > 0 && ((stats.hadir / stats.total) * 100) >= 80 && ((stats.hadir / stats.total) * 100) < 90
        ).length;
        const needAttentionClasses = Object.entries(classData).filter(([_, stats]) => 
          stats.total > 0 && ((stats.hadir / stats.total) * 100) < 80
        ).length;
        
        csvContent += `"Kelas dengan kehadiran sangat baik (â‰¥90%)","${excellentClasses}"\n`;
        csvContent += `"Kelas dengan kehadiran baik (80-89%)","${goodClasses}"\n`;
        csvContent += `"Kelas yang perlu perhatian (<80%)","${needAttentionClasses}"\n`;
        
        // Create and download file
        const blob = new Blob([csvContent], { 
          type: 'text/csv;charset=utf-8;' 
        });
        
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        
        // Generate filename with timestamp
        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
        const filename = `Rekap_Absensi_${title.replace(/[^a-zA-Z0-9]/g, '_')}_${timestamp}.csv`;
        link.setAttribute('download', filename);
        
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast('âœ… Rekap berhasil di-export ke Excel!', 'success');
        
      } catch (error) {
        console.error('Error exporting to Excel:', error);
        showToast('âŒ Gagal export ke Excel. Silakan coba lagi.', 'error');
      }
    };
    
    window.printRekap = function() {
      if (!hasPermission('export')) {
        showToast('âŒ Anda tidak memiliki izin untuk print data!', 'error');
        return;
      }
      
      const printContent = document.getElementById('rekap-results').innerHTML;
      const printWindow = window.open('', '_blank');
      
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Print Rekap Absensi</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            table { border-collapse: collapse; width: 100%; margin: 20px 0; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; font-weight: bold; }
            .text-center { text-align: center; }
            .text-green-600 { color: #059669; }
            .text-yellow-600 { color: #d97706; }
            .text-red-600 { color: #dc2626; }
            .text-purple-600 { color: #9333ea; }
            .bg-gray-50, .bg-green-50, .bg-yellow-50, .bg-red-50, .bg-purple-50 { background-color: #f9fafb; }
            .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; margin: 1rem 0; }
            .rounded-lg { border-radius: 0.5rem; }
            .p-4 { padding: 1rem; }
            .mb-4 { margin-bottom: 1rem; }
            .font-bold { font-weight: bold; }
            .text-2xl { font-size: 1.5rem; }
            .text-xl { font-size: 1.25rem; }
            .text-sm { font-size: 0.875rem; }
            @media print {
              body { margin: 0; }
              .no-print { display: none; }
            }
          </style>
        </head>
        <body>
          <div style="text-align: center; margin-bottom: 30px;">
            <h1>Rekap Absensi</h1>
            <p>Tanggal Print: ${new Date().toLocaleDateString('id-ID')}</p>
            <p>Waktu Print: ${new Date().toLocaleTimeString('id-ID')}</p>
          </div>
          ${printContent}
          <div style="margin-top: 30px; text-align: center; font-size: 12px; color: #666;">
            <p>Dicetak oleh: ${currentUser ? currentUser.username : 'System'} | Sistem Absensi Online</p>
          </div>
        </body>
        </html>
      `);
      
      printWindow.document.close();
      printWindow.focus();
      
      setTimeout(() => {
        printWindow.print();
        printWindow.close();
      }, 250);
      
      showToast('âœ… Halaman print telah disiapkan!', 'success');
    };

    // Start the app when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'997221730233aa0f',t:'MTc2MTkwMjk5NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
